<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trimint - TON Network Mining App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(45deg, #00D9FF, #0099FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .coin-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .coin-circle {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FF8C00);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 25px 80px rgba(255, 215, 0, 0.5);
            animation: float 4s ease-in-out infinite;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .coin-circle:hover {
            transform: scale(1.08);
            box-shadow: 0 30px 90px rgba(255, 215, 0, 0.7);
        }
        
        .coin-circle.farming {
            animation: rotate 2s linear infinite, float 4s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-25px); }
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .token-animation {
            position: absolute;
            color: #FFD700;
            font-weight: bold;
            font-size: 20px;
            pointer-events: none;
            animation: rise 2.5s ease-out forwards;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        @keyframes rise {
            0% { 
                opacity: 1; 
                transform: translateY(0px);
            }
            100% { 
                opacity: 0; 
                transform: translateY(-120px);
            }
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(25px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }
        
        .content-area {
            padding-bottom: 90px;
            min-height: 100vh;
        }
        
        .quiz-card {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            transition: all 0.3s ease;
        }
        
        .quiz-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.4);
        }
        
        .task-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        }
        
        .blog-post {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(15px);
            transition: all 0.3s ease;
        }
        
        .blog-post:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .leaderboard-item {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(5px);
        }
        
        .section-hidden {
            display: none;
        }
        
        .pulse-animation {
            animation: pulse 2.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .ton-connect-btn {
            background: linear-gradient(45deg, #0088CC, #0066AA);
            color: white;
            padding: 14px 28px;
            border-radius: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .ton-connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 136, 204, 0.4);
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .level-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .level-bronze {
            background: linear-gradient(45deg, #CD7F32, #B87333);
            color: white;
        }
        
        .level-gold {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }
        
        .level-diamond {
            background: linear-gradient(45deg, #B9F2FF, #00CED1);
            color: white;
        }
        
        .currency-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 4px;
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <h2 class="text-white text-2xl font-bold mb-2">Loading Trimint...</h2>
            <p id="referralMessage" class="text-white/70 hidden"></p>
        </div>
    </div>

    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="glass-effect p-4 sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-3xl font-bold gradient-text">Trimint</h1>
                <div id="userBalance" class="text-white font-semibold flex items-center">
                    <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="currency-icon">
                    <span id="balanceAmount" class="text-xl">0</span> TRM
                </div>
            </div>
        </header>

        <!-- Home Section -->
        <section id="homeSection" class="content-area">
            <!-- User Info -->
            <div class="container mx-auto p-4">
                <div class="glass-effect rounded-2xl p-4 mb-6 cursor-pointer" onclick="showProfile()">
                    <div class="flex items-center space-x-4">
                        <img id="userPhoto" src="https://picsum.photos/seed/user/60/60" alt="User" class="w-16 h-16 rounded-full border-2 border-blue-400">
                        <div class="flex-1">
                            <h3 id="userName" class="text-white font-semibold text-lg">Loading...</h3>
                            <p class="text-white/70 text-sm">Click to view profile â†’</p>
                        </div>
                        <div class="text-right">
                            <p class="text-white/70 text-sm">Level</p>
                            <div id="userLevel" class="level-badge level-bronze">Bronze</div>
                        </div>
                    </div>
                </div>

                <!-- Farming Section -->
                <div class="glass-effect rounded-2xl p-6 mb-6">
                    <div class="coin-container mb-4">
                        <div id="coinCircle" class="coin-circle" onclick="toggleFarming()">
                            <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM Coin" class="w-48 h-48 rounded-full">
                        </div>
                    </div>
                    <div class="text-center">
                        <button id="farmButton" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-10 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-300 pulse-animation" onclick="toggleFarming()">
                            <i class="fas fa-seedling mr-2"></i>Start Farming
                        </button>
                        <div id="farmingStatus" class="mt-4 text-white hidden">
                            <p class="text-sm">Farming Progress</p>
                            <p id="farmingTime" class="text-2xl font-bold">12:00:00</p>
                            <p class="text-sm mt-2">Rate: 0.001 TRM/sec</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Profile Section -->
        <section id="profileSection" class="content-area section-hidden">
            <div class="container mx-auto p-4">
                <button onclick="showHome()" class="mb-4 text-white/70 hover:text-white">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
                
                <div class="glass-effect rounded-2xl p-6 mb-6">
                    <div class="text-center">
                        <img id="profilePhoto" src="https://picsum.photos/seed/profile/120/120" alt="Profile" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-blue-400">
                        <h2 id="profileName" class="text-white text-2xl font-bold mb-2">Loading...</h2>
                        <p class="text-white/70 mb-4">Premium Member</p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="text-center">
                                <p class="text-white/70 text-sm">Level</p>
                                <div id="profileLevel" class="level-badge level-bronze text-lg">Bronze</div>
                            </div>
                            <div class="text-center">
                                <p class="text-white/70 text-sm">Balance</p>
                                <p id="profileBalance" class="text-yellow-400 text-2xl font-bold">0 TRM</p>
                            </div>
                            <div class="text-center">
                                <p class="text-white/70 text-sm">Quiz Completed</p>
                                <p id="quizCompleted" class="text-white text-2xl font-bold">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-white/70 text-sm">Friends Invited</p>
                                <p id="friendsInvited" class="text-white text-2xl font-bold">0</p>
                            </div>
                        </div>
                        
                        <div id="tonWalletSection" class="mb-4 hidden">
                            <div class="bg-green-500/20 border border-green-400 rounded-xl p-3 mb-3">
                                <p class="text-green-400 text-sm mb-1">Connected Wallet</p>
                                <p id="tonWalletAddress" class="text-white font-mono text-xs break-all"></p>
                                <div class="flex space-x-2 mt-2">
                                    <button onclick="copyWalletAddress()" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm">
                                        <i class="fas fa-copy mr-1"></i>Copy
                                    </button>
                                    <button onclick="disconnectTonWallet()" class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm">
                                        <i class="fas fa-unlink mr-1"></i>Disconnect
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <button id="tonConnectBtn" class="ton-connect-btn w-full mb-4" onclick="toggleTonConnect()">
                            <i class="fas fa-wallet mr-2"></i>Connect TON Wallet
                        </button>
                    </div>
                </div>

                <!-- Leaderboard Preview -->
                <div class="glass-effect rounded-2xl p-4">
                    <h3 class="text-white font-bold text-lg mb-4">
                        <i class="fas fa-trophy text-yellow-400 mr-2"></i>Your Ranking
                    </h3>
                    <div class="space-y-3">
                        <div class="leaderboard-item rounded-xl p-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <span class="text-yellow-400 font-bold">#1</span>
                                    <img src="https://picsum.photos/seed/top1/40/40" alt="User" class="w-10 h-10 rounded-full">
                                    <div>
                                        <p class="text-white font-semibold">You</p>
                                        <p class="text-white/70 text-sm">Level <span id="userRankLevel">1</span></p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-yellow-400 font-bold">0 TRM</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quiz Section -->
        <section id="quizSection" class="content-area section-hidden">
            <div class="container mx-auto p-4">
                <h2 class="text-white text-2xl font-bold mb-6">
                    <i class="fas fa-question-circle text-blue-400 mr-2"></i>TON Network Quiz
                </h2>
                <div id="quizContainer" class="space-y-4">
                    <!-- Quiz questions will be loaded here -->
                </div>
                <div id="quizResult" class="glass-effect rounded-2xl p-6 mt-6 hidden">
                    <h3 class="text-white text-xl font-bold mb-4">ðŸŽ‰ Congratulations!</h3>
                    <p class="text-green-400 text-lg">You earned <span id="quizReward">1500</span> TRM tokens!</p>
                    <button onclick="nextQuiz()" class="bg-blue-500 text-white px-6 py-2 rounded-full mt-4">Next Quiz</button>
                </div>
            </div>
        </section>

        <!-- Blog Section -->
        <section id="blogSection" class="content-area section-hidden">
            <div class="container mx-auto p-4">
                <h2 class="text-white text-2xl font-bold mb-6">
                    <i class="fas fa-blog text-purple-400 mr-2"></i>Community Forum
                </h2>
                <button onclick="createBlogPost()" class="bg-purple-500 text-white px-6 py-3 rounded-full mb-6 w-full font-semibold">
                    <i class="fas fa-plus mr-2"></i>Create New Post
                </button>
                <div id="blogContainer" class="space-y-4">
                    <!-- Blog posts will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Tasks Section -->
        <section id="tasksSection" class="content-area section-hidden">
            <div class="container mx-auto p-4">
                <h2 class="text-white text-2xl font-bold mb-6">
                    <i class="fas fa-tasks text-green-400 mr-2"></i>Earn Tasks
                </h2>
                
                <!-- Watch Ads Task (Always on top) -->
                <div class="task-card rounded-2xl p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="bg-white/20 p-3 rounded-xl">
                                <i class="fas fa-ad text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-white font-bold">Watch Ads</h3>
                                <p class="text-white/70 text-sm">Earn 1 TRM per ad</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-yellow-400 font-bold">1 TRM</p>
                            <button onclick="watchAd()" class="bg-white/20 text-white px-4 py-2 rounded-full text-sm mt-1">
                                Watch
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="tasksContainer" class="space-y-4">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Friends Section -->
        <section id="friendsSection" class="content-area section-hidden">
            <div class="container mx-auto p-4">
                <h2 class="text-white text-2xl font-bold mb-6">
                    <i class="fas fa-user-friends text-blue-400 mr-2"></i>Invite Friends
                </h2>
                
                <div class="glass-effect rounded-2xl p-6 mb-6">
                    <div class="text-center">
                        <p class="text-white/70 mb-4">Invite friends and earn 5000 TRM each!</p>
                        <div class="bg-white/10 rounded-xl p-4 mb-4">
                            <p class="text-white text-sm mb-2">Your referral link:</p>
                            <p id="referralLink" class="text-yellow-400 font-mono text-sm break-all"></p>
                        </div>
                        <button onclick="copyReferralLink()" class="bg-blue-500 text-white px-6 py-3 rounded-full font-semibold w-full">
                            <i class="fas fa-copy mr-2"></i>Copy Link
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <div class="text-center">
                            <p class="text-white/70 text-sm">Total Referrals</p>
                            <p id="totalReferrals" class="text-white text-2xl font-bold">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-white/70 text-sm">Earned from Referrals</p>
                            <p id="referralEarnings" class="text-yellow-400 text-2xl font-bold">0 TRM</p>
                        </div>
                    </div>
                </div>
                
                <div class="glass-effect rounded-2xl p-4">
                    <h3 class="text-white font-bold mb-4">Your Referrals</h3>
                    <div id="referralsList" class="space-y-3">
                        <!-- Referrals will be listed here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Leaderboard Section -->
        <section id="leaderboardSection" class="content-area section-hidden">
            <div class="container mx-auto p-4">
                <h2 class="text-white text-2xl font-bold mb-6">
                    <i class="fas fa-trophy text-yellow-400 mr-2"></i>Top 25 Leaders
                </h2>
                <div id="leaderboardList" class="space-y-3">
                    <!-- Leaderboard will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="container mx-auto">
                <div class="grid grid-cols-5 gap-1">
                    <button onclick="showHome()" class="nav-btn p-3 text-center hover:bg-gray-100 transition-colors rounded-t-lg">
                        <i class="fas fa-home text-xl mb-1" style="color: #3b82f6;"></i>
                        <p class="text-xs font-medium">Home</p>
                    </button>
                    <button onclick="showQuiz()" class="nav-btn p-3 text-center hover:bg-gray-100 transition-colors rounded-t-lg">
                        <i class="fas fa-question-circle text-xl mb-1" style="color: #8b5cf6;"></i>
                        <p class="text-xs font-medium">Quiz</p>
                    </button>
                    <button onclick="showBlog()" class="nav-btn p-3 text-center hover:bg-gray-100 transition-colors rounded-t-lg">
                        <i class="fas fa-blog text-xl mb-1" style="color: #06b6d4;"></i>
                        <p class="text-xs font-medium">Forum</p>
                    </button>
                    <button onclick="showTasks()" class="nav-btn p-3 text-center hover:bg-gray-100 transition-colors rounded-t-lg">
                        <i class="fas fa-tasks text-xl mb-1" style="color: #10b981;"></i>
                        <p class="text-xs font-medium">Tasks</p>
                    </button>
                    <button onclick="showFriends()" class="nav-btn p-3 text-center hover:bg-gray-100 transition-colors rounded-t-lg">
                        <i class="fas fa-user-friends text-xl mb-1" style="color: #f59e0b;"></i>
                        <p class="text-xs font-medium">Friends</p>
                    </button>
                </div>
            </div>
        </nav>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Initialize TON Connect
        let tonConnectUI;
        let isWalletConnected = false;

        // Initialize Telegram Web App
        let telegramUser = null;
        let userData = {
            userId: null,
            balance: 0,
            level: 'Bronze',
            quizCompleted: 0,
            friendsInvited: 0,
            completedTasks: [],
            referrals: [],
            farming: false,
            farmingEndTime: null,
            tonWallet: null,
            quizAttempts: {}
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadTasksFromFirebase();
            loadBlogPostsFromFirebase();
            loadLeaderboardFromFirebase();
        });

        function initializeApp() {
            // Initialize Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                telegramUser = tg.initDataUnsafe?.user;
                
                if (telegramUser) {
                    userData.userId = telegramUser.id;
                    document.getElementById('userName').textContent = telegramUser.first_name + ' ' + (telegramUser.last_name || '');
                    document.getElementById('profileName').textContent = telegramUser.first_name + ' ' + (telegramUser.last_name || '');
                    document.getElementById('userPhoto').src = telegramUser.photo_url || `https://picsum.photos/seed/${telegramUser.id}/60/60`;
                    document.getElementById('profilePhoto').src = telegramUser.photo_url || `https://picsum.photos/seed/${telegramUser.id}/120/120`;
                    
                    // Generate referral link
                    document.getElementById('referralLink').textContent = `http://t.me/TrimintBot/open?startapp=${telegramUser.id}`;
                    
                    // Check for referral
                    checkReferral();
                    
                    // Load user data from Firebase
                    loadUserData();
                }
                
                tg.ready();
                tg.expand();
            }

            // Initialize TON Connect
            tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                manifestUrl: 'https://trimint.vercel.app/tonconnect-manifest.json',
                buttonRootId: null
            });

            tonConnectUI.onStatusChange(wallet => {
                if (wallet) {
                    isWalletConnected = true;
                    userData.tonWallet = wallet.account.address;
                    updateTonWalletUI();
                    updateUserData();
                } else {
                    isWalletConnected = false;
                    userData.tonWallet = null;
                    document.getElementById('tonConnectBtn').innerHTML = '<i class="fas fa-wallet mr-2"></i>Connect TON Wallet';
                    document.getElementById('tonWalletSection').classList.add('hidden');
                }
            });
        }

        function loadUserData() {
            if (!userData.userId) return;
            
            db.collection('users').doc(userData.userId.toString()).get()
                .then(doc => {
                    if (doc.exists) {
                        userData = { ...userData, ...doc.data() };
                        updateUI();
                        updateUserLevel();
                        
                        // Check if farming is active
                        if (userData.farming && userData.farmingEndTime) {
                            startFarmingCountdown();
                        }
                    } else {
                        // Create new user document
                        saveUserData();
                    }
                    
                    // Hide loading screen
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                    document.getElementById('loadingScreen').style.display = 'none';
                });
        }

        function saveUserData() {
            if (!userData.userId) return;
            
            db.collection('users').doc(userData.userId.toString()).set(userData)
                .then(() => {
                    console.log('User data saved');
                    updateLeaderboardForUser();
                })
                .catch(error => {
                    console.error('Error saving user data:', error);
                });
        }

        function updateUserData() {
            saveUserData();
            updateUI();
            updateUserLevel();
        }

        function updateUserLevel() {
            let newLevel = 'Bronze';
            
            if (userData.balance > 50000) {
                newLevel = 'Diamond';
            } else if (userData.balance > 10000) {
                newLevel = 'Gold';
            }
            
            userData.level = newLevel;
            
            // Update level badges
            const levelElements = ['userLevel', 'profileLevel', 'userRankLevel'];
            levelElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.className = `level-badge level-${newLevel.toLowerCase()}`;
                    element.textContent = newLevel;
                }
            });
        }

        function updateUI() {
            document.getElementById('balanceAmount').textContent = userData.balance.toLocaleString();
            document.getElementById('profileBalance').textContent = userData.balance.toLocaleString() + ' TRM';
            document.getElementById('quizCompleted').textContent = userData.quizCompleted;
            document.getElementById('friendsInvited').textContent = userData.friendsInvited;
            document.getElementById('totalReferrals').textContent = userData.friendsInvited;
            document.getElementById('referralEarnings').textContent = (userData.friendsInvited * 5000).toLocaleString() + ' TRM';
            
            loadReferrals();
        }

        function updateTonWalletUI() {
            if (isWalletConnected && userData.tonWallet) {
                document.getElementById('tonConnectBtn').innerHTML = '<i class="fas fa-wallet mr-2"></i>Connected';
                document.getElementById('tonWalletSection').classList.remove('hidden');
                document.getElementById('tonWalletAddress').textContent = userData.tonWallet;
            }
        }

        function copyWalletAddress() {
            if (userData.tonWallet) {
                navigator.clipboard.writeText(userData.tonWallet).then(() => {
                    alert('Wallet address copied!');
                });
            }
        }

        function disconnectTonWallet() {
            if (tonConnectUI) {
                tonConnectUI.disconnect();
            }
        }

        // Farming Functions
        let farmingInterval = null;
        let tokenAnimationInterval = null;

        function toggleFarming() {
            if (userData.farming) {
                stopFarming();
            } else {
                startFarming();
            }
        }

        function startFarming() {
            userData.farming = true;
            userData.farmingEndTime = Date.now() + (12 * 60 * 60 * 1000); // 12 hours from now
            updateUserData();
            
            document.getElementById('farmButton').innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Farming';
            document.getElementById('farmingStatus').classList.remove('hidden');
            document.getElementById('coinCircle').classList.add('farming');
            
            startFarmingCountdown();
            startTokenAnimation();
        }

        function stopFarming() {
            userData.farming = false;
            userData.farmingEndTime = null;
            updateUserData();
            
            document.getElementById('farmButton').innerHTML = '<i class="fas fa-seedling mr-2"></i>Start Farming';
            document.getElementById('farmingStatus').classList.add('hidden');
            document.getElementById('coinCircle').classList.remove('farming');
            
            if (farmingInterval) {
                clearInterval(farmingInterval);
            }
            if (tokenAnimationInterval) {
                clearInterval(tokenAnimationInterval);
            }
        }

        function startFarmingCountdown() {
            if (farmingInterval) {
                clearInterval(farmingInterval);
            }
            
            farmingInterval = setInterval(() => {
                if (userData.farming && userData.farmingEndTime) {
                    const now = Date.now();
                    const remaining = userData.farmingEndTime - now;
                    
                    if (remaining <= 0) {
                        stopFarming();
                        return;
                    }
                    
                    const hours = Math.floor(remaining / (1000 * 60 * 60));
                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                    
                    document.getElementById('farmingTime').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Add tokens every second and save to database
                    userData.balance += 0.001;
                    saveUserData();
                    updateUI();
                }
            }, 1000);
        }

        function startTokenAnimation() {
            if (tokenAnimationInterval) {
                clearInterval(tokenAnimationInterval);
            }
            
            tokenAnimationInterval = setInterval(() => {
                createTokenAnimation();
            }, 1000);
        }

        function createTokenAnimation() {
            const coinContainer = document.querySelector('.coin-container');
            const animation = document.createElement('div');
            animation.className = 'token-animation';
            animation.textContent = '+0.001 TRM';
            animation.style.left = Math.random() * 100 + 'px';
            animation.style.top = '50%';
            
            coinContainer.appendChild(animation);
            
            setTimeout(() => {
                animation.remove();
            }, 2500);
        }

        // TON Connect Functions
        function toggleTonConnect() {
            if (isWalletConnected) {
                tonConnectUI.disconnect();
            } else {
                tonConnectUI.connectWallet();
            }
        }

        // Navigation Functions
        function showHome() {
            hideAllSections();
            document.getElementById('homeSection').classList.remove('section-hidden');
        }

        function showProfile() {
            hideAllSections();
            document.getElementById('profileSection').classList.remove('section-hidden');
        }

        function showQuiz() {
            hideAllSections();
            document.getElementById('quizSection').classList.remove('section-hidden');
            loadQuiz();
        }

        function showBlog() {
            hideAllSections();
            document.getElementById('blogSection').classList.remove('section-hidden');
        }

        function showTasks() {
            hideAllSections();
            document.getElementById('tasksSection').classList.remove('section-hidden');
        }

        function showFriends() {
            hideAllSections();
            document.getElementById('friendsSection').classList.remove('section-hidden');
        }

        function showLeaderboard() {
            hideAllSections();
            document.getElementById('leaderboardSection').classList.remove('section-hidden');
        }

        function hideAllSections() {
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('section-hidden');
            });
        }

        // Quiz Functions
        const quizQuestions = [
            {
                question: "What is TON?",
                options: ["The Open Network", "Telegram Only Network", "Token Operating Network", "Trust On Network"],
                correct: 0,
                reward: 1500
            },
            {
                question: "Who created TON?",
                options: ["Vitalik Buterin", "Pavel Durov", "Satoshi Nakamoto", "Charles Hoskinson"],
                correct: 1,
                reward: 1500
            },
            {
                question: "What is the native token of TON?",
                options: ["ETH", "TON", "BTC", "TRM"],
                correct: 1,
                reward: 1500
            },
            {
                question: "What is TON's consensus mechanism?",
                options: ["Proof of Work", "Proof of Stake", "Delegated Proof of Stake", "Proof of Authority"],
                correct: 2,
                reward: 1500
            },
            {
                question: "What is Telegram's role in TON?",
                options: ["Full control", "No involvement", "Initial creator, now independent", "Mining operator"],
                correct: 2,
                reward: 1500
            },
            {
                question: "What is TON's maximum TPS?",
                options: ["1000", "5000", "10000", "1 million"],
                correct: 4,
                reward: 1500
            },
            {
                question: "What is sharding in TON?",
                options: ["Splitting network", "Data partitioning", "Mining process", "Token distribution"],
                correct: 1,
                reward: 1500
            },
            {
                question: "What is TON's smart contract language?",
                options: ["Solidity", "Rust", "FunC", "JavaScript"],
                correct: 2,
                reward: 1500
            },
            {
                question: "What is TON's goal?",
                options: ["Digital payments", "Web3 infrastructure", "Social media", "Gaming platform"],
                correct: 1,
                reward: 1500
            },
            {
                question: "What is the TON Foundation?",
                options: ["Development team", "Regulatory body", "Marketing agency", "Exchange platform"],
                correct: 0,
                reward: 1500
            }
        ];

        let currentQuizIndex = 0;
        let currentQuizQuestions = [];

        function loadQuiz() {
            // Shuffle and select 10 questions
            currentQuizQuestions = [...quizQuestions].sort(() => Math.random() - 0.5).slice(0, 10);
            currentQuizIndex = 0;
            
            const container = document.getElementById('quizContainer');
            container.innerHTML = '';
            document.getElementById('quizResult').classList.add('hidden');
            
            loadCurrentQuestion();
        }

        function loadCurrentQuestion() {
            const container = document.getElementById('quizContainer');
            container.innerHTML = '';
            
            const quiz = currentQuizQuestions[currentQuizIndex];
            const quizCard = document.createElement('div');
            quizCard.className = 'quiz-card rounded-2xl p-6 text-white';
            quizCard.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Question ${currentQuizIndex + 1}/10</h3>
                    <div class="text-sm">
                        Attempts: <span id="attemptsLeft">${3 - (userData.quizAttempts[quiz.id] || 0)}</span>/3
                    </div>
                </div>
                <h3 class="text-lg mb-4">${quiz.question}</h3>
                <div class="space-y-3">
                    ${quiz.options.map((option, index) => `
                        <button onclick="answerQuiz(${index})" class="w-full bg-white/20 p-4 rounded-xl text-left hover:bg-white/30 transition-all">
                            ${option}
                        </button>
                    `).join('')}
                </div>
            `;
            container.appendChild(quizCard);
        }

        function answerQuiz(answerIndex) {
            const quiz = currentQuizQuestions[currentQuizIndex];
            const attempts = userData.quizAttempts[quiz.id] || 0;
            
            if (answerIndex === quiz.correct) {
                userData.balance += quiz.reward;
                userData.quizCompleted++;
                
                // Clear attempts for this quiz
                delete userData.quizAttempts[quiz.id];
                updateUserData();
                
                currentQuizIndex++;
                
                if (currentQuizIndex >= currentQuizQuestions.length) {
                    // Quiz completed
                    document.getElementById('quizContainer').classList.add('hidden');
                    document.getElementById('quizResult').classList.remove('hidden');
                    document.getElementById('quizReward').textContent = quizQuestions.length * quiz.reward;
                } else {
                    loadCurrentQuestion();
                }
            } else {
                attempts++;
                userData.quizAttempts[quiz.id] = attempts;
                
                if (attempts >= 3) {
                    // Failed after 3 attempts
                    userData.balance = Math.max(0, userData.balance - 500);
                    updateUserData();
                    alert(`Failed after 3 attempts! 500 TRM deducted. The correct answer was: ${quiz.options[quiz.correct]}`);
                    
                    currentQuizIndex++;
                    if (currentQuizIndex >= currentQuizQuestions.length) {
                        document.getElementById('quizContainer').classList.add('hidden');
                        document.getElementById('quizResult').classList.add('hidden');
                        loadQuiz();
                    } else {
                        loadCurrentQuestion();
                    }
                } else {
                    alert(`Wrong answer! ${3 - attempts} attempts remaining.`);
                    loadCurrentQuestion();
                }
            }
        }

        function nextQuiz() {
            loadQuiz();
        }

        // Blog Functions
        function loadBlogPostsFromFirebase() {
            db.collection('blogPosts').orderBy('timestamp', 'desc').get()
                .then(snapshot => {
                    const posts = [];
                    snapshot.forEach(doc => {
                        posts.push({ id: doc.id, ...doc.data() });
                    });
                    displayBlogPosts(posts);
                })
                .catch(error => {
                    console.error('Error loading blog posts:', error);
                    // Fallback to sample posts
                    loadSampleBlogPosts();
                });
        }

        function loadSampleBlogPosts() {
            const samplePosts = [
                {
                    id: 1,
                    author: "John Doe",
                    content: "TON is the future of blockchain! Amazing technology and great community.",
                    likes: 15,
                    comments: 3,
                    timestamp: new Date().toISOString()
                },
                {
                    id: 2,
                    author: "Jane Smith",
                    content: "Just completed my first quiz and earned 1500 TRM! This app is awesome!",
                    likes: 23,
                    comments: 7,
                    timestamp: new Date().toISOString()
                }
            ];
            displayBlogPosts(samplePosts);
        }

        function displayBlogPosts(posts) {
            const container = document.getElementById('blogContainer');
            container.innerHTML = '';
            
            posts.forEach(post => {
                const postCard = document.createElement('div');
                postCard.className = 'blog-post rounded-2xl p-6';
                postCard.innerHTML = `
                    <div class="flex items-start space-x-3 mb-4">
                        <img src="https://picsum.photos/seed/${post.author}/40/40" alt="${post.author}" class="w-10 h-10 rounded-full">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${post.author}</h4>
                            <p class="text-gray-500 text-sm">${new Date(post.timestamp).toLocaleDateString()}</p>
                        </div>
                        ${post.author === telegramUser?.first_name ? `
                            <button onclick="deleteBlogPost('${post.id}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                    <p class="text-gray-700 mb-4">${post.content}</p>
                    <div class="flex items-center space-x-4">
                        <button onclick="likeBlogPost('${post.id}')" class="flex items-center space-x-1 text-gray-600 hover:text-red-500">
                            <i class="fas fa-heart"></i>
                            <span>${post.likes || 0}</span>
                        </button>
                        <button onclick="commentOnPost('${post.id}')" class="flex items-center space-x-1 text-gray-600 hover:text-blue-500">
                            <i class="fas fa-comment"></i>
                            <span>${post.comments || 0}</span>
                        </button>
                    </div>
                `;
                container.appendChild(postCard);
            });
        }

        function createBlogPost() {
            const content = prompt('Write your forum post:');
            if (content && telegramUser) {
                const newPost = {
                    author: telegramUser.first_name,
                    content: content,
                    likes: 0,
                    comments: 0,
                    timestamp: new Date().toISOString(),
                    userId: telegramUser.id
                };
                
                db.collection('blogPosts').add(newPost)
                    .then(() => {
                        alert('Forum post created successfully!');
                        loadBlogPostsFromFirebase();
                    })
                    .catch(error => {
                        console.error('Error creating blog post:', error);
                        alert('Error creating post. Please try again.');
                    });
            }
        }

        function deleteBlogPost(postId) {
            if (confirm('Are you sure you want to delete this post?')) {
                db.collection('blogPosts').doc(postId).delete()
                    .then(() => {
                        alert('Post deleted successfully!');
                        loadBlogPostsFromFirebase();
                    })
                    .catch(error => {
                        console.error('Error deleting post:', error);
                        alert('Error deleting post. Please try again.');
                    });
            }
        }

        function likeBlogPost(postId) {
            db.collection('blogPosts').doc(postId).update({
                likes: firebase.firestore.FieldValue.increment(1)
            })
            .then(() => {
                loadBlogPostsFromFirebase();
            })
            .catch(error => {
                console.error('Error liking post:', error);
            });
        }

        function commentOnPost(postId) {
            const comment = prompt('Write your comment:');
            if (comment) {
                db.collection('blogPosts').doc(postId).update({
                    comments: firebase.firestore.FieldValue.increment(1)
                })
                .then(() => {
                    alert('Comment added successfully!');
                    loadBlogPostsFromFirebase();
                })
                .catch(error => {
                    console.error('Error commenting on post:', error);
                });
            }
        }

        // Tasks Functions
        function loadTasksFromFirebase() {
            db.collection('tasks').orderBy('order').get()
                .then(snapshot => {
                    const tasks = [];
                    snapshot.forEach(doc => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });
                    displayTasks(tasks);
                })
                .catch(error => {
                    console.error('Error loading tasks:', error);
                    // Fallback to sample tasks
                    loadSampleTasks();
                });
        }

        function loadSampleTasks() {
            const sampleTasks = [
                {
                    id: 1,
                    name: "Join TON Community",
                    description: "Join our official TON community group",
                    reward: 1000,
                    link: "https://t.me/toncoin",
                    completed: false
                },
                {
                    id: 2,
                    name: "Follow us on X",
                    description: "Follow our official X account",
                    reward: 500,
                    link: "https://twitter.com/ton_blockchain",
                    completed: false
                }
            ];
            displayTasks(sampleTasks);
        }

        function displayTasks(tasks) {
            const container = document.getElementById('tasksContainer');
            container.innerHTML = '';
            
            tasks.forEach(task => {
                const isCompleted = userData.completedTasks.includes(task.id);
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card rounded-2xl p-4';
                taskCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <img src="${task.photo || 'https://picsum.photos/seed/task' + task.id + '/50/50'}" alt="${task.name}" class="w-12 h-12 rounded-xl">
                            <div>
                                <h3 class="text-white font-bold">${task.name}</h3>
                                <p class="text-white/70 text-sm">${task.description}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-yellow-400 font-bold">${task.reward} TRM</p>
                            <button id="taskBtn${task.id}" onclick="completeTask('${task.id}', '${task.link}', ${task.reward})" class="bg-white/20 text-white px-4 py-2 rounded-full text-sm mt-1">
                                ${isCompleted ? 'Completed' : 'Open'}
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(taskCard);
            });
        }

        function completeTask(taskId, link, reward) {
            const button = document.getElementById(`taskBtn${taskId}`);
            const isCompleted = userData.completedTasks.includes(taskId);
            
            if (isCompleted) {
                window.open(link, '_blank');
                return;
            }
            
            window.open(link, '_blank');
            button.textContent = 'Processing...';
            button.disabled = true;
            
            setTimeout(() => {
                userData.balance += reward;
                userData.completedTasks.push(taskId);
                updateUserData();
                button.textContent = 'Completed';
                button.disabled = false;
            }, 10000);
        }

        function watchAd() {
            // Show ads using Monetag
            if (window.libtl) {
                window.libtl.showAd();
            }
            
            // Add 1 TRM after watching ad
            setTimeout(() => {
                userData.balance += 1;
                updateUserData();
                alert('You earned 1 TRM!');
            }, 5000);
        }

        // Friends Functions
        function copyReferralLink() {
            const link = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                alert('Referral link copied to clipboard!');
            });
        }

        function loadReferrals() {
            if (!userData.referrals || userData.referrals.length === 0) {
                document.getElementById('referralsList').innerHTML = '<p class="text-white/70 text-center">No referrals yet</p>';
                return;
            }
            
            const referralsList = document.getElementById('referralsList');
            referralsList.innerHTML = '';
            
            userData.referrals.forEach(referralId => {
                db.collection('users').doc(referralId.toString()).get()
                    .then(doc => {
                        if (doc.exists) {
                            const referralData = doc.data();
                            const referralCard = document.createElement('div');
                            referralCard.className = 'leaderboard-item rounded-xl p-3';
                            referralCard.innerHTML = `
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <img src="https://picsum.photos/seed/${referralId}/40/40" alt="User" class="w-10 h-10 rounded-full">
                                        <div>
                                            <p class="text-white font-semibold">${referralData.userName || 'User'}</p>
                                            <p class="text-white/70 text-sm">ID: ${referralId}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-yellow-400 font-bold">${referralData.balance?.toLocaleString() || 0} TRM</p>
                                        <p class="text-white/70 text-xs">Earned: 5000 TRM</p>
                                    </div>
                                </div>
                            `;
                            referralsList.appendChild(referralCard);
                        }
                    });
            });
        }

        function checkReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const referrerId = urlParams.get('startapp');
            
            if (referrerId && userData.userId && userData.userId.toString() !== referrerId) {
                // Show referral message on loading screen
                document.getElementById('referralMessage').classList.remove('hidden');
                document.getElementById('referralMessage').textContent = `Referred by User ${referrerId}`;
                
                // Process referral after data is loaded
                setTimeout(() => {
                    processReferral(referrerId);
                }, 2000);
            }
        }

        function processReferral(referrerId) {
            // Check if this user was already referred
            db.collection('users').doc(userData.userId.toString()).get()
                .then(doc => {
                    if (!doc.exists || !doc.data().referredBy) {
                        // Add referral bonus to new user
                        userData.balance += 5000;
                        userData.referredBy = referrerId;
                        updateUserData();
                        
                        // Update referrer's data
                        db.collection('users').doc(referrerId).get()
                            .then(referrerDoc => {
                                if (referrerDoc.exists) {
                                    const referrerData = referrerDoc.data();
                                    const referrals = referrerData.referrals || [];
                                    referrals.push(userData.userId);
                                    
                                    db.collection('users').doc(referrerId).update({
                                        referrals: referrals,
                                        friendsInvited: referrals.length,
                                        balance: referrerData.balance + 5000
                                    });
                                }
                            });
                        
                        alert('Welcome bonus! You received 5000 TRM from referral!');
                    }
                });
        }

        // Leaderboard Functions
        function loadLeaderboardFromFirebase() {
            db.collection('users').orderBy('balance', 'desc').limit(25).get()
                .then(snapshot => {
                    const leaderboard = [];
                    let rank = 1;
                    
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        leaderboard.push({
                            rank: rank++,
                            userId: doc.id,
                            name: userData.userName || `User ${doc.id}`,
                            balance: userData.balance || 0,
                            level: userData.level || 'Bronze',
                            photo: userData.photoUrl || doc.id
                        });
                    });
                    
                    displayLeaderboard(leaderboard);
                })
                .catch(error => {
                    console.error('Error loading leaderboard:', error);
                    loadSampleLeaderboard();
                });
        }

        function loadSampleLeaderboard() {
            const sampleLeaderboard = [
                { rank: 1, name: "Alice", balance: 50000, level: "Diamond", photo: "alice" },
                { rank: 2, name: "Bob", balance: 45000, level: "Gold", photo: "bob" },
                { rank: 3, name: "Charlie", balance: 40000, level: "Gold", photo: "charlie" }
            ];
            displayLeaderboard(sampleLeaderboard);
        }

        function displayLeaderboard(leaderboard) {
            const container = document.getElementById('leaderboardList');
            container.innerHTML = '';
            
            leaderboard.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'leaderboard-item rounded-xl p-3';
                userCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-yellow-400 font-bold">#${user.rank}</span>
                            <img src="https://picsum.photos/seed/${user.photo}/40/40" alt="${user.name}" class="w-10 h-10 rounded-full">
                            <div>
                                <p class="text-white font-semibold">${user.name}</p>
                                <p class="text-white/70 text-sm">Level ${user.level}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-yellow-400 font-bold">${user.balance.toLocaleString()} TRM</p>
                        </div>
                    </div>
                `;
                container.appendChild(userCard);
            });
        }

        function updateLeaderboardForUser() {
            // Real-time update of leaderboard when user data changes
            loadLeaderboardFromFirebase();
        }
    </script>
</body>
</html>
