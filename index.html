<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trimint - TRM Token Farming</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Monetag Ads -->
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #13f1fc 0%, #0470dc 100%);
            --gold-gradient: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            --diamond-gradient: linear-gradient(135deg, #b9f2ff 0%, #00d4ff 100%);
            --bg-light: #f8f9fa;
            --bg-dark: #1a1a2e;
            --text-light: #333;
            --text-dark: #fff;
            --card-light: #fff;
            --card-dark: #16213e;
            --border-light: #e0e0e0;
            --border-dark: #2d3561;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
            transition: background 0.3s ease;
        }

        body.dark-mode {
            background: var(--bg-dark);
        }

        body.dark-mode {
            --bg-light: var(--bg-dark);
            --bg-dark: #0f0f1e;
            --text-light: var(--text-dark);
            --text-dark: #fff;
            --card-light: var(--card-dark);
            --card-dark: #0a0a1f;
            --border-light: var(--border-dark);
            --border-dark: #1e2749;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .coin-loader {
            width: 100px;
            height: 100px;
            background: url('https://i.postimg.cc/fTQktNmX/maincoin.png') center/contain no-repeat;
            animation: pulse 1.5s infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        .referral-info {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .balance-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .coin-icon {
            width: 24px;
            height: 24px;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            padding-bottom: 100px;
            min-height: calc(100vh - 120px);
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        /* Home Page */
        .home-container {
            text-align: center;
            padding: 20px 0;
        }

        .coin-container {
            margin: 30px 0;
            position: relative;
        }

        .main-coin {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            background: url('https://i.postimg.cc/fTQktNmX/maincoin.png') center/contain no-repeat;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .main-coin:hover {
            transform: scale(1.1);
        }

        .main-coin.farming {
            animation: rotate 3s linear infinite, pulse 1.5s infinite;
        }

        .farming-timer {
            margin: 20px 0;
            font-size: 18px;
            font-weight: 600;
            color: #FFD700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .token-animation {
            position: absolute;
            color: #FFD700;
            font-weight: bold;
            font-size: 14px;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
        }

        .start-farming-btn {
            background: var(--success-gradient);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .start-farming-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .start-farming-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Tasks Page */
        .tasks-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .task-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .task-reward {
            color: #FFD700;
            font-size: 14px;
            font-weight: 500;
        }

        .task-btn {
            background: var(--secondary-gradient);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .task-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .task-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Leaderboard */
        .leaderboard-list {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.3s ease;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .leaderboard-rank {
            width: 30px;
            font-weight: 600;
            font-size: 16px;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 15px;
            object-fit: cover;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .leaderboard-balance {
            color: #FFD700;
            font-size: 14px;
        }

        .leaderboard-level {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .level-bronze {
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
        }

        .level-gold {
            background: var(--gold-gradient);
        }

        .level-diamond {
            background: var(--diamond-gradient);
        }

        /* Friends Page */
        .referral-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .referral-link {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }

        .copy-btn {
            background: var(--success-gradient);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            transform: scale(1.05);
        }

        .referral-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .referrals-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .referral-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .referral-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .referral-details {
            flex: 1;
        }

        .referral-name {
            font-weight: 600;
            font-size: 14px;
        }

        .referral-earned {
            color: #FFD700;
            font-size: 12px;
        }

        /* Profile Page */
        .profile-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .profile-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .profile-level {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .profile-stat {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .profile-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
        }

        .profile-stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .wallet-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .wallet-address {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
            display: none;
        }

        .wallet-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .wallet-btn {
            flex: 1;
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wallet-btn:hover {
            transform: scale(1.02);
        }

        .wallet-btn.disconnect {
            background: var(--secondary-gradient);
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 14px;
            font-weight: 500;
        }

        .setting-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            padding: 5px 15px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(20px);
            padding: 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px;
            margin: 0 5px;
        }

        .nav-item.home {
            transform: scale(1.1);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-icon {
            width: 30px;
            height: 30px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .nav-item.home .nav-icon {
            width: 40px;
            height: 40px;
            font-size: 25px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes floatUp {
            0% { 
                opacity: 1; 
                transform: translateY(0); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-50px); 
            }
        }

        /* Responsive Design */
        @media (max-width: 380px) {
            .main-content {
                padding: 15px;
            }
            
            .profile-stats {
                grid-template-columns: 1fr;
            }
            
            .nav-label {
                font-size: 10px;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="coin-loader"></div>
        <div class="loading-text">Loading Trimint...</div>
        <div class="referral-info" id="referralInfo" style="display: none;">
            <div>Welcome! Referred by: <strong id="referralName"></strong></div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="balance-display">
            <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" class="coin-icon" alt="TRM">
            <span id="userBalance">0 TRM</span>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Home Page -->
        <div class="page active" id="homePage">
            <div class="home-container">
                <h2 style="margin-bottom: 20px;">TRM Token Farming</h2>
                <div class="coin-container" id="coinContainer">
                    <div class="main-coin" id="mainCoin"></div>
                </div>
                <div class="farming-timer" id="farmingTimer" style="display: none;">
                    Farming ends in: <span id="timeLeft">12:00:00</span>
                </div>
                <button class="start-farming-btn" id="startFarmingBtn" onclick="toggleFarming()">
                    Start Farming
                </button>
                <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 15px;">
                    <h3 style="margin-bottom: 15px;">How it works</h3>
                    <p style="line-height: 1.6; opacity: 0.9;">
                        ‚Ä¢ Start farming to earn 0.001 TRM per second<br>
                        ‚Ä¢ Farming runs for 12 hours automatically<br>
                        ‚Ä¢ Complete tasks for bonus tokens<br>
                        ‚Ä¢ Invite friends to earn 5000 TRM each<br>
                        ‚Ä¢ Connect TON wallet for withdrawals
                    </p>
                </div>
            </div>
        </div>

        <!-- Tasks Page -->
        <div class="page" id="tasksPage">
            <div class="tasks-header">
                <h2>Complete Tasks</h2>
                <p style="opacity: 0.8; margin-top: 5px;">Earn extra TRM tokens</p>
            </div>
            <div class="task-card">
                <img src="https://via.placeholder.com/50/667eea/ffffff?text=AD" class="task-icon" alt="Watch Ads">
                <div class="task-info">
                    <div class="task-name">Watch Ads</div>
                    <div class="task-reward">+1 TRM</div>
                </div>
                <button class="task-btn" onclick="watchAd()">OPEN</button>
            </div>
            <div id="tasksList"></div>
        </div>

        <!-- Leaderboard Page -->
        <div class="page" id="leaderboardPage">
            <h2 style="text-align: center; margin-bottom: 20px;">Top Miners</h2>
            <div class="leaderboard-list" id="leaderboardList">
                <!-- Leaderboard items will be loaded here -->
            </div>
        </div>

        <!-- Friends Page -->
        <div class="page" id="friendsPage">
            <div class="referral-card">
                <h3 style="margin-bottom: 15px;">Invite Friends</h3>
                <p style="opacity: 0.8; margin-bottom: 15px;">Earn 5000 TRM for each friend!</p>
                <div class="referral-link" id="referralLink"></div>
                <button class="copy-btn" onclick="copyReferralLink()">Copy Link</button>
                <div class="referral-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="referralEarnings">0</div>
                        <div class="stat-label">TRM Earned</div>
                    </div>
                </div>
            </div>
            <h3 style="margin-bottom: 15px;">Your Referrals</h3>
            <div class="referrals-list" id="referralsList">
                <!-- Referrals will be loaded here -->
            </div>
        </div>

        <!-- Profile Page -->
        <div class="page" id="profilePage">
            <div class="profile-header">
                <img class="profile-avatar" id="profileAvatar" alt="Profile">
                <div class="profile-name" id="profileName">Loading...</div>
                <div class="profile-level level-bronze" id="profileLevel">Bronze</div>
            </div>

            <div class="profile-stats">
                <div class="profile-stat">
                    <div class="profile-stat-value" id="statBalance">0</div>
                    <div class="profile-stat-label">TRM Balance</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="statFriends">0</div>
                    <div class="profile-stat-label">Friends</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="statTasks">0</div>
                    <div class="profile-stat-label">Tasks Done</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="statFarmTime">0h</div>
                    <div class="profile-stat-label">Farm Time</div>
                </div>
            </div>

            <div class="wallet-section">
                <h3 style="margin-bottom: 15px;">TON Wallet</h3>
                <button class="wallet-btn" id="walletBtn" onclick="connectWallet()">
                    Connect TON Wallet
                </button>
                <div class="wallet-address" id="walletAddress"></div>
                <div class="wallet-buttons" id="walletButtons" style="display: none;">
                    <button class="wallet-btn" onclick="copyWalletAddress()">Copy</button>
                    <button class="wallet-btn disconnect" onclick="disconnectWallet()">Disconnect</button>
                </div>
            </div>

            <div class="settings-section">
                <h3 style="margin-bottom: 15px;">Settings</h3>
                <div class="setting-item">
                    <span class="setting-label">Notifications</span>
                    <button class="setting-toggle">ON</button>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Sound Effects</span>
                    <button class="setting-toggle">ON</button>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Auto Farming</span>
                    <button class="setting-toggle">OFF</button>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Language</span>
                    <button class="setting-toggle">English</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-container">
            <div class="nav-item home active" onclick="switchPage('home')">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">Home</div>
            </div>
            <div class="nav-item" onclick="switchPage('tasks')">
                <div class="nav-icon">üìã</div>
                <div class="nav-label">Tasks</div>
            </div>
            <div class="nav-item" onclick="switchPage('leaderboard')">
                <div class="nav-icon">üèÜ</div>
                <div class="nav-label">Leaderboard</div>
            </div>
            <div class="nav-item" onclick="switchPage('friends')">
                <div class="nav-icon">üë•</div>
                <div class="nav-label">Friends</div>
            </div>
            <div class="nav-item" onclick="switchPage('profile')">
                <div class="nav-icon">üë§</div>
                <div class="nav-label">Profile</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global variables
        let userData = null;
        let farmingInterval = null;
        let farmingEndTime = null;
        let isFarming = false;
        let connectedWallet = null;

        // Telegram Bot API
        const telegram = window.Telegram.WebApp;
        telegram.ready();
        telegram.expand();

        // Initialize app
        window.addEventListener('load', async () => {
            await initializeApp();
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 2000);
        });

        async function initializeApp() {
            // Get Telegram user data
            if (telegram.initDataUnsafe.user) {
                const telegramUser = telegram.initDataUnsafe.user;
                
                // Check for referral
                const urlParams = new URLSearchParams(window.location.search);
                const referrerId = urlParams.get('startapp');
                
                // Initialize or get user data
                userData = await getUserData(telegramUser.id);
                
                if (!userData) {
                    userData = {
                        telegramId: telegramUser.id,
                        username: telegramUser.username || telegramUser.first_name,
                        firstName: telegramUser.first_name,
                        lastName: telegramUser.last_name,
                        photoUrl: telegramUser.photo_url,
                        balance: 0,
                        level: 'Bronze',
                        totalFriends: 0,
                        tasksCompleted: 0,
                        totalFarmTime: 0,
                        referrals: [],
                        completedTasks: [],
                        walletAddress: null,
                        createdAt: Date.now(),
                        lastActive: Date.now()
                    };
                    
                    // Handle referral
                    if (referrerId && referrerId !== telegramUser.id.toString()) {
                        await handleReferral(telegramUser.id, referrerId);
                        
                        // Show referral info on loading screen
                        const referrerData = await getUserData(parseInt(referrerId));
                        if (referrerData) {
                            document.getElementById('referralName').textContent = referrerData.username || referrerData.firstName;
                            document.getElementById('referralInfo').style.display = 'block';
                        }
                    }
                    
                    await saveUserData(userData);
                } else {
                    // Update last active
                    userData.lastActive = Date.now();
                    await saveUserData(userData);
                }
                
                // Update UI with user data
                updateUI();
                loadTasks();
                loadLeaderboard();
                loadReferrals();
            }
        }

        async function getUserData(telegramId) {
            try {
                const snapshot = await database.ref('users/' + telegramId).once('value');
                return snapshot.val();
            } catch (error) {
                console.error('Error getting user data:', error);
                return null;
            }
        }

        async function saveUserData(data) {
            try {
                await database.ref('users/' + data.telegramId).set(data);
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        async function handleReferral(newUserId, referrerId) {
            try {
                const referrerData = await getUserData(parseInt(referrerId));
                if (referrerData) {
                    // Add referral to referrer
                    if (!referrerData.referrals) {
                        referrerData.referrals = [];
                    }
                    referrerData.referrals.push(newUserId);
                    referrerData.totalFriends = (referrerData.totalFriends || 0) + 1;
                    referrerData.balance += 5000;
                    
                    await saveUserData(referrerData);
                    
                    // Add referral record
                    await database.ref('referrals/' + referrerId + '/' + newUserId).set({
                        telegramId: newUserId,
                        referredAt: Date.now(),
                        reward: 5000
                    });
                }
            } catch (error) {
                console.error('Error handling referral:', error);
            }
        }

        function updateUI() {
            if (!userData) return;
            
            // Update balance
            document.getElementById('userBalance').textContent = formatBalance(userData.balance);
            document.getElementById('statBalance').textContent = formatBalance(userData.balance);
            
            // Update profile
            if (userData.photoUrl) {
                document.getElementById('profileAvatar').src = userData.photoUrl;
            }
            document.getElementById('profileName').textContent = userData.username || userData.firstName;
            
            // Update level
            const level = calculateLevel(userData.balance);
            document.getElementById('profileLevel').textContent = level.name;
            document.getElementById('profileLevel').className = 'profile-level level-' + level.class;
            
            // Update stats
            document.getElementById('statFriends').textContent = userData.totalFriends || 0;
            document.getElementById('statTasks').textContent = userData.tasksCompleted || 0;
            document.getElementById('statFarmTime').textContent = Math.floor((userData.totalFarmTime || 0) / 3600) + 'h';
            
            // Update referral link
            const referralLink = `https://t.me/TrimintBot/open?startapp=${userData.telegramId}`;
            document.getElementById('referralLink').textContent = referralLink;
            
            // Update wallet if connected
            if (userData.walletAddress) {
                updateWalletUI(userData.walletAddress);
            }
            
            // Check farming status
            if (userData.farmingEndTime && userData.farmingEndTime > Date.now()) {
                startFarmingFromSaved();
            }
        }

        function calculateLevel(balance) {
            if (balance < 10000) {
                return { name: 'Bronze', class: 'bronze' };
            } else if (balance < 50000) {
                return { name: 'Gold', class: 'gold' };
            } else {
                return { name: 'Diamond', class: 'diamond' };
            }
        }

        function formatBalance(balance) {
            return (balance || 0).toLocaleString() + ' TRM';
        }

        function switchPage(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            // Show selected page
            document.getElementById(page + 'Page').classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.nav-item.' + page).classList.add('active');
            
            // Load page-specific data
            if (page === 'leaderboard') {
                loadLeaderboard();
            } else if (page === 'friends') {
                loadReferrals();
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const themeBtn = document.querySelector('.theme-toggle');
            themeBtn.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
        }

        // Farming functions
        async function toggleFarming() {
            if (isFarming) {
                stopFarming();
            } else {
                startFarming();
            }
        }

        async function startFarming() {
            if (isFarming) return;
            
            isFarming = true;
            farmingEndTime = Date.now() + (12 * 60 * 60 * 1000); // 12 hours
            
            userData.farmingEndTime = farmingEndTime;
            await saveUserData(userData);
            
            document.getElementById('startFarmingBtn').textContent = 'Stop Farming';
            document.getElementById('farmingTimer').style.display = 'block';
            document.getElementById('mainCoin').classList.add('farming');
            
            updateFarmingTimer();
            farmingInterval = setInterval(updateFarmingTimer, 1000);
        }

        async function startFarmingFromSaved() {
            isFarming = true;
            farmingEndTime = userData.farmingEndTime;
            
            document.getElementById('startFarmingBtn').textContent = 'Stop Farming';
            document.getElementById('farmingTimer').style.display = 'block';
            document.getElementById('mainCoin').classList.add('farming');
            
            updateFarmingTimer();
            farmingInterval = setInterval(updateFarmingTimer, 1000);
        }

        function updateFarmingTimer() {
            const now = Date.now();
            const timeLeft = farmingEndTime - now;
            
            if (timeLeft <= 0) {
                stopFarming();
                return;
            }
            
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            document.getElementById('timeLeft').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Add 0.001 TRM every second
            userData.balance += 0.001;
            userData.totalFarmTime = (userData.totalFarmTime || 0) + 1;
            
            // Show token animation
            if (Math.random() < 0.1) { // Show animation 10% of the time
                showTokenAnimation();
            }
            
            // Update balance display
            document.getElementById('userBalance').textContent = formatBalance(userData.balance);
            document.getElementById('statBalance').textContent = formatBalance(userData.balance);
            
            // Save to database every 10 seconds
            if (seconds % 10 === 0) {
                saveUserData(userData);
            }
        }

        function showTokenAnimation() {
            const coin = document.getElementById('mainCoin');
            const animation = document.createElement('div');
            animation.className = 'token-animation';
            animation.textContent = '+0.001 TRM';
            animation.style.left = (Math.random() * 100 - 50) + 'px';
            animation.style.top = '0px';
            
            document.getElementById('coinContainer').appendChild(animation);
            
            setTimeout(() => {
                animation.remove();
            }, 2000);
        }

        async function stopFarming() {
            isFarming = false;
            clearInterval(farmingInterval);
            
            userData.farmingEndTime = null;
            await saveUserData(userData);
            
            document.getElementById('startFarmingBtn').textContent = 'Start Farming';
            document.getElementById('farmingTimer').style.display = 'none';
            document.getElementById('mainCoin').classList.remove('farming');
        }

        // Tasks functions
        async function loadTasks() {
            try {
                const snapshot = await database.ref('tasks').orderByChild('order').once('value');
                const tasks = snapshot.val();
                const tasksList = document.getElementById('tasksList');
                tasksList.innerHTML = '';
                
                if (tasks) {
                    Object.keys(tasks).forEach(key => {
                        const task = tasks[key];
                        const isCompleted = userData.completedTasks && userData.completedTasks.includes(key);
                        
                        const taskCard = document.createElement('div');
                        taskCard.className = 'task-card';
                        taskCard.innerHTML = `
                            <img src="${task.photoUrl || 'https://via.placeholder.com/50/667eea/ffffff?text=TASK'}" class="task-icon" alt="${task.name}">
                            <div class="task-info">
                                <div class="task-name">${task.name}</div>
                                <div class="task-reward">+${task.reward} TRM</div>
                            </div>
                            <button class="task-btn" ${isCompleted ? 'disabled' : ''} onclick="completeTask('${key}', '${task.link}', ${task.reward})">
                                ${isCompleted ? 'COMPLETED' : 'OPEN'}
                            </button>
                        `;
                        tasksList.appendChild(taskCard);
                    });
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        async function completeTask(taskId, link, reward) {
            const btn = event.target;
            btn.textContent = 'PROCESSING';
            btn.disabled = true;
            
            // Open the link
            window.open(link, '_blank');
            
            // Wait 10 seconds
            setTimeout(async () => {
                if (!userData.completedTasks) {
                    userData.completedTasks = [];
                }
                userData.completedTasks.push(taskId);
                userData.balance += reward;
                userData.tasksCompleted = (userData.tasksCompleted || 0) + 1;
                
                await saveUserData(userData);
                updateUI();
                
                btn.textContent = 'COMPLETED';
            }, 10000);
        }

        function watchAd() {
            const btn = event.target;
            btn.textContent = 'PROCESSING';
            btn.disabled = true;
            
            // Show Monetag ad (if available)
            if (window.show_10290264) {
                window.show_10290264();
            }
            
            setTimeout(async () => {
                userData.balance += 1;
                await saveUserData(userData);
                updateUI();
                
                btn.textContent = 'OPEN';
                btn.disabled = false;
            }, 10000);
        }

        // Leaderboard functions
        async function loadLeaderboard() {
            try {
                const snapshot = await database.ref('users').orderByChild('balance').limitToLast(25).once('value');
                const users = snapshot.val();
                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = '';
                
                if (users) {
                    const sortedUsers = Object.values(users).sort((a, b) => b.balance - a.balance);
                    
                    sortedUsers.forEach((user, index) => {
                        const level = calculateLevel(user.balance);
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        item.innerHTML = `
                            <div class="leaderboard-rank">#${index + 1}</div>
                            <img src="${user.photoUrl || 'https://via.placeholder.com/40'}" class="leaderboard-avatar" alt="${user.username}">
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${user.username || user.firstName}</div>
                                <div class="leaderboard-balance">${formatBalance(user.balance)}</div>
                            </div>
                            <div class="leaderboard-level level-${level.class}">${level.name}</div>
                        `;
                        leaderboardList.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Friends functions
        async function loadReferrals() {
            if (!userData.referrals || userData.referrals.length === 0) {
                document.getElementById('totalReferrals').textContent = '0';
                document.getElementById('referralEarnings').textContent = '0';
                document.getElementById('referralsList').innerHTML = '<p style="text-align: center; opacity: 0.6;">No referrals yet</p>';
                return;
            }
            
            try {
                const referralsList = document.getElementById('referralsList');
                referralsList.innerHTML = '';
                
                let totalEarned = 0;
                
                for (const referralId of userData.referrals) {
                    const referral = await getUserData(referralId);
                    if (referral) {
                        const item = document.createElement('div');
                        item.className = 'referral-item';
                        item.innerHTML = `
                            <img src="${referral.photoUrl || 'https://via.placeholder.com/35'}" class="referral-avatar" alt="${referral.username}">
                            <div class="referral-details">
                                <div class="referral-name">${referral.username || referral.firstName}</div>
                                <div class="referral-earned">ID: ${referral.telegramId} | Balance: ${formatBalance(referral.balance)}</div>
                            </div>
                        `;
                        referralsList.appendChild(item);
                        totalEarned += 5000;
                    }
                }
                
                document.getElementById('totalReferrals').textContent = userData.referrals.length;
                document.getElementById('referralEarnings').textContent = totalEarned.toLocaleString();
            } catch (error) {
                console.error('Error loading referrals:', error);
            }
        }

        function copyReferralLink() {
            const link = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        // Wallet functions
        async function connectWallet() {
            try {
                // Open TON connection website
                window.open('https://trimint.vercel.app/', '_blank');
                
                // Listen for wallet connection (this would need to be implemented on the connection site)
                // For now, we'll simulate a successful connection
                setTimeout(() => {
                    const mockAddress = 'EQD' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                    handleWalletConnection(mockAddress);
                }, 3000);
            } catch (error) {
                console.error('Error connecting wallet:', error);
            }
        }

        async function handleWalletConnection(address) {
            connectedWallet = address;
            userData.walletAddress = address;
            await saveUserData(userData);
            
            updateWalletUI(address);
        }

        function updateWalletUI(address) {
            document.getElementById('walletBtn').textContent = 'Connected';
            document.getElementById('walletAddress').textContent = address;
            document.getElementById('walletAddress').style.display = 'block';
            document.getElementById('walletButtons').style.display = 'flex';
        }

        async function disconnectWallet() {
            connectedWallet = null;
            userData.walletAddress = null;
            await saveUserData(userData);
            
            document.getElementById('walletBtn').textContent = 'Connect TON Wallet';
            document.getElementById('walletAddress').style.display = 'none';
            document.getElementById('walletButtons').style.display = 'none';
        }

        function copyWalletAddress() {
            navigator.clipboard.writeText(connectedWallet).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        // Periodic updates
        setInterval(() => {
            if (isFarming) {
                saveUserData(userData);
            }
        }, 30000); // Save every 30 seconds during farming

        // Prevent back navigation
        window.addEventListener('popstate', () => {
            window.history.pushState(null, null, window.location.pathname);
        });
        window.history.pushState(null, null, window.location.pathname);
    </script>
</body>
</html>
