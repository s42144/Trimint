<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trimint - Telegram Mini App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 70px;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .coin-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .farming-animation {
            animation: rotate 3s linear infinite;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .nav-button {
            transition: all 0.3s ease;
        }
        
        .nav-button:hover {
            transform: translateY(-2px);
        }
        
        .nav-button.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .task-card {
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .blog-card {
            transition: all 0.3s ease;
        }
        
        .blog-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .quiz-option {
            transition: all 0.3s ease;
        }
        
        .quiz-option:hover {
            transform: translateX(5px);
        }
        
        .leaderboard-item {
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            transform: translateX(5px);
        }
        
        .token-animation {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            animation: floatUp 2s ease-out forwards;
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-6 max-w-md">
        <!-- Header with User Info -->
        <div class="glass-effect p-4 mb-6 flex items-center justify-between cursor-pointer" onclick="showPage('profile')">
            <div class="flex items-center">
                <img id="userPhoto" src="https://picsum.photos/seed/user123/50/50.jpg" alt="User Photo" class="w-12 h-12 rounded-full mr-3">
                <div>
                    <h2 id="userName" class="text-white font-semibold">Loading...</h2>
                    <p class="text-white text-sm opacity-80">Level <span id="userLevel">1</span></p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-white font-bold text-xl"><span id="userBalance">0</span> TRM</p>
                <p class="text-white text-xs opacity-80">Balance</p>
            </div>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <!-- Farming Section -->
            <div class="glass-effect p-6 mb-6 text-center">
                <div id="coinContainer" class="mb-4">
                    <img src="https://github.com/s42144/Trimint/blob/458d3d743b279877c11199b833cc212dffb5ef45/main.png?raw=true" alt="TRM Coin" class="w-24 h-24 mx-auto coin-animation" id="coinImage">
                </div>
                <h3 class="text-white text-xl font-bold mb-2">Farm TRM Tokens</h3>
                <p id="farmingStatus" class="text-white mb-4">Start farming to earn 0.001 TRM per second</p>
                <div id="farmingTimer" class="hidden">
                    <p class="text-white mb-2">Time remaining: <span id="timeRemaining">12:00:00</span></p>
                    <p class="text-white">Earned: <span id="farmingEarned">0</span> TRM</p>
                </div>
                <button id="farmingButton" onclick="toggleFarming()" class="bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-3 px-6 rounded-full mt-4">
                    Start Farming
                </button>
            </div>

            <!-- Leaderboard Section -->
            <div class="glass-effect p-6">
                <h3 class="text-white text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-trophy mr-2 text-yellow-400"></i> Leaderboard
                </h3>
                <div id="leaderboard" class="space-y-3">
                    <!-- Leaderboard items will be populated here -->
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="page">
            <div class="glass-effect p-6 mb-6">
                <div class="flex items-center mb-6">
                    <img id="profileUserPhoto" src="https://picsum.photos/seed/user123/80/80.jpg" alt="User Photo" class="w-20 h-20 rounded-full mr-4">
                    <div>
                        <h2 id="profileUserName" class="text-white font-bold text-xl">Loading...</h2>
                        <p class="text-white opacity-80">ID: <span id="profileUserId">123456789</span></p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="glass-effect p-4 text-center">
                        <p class="text-white text-2xl font-bold" id="profileLevel">1</p>
                        <p class="text-white text-sm opacity-80">Level</p>
                    </div>
                    <div class="glass-effect p-4 text-center">
                        <p class="text-white text-2xl font-bold" id="profileQuizzes">0</p>
                        <p class="text-white text-sm opacity-80">Quizzes Completed</p>
                    </div>
                    <div class="glass-effect p-4 text-center">
                        <p class="text-white text-2xl font-bold" id="profileFriends">0</p>
                        <p class="text-white text-sm opacity-80">Friends Invited</p>
                    </div>
                    <div class="glass-effect p-4 text-center">
                        <p class="text-white text-2xl font-bold" id="profileTasks">0</p>
                        <p class="text-white text-sm opacity-80">Tasks Completed</p>
                    </div>
                </div>
                
                <button class="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white font-bold py-3 px-6 rounded-full mb-4">
                    <i class="fas fa-wallet mr-2"></i> Connect Wallet
                </button>
            </div>
        </div>

        <!-- Quiz Page -->
        <div id="quizPage" class="page">
            <div class="glass-effect p-6">
                <h3 class="text-white text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-question-circle mr-2 text-blue-400"></i> TON Network Quizzes
                </h3>
                <div id="quizContainer" class="space-y-4">
                    <!-- Quiz questions will be populated here -->
                </div>
            </div>
        </div>

        <!-- Blogs Page -->
        <div id="blogsPage" class="page">
            <div class="glass-effect p-6 mb-4">
                <h3 class="text-white text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-blog mr-2 text-green-400"></i> Community Blogs
                </h3>
                <button onclick="showCreateBlog()" class="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-2 px-4 rounded-full mb-4">
                    <i class="fas fa-plus mr-2"></i> Create New Blog
                </button>
                <div id="blogContainer" class="space-y-4">
                    <!-- Blog posts will be populated here -->
                </div>
            </div>
        </div>

        <!-- Tasks Page -->
        <div id="tasksPage" class="page">
            <div class="glass-effect p-6">
                <h3 class="text-white text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-tasks mr-2 text-orange-400"></i> Complete Tasks
                </h3>
                <div id="tasksContainer" class="space-y-4">
                    <!-- Tasks will be populated here -->
                </div>
            </div>
        </div>

        <!-- Friends Page -->
        <div id="friendsPage" class="page">
            <div class="glass-effect p-6 mb-4">
                <h3 class="text-white text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-user-friends mr-2 text-indigo-400"></i> Invite Friends
                </h3>
                <div class="bg-white bg-opacity-20 p-4 rounded-lg mb-4">
                    <p class="text-white mb-2">Your referral link:</p>
                    <div class="flex items-center">
                        <input id="referralLink" type="text" value="http://t.me/TrimintBot/open?start=123456789" class="flex-1 bg-white bg-opacity-20 text-white p-2 rounded-l" readonly>
                        <button onclick="copyReferralLink()" class="bg-blue-500 text-white p-2 rounded-r">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="glass-effect p-4 text-center">
                        <p class="text-white text-2xl font-bold" id="totalReferrals">0</p>
                        <p class="text-white text-sm opacity-80">Total Referrals</p>
                    </div>
                    <div class="glass-effect p-4 text-center">
                        <p class="text-white text-2xl font-bold" id="referralEarnings">0</p>
                        <p class="text-white text-sm opacity-80">Referral Earnings</p>
                    </div>
                </div>
            </div>
            <div class="glass-effect p-6">
                <h3 class="text-white text-lg font-bold mb-4">Your Referrals</h3>
                <div id="referralsContainer" class="space-y-3">
                    <!-- Referrals will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 left-0 right-0 glass-effect p-2">
        <div class="container mx-auto max-w-md flex justify-around">
            <button onclick="showPage('home')" class="nav-button active flex flex-col items-center p-2 rounded-lg text-white">
                <i class="fas fa-home text-xl mb-1"></i>
                <span class="text-xs">Home</span>
            </button>
            <button onclick="showPage('quiz')" class="nav-button flex flex-col items-center p-2 rounded-lg text-white">
                <i class="fas fa-question-circle text-xl mb-1"></i>
                <span class="text-xs">Quiz</span>
            </button>
            <button onclick="showPage('blogs')" class="nav-button flex flex-col items-center p-2 rounded-lg text-white">
                <i class="fas fa-blog text-xl mb-1"></i>
                <span class="text-xs">Blogs</span>
            </button>
            <button onclick="showPage('tasks')" class="nav-button flex flex-col items-center p-2 rounded-lg text-white">
                <i class="fas fa-tasks text-xl mb-1"></i>
                <span class="text-xs">Tasks</span>
            </button>
            <button onclick="showPage('friends')" class="nav-button flex flex-col items-center p-2 rounded-lg text-white">
                <i class="fas fa-user-friends text-xl mb-1"></i>
                <span class="text-xs">Friends</span>
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Telegram Web App initialization
        const telegram = window.Telegram.WebApp;
        telegram.ready();
        telegram.expand();

        // Global variables
        let currentUser = null;
        let isFarming = false;
        let farmingStartTime = null;
        let farmingEndTime = null;
        let farmingInterval = null;
        let farmingAmount = 0;
        let userBalance = 0;
        let userLevel = 1;
        let completedQuizzes = 0;
        let invitedFriends = 0;
        let completedTasks = 0;
        let referrals = [];
        let tasks = [];
        let quizzes = [];
        let blogs = [];
        let leaderboardData = [];

        // Initialize the app
        function initApp() {
            // Get Telegram user data
            if (telegram.initDataUnsafe && telegram.initDataUnsafe.user) {
                currentUser = telegram.initDataUnsafe.user;
                document.getElementById('userName').textContent = currentUser.first_name + ' ' + (currentUser.last_name || '');
                document.getElementById('profileUserName').textContent = currentUser.first_name + ' ' + (currentUser.last_name || '');
                document.getElementById('userPhoto').src = currentUser.photo_url || 'https://picsum.photos/seed/user123/50/50.jpg';
                document.getElementById('profileUserPhoto').src = currentUser.photo_url || 'https://picsum.photos/seed/user123/80/80.jpg';
                document.getElementById('profileUserId').textContent = currentUser.id;
                
                // Update referral link with user ID
                document.getElementById('referralLink').value = `http://t.me/TrimintBot/open?start=${currentUser.id}`;
                
                // Load user data from Firebase
                loadUserData();
            } else {
                // For testing outside Telegram
                document.getElementById('userName').textContent = 'Test User';
                document.getElementById('profileUserName').textContent = 'Test User';
                document.getElementById('profileUserId').textContent = '123456789';
                
                // Load sample data
                loadSampleData();
            }
            
            // Load data from Firebase
            loadLeaderboard();
            loadTasks();
            loadQuizzes();
            loadBlogs();
            loadReferrals();
        }

        // Load user data from Firebase
        function loadUserData() {
            if (!currentUser) return;
            
            const userRef = db.collection('users').doc(currentUser.id.toString());
            
            userRef.get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    userBalance = userData.balance || 0;
                    userLevel = userData.level || 1;
                    completedQuizzes = userData.completedQuizzes || 0;
                    invitedFriends = userData.invitedFriends || 0;
                    completedTasks = userData.completedTasks || 0;
                    
                    // Check if farming was active
                    if (userData.farmingEndTime && userData.farmingEndTime > Date.now()) {
                        isFarming = true;
                        farmingStartTime = userData.farmingStartTime;
                        farmingEndTime = userData.farmingEndTime;
                        farmingAmount = userData.farmingAmount || 0;
                        startFarmingUI();
                    }
                    
                    updateUserUI();
                } else {
                    // Create new user document
                    userRef.set({
                        id: currentUser.id,
                        name: currentUser.first_name + ' ' + (currentUser.last_name || ''),
                        photoUrl: currentUser.photo_url || '',
                        balance: 0,
                        level: 1,
                        completedQuizzes: 0,
                        invitedFriends: 0,
                        completedTasks: 0,
                        referrals: []
                    });
                }
            });
        }

        // Update user UI
        function updateUserUI() {
            document.getElementById('userBalance').textContent = userBalance.toFixed(3);
            document.getElementById('userLevel').textContent = userLevel;
            document.getElementById('profileLevel').textContent = userLevel;
            document.getElementById('profileQuizzes').textContent = completedQuizzes;
            document.getElementById('profileFriends').textContent = invitedFriends;
            document.getElementById('profileTasks').textContent = completedTasks;
        }

        // Load sample data for testing
        function loadSampleData() {
            userBalance = 1250.75;
            userLevel = 3;
            completedQuizzes = 5;
            invitedFriends = 2;
            completedTasks = 8;
            
            // Sample referrals
            referrals = [
                { id: '987654321', name: 'John Doe', photoUrl: 'https://picsum.photos/seed/user987/40/40.jpg', joinedAt: new Date(Date.now() - 86400000 * 5).toISOString() },
                { id: '123456789', name: 'Jane Smith', photoUrl: 'https://picsum.photos/seed/user456/40/40.jpg', joinedAt: new Date(Date.now() - 86400000 * 2).toISOString() }
            ];
            
            // Sample tasks
            tasks = [
                {
                    id: 'task1',
                    name: 'Join Trimint Community',
                    description: 'Join our official Telegram community to stay updated',
                    photoUrl: 'https://picsum.photos/seed/task1/60/60.jpg',
                    link: 'https://t.me/trimintcommunity',
                    reward: 500,
                    status: 'open'
                },
                {
                    id: 'task2',
                    name: 'Follow on Twitter',
                    description: 'Follow our official Twitter account for latest updates',
                    photoUrl: 'https://picsum.photos/seed/task2/60/60.jpg',
                    link: 'https://twitter.com/trimint',
                    reward: 300,
                    status: 'completed'
                },
                {
                    id: 'task3',
                    name: 'Subscribe to YouTube',
                    description: 'Subscribe to our YouTube channel for video tutorials',
                    photoUrl: 'https://picsum.photos/seed/task3/60/60.jpg',
                    link: 'https://youtube.com/trimint',
                    reward: 400,
                    status: 'processing'
                }
            ];
            
            // Sample quizzes
            quizzes = [
                {
                    id: 'quiz1',
                    question: 'What is TON?',
                    options: ['The Open Network', 'Telegram Open Network', 'Token of Networks', 'Both A and B'],
                    correctAnswer: 3,
                    reward: 1500
                },
                {
                    id: 'quiz2',
                    question: 'Who created TON?',
                    options: ['Pavel Durov', 'Nikolai Durov', 'Satoshi Nakamoto', 'Vitalik Buterin'],
                    correctAnswer: 1,
                    reward: 1500
                }
            ];
            
            // Sample blogs
            blogs = [
                {
                    id: 'blog1',
                    author: 'Alice',
                    authorPhoto: 'https://picsum.photos/seed/alice/40/40.jpg',
                    content: 'I just earned my first 1000 TRM tokens by completing quizzes. This app is amazing!',
                    likes: 24,
                    comments: 5,
                    createdAt: new Date(Date.now() - 86400000 * 1).toISOString()
                },
                {
                    id: 'blog2',
                    author: 'Bob',
                    authorPhoto: 'https://picsum.photos/seed/bob/40/40.jpg',
                    content: 'The farming feature is great! I earned 43.2 TRM while I was sleeping. Keep up the good work!',
                    likes: 18,
                    comments: 3,
                    createdAt: new Date(Date.now() - 86400000 * 3).toISOString()
                }
            ];
            
            // Sample leaderboard
            leaderboardData = [
                { rank: 1, name: 'CryptoKing', photoUrl: 'https://picsum.photos/seed/leader1/40/40.jpg', balance: 15420.5 },
                { rank: 2, name: 'TokenMaster', photoUrl: 'https://picsum.photos/seed/leader2/40/40.jpg', balance: 12350.75 },
                { rank: 3, name: 'TONWhale', photoUrl: 'https://picsum.photos/seed/leader3/40/40.jpg', balance: 9875.25 },
                { rank: 4, name: 'BlockchainPro', photoUrl: 'https://picsum.photos/seed/leader4/40/40.jpg', balance: 7650.0 },
                { rank: 5, name: 'CryptoGuru', photoUrl: 'https://picsum.photos/seed/leader5/40/40.jpg', balance: 5430.5 }
            ];
            
            updateUserUI();
            renderLeaderboard();
            renderTasks();
            renderQuizzes();
            renderBlogs();
            renderReferrals();
        }

        // Toggle farming
        function toggleFarming() {
            if (isFarming) {
                stopFarming();
            } else {
                startFarming();
            }
        }

        // Start farming
        function startFarming() {
            isFarming = true;
            farmingStartTime = Date.now();
            farmingEndTime = farmingStartTime + 43200000; // 12 hours in milliseconds
            farmingAmount = 0;
            
            // Save farming state to Firebase
            if (currentUser) {
                const userRef = db.collection('users').doc(currentUser.id.toString());
                userRef.update({
                    farmingStartTime: farmingStartTime,
                    farmingEndTime: farmingEndTime,
                    farmingAmount: farmingAmount
                });
            }
            
            startFarmingUI();
        }

        // Start farming UI
        function startFarmingUI() {
            document.getElementById('farmingButton').textContent = 'Stop Farming';
            document.getElementById('farmingStatus').textContent = 'Farming in progress...';
            document.getElementById('farmingTimer').classList.remove('hidden');
            document.getElementById('coinImage').classList.add('farming-animation');
            
            farmingInterval = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, farmingEndTime - now);
                
                if (remaining > 0) {
                    // Update farming amount (0.001 TRM per second)
                    farmingAmount += 0.001;
                    userBalance += 0.001;
                    
                    // Update UI
                    updateUserUI();
                    document.getElementById('farmingEarned').textContent = farmingAmount.toFixed(3);
                    
                    // Update timer
                    const hours = Math.floor(remaining / 3600000);
                    const minutes = Math.floor((remaining % 3600000) / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    document.getElementById('timeRemaining').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Show token animation
                    if (Math.floor(farmingAmount * 100) % 10 === 0) {
                        showTokenAnimation();
                    }
                    
                    // Save to Firebase periodically
                    if (Math.floor(farmingAmount * 100) % 100 === 0 && currentUser) {
                        const userRef = db.collection('users').doc(currentUser.id.toString());
                        userRef.update({
                            balance: userBalance,
                            farmingAmount: farmingAmount
                        });
                    }
                } else {
                    // Farming completed
                    stopFarming();
                    telegram.showAlert('Farming completed! You earned ' + farmingAmount.toFixed(3) + ' TRM tokens.');
                }
            }, 1000);
        }

        // Stop farming
        function stopFarming() {
            isFarming = false;
            clearInterval(farmingInterval);
            
            document.getElementById('farmingButton').textContent = 'Start Farming';
            document.getElementById('farmingStatus').textContent = 'Start farming to earn 0.001 TRM per second';
            document.getElementById('farmingTimer').classList.add('hidden');
            document.getElementById('coinImage').classList.remove('farming-animation');
            
            // Reset farming state in Firebase
            if (currentUser) {
                const userRef = db.collection('users').doc(currentUser.id.toString());
                userRef.update({
                    farmingStartTime: null,
                    farmingEndTime: null,
                    farmingAmount: 0
                });
            }
            
            farmingAmount = 0;
        }

        // Show token animation
        function showTokenAnimation() {
            const token = document.createElement('div');
            token.className = 'token-animation';
            token.innerHTML = '<i class="fas fa-coins text-yellow-400 text-xl"></i> +0.001 TRM';
            token.style.left = Math.random() * window.innerWidth + 'px';
            token.style.top = (window.innerHeight / 2) + 'px';
            document.body.appendChild(token);
            
            setTimeout(() => {
                document.body.removeChild(token);
            }, 2000);
        }

        // Load leaderboard from Firebase
        function loadLeaderboard() {
            db.collection('users')
                .orderBy('balance', 'desc')
                .limit(25)
                .get()
                .then((querySnapshot) => {
                    leaderboardData = [];
                    querySnapshot.forEach((doc) => {
                        const userData = doc.data();
                        leaderboardData.push({
                            rank: leaderboardData.length + 1,
                            name: userData.name,
                            photoUrl: userData.photoUrl || 'https://picsum.photos/seed/' + userData.id + '/40/40.jpg',
                            balance: userData.balance || 0
                        });
                    });
                    renderLeaderboard();
                })
                .catch((error) => {
                    console.error('Error loading leaderboard:', error);
                    // Load sample data if Firebase fails
                    loadSampleData();
                });
        }

        // Render leaderboard
        function renderLeaderboard() {
            const leaderboardContainer = document.getElementById('leaderboard');
            leaderboardContainer.innerHTML = '';
            
            leaderboardData.forEach((user) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item flex items-center justify-between p-3 rounded-lg bg-white bg-opacity-10';
                
                const medalColor = user.rank <= 3 ? 
                    (user.rank === 1 ? 'text-yellow-400' : user.rank === 2 ? 'text-gray-300' : 'text-orange-600') : '';
                
                item.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 flex items-center justify-center mr-3">
                            ${user.rank <= 3 ? 
                                `<i class="fas fa-medal ${medalColor} text-xl"></i>` : 
                                `<span class="text-white font-bold">${user.rank}</span>`
                            }
                        </div>
                        <img src="${user.photoUrl}" alt="${user.name}" class="w-10 h-10 rounded-full mr-3">
                        <span class="text-white font-medium">${user.name}</span>
                    </div>
                    <span class="text-white font-bold">${user.balance.toFixed(3)} TRM</span>
                `;
                
                leaderboardContainer.appendChild(item);
            });
        }

        // Load tasks from Firebase
        function loadTasks() {
            db.collection('tasks')
                .get()
                .then((querySnapshot) => {
                    tasks = [];
                    querySnapshot.forEach((doc) => {
                        const taskData = doc.data();
                        tasks.push({
                            id: doc.id,
                            ...taskData
                        });
                    });
                    renderTasks();
                })
                .catch((error) => {
                    console.error('Error loading tasks:', error);
                    // Tasks are already loaded in loadSampleData
                });
        }

        // Render tasks
        function renderTasks() {
            const tasksContainer = document.getElementById('tasksContainer');
            tasksContainer.innerHTML = '';
            
            tasks.forEach((task) => {
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card glass-effect p-4';
                
                let buttonClass = 'bg-blue-500';
                let buttonText = 'OPEN';
                let buttonDisabled = false;
                
                if (task.status === 'processing') {
                    buttonClass = 'bg-yellow-500';
                    buttonText = 'PROCESSING';
                    buttonDisabled = true;
                } else if (task.status === 'completed') {
                    buttonClass = 'bg-green-500';
                    buttonText = 'COMPLETED';
                }
                
                taskCard.innerHTML = `
                    <div class="flex items-start">
                        <img src="${task.photoUrl}" alt="${task.name}" class="w-14 h-14 rounded-lg mr-3">
                        <div class="flex-1">
                            <h4 class="text-white font-semibold mb-1">${task.name}</h4>
                            <p class="text-white text-sm opacity-80 mb-2">${task.description}</p>
                            <div class="flex items-center justify-between">
                                <span class="text-yellow-400 font-bold">+${task.reward} TRM</span>
                                <button 
                                    onclick="handleTaskClick('${task.id}')" 
                                    class="${buttonClass} text-white font-bold py-1 px-4 rounded-full text-sm"
                                    ${buttonDisabled ? 'disabled' : ''}
                                >
                                    ${buttonText}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                tasksContainer.appendChild(taskCard);
            });
        }

        // Handle task click
        function handleTaskClick(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            if (task.status === 'open') {
                // Open the task link
                window.open(task.link, '_blank');
                
                // Update task status to processing
                task.status = 'processing';
                renderTasks();
                
                // After 10 seconds, complete the task and add reward
                setTimeout(() => {
                    task.status = 'completed';
                    userBalance += task.reward;
                    completedTasks++;
                    updateUserUI();
                    renderTasks();
                    
                    // Save to Firebase
                    if (currentUser) {
                        const userRef = db.collection('users').doc(currentUser.id.toString());
                        userRef.update({
                            balance: userBalance,
                            completedTasks: completedTasks
                        });
                    }
                    
                    telegram.showAlert(`Task completed! You earned ${task.reward} TRM tokens.`);
                }, 10000);
            } else if (task.status === 'completed') {
                // Open the task link again
                window.open(task.link, '_blank');
            }
        }

        // Load quizzes from Firebase
        function loadQuizzes() {
            db.collection('quizzes')
                .get()
                .then((querySnapshot) => {
                    quizzes = [];
                    querySnapshot.forEach((doc) => {
                        const quizData = doc.data();
                        quizzes.push({
                            id: doc.id,
                            ...quizData
                        });
                    });
                    renderQuizzes();
                })
                .catch((error) => {
                    console.error('Error loading quizzes:', error);
                    // Quizzes are already loaded in loadSampleData
                });
        }

        // Render quizzes
        function renderQuizzes() {
            const quizContainer = document.getElementById('quizContainer');
            quizContainer.innerHTML = '';
            
            quizzes.forEach((quiz, index) => {
                const quizCard = document.createElement('div');
                quizCard.className = 'glass-effect p-4';
                quizCard.innerHTML = `
                    <h4 class="text-white font-semibold mb-3">${index + 1}. ${quiz.question}</h4>
                    <div class="space-y-2">
                        ${quiz.options.map((option, optionIndex) => `
                            <div class="quiz-option bg-white bg-opacity-10 p-3 rounded-lg cursor-pointer" onclick="checkAnswer('${quiz.id}', ${optionIndex})">
                                <span class="text-white">${String.fromCharCode(65 + optionIndex)}. ${option}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-yellow-400 font-bold">+${quiz.reward} TRM</span>
                    </div>
                `;
                quizContainer.appendChild(quizCard);
            });
        }

        // Check quiz answer
        function checkAnswer(quizId, selectedOption) {
            const quiz = quizzes.find(q => q.id === quizId);
            if (!quiz) return;
            
            if (selectedOption === quiz.correctAnswer) {
                // Correct answer
                userBalance += quiz.reward;
                completedQuizzes++;
                updateUserUI();
                
                // Remove the completed quiz
                quizzes = quizzes.filter(q => q.id !== quizId);
                renderQuizzes();
                
                // Save to Firebase
                if (currentUser) {
                    const userRef = db.collection('users').doc(currentUser.id.toString());
                    userRef.update({
                        balance: userBalance,
                        completedQuizzes: completedQuizzes
                    });
                }
                
                telegram.showAlert(`Correct answer! You earned ${quiz.reward} TRM tokens.`);
            } else {
                // Wrong answer
                telegram.showAlert('Wrong answer. Please try again.');
            }
        }

        // Load blogs from Firebase
        function loadBlogs() {
            db.collection('blogs')
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    blogs = [];
                    querySnapshot.forEach((doc) => {
                        const blogData = doc.data();
                        blogs.push({
                            id: doc.id,
                            ...blogData
                        });
                    });
                    renderBlogs();
                })
                .catch((error) => {
                    console.error('Error loading blogs:', error);
                    // Blogs are already loaded in loadSampleData
                });
        }

        // Render blogs
        function renderBlogs() {
            const blogContainer = document.getElementById('blogContainer');
            blogContainer.innerHTML = '';
            
            blogs.forEach((blog) => {
                const blogCard = document.createElement('div');
                blogCard.className = 'blog-card glass-effect p-4';
                
                const date = new Date(blog.createdAt);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                blogCard.innerHTML = `
                    <div class="flex items-start mb-3">
                        <img src="${blog.authorPhoto}" alt="${blog.author}" class="w-10 h-10 rounded-full mr-3">
                        <div>
                            <h4 class="text-white font-semibold">${blog.author}</h4>
                            <p class="text-white text-xs opacity-60">${formattedDate}</p>
                        </div>
                    </div>
                    <p class="text-white mb-3">${blog.content}</p>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <button onclick="likeBlog('${blog.id}')" class="flex items-center text-white text-sm">
                                <i class="far fa-heart mr-1"></i> ${blog.likes}
                            </button>
                            <button onclick="commentOnBlog('${blog.id}')" class="flex items-center text-white text-sm">
                                <i class="far fa-comment mr-1"></i> ${blog.comments}
                            </button>
                        </div>
                    </div>
                `;
                
                blogContainer.appendChild(blogCard);
            });
        }

        // Show create blog form
        function showCreateBlog() {
            const content = prompt('Share your experience with Trimint:');
            if (content && content.trim()) {
                const newBlog = {
                    author: currentUser ? currentUser.first_name : 'Anonymous',
                    authorPhoto: currentUser ? currentUser.photo_url : 'https://picsum.photos/seed/anonymous/40/40.jpg',
                    content: content.trim(),
                    likes: 0,
                    comments: 0,
                    createdAt: new Date().toISOString()
                };
                
                // Add to local array
                blogs.unshift(newBlog);
                renderBlogs();
                
                // Save to Firebase
                if (currentUser) {
                    db.collection('blogs').add(newBlog)
                        .then(() => {
                            telegram.showAlert('Your blog has been posted successfully!');
                        })
                        .catch((error) => {
                            console.error('Error posting blog:', error);
                            telegram.showAlert('Failed to post your blog. Please try again.');
                        });
                } else {
                    telegram.showAlert('Your blog has been posted successfully!');
                }
            }
        }

        // Like a blog
        function likeBlog(blogId) {
            const blog = blogs.find(b => b.id === blogId);
            if (blog) {
                blog.likes++;
                renderBlogs();
                
                // Update in Firebase
                db.collection('blogs').doc(blogId).update({
                    likes: blog.likes
                });
            }
        }

        // Comment on a blog
        function commentOnBlog(blogId) {
            const comment = prompt('Add your comment:');
            if (comment && comment.trim()) {
                const blog = blogs.find(b => b.id === blogId);
                if (blog) {
                    blog.comments++;
                    renderBlogs();
                    
                    // Update in Firebase
                    db.collection('blogs').doc(blogId).update({
                        comments: blog.comments
                    });
                    
                    // Save the actual comment
                    db.collection('blogs').doc(blogId).collection('comments').add({
                        author: currentUser ? currentUser.first_name : 'Anonymous',
                        content: comment.trim(),
                        createdAt: new Date().toISOString()
                    });
                    
                    telegram.showAlert('Your comment has been added!');
                }
            }
        }

        // Load referrals from Firebase
        function loadReferrals() {
            if (!currentUser) {
                // Referrals are already loaded in loadSampleData
                renderReferrals();
                return;
            }
            
            db.collection('users').doc(currentUser.id.toString())
                .get()
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        referrals = userData.referrals || [];
                        invitedFriends = referrals.length;
                        
                        // Calculate referral earnings
                        const referralEarnings = referrals.length * 5000;
                        document.getElementById('totalReferrals').textContent = referrals.length;
                        document.getElementById('referralEarnings').textContent = referralEarnings;
                        
                        renderReferrals();
                    }
                })
                .catch((error) => {
                    console.error('Error loading referrals:', error);
                    // Referrals are already loaded in loadSampleData
                    renderReferrals();
                });
        }

        // Render referrals
        function renderReferrals() {
            const referralsContainer = document.getElementById('referralsContainer');
            referralsContainer.innerHTML = '';
            
            if (referrals.length === 0) {
                referralsContainer.innerHTML = '<p class="text-white text-center opacity-60">No referrals yet. Invite your friends to earn 5000 TRM for each referral!</p>';
                return;
            }
            
            referrals.forEach((referral) => {
                const referralCard = document.createElement('div');
                referralCard.className = 'flex items-center justify-between p-3 rounded-lg bg-white bg-opacity-10';
                
                const date = new Date(referral.joinedAt);
                const formattedDate = date.toLocaleDateString();
                
                referralCard.innerHTML = `
                    <div class="flex items-center">
                        <img src="${referral.photoUrl}" alt="${referral.name}" class="w-10 h-10 rounded-full mr-3">
                        <div>
                            <span class="text-white font-medium">${referral.name}</span>
                            <p class="text-white text-xs opacity-60">Joined: ${formattedDate}</p>
                        </div>
                    </div>
                    <span class="text-green-400 font-bold">+5000 TRM</span>
                `;
                
                referralsContainer.appendChild(referralCard);
            });
        }

        // Copy referral link
        function copyReferralLink() {
            const referralLink = document.getElementById('referralLink');
            referralLink.select();
            document.execCommand('copy');
            telegram.showAlert('Referral link copied to clipboard!');
        }

        // Show page
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageName + 'Page').classList.add('active');
            
            // Add active class to selected nav button
            const navButtons = document.querySelectorAll('.nav-button');
            const pageIndex = ['home', 'quiz', 'blogs', 'tasks', 'friends'].indexOf(pageName);
            if (pageIndex !== -1) {
                navButtons[pageIndex].classList.add('active');
            }
        }

        // Initialize the app when the page loads
        window.onload = initApp;
    </script>
</body>
</html>
