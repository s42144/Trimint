<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trimint - TRM Mining</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <!-- Monetag Ads -->
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
    
    <!-- Telegram WebApp API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #0088cc;
            --secondary-color: #005580;
            --accent-color: #ff6b35;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --background: #0a0e27;
            --surface: #151932;
            --surface-light: #1e2139;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --border-color: #2a2f4a;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] {
            --primary-color: #2196f3;
            --secondary-color: #1976d2;
            --accent-color: #ff6b35;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --background: #f5f5f5;
            --surface: #ffffff;
            --surface-light: #f8f9fa;
            --text-primary: #212121;
            --text-secondary: #757575;
            --border-color: #e0e0e0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .coin-loader {
            width: 100px;
            height: 100px;
            background: url('https://i.postimg.cc/fTQktNmX/maincoin.png') center/contain no-repeat;
            animation: pulse 1.5s infinite;
            margin-bottom: 20px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .loading-text {
            color: white;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .referral-text {
            color: #ffd700;
            font-size: 16px;
            text-align: center;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        /* Header */
        .header {
            background: var(--surface);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .balance-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .coin-icon {
            width: 30px;
            height: 30px;
            background: url('https://i.postimg.cc/fTQktNmX/maincoin.png') center/contain no-repeat;
        }

        .balance-amount {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .level-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .level-bronze { background: linear-gradient(135deg, #cd7f32, #b87333); }
        .level-gold { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; }
        .level-diamond { background: linear-gradient(135deg, #b9f2ff, #00d4ff); color: #333; }

        .theme-toggle {
            background: var(--surface-light);
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover {
            transform: rotate(180deg);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            padding-bottom: 100px;
            overflow-y: auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Section */
        .home-section {
            text-align: center;
            padding: 20px 0;
        }

        .main-coin {
            width: 200px;
            height: 200px;
            background: url('https://i.postimg.cc/fTQktNmX/maincoin.png') center/contain no-repeat;
            margin: 0 auto 30px;
            transition: transform 0.3s ease;
        }

        .main-coin.farming {
            animation: farmingPulse 2s infinite;
        }

        @keyframes farmingPulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(5deg); }
            50% { transform: scale(1.1) rotate(0deg); }
            75% { transform: scale(1.05) rotate(-5deg); }
        }

        .farming-button {
            background: linear-gradient(135deg, var(--success-color), #45a049);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .farming-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .farming-button:disabled {
            background: var(--surface-light);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .farming-timer {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-color);
        }

        .mining-rate {
            margin-top: 10px;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .token-animation {
            position: fixed;
            font-size: 20px;
            font-weight: bold;
            color: var(--success-color);
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-100px); }
        }

        /* Tasks Section */
        .task-card {
            background: var(--surface);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .task-card:hover {
            transform: translateY(-2px);
        }

        .task-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .task-reward {
            color: var(--success-color);
            font-size: 14px;
            font-weight: bold;
        }

        .task-description {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .task-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
        }

        .task-button:hover:not(:disabled) {
            background: var(--secondary-color);
        }

        .task-button:disabled {
            background: var(--surface-light);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .task-button.processing {
            background: var(--warning-color);
        }

        .task-button.completed {
            background: var(--success-color);
        }

        /* Leaderboard Section */
        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .leaderboard-item {
            background: var(--surface);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
        }

        .rank-number {
            width: 30px;
            height: 30px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); color: #333; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #e8a860); }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .user-balance {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .user-level {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* Friends Section */
        .referral-section {
            background: var(--surface);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .referral-link-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .referral-link {
            flex: 1;
            background: var(--surface-light);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            word-break: break-all;
        }

        .copy-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .copy-button:hover {
            background: var(--secondary-color);
        }

        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--surface-light);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .referrals-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .referral-item {
            background: var(--surface-light);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Profile Section */
        .profile-header {
            background: var(--surface);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            object-fit: cover;
        }

        .profile-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-id {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .wallet-section {
            background: var(--surface);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .wallet-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .wallet-address {
            font-size: 14px;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .wallet-buttons {
            display: flex;
            gap: 10px;
        }

        .wallet-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .wallet-button:hover {
            background: var(--secondary-color);
        }

        .wallet-button.disconnect {
            background: var(--danger-color);
        }

        .profile-stats {
            background: var(--surface);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .settings-section {
            background: var(--surface);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--surface-light);
            border-radius: 34px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--primary-color);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 5px 15px;
            cursor: pointer;
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .nav-item:hover {
            transform: translateY(-2px);
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item.home {
            transform: scale(1.2);
        }

        .nav-item.home.active {
            transform: scale(1.2);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: bold;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .main-content {
                padding: 15px;
            }

            .main-coin {
                width: 150px;
                height: 150px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .referral-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        .slide-up {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .toast.warning {
            border-left: 4px solid var(--warning-color);
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="coin-loader"></div>
        <div class="loading-text">Initializing Trimint...</div>
        <div class="referral-text" id="referralText" style="display: none;"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="balance-section">
            <div class="coin-icon"></div>
            <div class="balance-amount" id="balanceAmount">0 TRM</div>
        </div>
        <div class="level-badge" id="levelBadge">BRONZE</div>
        <button class="theme-toggle" id="themeToggle">üåô</button>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Home Section -->
        <section class="section active" id="homeSection">
            <div class="home-section">
                <div class="main-coin" id="mainCoin"></div>
                <button class="farming-button" id="farmingButton">Start Farming</button>
                <div class="farming-timer" id="farmingTimer" style="display: none;"></div>
                <div class="mining-rate">Mining Rate: 0.001 TRM/second</div>
            </div>
        </section>

        <!-- Tasks Section -->
        <section class="section" id="tasksSection">
            <div class="section-header">
                <h2>Tasks</h2>
            </div>
            <div class="tasks-list" id="tasksList">
                <!-- Watch Ads Task (Fixed) -->
                <div class="task-card">
                    <div class="task-header">
                        <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="Watch Ads" class="task-icon">
                        <div class="task-info">
                            <div class="task-name">Watch Ads</div>
                            <div class="task-reward">Reward: 1 TRM</div>
                        </div>
                    </div>
                    <div class="task-description">Watch advertisements to earn TRM tokens</div>
                    <button class="task-button" onclick="watchAd()">OPEN</button>
                </div>
            </div>
        </section>

        <!-- Leaderboard Section -->
        <section class="section" id="leaderboardSection">
            <div class="section-header">
                <h2>Leaderboard</h2>
            </div>
            <div class="leaderboard-list" id="leaderboardList">
                <!-- Leaderboard items will be populated here -->
            </div>
        </section>

        <!-- Friends Section -->
        <section class="section" id="friendsSection">
            <div class="referral-section">
                <h3>Invite Friends</h3>
                <div class="referral-link-container">
                    <input type="text" class="referral-link" id="referralLink" readonly>
                    <button class="copy-button" onclick="copyReferralLink()">Copy</button>
                </div>
                <div class="referral-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="referralEarnings">0 TRM</div>
                        <div class="stat-label">Referral Earnings</div>
                    </div>
                </div>
            </div>
            <h3>Your Referrals</h3>
            <div class="referrals-list" id="referralsList">
                <!-- Referrals will be populated here -->
            </div>
        </section>

        <!-- Profile Section -->
        <section class="section" id="profileSection">
            <div class="profile-header">
                <img src="" alt="Profile" class="profile-avatar" id="profileAvatar">
                <div class="profile-name" id="profileName">Loading...</div>
                <div class="profile-id" id="profileId">ID: </div>
            </div>

            <div class="wallet-section">
                <h3>TON Wallet</h3>
                <div class="wallet-info">
                    <div class="wallet-address" id="walletAddress">Not Connected</div>
                </div>
                <div class="wallet-buttons">
                    <button class="wallet-button" id="connectWalletButton" onclick="connectWallet()">Connect TON Wallet</button>
                    <button class="wallet-button" id="copyWalletButton" onclick="copyWalletAddress()" style="display: none;">Copy</button>
                    <button class="wallet-button disconnect" id="disconnectWalletButton" onclick="disconnectWallet()" style="display: none;">Disconnect</button>
                </div>
            </div>

            <div class="profile-stats">
                <h3>Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-value" id="profileLevel">Bronze</div>
                        <div class="stat-label">Level</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-value" id="profileFriends">0</div>
                        <div class="stat-label">Friends</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">‚è∞</div>
                        <div class="stat-value" id="profileFarmingTime">0h</div>
                        <div class="stat-label">Farm Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="profileTotalEarned">0 TRM</div>
                        <div class="stat-label">Total Earned</div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Settings</h3>
                <div class="setting-item">
                    <div>
                        <div>Notifications</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Receive farming notifications</div>
                    </div>
                    <div class="toggle-switch" id="notificationToggle" onclick="toggleSetting('notifications')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div>
                        <div>Sound Effects</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Play sounds on actions</div>
                    </div>
                    <div class="toggle-switch" id="soundToggle" onclick="toggleSetting('sound')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div>
                        <div>Auto Farming</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Auto-restart farming when completed</div>
                    </div>
                    <div class="toggle-switch" id="autoFarmingToggle" onclick="toggleSetting('autoFarming')">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item home active" onclick="switchSection('home')">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">Home</div>
        </div>
        <div class="nav-item" onclick="switchSection('tasks')">
            <div class="nav-icon">üìã</div>
            <div class="nav-label">Tasks</div>
        </div>
        <div class="nav-item" onclick="switchSection('leaderboard')">
            <div class="nav-icon">üèÜ</div>
            <div class="nav-label">Leaderboard</div>
        </div>
        <div class="nav-item" onclick="switchSection('friends')">
            <div class="nav-icon">üë•</div>
            <div class="nav-label">Friends</div>
        </div>
        <div class="nav-item" onclick="switchSection('profile')">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">Profile</div>
        </div>
    </nav>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Telegram Bot API
        const telegramBotToken = '8099896534:AAFmOTkOjLC8RSSJy-dXtjPQotF3hJlyXTQ';
        
        // Global Variables
        let currentUser = null;
        let userData = null;
        let farmingInterval = null;
        let farmingEndTime = null;
        let tonConnect = null;

        // Initialize Telegram WebApp
        function initTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                
                // Get user data
                currentUser = tg.initDataUnsafe?.user;
                
                if (currentUser) {
                    // Initialize user data
                    initializeUserData();
                }
            }
        }

        // Initialize User Data
        async function initializeUserData() {
            if (!currentUser) return;

            const userId = currentUser.id.toString();
            const userRef = database.ref('users/' + userId);

            // Check if user exists
            userRef.once('value', async (snapshot) => {
                const data = snapshot.val();
                
                if (!data) {
                    // New user - check for referral
                    const urlParams = new URLSearchParams(window.location.search);
                    const referralCode = urlParams.get('startapp');
                    
                    let referrerName = '';
                    if (referralCode) {
                        // Process referral
                        await processReferral(referralCode, userId);
                        
                        // Get referrer info for display
                        const referrerRef = database.ref('users/' + referralCode);
                        const referrerSnapshot = await referrerRef.once('value');
                        const referrerData = referrerSnapshot.val();
                        if (referrerData) {
                            referrerName = referrerData.firstName || 'Friend';
                        }
                    }

                    // Show referral message if exists
                    if (referrerName) {
                        document.getElementById('referralText').textContent = `Welcome! You were invited by ${referrerName}`;
                        document.getElementById('referralText').style.display = 'block';
                        setTimeout(() => {
                            hideLoadingScreen();
                        }, 3000);
                    } else {
                        setTimeout(() => {
                            hideLoadingScreen();
                        }, 1500);
                    }

                    // Create new user
                    userData = {
                        id: userId,
                        firstName: currentUser.first_name,
                        lastName: currentUser.last_name || '',
                        username: currentUser.username || '',
                        photoUrl: currentUser.photo_url || '',
                        balance: 0,
                        totalEarned: 0,
                        level: 'Bronze',
                        referrals: 0,
                        referralEarnings: 0,
                        farmingEndTime: null,
                        isFarming: false,
                        walletAddress: null,
                        tasksCompleted: [],
                        settings: {
                            notifications: false,
                            sound: false,
                            autoFarming: false
                        },
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    };

                    await userRef.set(userData);
                } else {
                    userData = data;
                    
                    // Update last active
                    await userRef.update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });

                    // Check if farming was active
                    if (userData.farmingEndTime && userData.isFarming) {
                        const now = Date.now();
                        if (now < userData.farmingEndTime) {
                            startFarming(userData.farmingEndTime - now);
                        } else {
                            // Farming completed
                            userData.isFarming = false;
                            userData.farmingEndTime = null;
                            await userRef.update({
                                isFarming: false,
                                farmingEndTime: null
                            });
                        }
                    }

                    hideLoadingScreen();
                }

                // Update UI
                updateUI();
                loadTasks();
                loadLeaderboard();
                loadReferrals();
            });
        }

        // Process Referral
        async function processReferral(referrerId, newUserId) {
            const referrerRef = database.ref('users/' + referrerId);
            const referrerSnapshot = await referrerRef.once('value');
            const referrerData = referrerSnapshot.val();

            if (referrerData) {
                // Give referrer 5000 TRM
                const newBalance = referrerData.balance + 5000;
                const newReferralEarnings = referrerData.referralEarnings + 5000;
                const newReferrals = (referrerData.referrals || 0) + 1;

                await referrerRef.update({
                    balance: newBalance,
                    totalEarned: referrerData.totalEarned + 5000,
                    referralEarnings: newReferralEarnings,
                    referrals: newReferrals
                });

                // Add to referral list
                await referrerRef.child('referralList').push({
                    referredUserId: newUserId,
                    referredAt: firebase.database.ServerValue.TIMESTAMP,
                    reward: 5000
                });
            }
        }

        // Hide Loading Screen
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.classList.add('hidden');
        }

        // Update UI
        function updateUI() {
            if (!userData) return;

            // Update balance
            document.getElementById('balanceAmount').textContent = `${userData.balance.toFixed(3)} TRM`;
            
            // Update level
            updateLevel();
            
            // Update profile
            updateProfile();
            
            // Update referral link
            updateReferralLink();
        }

        // Update Level
        function updateLevel() {
            let level = 'Bronze';
            let levelClass = 'level-bronze';

            if (userData.balance >= 50000) {
                level = 'Diamond';
                levelClass = 'level-diamond';
            } else if (userData.balance >= 10000) {
                level = 'Gold';
                levelClass = 'level-gold';
            }

            userData.level = level;
            
            document.getElementById('levelBadge').textContent = level.toUpperCase();
            document.getElementById('levelBadge').className = `level-badge ${levelClass}`;
            document.getElementById('profileLevel').textContent = level;
        }

        // Update Profile
        function updateProfile() {
            document.getElementById('profileName').textContent = userData.firstName + ' ' + userData.lastName;
            document.getElementById('profileId').textContent = `ID: ${userData.id}`;
            document.getElementById('profileFriends').textContent = userData.referrals || 0;
            document.getElementById('profileTotalEarned').textContent = `${userData.totalEarned.toFixed(3)} TRM`;
            
            if (userData.photoUrl) {
                document.getElementById('profileAvatar').src = userData.photoUrl;
            }

            // Update farming time
            const farmingHours = Math.floor((userData.totalEarned / userData.balance) * 12) || 0;
            document.getElementById('profileFarmingTime').textContent = `${farmingHours}h`;

            // Update wallet info
            if (userData.walletAddress) {
                document.getElementById('walletAddress').textContent = userData.walletAddress;
                document.getElementById('connectWalletButton').style.display = 'none';
                document.getElementById('copyWalletButton').style.display = 'block';
                document.getElementById('disconnectWalletButton').style.display = 'block';
            }

            // Update settings
            if (userData.settings) {
                Object.keys(userData.settings).forEach(key => {
                    const toggle = document.getElementById(key + 'Toggle');
                    if (toggle && userData.settings[key]) {
                        toggle.classList.add('active');
                    }
                });
            }
        }

        // Update Referral Link
        function updateReferralLink() {
            const referralLink = `https://t.me/TrimintBot/mine?startapp=${userData.id}`;
            document.getElementById('referralLink').value = referralLink;
            document.getElementById('totalReferrals').textContent = userData.referrals || 0;
            document.getElementById('referralEarnings').textContent = `${userData.referralEarnings || 0} TRM`;
        }

        // Switch Section
        function switchSection(sectionName) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Update sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName + 'Section').classList.add('active');
        }

        // Farming Functions
        async function startFarming(duration = 43200000) { // 12 hours in milliseconds
            if (!userData) return;

            userData.isFarming = true;
            userData.farmingEndTime = Date.now() + duration;

            const userRef = database.ref('users/' + userData.id);
            await userRef.update({
                isFarming: true,
                farmingEndTime: userData.farmingEndTime
            });

            const farmingButton = document.getElementById('farmingButton');
            const mainCoin = document.getElementById('mainCoin');
            const farmingTimer = document.getElementById('farmingTimer');

            farmingButton.textContent = 'Farming...';
            farmingButton.disabled = true;
            mainCoin.classList.add('farming');
            farmingTimer.style.display = 'block';

            // Start mining animation
            farmingInterval = setInterval(() => {
                mineToken();
                updateFarmingTimer();
            }, 1000);
        }

        function mineToken() {
            userData.balance += 0.001;
            userData.totalEarned += 0.001;
            
            updateUI();
            showTokenAnimation();
        }

        function showTokenAnimation() {
            const animation = document.createElement('div');
            animation.className = 'token-animation';
            animation.textContent = '+0.001 TRM';
            animation.style.left = Math.random() * window.innerWidth + 'px';
            animation.style.top = (window.innerHeight / 2) + 'px';
            document.body.appendChild(animation);

            setTimeout(() => {
                animation.remove();
            }, 2000);
        }

        function updateFarmingTimer() {
            if (!userData || !userData.farmingEndTime) return;

            const now = Date.now();
            const remaining = userData.farmingEndTime - now;

            if (remaining <= 0) {
                stopFarming();
            } else {
                const hours = Math.floor(remaining / 3600000);
                const minutes = Math.floor((remaining % 3600000) / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);

                document.getElementById('farmingTimer').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        async function stopFarming() {
            if (!userData) return;

            clearInterval(farmingInterval);
            farmingInterval = null;

            userData.isFarming = false;
            userData.farmingEndTime = null;

            const userRef = database.ref('users/' + userData.id);
            await userRef.update({
                isFarming: false,
                farmingEndTime: null,
                balance: userData.balance,
                totalEarned: userData.totalEarned
            });

            const farmingButton = document.getElementById('farmingButton');
            const mainCoin = document.getElementById('mainCoin');
            const farmingTimer = document.getElementById('farmingTimer');

            farmingButton.textContent = 'Start Farming';
            farmingButton.disabled = false;
            mainCoin.classList.remove('farming');
            farmingTimer.style.display = 'none';

            showToast('Farming completed! üéâ', 'success');

            // Auto farming if enabled
            if (userData.settings && userData.settings.autoFarming) {
                setTimeout(() => {
                    startFarming();
                }, 2000);
            }
        }

        // Farming button click handler
        document.getElementById('farmingButton').addEventListener('click', async function() {
            if (!userData.isFarming) {
                await startFarming();
            }
        });

        // Tasks Functions
        async function loadTasks() {
            const tasksRef = database.ref('tasks');
            tasksRef.on('value', (snapshot) => {
                const tasks = snapshot.val();
                const tasksList = document.getElementById('tasksList');
                
                // Clear existing tasks (except the Watch Ads task)
                const existingTasks = tasksList.querySelectorAll('.task-card');
                existingTasks.forEach((card, index) => {
                    if (index > 0) card.remove();
                });

                if (tasks) {
                    Object.keys(tasks).forEach(taskId => {
                        const task = tasks[taskId];
                        createTaskCard(task, taskId);
                    });
                }
            });
        }

        function createTaskCard(task, taskId) {
            const tasksList = document.getElementById('tasksList');
            
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card';
            taskCard.innerHTML = `
                <div class="task-header">
                    <img src="${task.photo || 'https://i.postimg.cc/fTQktNmX/maincoin.png'}" alt="${task.name}" class="task-icon">
                    <div class="task-info">
                        <div class="task-name">${task.name}</div>
                        <div class="task-reward">Reward: ${task.reward} TRM</div>
                    </div>
                </div>
                <div class="task-description">${task.description}</div>
                <button class="task-button" onclick="completeTask('${taskId}', '${task.link}', ${task.reward})">OPEN</button>
            `;
            
            tasksList.appendChild(taskCard);
        }

        async function completeTask(taskId, link, reward) {
            if (!userData) return;

            // Check if task already completed
            if (userData.tasksCompleted && userData.tasksCompleted.includes(taskId)) {
                window.open(link, '_blank');
                return;
            }

            const button = event.target;
            button.textContent = 'PROCESSING';
            button.className = 'task-button processing';
            button.disabled = true;

            // Open link
            window.open(link, '_blank');

            // Simulate processing time
            setTimeout(async () => {
                // Add reward to balance
                userData.balance += reward;
                userData.totalEarned += reward;
                
                if (!userData.tasksCompleted) {
                    userData.tasksCompleted = [];
                }
                userData.tasksCompleted.push(taskId);

                // Update database
                const userRef = database.ref('users/' + userData.id);
                await userRef.update({
                    balance: userData.balance,
                    totalEarned: userData.totalEarned,
                    tasksCompleted: userData.tasksCompleted
                });

                // Update button
                button.textContent = 'COMPLETED';
                button.className = 'task-button completed';
                button.disabled = false;

                // Update UI
                updateUI();
                
                showToast(`Task completed! +${reward} TRM`, 'success');
            }, 10000);
        }

        // Watch Ad Function
        function watchAd() {
            const button = event.target;
            button.textContent = 'WATCHING...';
            button.disabled = true;

            // Show Monetag ad (this is a placeholder - actual implementation would depend on Monetag SDK)
            if (typeof show_10290264 !== 'undefined') {
                show_10290264();
            }

            setTimeout(async () => {
                if (userData) {
                    userData.balance += 1;
                    userData.totalEarned += 1;

                    const userRef = database.ref('users/' + userData.id);
                    await userRef.update({
                        balance: userData.balance,
                        totalEarned: userData.totalEarned
                    });

                    updateUI();
                    showToast('Ad watched! +1 TRM', 'success');
                }

                button.textContent = 'OPEN';
                button.disabled = false;
            }, 3000);
        }

        // Leaderboard Functions
        async function loadLeaderboard() {
            const usersRef = database.ref('users');
            usersRef.orderByChild('balance').limitToLast(25).on('value', (snapshot) => {
                const users = snapshot.val();
                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = '';

                if (users) {
                    const sortedUsers = Object.values(users).sort((a, b) => b.balance - a.balance);
                    
                    sortedUsers.forEach((user, index) => {
                        createLeaderboardItem(user, index + 1);
                    });
                }
            });
        }

        function createLeaderboardItem(user, rank) {
            const leaderboardList = document.getElementById('leaderboardList');
            
            const item = document.createElement('div');
            item.className = 'leaderboard-item';
            
            let levelClass = 'level-bronze';
            if (user.balance >= 50000) levelClass = 'level-diamond';
            else if (user.balance >= 10000) levelClass = 'level-gold';

            item.innerHTML = `
                <div class="rank-number rank-${rank <= 3 ? rank : ''}">${rank}</div>
                <img src="${user.photoUrl || 'https://i.postimg.cc/fTQktNmX/maincoin.png'}" alt="${user.firstName}" class="user-avatar">
                <div class="user-info">
                    <div class="user-name">${user.firstName} ${user.lastName}</div>
                    <div class="user-balance">${user.balance.toFixed(3)} TRM</div>
                </div>
                <div class="user-level ${levelClass}">${(user.level || 'Bronze').toUpperCase()}</div>
            `;
            
            leaderboardList.appendChild(item);
        }

        // Friends Functions
        async function loadReferrals() {
            if (!userData) return;

            const referralListRef = database.ref('users/' + userData.id + '/referralList');
            referralListRef.on('value', (snapshot) => {
                const referrals = snapshot.val();
                const referralsList = document.getElementById('referralsList');
                referralsList.innerHTML = '';

                if (referrals) {
                    Object.values(referrals).forEach(async (referral) => {
                        const referredUserRef = database.ref('users/' + referral.referredUserId);
                        const referredUserSnapshot = await referredUserRef.once('value');
                        const referredUser = referredUserSnapshot.val();

                        if (referredUser) {
                            createReferralItem(referredUser);
                        }
                    });
                }
            });
        }

        function createReferralItem(user) {
            const referralsList = document.getElementById('referralsList');
            
            const item = document.createElement('div');
            item.className = 'referral-item';
            item.innerHTML = `
                <img src="${user.photoUrl || 'https://i.postimg.cc/fTQktNmX/maincoin.png'}" alt="${user.firstName}" class="user-avatar">
                <div class="user-info">
                    <div class="user-name">${user.firstName} ${user.lastName}</div>
                    <div class="user-balance">Balance: ${user.balance.toFixed(3)} TRM</div>
                    <div class="user-id">ID: ${user.id}</div>
                </div>
            `;
            
            referralsList.appendChild(item);
        }

        function copyReferralLink() {
            const referralLink = document.getElementById('referralLink');
            referralLink.select();
            document.execCommand('copy');
            showToast('Referral link copied!', 'success');
        }

        // Wallet Functions
        async function connectWallet() {
            try {
                // Initialize TON Connect UI
                if (!tonConnect) {
                    tonConnect = new TON_CONNECT_UI.TonConnectUI({
                        manifestUrl: 'https://trimint.vercel.app/tonconnect-manifest.json',
                        buttonRootId: null
                    });
                }

                const wallet = await tonConnect.connectWallet();
                
                if (wallet) {
                    const address = wallet.account.address;
                    const formattedAddress = formatTonAddress(address);
                    
                    userData.walletAddress = formattedAddress;
                    
                    const userRef = database.ref('users/' + userData.id);
                    await userRef.update({
                        walletAddress: formattedAddress
                    });

                    updateProfile();
                    showToast('Wallet connected successfully!', 'success');
                }
            } catch (error) {
                showToast('Failed to connect wallet', 'error');
                console.error('Wallet connection error:', error);
            }
        }

        function formatTonAddress(address) {
            return address.slice(0, 6) + '...' + address.slice(-4);
        }

        function copyWalletAddress() {
            if (userData.walletAddress) {
                navigator.clipboard.writeText(userData.walletAddress);
                showToast('Wallet address copied!', 'success');
            }
        }

        async function disconnectWallet() {
            if (tonConnect) {
                await tonConnect.disconnect();
            }

            userData.walletAddress = null;
            
            const userRef = database.ref('users/' + userData.id);
            await userRef.update({
                walletAddress: null
            });

            updateProfile();
            showToast('Wallet disconnected', 'success');
        }

        // Settings Functions
        async function toggleSetting(settingName) {
            if (!userData) return;

            const toggle = event.currentTarget;
            toggle.classList.toggle('active');

            if (!userData.settings) {
                userData.settings = {};
            }

            userData.settings[settingName] = !userData.settings[settingName];

            const userRef = database.ref('users/' + userData.id);
            await userRef.update({
                settings: userData.settings
            });

            showToast(`${settingName} ${userData.settings[settingName] ? 'enabled' : 'disabled'}`, 'success');
        }

        // Theme Toggle
        document.getElementById('themeToggle').addEventListener('click', function() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            body.setAttribute('data-theme', newTheme);
            this.textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            
            // Save theme preference
            if (userData) {
                const userRef = database.ref('users/' + userData.id);
                userRef.update({
                    theme: newTheme
                });
            }
        });

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Initialize App
        window.addEventListener('DOMContentLoaded', function() {
            initTelegramWebApp();

            // Listen for balance changes
            if (currentUser) {
                const userId = currentUser.id.toString();
                const userRef = database.ref('users/' + userId);
                
                userRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data !== userData) {
                        userData = data;
                        updateUI();
                    }
                });
            }
        });

        // Prevent context menu on mobile
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // Handle visibility change (app in background)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // App is in background
                if (farmingInterval) {
                    // Farming continues in background with Firebase
                }
            } else {
                // App is visible again
                if (userData && userData.isFarming && userData.farmingEndTime) {
                    const now = Date.now();
                    if (now < userData.farmingEndTime) {
                        // Resume farming display
                        updateFarmingTimer();
                    } else {
                        // Farming completed while app was in background
                        stopFarming();
                    }
                }
            }
        });
    </script>
</body>
</html>
