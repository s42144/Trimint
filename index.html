<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trimint - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --dark: #1f2937;
            --light: #f3f4f6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--gradient);
            color: var(--dark);
            min-height: 100vh;
            padding-bottom: 70px;
            position: relative;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 15px;
            margin: 0 auto;
        }

        /* Header Section */
        .header {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .header:hover {
            transform: translateY(-3px);
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            border: 3px solid var(--primary);
        }

        .user-info h2 {
            font-size: 18px;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .user-info p {
            font-size: 14px;
            color: #6B7280;
        }

        .user-level {
            margin-left: auto;
            background: var(--accent);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }

        /* Balance Section */
        .balance-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .balance-title {
            font-size: 16px;
            color: #6B7280;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .balance-token {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .token-icon {
            width: 80px;
            height: 80px;
            margin-right: 10px;
        }

        /* Farming Section */
        .farming-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .farming-button {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .farming-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .farming-button:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
        }

        .farming-timer {
            font-size: 18px;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .farming-rate {
            font-size: 14px;
            color: #6B7280;
        }

        .farming-animation {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            position: relative;
        }

        .coin {
            width: 100%;
            height: 100%;
            background: var(--warning);
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
            }
        }

        .token-addition {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 18px;
            animation: floatUp 2s ease-out forwards;
            pointer-events: none;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -150%);
            }
        }

        /* Leaderboard Section */
        .leaderboard-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 10px;
            color: var(--primary);
        }

        .leaderboard-list {
            list-style: none;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #E5E7EB;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-item.current-user {
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 5px;
        }

        .leaderboard-rank {
            width: 30px;
            height: 30px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
        }

        .leaderboard-info {
            flex-grow: 1;
        }

        .leaderboard-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .leaderboard-score {
            font-size: 14px;
            color: #6B7280;
        }

        .leaderboard-amount {
            font-weight: bold;
            color: var(--primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Quiz Section */
        .quiz-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .quiz-question {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--dark);
        }

        .quiz-options {
            list-style: none;
        }

        .quiz-option {
            background: var(--light);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-option:hover {
            background: #E5E7EB;
            transform: translateX(5px);
        }

        .quiz-option.selected {
            background: var(--primary);
            color: white;
        }

        .quiz-option.correct {
            background: var(--success);
            color: white;
        }

        .quiz-option.incorrect {
            background: var(--error);
            color: white;
        }

        .quiz-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .quiz-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-button:hover {
            background: #3A5BDB;
        }

        .quiz-button:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
        }

        /* Blog Section */
        .blog-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .blog-form {
            margin-bottom: 20px;
        }

        .blog-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #E5E7EB;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
        }

        .blog-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .blog-button:hover {
            background: #3A5BDB;
        }

        .blog-posts {
            list-style: none;
        }

        .blog-post {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .blog-author {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .blog-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .blog-name {
            font-weight: bold;
        }

        .blog-content {
            margin-bottom: 10px;
        }

        .blog-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .blog-action {
            display: flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
            color: #6B7280;
        }

        .blog-action:hover {
            color: var(--primary);
        }

        .blog-action i {
            margin-right: 5px;
        }

        .blog-delete {
            color: var(--error);
            cursor: pointer;
        }

        .blog-delete:hover {
            color: #dc2626;
        }

        /* Tasks Section */
        .tasks-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .task-item {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            margin-right: 15px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .task-info {
            flex-grow: 1;
        }

        .task-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .task-reward {
            font-size: 14px;
            color: var(--primary);
        }

        .task-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .task-button:hover {
            background: #3A5BDB;
        }

        .task-button.processing {
            background: var(--warning);
        }

        .task-button.completed {
            background: var(--success);
        }

        /* Friends Section */
        .friends-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .referral-link {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .referral-link-text {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 10px;
        }

        .referral-link-value {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
            word-break: break-all;
        }

        .copy-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-button:hover {
            background: #3A5BDB;
        }

        .referral-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .referral-stat {
            text-align: center;
        }

        .referral-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .referral-stat-label {
            font-size: 14px;
            color: #6B7280;
        }

        .referral-list {
            list-style: none;
        }

        .referral-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #E5E7EB;
        }

        .referral-item:last-child {
            border-bottom: none;
        }

        .referral-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
        }

        .referral-info {
            flex-grow: 1;
        }

        .referral-name {
            font-weight: bold;
        }

        .referral-date {
            font-size: 14px;
            color: #6B7280;
        }

        .referral-reward {
            font-weight: bold;
            color: var(--success);
        }

        /* Profile Section */
        .profile-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .profile-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 15px;
            border: 3px solid var(--primary);
        }

        .profile-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-level {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .profile-stat-label {
            font-size: 14px;
            color: #6B7280;
        }

        .wallet-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
        }

        .wallet-button:hover {
            background: #3A5BDB;
        }

        .wallet-button.connected {
            background: var(--success);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #6B7280;
            transition: all 0.3s ease;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .nav-item span {
            font-size: 12px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--dark);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(0);
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ads Container */
        .ads-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .ads-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--dark);
        }

        /* Comments Section */
        .comments-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #E5E7EB;
        }

        .comment-form {
            display: flex;
            margin-bottom: 10px;
        }

        .comment-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #E5E7EB;
            border-radius: 20px;
            margin-right: 10px;
        }

        .comment-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        .comments-list {
            list-style: none;
        }

        .comment-item {
            display: flex;
            margin-bottom: 10px;
        }

        .comment-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .comment-content {
            flex-grow: 1;
            background: #F9FAFB;
            padding: 8px 12px;
            border-radius: 10px;
        }

        .comment-author {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .comment-text {
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .balance-amount {
                font-size: 24px;
            }
            
            .farming-button {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Tab -->
        <div id="home-tab" class="tab-content active">
            <!-- User Header -->
            <div class="header" onclick="showProfile()">
                <img id="user-avatar" src="https://picsum.photos/seed/user123/60/60.jpg" alt="User Avatar" class="user-avatar">
                <div class="user-info">
                    <h2 id="user-name">Loading...</h2>
                    <p id="user-id">@username</p>
                </div>
                <div class="user-level">Level <span id="user-level">1</span></div>
            </div>

            <!-- Balance Card -->
            <div class="balance-card">
                <div class="balance-title">Your Balance</div>
                <div class="balance-token">
                    <img src="https://github.com/s42144/Trimint/blob/458d3d743b279877c11199b833cc212dffb5ef45/main.png?raw=true" alt="TRM Token" class="token-icon">
                </div>
                <div class="balance-amount" id="balance-amount">0.0000 TRM</div>
                <div class="balance-title">â‰ˆ $0.00 USD</div>
            </div>

            <!-- Farming Section -->
            <div class="farming-section">
                <div class="farming-animation">
                    <div class="coin" id="farming-coin">TRM</div>
                </div>
                <div class="farming-timer" id="farming-timer">Start farming to earn TRM</div>
                <div class="farming-rate">Rate: 0.001 TRM per second</div>
                <button class="farming-button" id="farming-button" onclick="toggleFarming()">Start Farming</button>
            </div>

            <!-- Leaderboard Section -->
            <div class="leaderboard-section">
                <div class="section-title">
                    <i class="fas fa-trophy"></i>
                    Leaderboard
                </div>
                <ul class="leaderboard-list" id="leaderboard-list">
                    <!-- Leaderboard items will be populated here -->
                </ul>
            </div>
        </div>

        <!-- Quiz Tab -->
        <div id="quiz-tab" class="tab-content">
            <div class="quiz-container">
                <div class="section-title">
                    <i class="fas fa-question-circle"></i>
                    TON Network Quiz
                </div>
                <div class="quiz-question" id="quiz-question">Loading quiz...</div>
                <ul class="quiz-options" id="quiz-options">
                    <!-- Quiz options will be populated here -->
                </ul>
                <div class="quiz-actions">
                    <div id="quiz-feedback"></div>
                    <button class="quiz-button" id="quiz-submit-button" onclick="submitQuizAnswer()" disabled>Submit Answer</button>
                    <button class="quiz-button" id="quiz-next-button" onclick="nextQuizQuestion()" style="display: none;">Next Question</button>
                </div>
            </div>
        </div>

        <!-- Blogs Tab -->
        <div id="blogs-tab" class="tab-content">
            <div class="blog-container">
                <div class="section-title">
                    <i class="fas fa-blog"></i>
                    Community Blogs
                </div>
                <div class="blog-form">
                    <textarea class="blog-textarea" id="blog-textarea" placeholder="Share your experience with Trimint..."></textarea>
                    <button class="blog-button" onclick="postBlog()">Post Blog</button>
                </div>
                <ul class="blog-posts" id="blog-posts">
                    <!-- Blog posts will be populated here -->
                </ul>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks-tab" class="tab-content">
            <div class="tasks-container">
                <div class="section-title">
                    <i class="fas fa-tasks"></i>
                    Complete Tasks for TRM
                </div>
                <div id="tasks-list">
                    <!-- Tasks will be populated here -->
                </div>
            </div>
            
            <!-- Ads Section -->
            <div class="ads-container">
                <div class="ads-title">Watch Ads for TRM</div>
                <div id="ads-container">
                    <!-- Ads will be displayed here -->
                </div>
                <button class="farming-button" id="watch-ads-button" onclick="watchAds()">Watch Ads (1 TRM)</button>
            </div>
        </div>

        <!-- Friends Tab -->
        <div id="friends-tab" class="tab-content">
            <div class="friends-container">
                <div class="section-title">
                    <i class="fas fa-user-friends"></i>
                    Invite Friends
                </div>
                <div class="referral-link">
                    <div class="referral-link-text">Your Referral Link</div>
                    <div class="referral-link-value" id="referral-link">http://t.me/TrimintBot/open?start=123456</div>
                    <button class="copy-button" onclick="copyReferralLink()">Copy Link</button>
                </div>
                <div class="referral-stats">
                    <div class="referral-stat">
                        <div class="referral-stat-value" id="total-referrals">0</div>
                        <div class="referral-stat-label">Total Referrals</div>
                    </div>
                    <div class="referral-stat">
                        <div class="referral-stat-value" id="referral-earnings">0</div>
                        <div class="referral-stat-label">Referral Earnings (TRM)</div>
                    </div>
                </div>
                <div class="section-title">
                    <i class="fas fa-users"></i>
                    Your Referrals
                </div>
                <ul class="referral-list" id="referral-list">
                    <!-- Referrals will be populated here -->
                </ul>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profile-tab" class="tab-content">
            <div class="profile-container">
                <div class="profile-header">
                    <img id="profile-avatar" src="https://picsum.photos/seed/user123/100/100.jpg" alt="Profile Avatar" class="profile-avatar">
                    <div class="profile-name" id="profile-name">Loading...</div>
                    <div class="profile-level">Level <span id="profile-level">1</span></div>
                </div>
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profile-level-stat">1</div>
                        <div class="profile-stat-label">Level</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profile-quizzes">0</div>
                        <div class="profile-stat-label">Completed Quizzes</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profile-friends">0</div>
                        <div class="profile-stat-label">Friends Invited</div>
                    </div>
                </div>
                <button class="wallet-button" id="wallet-button" onclick="connectTonWallet()">
                    <i class="fas fa-wallet"></i> Connect TON Wallet
                </button>
                <div class="section-title">
                    <i class="fas fa-chart-line"></i>
                    Your Activity
                </div>
                <div id="activity-list">
                    <!-- Activity items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showTab('home-tab')">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="showTab('quiz-tab')">
            <i class="fas fa-question-circle"></i>
            <span>Quiz</span>
        </div>
        <div class="nav-item" onclick="showTab('blogs-tab')">
            <i class="fas fa-blog"></i>
            <span>Blogs</span>
        </div>
        <div class="nav-item" onclick="showTab('tasks-tab')">
            <i class="fas fa-tasks"></i>
            <span>Tasks</span>
        </div>
        <div class="nav-item" onclick="showTab('friends-tab')">
            <i class="fas fa-user-friends"></i>
            <span>Friends</span>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Telegram Web App initialization
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // User data
        let user = {
            id: tg.initDataUnsafe.user?.id || 123456,
            firstName: tg.initDataUnsafe.user?.first_name || "User",
            lastName: tg.initDataUnsafe.user?.last_name || "",
            username: tg.initDataUnsafe.user?.username || "username",
            photoUrl: tg.initDataUnsafe.user?.photo_url || "https://picsum.photos/seed/user123/60/60.jpg",
            balance: 0,
            level: 1,
            completedQuizzes: 0,
            invitedFriends: 0,
            farming: false,
            farmingEndTime: null,
            walletConnected: false,
            tonWalletAddress: null
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            updateUI();
            loadLeaderboard();
            loadQuiz();
            loadBlogs();
            loadTasks();
            loadReferrals();
            checkFarmingStatus();
            initializeAds();
        });

        // Load user data from Firestore
        function loadUserData() {
            db.collection('users').doc(user.id.toString()).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        user = { ...user, ...userData };
                    } else {
                        // Create new user document
                        db.collection('users').doc(user.id.toString()).set(user);
                    }
                    updateUI();
                })
                .catch(error => {
                    console.error("Error getting user data:", error);
                    showToast("Failed to load user data");
                });
        }

        // Update UI with user data
        function updateUI() {
            document.getElementById('user-name').textContent = `${user.firstName} ${user.lastName}`;
            document.getElementById('user-id').textContent = `@${user.username}`;
            document.getElementById('user-avatar').src = user.photoUrl;
            document.getElementById('user-level').textContent = user.level;
            document.getElementById('balance-amount').textContent = `${user.balance.toFixed(4)} TRM`;
            
            document.getElementById('profile-name').textContent = `${user.firstName} ${user.lastName}`;
            document.getElementById('profile-avatar').src = user.photoUrl;
            document.getElementById('profile-level').textContent = user.level;
            document.getElementById('profile-level-stat').textContent = user.level;
            document.getElementById('profile-quizzes').textContent = user.completedQuizzes;
            document.getElementById('profile-friends').textContent = user.invitedFriends;
            
            document.getElementById('referral-link').textContent = `http://t.me/TrimintBot/open?start=${user.id}`;
            document.getElementById('total-referrals').textContent = user.invitedFriends;
            document.getElementById('referral-earnings').textContent = (user.invitedFriends * 5000).toFixed(4);
            
            if (user.walletConnected) {
                document.getElementById('wallet-button').innerHTML = '<i class="fas fa-check-circle"></i> TON Wallet Connected';
                document.getElementById('wallet-button').classList.add('connected');
            }
        }

        // Tab navigation
        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the corresponding nav item
            const navItems = document.querySelectorAll('.nav-item');
            const tabIndex = ['home-tab', 'quiz-tab', 'blogs-tab', 'tasks-tab', 'friends-tab'].indexOf(tabId);
            if (tabIndex !== -1 && navItems[tabIndex]) {
                navItems[tabIndex].classList.add('active');
            }
        }

        // Show profile tab
        function showProfile() {
            showTab('profile-tab');
            loadUserActivity();
        }

        // Load user activity
        function loadUserActivity() {
            db.collection('users').doc(user.id.toString()).collection('activities')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get()
                .then(snapshot => {
                    const activityList = document.getElementById('activity-list');
                    activityList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        activityList.innerHTML = '<p>No activity yet</p>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const activity = doc.data();
                        const activityItem = document.createElement('div');
                        activityItem.className = 'activity-item';
                        activityItem.innerHTML = `
                            <div class="activity-type">${activity.type}</div>
                            <div class="activity-description">${activity.description}</div>
                            <div class="activity-time">${new Date(activity.timestamp.toDate()).toLocaleString()}</div>
                        `;
                        activityList.appendChild(activityItem);
                    });
                })
                .catch(error => {
                    console.error("Error loading user activity:", error);
                });
        }

        // Connect TON Wallet
        function connectTonWallet() {
            if (!user.walletConnected) {
                // Open TON wallet connection page
                window.open('https://trimint.vercel.app/', '_blank');
                
                // Simulate wallet connection (in a real app, you would handle the callback)
                showToast('Connecting to TON wallet...');
                setTimeout(() => {
                    user.walletConnected = true;
                    user.tonWalletAddress = 'EQD...'; // Simulated address
                    
                    db.collection('users').doc(user.id.toString()).update({
                        walletConnected: user.walletConnected,
                        tonWalletAddress: user.tonWalletAddress
                    });
                    
                    updateUI();
                    showToast('TON wallet connected successfully!');
                }, 3000);
            } else {
                showToast('TON wallet already connected');
            }
        }

        // Farming functionality
        let farmingInterval;
        let farmingTimerInterval;

        function toggleFarming() {
            if (user.farming) {
                // Stop farming
                stopFarming();
            } else {
                // Start farming
                startFarming();
            }
        }

        function startFarming() {
            user.farming = true;
            user.farmingEndTime = new Date(Date.now() + 12 * 60 * 60 * 1000); // 12 hours from now
            
            db.collection('users').doc(user.id.toString()).update({
                farming: user.farming,
                farmingEndTime: user.farmingEndTime
            });
            
            document.getElementById('farming-button').textContent = 'Stop Farming';
            document.getElementById('farming-timer').textContent = 'Farming in progress...';
            
            // Add animation to coin
            document.getElementById('farming-coin').style.animation = 'pulse 2s infinite';
            
            // Start farming interval (add 0.001 TRM per second)
            farmingInterval = setInterval(() => {
                user.balance += 0.001;
                updateUI();
                
                // Show token addition animation
                showTokenAddition();
                
                // Update farming timer
                updateFarmingTimer();
            }, 1000);
            
            showToast('Farming started! You will earn 0.001 TRM per second.');
        }

        function stopFarming() {
            user.farming = false;
            user.farmingEndTime = null;
            
            db.collection('users').doc(user.id.toString()).update({
                farming: user.farming,
                farmingEndTime: firebase.firestore.FieldValue.delete()
            });
            
            document.getElementById('farming-button').textContent = 'Start Farming';
            document.getElementById('farming-timer').textContent = 'Start farming to earn TRM';
            
            // Remove animation from coin
            document.getElementById('farming-coin').style.animation = '';
            
            // Clear intervals
            clearInterval(farmingInterval);
            clearInterval(farmingTimerInterval);
            
            showToast('Farming stopped.');
        }

        function updateFarmingTimer() {
            if (!user.farming || !user.farmingEndTime) return;
            
            const now = new Date();
            const endTime = user.farmingEndTime.toDate();
            const remainingTime = Math.max(0, endTime - now);
            
            if (remainingTime <= 0) {
                stopFarming();
                showToast('Farming completed! You can start farming again.');
                return;
            }
            
            const hours = Math.floor(remainingTime / (1000 * 60 * 60));
            const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
            
            document.getElementById('farming-timer').textContent = `Time remaining: ${hours}h ${minutes}m ${seconds}s`;
        }

        function checkFarmingStatus() {
            if (user.farming && user.farmingEndTime) {
                const now = new Date();
                const endTime = user.farmingEndTime.toDate();
                
                if (endTime > now) {
                    // Continue farming
                    document.getElementById('farming-button').textContent = 'Stop Farming';
                    
                    // Add animation to coin
                    document.getElementById('farming-coin').style.animation = 'pulse 2s infinite';
                    
                    // Start farming interval
                    farmingInterval = setInterval(() => {
                        user.balance += 0.001;
                        updateUI();
                        updateFarmingTimer();
                        showTokenAddition();
                    }, 1000);
                    
                    // Update timer immediately
                    updateFarmingTimer();
                } else {
                    // Farming period ended
                    user.farming = false;
                    user.farmingEndTime = null;
                    
                    db.collection('users').doc(user.id.toString()).update({
                        farming: user.farming,
                        farmingEndTime: firebase.firestore.FieldValue.delete()
                    });
                }
            }
        }

        function showTokenAddition() {
            const farmingAnimation = document.querySelector('.farming-animation');
            const tokenAddition = document.createElement('div');
            tokenAddition.className = 'token-addition';
            tokenAddition.textContent = '+0.001 TRM';
            farmingAnimation.appendChild(tokenAddition);
            
            // Remove the element after animation completes
            setTimeout(() => {
                farmingAnimation.removeChild(tokenAddition);
            }, 2000);
        }

        // Load leaderboard
        function loadLeaderboard() {
            db.collection('users')
                .orderBy('balance', 'desc')
                .limit(25)
                .get()
                .then(snapshot => {
                    const leaderboardList = document.getElementById('leaderboard-list');
                    leaderboardList.innerHTML = '';
                    
                    let userRank = 0;
                    
                    snapshot.forEach((doc, index) => {
                        const userData = doc.data();
                        const leaderboardItem = document.createElement('li');
                        
                        // Check if this is the current user
                        const isCurrentUser = doc.id === user.id.toString();
                        if (isCurrentUser) {
                            userRank = index + 1;
                            leaderboardItem.className = 'leaderboard-item current-user';
                        } else {
                            leaderboardItem.className = 'leaderboard-item';
                        }
                        
                        leaderboardItem.innerHTML = `
                            <div class="leaderboard-rank">${index + 1}</div>
                            <img src="${userData.photoUrl || 'https://picsum.photos/seed/user' + doc.id + '/40/40.jpg'}" alt="${userData.firstName}" class="leaderboard-avatar">
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${userData.firstName} ${userData.lastName}</div>
                                <div class="leaderboard-score">Level ${userData.level || 1}</div>
                            </div>
                            <div class="leaderboard-amount">${userData.balance.toFixed(4)} TRM</div>
                        `;
                        
                        leaderboardList.appendChild(leaderboardItem);
                    });
                    
                    // If user is not in top 25, add them at the end
                    if (userRank === 0) {
                        // Get user's rank
                        db.collection('users')
                            .where('balance', '>', user.balance)
                            .get()
                            .then(countSnapshot => {
                                userRank = countSnapshot.size + 1;
                                
                                const userItem = document.createElement('li');
                                userItem.className = 'leaderboard-item current-user';
                                userItem.innerHTML = `
                                    <div class="leaderboard-rank">${userRank}</div>
                                    <img src="${user.photoUrl}" alt="${user.firstName}" class="leaderboard-avatar">
                                    <div class="leaderboard-info">
                                        <div class="leaderboard-name">${user.firstName} ${user.lastName}</div>
                                        <div class="leaderboard-score">Level ${user.level}</div>
                                    </div>
                                    <div class="leaderboard-amount">${user.balance.toFixed(4)} TRM</div>
                                `;
                                
                                leaderboardList.appendChild(userItem);
                            });
                    }
                })
                .catch(error => {
                    console.error("Error loading leaderboard:", error);
                    showToast("Failed to load leaderboard");
                });
        }

        // Quiz functionality
        let currentQuiz = null;
        let selectedAnswer = null;

        function loadQuiz() {
            // First, check if there are quizzes in the database
            db.collection('quizzes').get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        // If no quizzes in database, create default quizzes
                        createDefaultQuizzes().then(() => {
                            loadQuizFromDatabase();
                        });
                    } else {
                        loadQuizFromDatabase();
                    }
                })
                .catch(error => {
                    console.error("Error checking quizzes:", error);
                    showToast("Failed to load quiz");
                });
        }

        function createDefaultQuizzes() {
            const defaultQuizzes = [
                {
                    question: "What is TON Blockchain?",
                    options: [
                        "The Open Network",
                        "Telegram Only Network",
                        "Token Only Network",
                        "The Official Network"
                    ],
                    correctAnswer: 0,
                    reward: 1500,
                    active: true
                },
                {
                    question: "Who originally created TON?",
                    options: [
                        "Vitalik Buterin",
                        "Pavel Durov",
                        "Satoshi Nakamoto",
                        "Charles Hoskinson"
                    ],
                    correctAnswer: 1,
                    reward: 1500,
                    active: true
                },
                {
                    question: "What is the native token of TON?",
                    options: [
                        "TON",
                        "ETH",
                        "BTC",
                        "GRAM"
                    ],
                    correctAnswer: 0,
                    reward: 1500,
                    active: true
                },
                {
                    question: "What consensus mechanism does TON use?",
                    options: [
                        "Proof of Work",
                        "Proof of Stake",
                        "Proof of Authority",
                        "Delegated Proof of Stake"
                    ],
                    correctAnswer: 1,
                    reward: 1500,
                    active: true
                },
                {
                    question: "What is TON DNS?",
                    options: [
                        "A decentralized domain name system",
                        "A centralized DNS provider",
                        "A VPN service",
                        "A web browser"
                    ],
                    correctAnswer: 0,
                    reward: 1500,
                    active: true
                },
                {
                    question: "What is TON Storage?",
                    options: [
                        "A decentralized file storage system",
                        "A cloud storage service",
                        "A hardware wallet",
                        "A mining pool"
                    ],
                    correctAnswer: 0,
                    reward: 1500,
                    active: true
                },
                {
                    question: "What is TON Proxy?",
                    options: [
                        "A decentralized VPN service",
                        "A centralized proxy server",
                        "A web browser extension",
                        "A mining software"
                    ],
                    correctAnswer: 0,
                    reward: 1500,
                    active: true
                },
                {
                    question: "What programming language is used for smart contracts on TON?",
                    options: [
                        "Solidity",
                        "FunC",
                        "Rust",
                        "JavaScript"
                    ],
                    correctAnswer: 1,
                    reward: 1500,
                    active: true
                },
                {
                    question: "What is TON NFT?",
                    options: [
                        "A decentralized NFT standard",
                        "A centralized NFT marketplace",
                        "A digital art gallery",
                        "A gaming platform"
                    ],
                    correctAnswer: 0,
                    reward: 1500,
                    active: true
                },
                {
                    question: "What is TON Crystal?",
                    options: [
                        "A blockchain explorer",
                        "A cryptocurrency exchange",
                        "A hardware wallet",
                        "A mining pool"
                    ],
                    correctAnswer: 0,
                    reward: 1500,
                    active: true
                }
            ];

            const batch = db.batch();
            
            defaultQuizzes.forEach(quiz => {
                const docRef = db.collection('quizzes').doc();
                batch.set(docRef, quiz);
            });
            
            return batch.commit();
        }

        function loadQuizFromDatabase() {
            db.collection('quizzes')
                .where('active', '==', true)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        document.getElementById('quiz-question').textContent = 'No quizzes available at the moment.';
                        return;
                    }
                    
                    // Get a random quiz
                    const quizzes = [];
                    snapshot.forEach(doc => {
                        quizzes.push({ id: doc.id, ...doc.data() });
                    });
                    
                    currentQuiz = quizzes[Math.floor(Math.random() * quizzes.length)];
                    displayQuiz();
                })
                .catch(error => {
                    console.error("Error loading quiz:", error);
                    showToast("Failed to load quiz");
                });
        }

        function displayQuiz() {
            if (!currentQuiz) return;
            
            document.getElementById('quiz-question').textContent = currentQuiz.question;
            
            const optionsList = document.getElementById('quiz-options');
            optionsList.innerHTML = '';
            
            currentQuiz.options.forEach((option, index) => {
                const optionItem = document.createElement('li');
                optionItem.className = 'quiz-option';
                optionItem.textContent = option;
                optionItem.onclick = () => selectAnswer(index);
                optionsList.appendChild(optionItem);
            });
            
            // Reset UI
            selectedAnswer = null;
            document.getElementById('quiz-submit-button').disabled = true;
            document.getElementById('quiz-feedback').innerHTML = '';
            document.getElementById('quiz-next-button').style.display = 'none';
            document.getElementById('quiz-submit-button').style.display = 'inline-block';
        }

        function selectAnswer(index) {
            // Remove previous selection
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selection to clicked option
            document.querySelectorAll('.quiz-option')[index].classList.add('selected');
            selectedAnswer = index;
            
            // Enable submit button
            document.getElementById('quiz-submit-button').disabled = false;
        }

        function submitQuizAnswer() {
            if (selectedAnswer === null) return;
            
            // Check if answer is correct
            const isCorrect = selectedAnswer === currentQuiz.correctAnswer;
            
            // Show feedback
            const feedbackElement = document.getElementById('quiz-feedback');
            if (isCorrect) {
                feedbackElement.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success);"></i> Correct! You earned ' + currentQuiz.reward + ' TRM.';
                
                // Update user balance
                user.balance += currentQuiz.reward;
                user.completedQuizzes += 1;
                
                db.collection('users').doc(user.id.toString()).update({
                    balance: user.balance,
                    completedQuizzes: user.completedQuizzes
                });
                
                // Add activity
                addActivity('Quiz Completed', `Earned ${currentQuiz.reward} TRM by completing a quiz`);
                
                updateUI();
            } else {
                feedbackElement.innerHTML = '<i class="fas fa-times-circle" style="color: var(--error);"></i> Incorrect. Try again!';
            }
            
            // Highlight correct and incorrect answers
            document.querySelectorAll('.quiz-option').forEach((option, index) => {
                if (index === currentQuiz.correctAnswer) {
                    option.classList.add('correct');
                } else if (index === selectedAnswer && !isCorrect) {
                    option.classList.add('incorrect');
                }
            });
            
            // Disable options
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.onclick = null;
            });
            
            // Show next button and hide submit button
            document.getElementById('quiz-submit-button').style.display = 'none';
            document.getElementById('quiz-next-button').style.display = 'inline-block';
        }

        function nextQuizQuestion() {
            loadQuizFromDatabase();
        }

        // Blog functionality
        function loadBlogs() {
            db.collection('blogs')
                .orderBy('timestamp', 'desc')
                .get()
                .then(snapshot => {
                    const blogPosts = document.getElementById('blog-posts');
                    blogPosts.innerHTML = '';
                    
                    if (snapshot.empty) {
                        blogPosts.innerHTML = '<p>No blog posts yet. Be the first to share your experience!</p>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const blog = doc.data();
                        displayBlog(doc.id, blog);
                    });
                })
                .catch(error => {
                    console.error("Error loading blogs:", error);
                    showToast("Failed to load blogs");
                });
        }

        function displayBlog(blogId, blog) {
            const blogPosts = document.getElementById('blog-posts');
            const blogItem = document.createElement('li');
            blogItem.className = 'blog-post';
            blogItem.id = `blog-${blogId}`;
            
            const date = blog.timestamp.toDate();
            const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
            
            blogItem.innerHTML = `
                <div class="blog-author">
                    <img src="${blog.authorPhotoUrl || 'https://picsum.photos/seed/user' + blog.authorId + '/30/30.jpg'}" alt="${blog.authorName}" class="blog-avatar">
                    <div class="blog-name">${blog.authorName}</div>
                    <div class="blog-date">${formattedDate}</div>
                </div>
                <div class="blog-content">${blog.content}</div>
                <div class="blog-actions">
                    <div class="blog-action" onclick="likeBlog('${blogId}')">
                        <i class="fas fa-heart"></i>
                        <span id="likes-${blogId}">${blog.likes || 0}</span>
                    </div>
                    <div class="blog-action" onclick="toggleComments('${blogId}')">
                        <i class="fas fa-comment"></i>
                        <span id="comments-count-${blogId}">${blog.comments || 0}</span>
                    </div>
                    ${blog.authorId === user.id.toString() ? `<div class="blog-delete" onclick="deleteBlog('${blogId}')"><i class="fas fa-trash"></i></div>` : ''}
                </div>
                <div class="comments-section" id="comments-section-${blogId}" style="display: none;">
                    <div class="comment-form">
                        <input type="text" class="comment-input" id="comment-input-${blogId}" placeholder="Add a comment...">
                        <button class="comment-button" onclick="addComment('${blogId}')">Post</button>
                    </div>
                    <ul class="comments-list" id="comments-list-${blogId}">
                        <!-- Comments will be loaded here -->
                    </ul>
                </div>
            `;
            
            blogPosts.appendChild(blogItem);
            
            // Load comments for this blog
            loadComments(blogId);
        }

        function postBlog() {
            const content = document.getElementById('blog-textarea').value.trim();
            
            if (!content) {
                showToast('Please write something before posting.');
                return;
            }
            
            const blog = {
                authorId: user.id,
                authorName: `${user.firstName} ${user.lastName}`,
                authorPhotoUrl: user.photoUrl,
                content: content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                likes: 0,
                comments: 0
            };
            
            db.collection('blogs').add(blog)
                .then(() => {
                    document.getElementById('blog-textarea').value = '';
                    showToast('Blog posted successfully!');
                    loadBlogs();
                    
                    // Add activity
                    addActivity('Blog Posted', 'Shared your experience with the community');
                })
                .catch(error => {
                    console.error("Error posting blog:", error);
                    showToast("Failed to post blog");
                });
        }

        function deleteBlog(blogId) {
            if (confirm('Are you sure you want to delete this blog post?')) {
                db.collection('blogs').doc(blogId).delete()
                    .then(() => {
                        showToast('Blog post deleted successfully!');
                        document.getElementById(`blog-${blogId}`).remove();
                        
                        // Add activity
                        addActivity('Blog Deleted', 'Deleted your blog post');
                    })
                    .catch(error => {
                        console.error("Error deleting blog:", error);
                        showToast("Failed to delete blog post");
                    });
            }
        }

        function likeBlog(blogId) {
            // Check if user already liked this blog
            db.collection('blogs').doc(blogId).collection('likes').doc(user.id.toString()).get()
                .then(doc => {
                    if (doc.exists) {
                        // Unlike
                        db.collection('blogs').doc(blogId).collection('likes').doc(user.id.toString()).delete();
                        db.collection('blogs').doc(blogId).update({
                            likes: firebase.firestore.FieldValue.increment(-1)
                        });
                        showToast('Like removed');
                    } else {
                        // Like
                        db.collection('blogs').doc(blogId).collection('likes').doc(user.id.toString()).set({
                            userId: user.id,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        db.collection('blogs').doc(blogId).update({
                            likes: firebase.firestore.FieldValue.increment(1)
                        });
                        showToast('Liked!');
                    }
                    
                    // Update likes count
                    db.collection('blogs').doc(blogId).get().then(doc => {
                        if (doc.exists) {
                            const likes = doc.data().likes || 0;
                            document.getElementById(`likes-${blogId}`).textContent = likes;
                        }
                    });
                })
                .catch(error => {
                    console.error("Error liking blog:", error);
                    showToast("Failed to like blog");
                });
        }

        function toggleComments(blogId) {
            const commentsSection = document.getElementById(`comments-section-${blogId}`);
            if (commentsSection.style.display === 'none') {
                commentsSection.style.display = 'block';
            } else {
                commentsSection.style.display = 'none';
            }
        }

        function loadComments(blogId) {
            db.collection('blogs').doc(blogId).collection('comments')
                .orderBy('timestamp', 'desc')
                .get()
                .then(snapshot => {
                    const commentsList = document.getElementById(`comments-list-${blogId}`);
                    commentsList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        commentsList.innerHTML = '<p style="font-size: 14px; color: #6B7280;">No comments yet. Be the first to comment!</p>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const comment = doc.data();
                        const commentItem = document.createElement('li');
                        commentItem.className = 'comment-item';
                        
                        const date = comment.timestamp.toDate();
                        const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                        
                        commentItem.innerHTML = `
                            <img src="${comment.authorPhotoUrl || 'https://picsum.photos/seed/user' + comment.authorId + '/30/30.jpg'}" alt="${comment.authorName}" class="comment-avatar">
                            <div class="comment-content">
                                <div class="comment-author">${comment.authorName}</div>
                                <div class="comment-text">${comment.text}</div>
                            </div>
                        `;
                        
                        commentsList.appendChild(commentItem);
                    });
                })
                .catch(error => {
                    console.error("Error loading comments:", error);
                });
        }

        function addComment(blogId) {
            const commentInput = document.getElementById(`comment-input-${blogId}`);
            const text = commentInput.value.trim();
            
            if (!text) {
                showToast('Please write a comment.');
                return;
            }
            
            const comment = {
                authorId: user.id,
                authorName: `${user.firstName} ${user.lastName}`,
                authorPhotoUrl: user.photoUrl,
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('blogs').doc(blogId).collection('comments').add(comment)
                .then(() => {
                    commentInput.value = '';
                    
                    // Update comment count
                    db.collection('blogs').doc(blogId).update({
                        comments: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    // Reload comments
                    loadComments(blogId);
                    
                    // Update comment count in UI
                    db.collection('blogs').doc(blogId).get().then(doc => {
                        if (doc.exists) {
                            const comments = doc.data().comments || 0;
                            document.getElementById(`comments-count-${blogId}`).textContent = comments;
                        }
                    });
                    
                    showToast('Comment added!');
                })
                .catch(error => {
                    console.error("Error adding comment:", error);
                    showToast("Failed to add comment");
                });
        }

        // Tasks functionality
        function loadTasks() {
            // First, check if there are tasks in the database
            db.collection('tasks').get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        // If no tasks in database, create default tasks
                        createDefaultTasks().then(() => {
                            loadTasksFromDatabase();
                        });
                    } else {
                        loadTasksFromDatabase();
                    }
                })
                .catch(error => {
                    console.error("Error checking tasks:", error);
                    showToast("Failed to load tasks");
                });
        }

        function createDefaultTasks() {
            const defaultTasks = [
                {
                    name: "Join our Telegram Channel",
                    description: "Join our official Telegram channel for updates",
                    icon: "fab fa-telegram",
                    link: "https://t.me/trimint",
                    reward: 10,
                    active: true,
                    order: 1
                },
                {
                    name: "Follow us on Twitter",
                    description: "Follow our official Twitter account",
                    icon: "fab fa-twitter",
                    link: "https://twitter.com/trimint",
                    reward: 5,
                    active: true,
                    order: 2
                },
                {
                    name: "Visit our Website",
                    description: "Visit our official website for more information",
                    icon: "fas fa-globe",
                    link: "https://trimint.vercel.app",
                    reward: 5,
                    active: true,
                    order: 3
                },
                {
                    name: "Share on Social Media",
                    description: "Share about Trimint on your social media",
                    icon: "fas fa-share-alt",
                    link: "#",
                    reward: 15,
                    active: true,
                    order: 4
                },
                {
                    name: "Watch a Video",
                    description: "Watch our promotional video",
                    icon: "fas fa-play-circle",
                    link: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
                    reward: 8,
                    active: true,
                    order: 5
                }
            ];

            const batch = db.batch();
            
            defaultTasks.forEach(task => {
                const docRef = db.collection('tasks').doc();
                batch.set(docRef, task);
            });
            
            return batch.commit();
        }

        function loadTasksFromDatabase() {
            db.collection('tasks')
                .where('active', '==', true)
                .orderBy('order')
                .get()
                .then(snapshot => {
                    const tasksList = document.getElementById('tasks-list');
                    tasksList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        tasksList.innerHTML = '<p>No tasks available at the moment.</p>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const task = { id: doc.id, ...doc.data() };
                        displayTask(task);
                    });
                })
                .catch(error => {
                    console.error("Error loading tasks:", error);
                    showToast("Failed to load tasks");
                });
        }

        function displayTask(task) {
            const tasksList = document.getElementById('tasks-list');
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item';
            taskItem.id = `task-${task.id}`;
            
            // Check if user completed this task
            db.collection('users').doc(user.id.toString()).collection('completedTasks').doc(task.id).get()
                .then(taskDoc => {
                    const isCompleted = taskDoc.exists && !taskDoc.data().processing;
                    const isProcessing = taskDoc.exists && taskDoc.data().processing;
                    
                    let buttonText = 'OPEN';
                    let buttonClass = 'task-button';
                    
                    if (isProcessing) {
                        buttonText = 'PROCESSING';
                        buttonClass = 'task-button processing';
                    } else if (isCompleted) {
                        buttonText = 'COMPLETED';
                        buttonClass = 'task-button completed';
                    }
                    
                    taskItem.innerHTML = `
                        <div class="task-icon">
                            <i class="${task.icon || 'fas fa-tasks'}"></i>
                        </div>
                        <div class="task-info">
                            <div class="task-name">${task.name}</div>
                            <div class="task-reward">Reward: ${task.reward} TRM</div>
                        </div>
                        <button class="${buttonClass}" onclick="openTask('${task.id}', '${task.link}', ${task.reward})">${buttonText}</button>
                    `;
                });
            
            tasksList.appendChild(taskItem);
        }

        function openTask(taskId, link, reward) {
            // Check if task is already completed
            db.collection('users').doc(user.id.toString()).collection('completedTasks').doc(taskId).get()
                .then(doc => {
                    if (doc.exists && !doc.data().processing) {
                        // Task already completed, just open the link
                        window.open(link, '_blank');
                        return;
                    }
                    
                    if (doc.exists && doc.data().processing) {
                        // Task is processing, show remaining time
                        const startTime = doc.data().startTime.toDate();
                        const elapsed = Date.now() - startTime.getTime();
                        const remaining = Math.max(0, 10000 - elapsed); // 10 seconds processing time
                        
                        if (remaining > 0) {
                            showToast(`Please wait ${Math.ceil(remaining / 1000)} seconds before completing this task.`);
                            return;
                        } else {
                            // Processing time is over, complete the task
                            completeTask(taskId, reward);
                            return;
                        }
                    }
                    
                    // Start processing the task
                    db.collection('users').doc(user.id.toString()).collection('completedTasks').doc(taskId).set({
                        processing: true,
                        startTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Open the task link
                    window.open(link, '_blank');
                    
                    // Update UI
                    const taskItem = document.getElementById(`task-${taskId}`);
                    const button = taskItem.querySelector('.task-button');
                    button.textContent = 'PROCESSING';
                    button.className = 'task-button processing';
                    
                    // Set a timer to complete the task after 10 seconds
                    setTimeout(() => {
                        completeTask(taskId, reward);
                    }, 10000);
                })
                .catch(error => {
                    console.error("Error opening task:", error);
                    showToast("Failed to open task");
                });
        }

        function completeTask(taskId, reward) {
            // Update task status
            db.collection('users').doc(user.id.toString()).collection('completedTasks').doc(taskId).update({
                processing: false,
                completed: true,
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update user balance
            user.balance += reward;
            db.collection('users').doc(user.id.toString()).update({
                balance: user.balance
            });
            
            // Add activity
            addActivity('Task Completed', `Earned ${reward} TRM by completing a task`);
            
            updateUI();
            
            // Update UI
            const taskItem = document.getElementById(`task-${taskId}`);
            const button = taskItem.querySelector('.task-button');
            button.textContent = 'COMPLETED';
            button.className = 'task-button completed';
            
            showToast(`Task completed! You earned ${reward} TRM.`);
        }

        // Ads functionality
        function initializeAds() {
            // Initialize the monetag ads
            // This is a placeholder for the actual ads initialization
            console.log('Ads initialized');
        }

        function watchAds() {
            // Show the ads
            const adsContainer = document.getElementById('ads-container');
            adsContainer.innerHTML = '<div id="libtl-ad"></div>';
            
            // Initialize the ad
            // This is a placeholder for the actual ad display
            showToast('Loading ads...');
            
            // Simulate watching ads for 5 seconds
            setTimeout(() => {
                // Update user balance
                user.balance += 1;
                db.collection('users').doc(user.id.toString()).update({
                    balance: user.balance
                });
                
                // Add activity
                addActivity('Watched Ads', 'Earned 1 TRM by watching ads');
                
                updateUI();
                showToast('You earned 1 TRM by watching ads!');
                
                // Clear the ad container
                adsContainer.innerHTML = '';
            }, 5000);
        }

        // Friends/Referral functionality
        function loadReferrals() {
            db.collection('users').doc(user.id.toString()).collection('referrals')
                .orderBy('timestamp', 'desc')
                .get()
                .then(snapshot => {
                    const referralList = document.getElementById('referral-list');
                    referralList.innerHTML = '';
                    
                    if (snapshot.empty) {
                        referralList.innerHTML = '<p>No referrals yet. Invite your friends to earn TRM!</p>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const referral = doc.data();
                        const referralItem = document.createElement('li');
                        referralItem.className = 'referral-item';
                        
                        const date = referral.timestamp.toDate();
                        const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                        
                        referralItem.innerHTML = `
                            <img src="${referral.photoUrl || 'https://picsum.photos/seed/user' + referral.id + '/40/40.jpg'}" alt="${referral.name}" class="referral-avatar">
                            <div class="referral-info">
                                <div class="referral-name">${referral.name}</div>
                                <div class="referral-date">${formattedDate}</div>
                            </div>
                            <div class="referral-reward">+5000 TRM</div>
                        `;
                        
                        referralList.appendChild(referralItem);
                    });
                })
                .catch(error => {
                    console.error("Error loading referrals:", error);
                    showToast("Failed to load referrals");
                });
        }

        function copyReferralLink() {
            const referralLink = `http://t.me/TrimintBot/open?start=${user.id}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(referralLink)
                .then(() => {
                    showToast('Referral link copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    showToast('Failed to copy referral link');
                });
        }

        // Add user activity
        function addActivity(type, description) {
            db.collection('users').doc(user.id.toString()).collection('activities').add({
                type: type,
                description: description,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Check for referral on app load
        function checkReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const referralId = urlParams.get('start');
            
            if (referralId && referralId !== user.id.toString()) {
                // Add referral to referrer
                db.collection('users').doc(referralId).collection('referrals').doc(user.id.toString()).set({
                    id: user.id,
                    name: `${user.firstName} ${user.lastName}`,
                    photoUrl: user.photoUrl,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update referrer's balance and friend count
                db.collection('users').doc(referralId).update({
                    balance: firebase.firestore.FieldValue.increment(5000),
                    invitedFriends: firebase.firestore.FieldValue.increment(1)
                });
                
                // Add activity to referrer
                db.collection('users').doc(referralId).collection('activities').add({
                    type: 'New Referral',
                    description: `Invited ${user.firstName} ${user.lastName} and earned 5000 TRM`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Welcome! Your referrer has been rewarded.');
            }
        }

        // Initialize referral check
        checkReferral();
    </script>
</body>
</html>
