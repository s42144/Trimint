<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trimint - Telegram Mini App</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <!-- Monetag Ads Script -->
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
    
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #ec4899;
            --background-color: #111827;
            --card-background: #1f2937;
            --text-color: #f3f4f6;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s ease;
        }

        [data-theme="light"] {
            --primary-color: #4f46e5;
            --secondary-color: #7c3aed;
            --accent-color: #db2777;
            --background-color: #f9fafb;
            --card-background: #ffffff;
            --text-color: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 100%;
            padding: 15px;
            margin: 0 auto;
            flex: 1;
            padding-bottom: 80px;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: var(--text-color);
        }

        .referral-info {
            margin-top: 10px;
            font-size: 16px;
            color: var(--primary-color);
            text-align: center;
            max-width: 80%;
        }

        /* Header */
        header {
            background-color: var(--card-background);
            padding: 15px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: var(--transition);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 20px;
        }

        .logo img {
            width: 30px;
            height: 30px;
        }

        .balance {
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: var(--primary-color);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .balance img {
            width: 20px;
            height: 20px;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Navigation */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--card-background);
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            z-index: 100;
            transition: var(--transition);
        }

        .nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--primary-color);
            background-color: rgba(99, 102, 241, 0.1);
        }

        .nav-item:hover {
            background-color: rgba(99, 102, 241, 0.05);
        }

        .nav-item.home {
            position: relative;
            transform: scale(1.1);
        }

        .nav-item.home::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            z-index: -1;
            opacity: 0.2;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-text {
            font-size: 12px;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Section */
        .coin-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
        }

        .coin {
            width: 150px;
            height: 150px;
            background: url('https://i.postimg.cc/fTQktNmX/maincoin.png') no-repeat center;
            background-size: contain;
            margin-bottom: 20px;
            position: relative;
            transition: transform 0.3s ease;
        }

        .coin:hover {
            transform: scale(1.05);
        }

        .coin.farming {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .farming-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            opacity: 0;
            animation: farmingPulse 2s infinite;
        }

        @keyframes farmingPulse {
            0% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 0.5; }
            100% { opacity: 0; transform: scale(1.2); }
        }

        .farming-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .farming-timer {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .farming-rate {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            font-size: 16px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Tasks Section */
        .task-item {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .task-item:hover {
            transform: translateY(-3px);
        }

        .task-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .task-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .task-reward {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--success-color);
            font-weight: bold;
        }

        .task-reward img {
            width: 16px;
            height: 16px;
        }

        .task-description {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 14px;
        }

        .task-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .task-button:hover {
            background-color: var(--secondary-color);
        }

        .task-button.processing {
            background-color: var(--warning-color);
        }

        .task-button.completed {
            background-color: var(--success-color);
        }

        /* Leaderboard Section */
        .leaderboard-tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: var(--card-background);
            border-radius: 10px;
            overflow: hidden;
        }

        .leaderboard-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .leaderboard-tab.active {
            background-color: var(--primary-color);
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: var(--card-background);
            padding: 15px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .leaderboard-item:hover {
            transform: translateY(-3px);
        }

        .leaderboard-rank {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
        }

        .leaderboard-rank.gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .leaderboard-rank.silver {
            background: linear-gradient(135deg, #C0C0C0, #808080);
        }

        .leaderboard-rank.bronze {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
        }

        .leaderboard-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .leaderboard-level {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .leaderboard-balance {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }

        .leaderboard-balance img {
            width: 16px;
            height: 16px;
        }

        /* Friends Section */
        .referral-card {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .referral-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .referral-link-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .referral-link {
            flex: 1;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
            word-break: break-all;
        }

        .copy-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .copy-button:hover {
            background-color: var(--secondary-color);
        }

        .referral-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .referrals-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .referral-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: var(--card-background);
            padding: 15px;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .referral-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
        }

        .referral-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .referral-info {
            flex: 1;
        }

        .referral-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .referral-earned {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Profile Section */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--primary-color);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-level {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .profile-level.bronze {
            background-color: #CD7F32;
            color: white;
        }

        .profile-level.gold {
            background-color: #FFD700;
            color: #333;
        }

        .profile-level.diamond {
            background: linear-gradient(135deg, #39C5BB, #004D7A);
            color: white;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .profile-stat {
            background-color: var(--card-background);
            padding: 15px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .profile-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .profile-stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .wallet-section {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .wallet-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .wallet-address {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
            word-break: break-all;
            margin-bottom: 10px;
            display: none;
        }

        .wallet-address.connected {
            display: block;
        }

        .wallet-buttons {
            display: flex;
            gap: 10px;
        }

        .wallet-button {
            flex: 1;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: bold;
        }

        .wallet-button:hover {
            background-color: var(--secondary-color);
        }

        .wallet-button.disconnect {
            background-color: var(--error-color);
        }

        .wallet-button.disconnect:hover {
            background-color: #dc2626;
        }

        .settings-section {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .settings-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-label {
            font-size: 16px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background-color: var(--border-color);
            border-radius: 13px;
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-switch.active {
            background-color: var(--primary-color);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle-switch.active::after {
            left: 27px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-background);
            color: var(--text-color);
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: var(--shadow);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .profile-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Trimint...</div>
        <div class="referral-info" id="referralInfo"></div>
    </div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="Trimint">
                <span>Trimint</span>
            </div>
            <div class="balance">
                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM">
                <span id="userBalance">0</span>
            </div>
            <button class="theme-toggle" id="themeToggle">
                <span id="themeIcon">üåô</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Home Section -->
        <section class="section active" id="homeSection">
            <div class="coin-container">
                <div class="coin" id="coin">
                    <div class="farming-animation" id="farmingAnimation"></div>
                </div>
                <div class="farming-info">
                    <div class="farming-timer" id="farmingTimer">Start farming to earn TRM</div>
                    <div class="farming-rate" id="farmingRate">0.001 TRM per second</div>
                </div>
                <button class="btn" id="startFarmingBtn">Start Farming</button>
            </div>
        </section>

        <!-- Tasks Section -->
        <section class="section" id="tasksSection">
            <div class="task-item">
                <div class="task-header">
                    <div class="task-icon">
                        <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="Watch Ads">
                    </div>
                    <div class="task-info">
                        <div class="task-name">Watch Ads</div>
                        <div class="task-reward">
                            <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM">
                            <span>1 TRM</span>
                        </div>
                    </div>
                </div>
                <div class="task-description">Watch an advertisement to earn 1 TRM token</div>
                <button class="task-button" id="watchAdsBtn">OPEN</button>
            </div>
            <div id="tasksList"></div>
        </section>

        <!-- Leaderboard Section -->
        <section class="section" id="leaderboardSection">
            <div class="leaderboard-tabs">
                <div class="leaderboard-tab active" data-period="daily">Daily</div>
                <div class="leaderboard-tab" data-period="weekly">Weekly</div>
                <div class="leaderboard-tab" data-period="all-time">All Time</div>
            </div>
            <div class="leaderboard-list" id="leaderboardList"></div>
        </section>

        <!-- Friends Section -->
        <section class="section" id="friendsSection">
            <div class="referral-card">
                <div class="referral-title">Invite Friends</div>
                <div class="referral-link-container">
                    <div class="referral-link" id="referralLink"></div>
                    <button class="copy-button" id="copyReferralBtn">Copy</button>
                </div>
                <div class="referral-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="referralEarnings">0</div>
                        <div class="stat-label">TRM Earned</div>
                    </div>
                </div>
            </div>
            <div class="referrals-list" id="referralsList"></div>
        </section>

        <!-- Profile Section -->
        <section class="section" id="profileSection">
            <div class="profile-header">
                <div class="profile-avatar">
                    <img id="profileAvatar" src="" alt="Profile">
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="profileName"></div>
                    <div class="profile-level" id="profileLevel">Bronze</div>
                </div>
            </div>
            <div class="profile-stats">
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileBalance">0</div>
                    <div class="profile-stat-label">TRM Balance</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileFriends">0</div>
                    <div class="profile-stat-label">Friends Invited</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileTasks">0</div>
                    <div class="profile-stat-label">Tasks Completed</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileFarming">0</div>
                    <div class="profile-stat-label">Hours Farmed</div>
                </div>
            </div>
            <div class="wallet-section">
                <div class="wallet-title">TON Wallet</div>
                <div class="wallet-address" id="walletAddress"></div>
                <div class="wallet-buttons">
                    <button class="wallet-button" id="connectWalletBtn">Connect Wallet</button>
                    <button class="wallet-button disconnect" id="disconnectWalletBtn" style="display: none;">Disconnect</button>
                    <button class="wallet-button" id="copyAddressBtn" style="display: none;">Copy Address</button>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">Settings</div>
                <div class="setting-item">
                    <div class="setting-label">Notifications</div>
                    <div class="toggle-switch active" id="notificationsToggle"></div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">Sound Effects</div>
                    <div class="toggle-switch active" id="soundToggle"></div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">Auto-Farming</div>
                    <div class="toggle-switch" id="autoFarmingToggle"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="nav-item home active" data-section="homeSection">
                <div class="nav-icon">üè†</div>
                <div class="nav-text">Home</div>
            </div>
            <div class="nav-item" data-section="tasksSection">
                <div class="nav-icon">üìã</div>
                <div class="nav-text">Tasks</div>
            </div>
            <div class="nav-item" data-section="leaderboardSection">
                <div class="nav-icon">üèÜ</div>
                <div class="nav-text">Leaderboard</div>
            </div>
            <div class="nav-item" data-section="friendsSection">
                <div class="nav-icon">üë•</div>
                <div class="nav-text">Friends</div>
            </div>
            <div class="nav-item" data-section="profileSection">
                <div class="nav-icon">üë§</div>
                <div class="nav-text">Profile</div>
            </div>
        </div>
    </nav>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Telegram Bot API Key
        const TELEGRAM_BOT_TOKEN = "8099896534:AAFmOTkOjLC8RSSJy-dXtjPQotF3hJlyXTQ";

        // TON Connect Configuration
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://trimint.vercel.app/tonconnect-manifest.json',
            buttonRootId: null
        });

        // Global Variables
        let currentUser = null;
        let userData = null;
        let farmingInterval = null;
        let farmingEndTime = null;
        let tasks = [];
        let leaderboard = [];
        let referrals = [];

        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const referralInfo = document.getElementById('referralInfo');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const userBalance = document.getElementById('userBalance');
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.section');
        const coin = document.getElementById('coin');
        const farmingAnimation = document.getElementById('farmingAnimation');
        const farmingTimer = document.getElementById('farmingTimer');
        const farmingRate = document.getElementById('farmingRate');
        const startFarmingBtn = document.getElementById('startFarmingBtn');
        const watchAdsBtn = document.getElementById('watchAdsBtn');
        const tasksList = document.getElementById('tasksList');
        const leaderboardTabs = document.querySelectorAll('.leaderboard-tab');
        const leaderboardList = document.getElementById('leaderboardList');
        const referralLink = document.getElementById('referralLink');
        const copyReferralBtn = document.getElementById('copyReferralBtn');
        const totalReferrals = document.getElementById('totalReferrals');
        const referralEarnings = document.getElementById('referralEarnings');
        const referralsList = document.getElementById('referralsList');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileLevel = document.getElementById('profileLevel');
        const profileBalance = document.getElementById('profileBalance');
        const profileFriends = document.getElementById('profileFriends');
        const profileTasks = document.getElementById('profileTasks');
        const profileFarming = document.getElementById('profileFarming');
        const walletAddress = document.getElementById('walletAddress');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const disconnectWalletBtn = document.getElementById('disconnectWalletBtn');
        const copyAddressBtn = document.getElementById('copyAddressBtn');
        const notificationsToggle = document.getElementById('notificationsToggle');
        const soundToggle = document.getElementById('soundToggle');
        const autoFarmingToggle = document.getElementById('autoFarmingToggle');
        const toast = document.getElementById('toast');

        // Initialize App
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.setBackgroundColor('#111827');
                window.Telegram.WebApp.setHeaderColor('#111827');
            }

            // Check theme preference
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);

            // Initialize user data
            await initializeUser();

            // Load tasks from Firebase
            await loadTasks();

            // Load leaderboard from Firebase
            await loadLeaderboard('daily');

            // Load referrals from Firebase
            await loadReferrals();

            // Check if user is farming
            checkFarmingStatus();

            // Hide loading screen after initialization
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, 1500);

            // Set up event listeners
            setupEventListeners();
        });

        // Initialize User
        async function initializeUser() {
            // Get Telegram user data
            let telegramUser = null;
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
            }

            // If no Telegram user, use a mock user for development
            if (!telegramUser) {
                telegramUser = {
                    id: 123456789,
                    first_name: 'Test',
                    last_name: 'User',
                    username: 'testuser',
                    photo_url: 'https://picsum.photos/seed/user123/200/200.jpg'
                };
            }

            // Check if user exists in Firebase
            const userDoc = await db.collection('users').doc(telegramUser.id.toString()).get();

            if (!userDoc.exists) {
                // Create new user
                const newUser = {
                    telegramId: telegramUser.id,
                    firstName: telegramUser.first_name,
                    lastName: telegramUser.last_name || '',
                    username: telegramUser.username || '',
                    photoUrl: telegramUser.photo_url || '',
                    balance: 0,
                    level: 'Bronze',
                    totalFriendsInvited: 0,
                    totalTasksCompleted: 0,
                    totalHoursFarmed: 0,
                    referralCode: generateReferralCode(telegramUser.id),
                    referredBy: null,
                    walletAddress: null,
                    settings: {
                        notifications: true,
                        soundEffects: true,
                        autoFarming: false
                    },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActiveAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Check if user was referred
                const urlParams = new URLSearchParams(window.location.search);
                const referralCode = urlParams.get('startapp');
                if (referralCode) {
                    const referrerId = referralCode.split('_')[1];
                    if (referrerId) {
                        newUser.referredBy = referrerId;
                        
                        // Update referrer's stats
                        await db.collection('users').doc(referrerId).update({
                            totalFriendsInvited: firebase.firestore.FieldValue.increment(1),
                            balance: firebase.firestore.FieldValue.increment(5000),
                            lastActiveAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Add referral record
                        await db.collection('referrals').add({
                            referrerId: referrerId,
                            referredId: telegramUser.id.toString(),
                            referredName: `${telegramUser.first_name} ${telegramUser.last_name || ''}`,
                            reward: 5000,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Show referral info on loading screen
                        const referrerDoc = await db.collection('users').doc(referrerId).get();
                        if (referrerDoc.exists) {
                            const referrerData = referrerDoc.data();
                            referralInfo.textContent = `You were invited by ${referrerData.firstName} ${referrerData.lastName || ''}`;
                        }
                    }
                }

                await db.collection('users').doc(telegramUser.id.toString()).set(newUser);
                userData = newUser;
            } else {
                userData = userDoc.data();
                
                // Update last active time
                await db.collection('users').doc(telegramUser.id.toString()).update({
                    lastActiveAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            currentUser = telegramUser;
            updateUI();
        }

        // Generate Referral Code
        function generateReferralCode(userId) {
            return `ref_${userId}`;
        }

        // Update UI with User Data
        function updateUI() {
            if (!userData) return;

            // Update header balance
            userBalance.textContent = userData.balance.toFixed(2);

            // Update profile
            profileAvatar.src = userData.photoUrl || 'https://picsum.photos/seed/default/200/200.jpg';
            profileName.textContent = `${userData.firstName} ${userData.lastName || ''}`;
            profileLevel.textContent = userData.level;
            profileLevel.className = `profile-level ${userData.level.toLowerCase()}`;
            profileBalance.textContent = userData.balance.toFixed(2);
            profileFriends.textContent = userData.totalFriendsInvited;
            profileTasks.textContent = userData.totalTasksCompleted;
            profileFarming.textContent = userData.totalHoursFarmed;

            // Update referral link
            referralLink.textContent = `https://t.me/TrimintBot/open?startapp=${userData.referralCode}`;

            // Update wallet
            if (userData.walletAddress) {
                walletAddress.textContent = userData.walletAddress;
                walletAddress.classList.add('connected');
                connectWalletBtn.textContent = 'Connected';
                connectWalletBtn.disabled = true;
                disconnectWalletBtn.style.display = 'block';
                copyAddressBtn.style.display = 'block';
            }

            // Update settings
            notificationsToggle.classList.toggle('active', userData.settings.notifications);
            soundToggle.classList.toggle('active', userData.settings.soundEffects);
            autoFarmingToggle.classList.toggle('active', userData.settings.autoFarming);
        }

        // Load Tasks from Firebase
        async function loadTasks() {
            try {
                const tasksSnapshot = await db.collection('tasks').orderBy('order', 'asc').get();
                tasks = [];
                
                tasksSnapshot.forEach(doc => {
                    tasks.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                renderTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
                showToast('Failed to load tasks. Please try again.');
            }
        }

        // Render Tasks
        function renderTasks() {
            tasksList.innerHTML = '';
            
            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                
                const isCompleted = userData.completedTasks && userData.completedTasks.includes(task.id);
                const buttonClass = isCompleted ? 'completed' : '';
                const buttonText = isCompleted ? 'Completed' : 'OPEN';
                
                taskElement.innerHTML = `
                    <div class="task-header">
                        <div class="task-icon">
                            <img src="${task.iconUrl || 'https://i.postimg.cc/fTQktNmX/maincoin.png'}" alt="${task.name}">
                        </div>
                        <div class="task-info">
                            <div class="task-name">${task.name}</div>
                            <div class="task-reward">
                                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM">
                                <span>${task.reward} TRM</span>
                            </div>
                        </div>
                    </div>
                    <div class="task-description">${task.description}</div>
                    <button class="task-button ${buttonClass}" data-task-id="${task.id}" data-task-link="${task.link}" data-task-reward="${task.reward}">${buttonText}</button>
                `;
                
                tasksList.appendChild(taskElement);
            });

            // Add event listeners to task buttons
            document.querySelectorAll('.task-button').forEach(button => {
                button.addEventListener('click', handleTaskClick);
            });
        }

        // Handle Task Click
        async function handleTaskClick(e) {
            const button = e.target;
            const taskId = button.getAttribute('data-task-id');
            const taskLink = button.getAttribute('data-task-link');
            const taskReward = parseFloat(button.getAttribute('data-task-reward'));
            
            if (button.classList.contains('completed')) {
                // Still open the link even if completed
                window.open(taskLink, '_blank');
                return;
            }
            
            if (button.classList.contains('processing')) {
                return; // Already processing
            }
            
            // Change button state to processing
            button.classList.add('processing');
            button.textContent = 'Processing...';
            
            // Open the task link
            window.open(taskLink, '_blank');
            
            // Simulate processing time (10 seconds)
            setTimeout(async () => {
                try {
                    // Update user balance
                    const newBalance = userData.balance + taskReward;
                    await db.collection('users').doc(currentUser.id.toString()).update({
                        balance: newBalance,
                        totalTasksCompleted: userData.totalTasksCompleted + 1,
                        completedTasks: firebase.firestore.FieldValue.arrayUnion(taskId),
                        lastActiveAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local user data
                    userData.balance = newBalance;
                    userData.totalTasksCompleted += 1;
                    if (!userData.completedTasks) userData.completedTasks = [];
                    userData.completedTasks.push(taskId);
                    
                    // Update UI
                    updateUI();
                    
                    // Change button state to completed
                    button.classList.remove('processing');
                    button.classList.add('completed');
                    button.textContent = 'Completed';
                    
                    showToast(`You earned ${taskReward} TRM!`);
                } catch (error) {
                    console.error('Error completing task:', error);
                    showToast('Failed to complete task. Please try again.');
                    
                    // Reset button state
                    button.classList.remove('processing');
                    button.textContent = 'OPEN';
                }
            }, 10000);
        }

        // Load Leaderboard from Firebase
        async function loadLeaderboard(period) {
            try {
                let query;
                const now = new Date();
                
                if (period === 'daily') {
                    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    query = db.collection('users')
                        .orderBy('balance', 'desc')
                        .where('lastActiveAt', '>=', startOfDay)
                        .limit(25);
                } else if (period === 'weekly') {
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    query = db.collection('users')
                        .orderBy('balance', 'desc')
                        .where('lastActiveAt', '>=', startOfWeek)
                        .limit(25);
                } else {
                    query = db.collection('users')
                        .orderBy('balance', 'desc')
                        .limit(25);
                }
                
                const leaderboardSnapshot = await query.get();
                leaderboard = [];
                
                leaderboardSnapshot.forEach(doc => {
                    leaderboard.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                renderLeaderboard();
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                showToast('Failed to load leaderboard. Please try again.');
            }
        }

        // Render Leaderboard
        function renderLeaderboard() {
            leaderboardList.innerHTML = '';
            
            leaderboard.forEach((user, index) => {
                const leaderboardItem = document.createElement('div');
                leaderboardItem.className = 'leaderboard-item';
                
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
                
                leaderboardItem.innerHTML = `
                    <div class="leaderboard-rank ${rankClass}">${index + 1}</div>
                    <div class="leaderboard-avatar">
                        <img src="${user.photoUrl || 'https://picsum.photos/seed/user' + user.id + '/200/200.jpg'}" alt="${user.firstName}">
                    </div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${user.firstName} ${user.lastName || ''}</div>
                        <div class="leaderboard-level">${user.level}</div>
                    </div>
                    <div class="leaderboard-balance">
                        <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM">
                        <span>${user.balance.toFixed(2)}</span>
                    </div>
                `;
                
                leaderboardList.appendChild(leaderboardItem);
            });
        }

        // Load Referrals from Firebase
        async function loadReferrals() {
            try {
                const referralsSnapshot = await db.collection('referrals')
                    .where('referrerId', '==', currentUser.id.toString())
                    .orderBy('createdAt', 'desc')
                    .get();
                
                referrals = [];
                let totalEarnings = 0;
                
                referralsSnapshot.forEach(doc => {
                    const referral = {
                        id: doc.id,
                        ...doc.data()
                    };
                    referrals.push(referral);
                    totalEarnings += referral.reward;
                });
                
                // Update UI
                totalReferrals.textContent = referrals.length;
                referralEarnings.textContent = totalEarnings.toFixed(2);
                
                renderReferrals();
            } catch (error) {
                console.error('Error loading referrals:', error);
                showToast('Failed to load referrals. Please try again.');
            }
        }

        // Render Referrals
        function renderReferrals() {
            referralsList.innerHTML = '';
            
            referrals.forEach(referral => {
                const referralItem = document.createElement('div');
                referralItem.className = 'referral-item';
                
                referralItem.innerHTML = `
                    <div class="referral-avatar">
                        <img src="https://picsum.photos/seed/user' + ${referral.referredId} + '/200/200.jpg" alt="${referral.referredName}">
                    </div>
                    <div class="referral-info">
                        <div class="referral-name">${referral.referredName}</div>
                        <div class="referral-earned">Earned: ${referral.reward} TRM</div>
                    </div>
                `;
                
                referralsList.appendChild(referralItem);
            });
        }

        // Check Farming Status
        function checkFarmingStatus() {
            // Check if user has an active farming session
            if (userData.farmingEndTime) {
                const now = new Date().getTime();
                const endTime = new Date(userData.farmingEndTime).getTime();
                
                if (now < endTime) {
                    // User is still farming
                    startFarming(endTime - now);
                } else {
                    // Farming session has ended, collect rewards
                    collectFarmingRewards();
                }
            }
        }

        // Start Farming
        function startFarming(duration = 43200000) { // 12 hours in milliseconds
            const now = new Date().getTime();
            const endTime = now + duration;
            
            // Update UI
            coin.classList.add('farming');
            farmingAnimation.style.display = 'block';
            startFarmingBtn.textContent = 'Farming...';
            startFarmingBtn.disabled = true;
            
            // Save farming end time to Firebase
            db.collection('users').doc(currentUser.id.toString()).update({
                farmingEndTime: new Date(endTime),
                lastActiveAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                userData.farmingEndTime = new Date(endTime);
            });
            
            // Start countdown
            updateFarmingTimer(endTime);
            farmingInterval = setInterval(() => {
                updateFarmingTimer(endTime);
            }, 1000);
            
            // Add TRM every second
            const earningInterval = setInterval(() => {
                if (new Date().getTime() >= endTime) {
                    clearInterval(earningInterval);
                    collectFarmingRewards();
                    return;
                }
                
                // Update balance in UI
                userData.balance += 0.001;
                updateUI();
                
                // Show earning animation
                showEarningAnimation();
            }, 1000);
            
            farmingEndTime = endTime;
        }

        // Update Farming Timer
        function updateFarmingTimer(endTime) {
            const now = new Date().getTime();
            const remaining = endTime - now;
            
            if (remaining <= 0) {
                clearInterval(farmingInterval);
                collectFarmingRewards();
                return;
            }
            
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            farmingTimer.textContent = `Farming: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Show Earning Animation
        function showEarningAnimation() {
            const earningElement = document.createElement('div');
            earningElement.className = 'earning-animation';
            earningElement.textContent = '+0.001 TRM';
            earningElement.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: #10b981;
                font-weight: bold;
                font-size: 16px;
                pointer-events: none;
                animation: floatUp 2s ease-out forwards;
            `;
            
            coin.appendChild(earningElement);
            
            // Remove element after animation
            setTimeout(() => {
                coin.removeChild(earningElement);
            }, 2000);
        }

        // Collect Farming Rewards
        async function collectFarmingRewards() {
            try {
                // Calculate total earnings (12 hours * 3600 seconds * 0.001 TRM)
                const totalEarnings = 43.2;
                
                // Update user balance and stats
                const newBalance = userData.balance + totalEarnings;
                const newHoursFarmed = userData.totalHoursFarmed + 12;
                
                await db.collection('users').doc(currentUser.id.toString()).update({
                    balance: newBalance,
                    totalHoursFarmed: newHoursFarmed,
                    farmingEndTime: null,
                    lastActiveAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local user data
                userData.balance = newBalance;
                userData.totalHoursFarmed = newHoursFarmed;
                userData.farmingEndTime = null;
                
                // Update UI
                updateUI();
                
                // Reset farming UI
                coin.classList.remove('farming');
                farmingAnimation.style.display = 'none';
                farmingTimer.textContent = 'Start farming to earn TRM';
                startFarmingBtn.textContent = 'Start Farming';
                startFarmingBtn.disabled = false;
                
                showToast(`You earned ${totalEarnings} TRM from farming!`);
                
                // Check if auto-farming is enabled
                if (userData.settings.autoFarming) {
                    setTimeout(() => {
                        startFarming();
                    }, 1000);
                }
            } catch (error) {
                console.error('Error collecting farming rewards:', error);
                showToast('Failed to collect farming rewards. Please try again.');
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Theme toggle
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
                
                // Update Telegram Web App theme
                if (window.Telegram && window.Telegram.WebApp) {
                    if (newTheme === 'dark') {
                        window.Telegram.WebApp.setBackgroundColor('#111827');
                        window.Telegram.WebApp.setHeaderColor('#111827');
                    } else {
                        window.Telegram.WebApp.setBackgroundColor('#f9fafb');
                        window.Telegram.WebApp.setHeaderColor('#f9fafb');
                    }
                }
            });
            
            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const targetSection = item.getAttribute('data-section');
                    
                    // Update active nav item
                    navItems.forEach(navItem => navItem.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Update active section
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById(targetSection).classList.add('active');
                    
                    // Load section-specific data
                    if (targetSection === 'leaderboardSection') {
                        const activeTab = document.querySelector('.leaderboard-tab.active');
                        loadLeaderboard(activeTab.getAttribute('data-period'));
                    }
                });
            });
            
            // Start farming button
            startFarmingBtn.addEventListener('click', () => {
                if (!startFarmingBtn.disabled) {
                    startFarming();
                }
            });
            
            // Watch ads button
            watchAdsBtn.addEventListener('click', () => {
                if (watchAdsBtn.classList.contains('processing') || watchAdsBtn.classList.contains('completed')) {
                    return;
                }
                
                // Change button state to processing
                watchAdsBtn.classList.add('processing');
                watchAdsBtn.textContent = 'Processing...';
                
                // Show ad
                // Note: This is a placeholder for the actual ad implementation
                // You would integrate the Monetag ad SDK here
                setTimeout(() => {
                    // Simulate ad completion
                    try {
                        // Update user balance
                        const newBalance = userData.balance + 1;
                        db.collection('users').doc(currentUser.id.toString()).update({
                            balance: newBalance,
                            lastActiveAt: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(() => {
                            // Update local user data
                            userData.balance = newBalance;
                            
                            // Update UI
                            updateUI();
                            
                            // Change button state to completed
                            watchAdsBtn.classList.remove('processing');
                            watchAdsBtn.classList.add('completed');
                            watchAdsBtn.textContent = 'Completed';
                            
                            showToast('You earned 1 TRM from watching an ad!');
                        });
                    } catch (error) {
                        console.error('Error completing ad task:', error);
                        showToast('Failed to complete ad task. Please try again.');
                        
                        // Reset button state
                        watchAdsBtn.classList.remove('processing');
                        watchAdsBtn.textContent = 'OPEN';
                    }
                }, 5000); // Simulate 5 seconds of ad watching
            });
            
            // Leaderboard tabs
            leaderboardTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update active tab
                    leaderboardTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Load leaderboard data
                    loadLeaderboard(tab.getAttribute('data-period'));
                });
            });
            
            // Copy referral link
            copyReferralBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(referralLink.textContent).then(() => {
                    showToast('Referral link copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy referral link:', err);
                    showToast('Failed to copy referral link. Please try again.');
                });
            });
            
            // Connect wallet button
            connectWalletBtn.addEventListener('click', async () => {
                try {
                    await tonConnectUI.connectWallet();
                    const wallet = tonConnectUI.wallet;
                    
                    if (wallet) {
                        const address = wallet.account.address;
                        
                        // Update user data in Firebase
                        await db.collection('users').doc(currentUser.id.toString()).update({
                            walletAddress: address,
                            lastActiveAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Update local user data
                        userData.walletAddress = address;
                        
                        // Update UI
                        walletAddress.textContent = address;
                        walletAddress.classList.add('connected');
                        connectWalletBtn.textContent = 'Connected';
                        connectWalletBtn.disabled = true;
                        disconnectWalletBtn.style.display = 'block';
                        copyAddressBtn.style.display = 'block';
                        
                        showToast('Wallet connected successfully!');
                    }
                } catch (error) {
                    console.error('Error connecting wallet:', error);
                    showToast('Failed to connect wallet. Please try again.');
                }
            });
            
            // Disconnect wallet button
            disconnectWalletBtn.addEventListener('click', async () => {
                try {
                    await tonConnectUI.disconnect();
                    
                    // Update user data in Firebase
                    await db.collection('users').doc(currentUser.id.toString()).update({
                        walletAddress: null,
                        lastActiveAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local user data
                    userData.walletAddress = null;
                    
                    // Update UI
                    walletAddress.textContent = '';
                    walletAddress.classList.remove('connected');
                    connectWalletBtn.textContent = 'Connect Wallet';
                    connectWalletBtn.disabled = false;
                    disconnectWalletBtn.style.display = 'none';
                    copyAddressBtn.style.display = 'none';
                    
                    showToast('Wallet disconnected successfully!');
                } catch (error) {
                    console.error('Error disconnecting wallet:', error);
                    showToast('Failed to disconnect wallet. Please try again.');
                }
            });
            
            // Copy wallet address button
            copyAddressBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(walletAddress.textContent).then(() => {
                    showToast('Wallet address copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy wallet address:', err);
                    showToast('Failed to copy wallet address. Please try again.');
                });
            });
            
            // Settings toggles
            notificationsToggle.addEventListener('click', async () => {
                const newValue = !notificationsToggle.classList.contains('active');
                notificationsToggle.classList.toggle('active', newValue);
                
                // Update user data in Firebase
                await db.collection('users').doc(currentUser.id.toString()).update({
                    'settings.notifications': newValue,
                    lastActiveAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local user data
                userData.settings.notifications = newValue;
                
                showToast(`Notifications ${newValue ? 'enabled' : 'disabled'}!`);
            });
            
            soundToggle.addEventListener('click', async () => {
                const newValue = !soundToggle.classList.contains('active');
                soundToggle.classList.toggle('active', newValue);
                
                // Update user data in Firebase
                await db.collection('users').doc(currentUser.id.toString()).update({
                    'settings.soundEffects': newValue,
                    lastActiveAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local user data
                userData.settings.soundEffects = newValue;
                
                showToast(`Sound effects ${newValue ? 'enabled' : 'disabled'}!`);
            });
            
            autoFarmingToggle.addEventListener('click', async () => {
                const newValue = !autoFarmingToggle.classList.contains('active');
                autoFarmingToggle.classList.toggle('active', newValue);
                
                // Update user data in Firebase
                await db.collection('users').doc(currentUser.id.toString()).update({
                    'settings.autoFarming': newValue,
                    lastActiveAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local user data
                userData.settings.autoFarming = newValue;
                
                showToast(`Auto-farming ${newValue ? 'enabled' : 'disabled'}!`);
            });
        }

        // Update Theme Icon
        function updateThemeIcon(theme) {
            themeIcon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }

        // Show Toast Notification
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Add CSS animation for floating up effect
        const style = document.createElement('style');
        style.textContent = `
            @keyframes floatUp {
                0% {
                    opacity: 1;
                    transform: translate(-50%, -50%);
                }
                100% {
                    opacity: 0;
                    transform: translate(-50%, -150%);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
