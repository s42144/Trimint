<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trimint - Telegram Mini App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            position: relative;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        /* Telegram User Header */
        .user-header {
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
            padding: 20px;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .user-header:active {
            transform: scale(0.98);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .user-details h2 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .user-level {
            background: rgba(255, 255, 255, 0.2);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: inline-block;
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            padding-bottom: 100px;
            min-height: calc(100vh - 200px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Coin Section */
        .coin-section {
            text-align: center;
            margin: 30px 0;
        }

        .coin-container {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .coin {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.5);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .coin.farming {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 15px 40px rgba(255, 215, 0, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 20px 50px rgba(255, 215, 0, 0.8); }
        }

        .coin img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }

        .balance {
            font-size: 28px;
            font-weight: bold;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .farm-button {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            color: white;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(56, 239, 125, 0.4);
            margin: 15px 0;
        }

        .farm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(56, 239, 125, 0.6);
        }

        .farm-button:disabled {
            background: linear-gradient(135deg, #666 0%, #999 100%);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .farming-timer {
            margin-top: 10px;
            font-size: 14px;
            color: #FFD700;
            min-height: 20px;
        }

        .token-animation {
            position: absolute;
            top: -20px;
            right: -10px;
            color: #FFD700;
            font-weight: bold;
            font-size: 14px;
            animation: floatUp 2s ease-out;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        /* Quiz Section */
        .quiz-question {
            font-size: 18px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiz-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #4ECDC4;
        }

        .quiz-option.correct {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }

        .quiz-option.incorrect {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
        }

        /* Blog Section */
        .blog-post {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .blog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .blog-author {
            font-weight: bold;
            color: #4ECDC4;
        }

        .blog-content {
            margin: 10px 0;
            line-height: 1.6;
        }

        .blog-actions {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .blog-action {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .blog-action:hover {
            color: #FFD700;
        }

        .blog-action.liked {
            color: #FF6B6B;
        }

        /* Tasks Section */
        .task-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .task-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .task-details {
            flex: 1;
        }

        .task-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .task-reward {
            color: #FFD700;
            font-size: 14px;
        }

        .task-button {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .task-button:hover {
            transform: scale(1.05);
        }

        .task-button:disabled {
            background: linear-gradient(135deg, #666 0%, #999 100%);
            cursor: not-allowed;
        }

        /* Friends Section */
        .referral-link {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .referral-link-text {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }

        .copy-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .copy-button:hover {
            transform: scale(1.05);
        }

        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
        }

        .stat-label {
            font-size: 14px;
            margin-top: 5px;
        }

        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .leaderboard-item.current-user {
            background: rgba(255, 215, 0, 0.2);
            border-color: #FFD700;
        }

        .rank-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .rank-number.top-3 {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        .leaderboard-name {
            flex: 1;
            font-weight: bold;
        }

        .leaderboard-score {
            color: #FFD700;
            font-weight: bold;
        }

        /* Profile Section */
        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .profile-stat {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .profile-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4ECDC4;
        }

        .profile-stat-label {
            font-size: 14px;
            margin-top: 5px;
            opacity: 0.8;
        }

        .wallet-button {
            background: linear-gradient(135deg, #0088CC 0%, #00AAFF 100%);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            width: 100%;
            justify-content: center;
        }

        .wallet-button:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 170, 255, 0.4);
        }

        .wallet-connected {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px 15px;
            border-radius: 15px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            color: #FFD700;
        }

        .nav-icon {
            font-size: 20px;
        }

        .nav-label {
            font-size: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .modal-close:hover {
            transform: rotate(90deg);
        }

        /* Input fields */
        .input-field {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #4ECDC4;
            background: rgba(255, 255, 255, 0.15);
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 10px 0;
            width: 100%;
        }

        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 25px rgba(56, 239, 125, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 10px 0;
            width: 100%;
        }

        .btn-secondary:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            z-index: 3000;
            animation: slideDown 0.3s ease;
            display: none;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); }
            to { transform: translateX(-50%) translateY(0); }
        }

        /* Ads container */
        .ads-container {
            margin: 20px 0;
            min-height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .coin {
                width: 120px;
                height: 120px;
            }
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <div class="container">
        <!-- Telegram User Header -->
        <div class="user-header" onclick="showProfile()">
            <div class="user-info">
                <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=FF6B6B&color=fff" alt="User Avatar" class="user-avatar">
                <div class="user-details">
                    <h2 id="userName">Loading...</h2>
                    <span class="user-level" id="userLevel">Level 1</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Home Section -->
            <div class="section active" id="homeSection">
                <div class="coin-section">
                    <div class="coin-container">
                        <div class="coin" id="coin">
                            <img src="https://raw.githubusercontent.com/s42144/Trimint/main.png" alt="TRM Coin">
                        </div>
                    </div>
                    <div class="balance" id="balance">0 TRM</div>
                    <button class="farm-button" id="farmButton" onclick="toggleFarming()">
                        Start Farming
                    </button>
                    <div class="farming-timer" id="farmingTimer"></div>
                </div>

                <!-- Quick Stats -->
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="userRank">25</div>
                        <div class="profile-stat-label">Your Rank</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="referralCount">0</div>
                        <div class="profile-stat-label">Referrals</div>
                    </div>
                </div>

                <!-- Ads -->
                <div class="ads-container">
                    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
                </div>
            </div>

            <!-- Quiz Section -->
            <div class="section" id="quizSection">
                <div class="card">
                    <h3>TON Network Quiz</h3>
                    <div id="quizContainer">
                        <div class="quiz-question" id="quizQuestion">Loading quiz...</div>
                        <div class="quiz-options" id="quizOptions"></div>
                    </div>
                </div>
            </div>

            <!-- Blog Section -->
            <div class="section" id="blogSection">
                <button class="btn-primary" onclick="showCreateBlogModal()">
                    <i class="fas fa-plus"></i> Create New Post
                </button>
                <div id="blogContainer"></div>
            </div>

            <!-- Tasks Section -->
            <div class="section" id="tasksSection">
                <div id="tasksContainer">
                    <div class="task-item">
                        <div class="task-icon">
                            <i class="fas fa-ad"></i>
                        </div>
                        <div class="task-details">
                            <div class="task-name">Watch Ads</div>
                            <div class="task-reward">+1 TRM</div>
                        </div>
                        <button class="task-button" onclick="watchAds()">
                            OPEN
                        </button>
                    </div>
                </div>
            </div>

            <!-- Friends Section -->
            <div class="section" id="friendsSection">
                <div class="referral-link">
                    <h3>Your Referral Link</h3>
                    <div class="referral-link-text" id="referralLink">Generating...</div>
                    <button class="copy-button" onclick="copyReferralLink()">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>

                <div class="referral-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="referralEarnings">0</div>
                        <div class="stat-label">Referral Earnings</div>
                    </div>
                </div>

                <h3>Your Referrals</h3>
                <div id="referralsList"></div>
            </div>

            <!-- Leaderboard Section -->
            <div class="section" id="leaderboardSection">
                <h3>Top 25 Players</h3>
                <div id="leaderboardContainer"></div>
            </div>

            <!-- Profile Section -->
            <div class="section" id="profileSection">
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profileLevel">1</div>
                        <div class="profile-stat-label">Level</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="completedQuizzes">0</div>
                        <div class="profile-stat-label">Completed Quizzes</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="totalFriends">0</div>
                        <div class="profile-stat-label">Friends Invited</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profileRank">25</div>
                        <div class="profile-stat-label">Rank</div>
                    </div>
                </div>

                <button class="wallet-button" id="walletButton" onclick="connectTONWallet()">
                    <i class="fas fa-wallet"></i>
                    Connect TON Wallet
                </button>

                <div class="card">
                    <h3>Account Settings</h3>
                    <button class="btn-secondary" onclick="showToast('Settings coming soon!')">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showSection('home')">
                <i class="fas fa-home nav-icon"></i>
                <span class="nav-label">Home</span>
            </div>
            <div class="nav-item" onclick="showSection('quiz')">
                <i class="fas fa-question-circle nav-icon"></i>
                <span class="nav-label">Quiz</span>
            </div>
            <div class="nav-item" onclick="showSection('blog')">
                <i class="fas fa-blog nav-icon"></i>
                <span class="nav-label">Blogs</span>
            </div>
            <div class="nav-item" onclick="showSection('tasks')">
                <i class="fas fa-tasks nav-icon"></i>
                <span class="nav-label">Tasks</span>
            </div>
            <div class="nav-item" onclick="showSection('friends')">
                <i class="fas fa-users nav-icon"></i>
                <span class="nav-label">Friends</span>
            </div>
        </div>
    </div>

    <!-- Modal for creating blog post -->
    <div class="modal" id="createBlogModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('createBlogModal')">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="modal-header">Create New Blog Post</h3>
            <textarea class="input-field" id="blogContent" placeholder="Share your experience..." rows="5"></textarea>
            <button class="btn-primary" onclick="createBlogPost()">
                <i class="fas fa-paper-plane"></i> Publish Post
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics-compat.js"></script>

    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // Initialize Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Initialize TON Connect
        let tonConnectUI;
        let tonWalletConnected = false;

        // Global variables
        let currentUser = null;
        let userData = {
            balance: 0,
            level: 1,
            completedQuizzes: 0,
            referrals: [],
            farmingStartTime: null,
            farmingEndTime: null,
            isFarming: false,
            tonWallet: null
        };

        // Quiz questions
        const quizQuestions = [
            {
                question: "What is TON Blockchain?",
                options: ["Telegram's blockchain", "Ethereum competitor", "Bitcoin fork", "Solana alternative"],
                correct: 0
            },
            {
                question: "What is TON Coin (TON)?",
                options: ["Native cryptocurrency of TON", "Stablecoin", "NFT token", "Governance token only"],
                correct: 0
            },
            {
                question: "Who created TON Blockchain?",
                options: ["Telegram team", "Vitalik Buterin", "Satoshi Nakamoto", "Changpeng Zhao"],
                correct: 0
            },
            {
                question: "What is TON's consensus mechanism?",
                options: ["Proof-of-Stake", "Proof-of-Work", "Delegated Proof-of-Stake", "Proof-of-Authority"],
                correct: 0
            },
            {
                question: "What is TON DNS?",
                options: ["Naming system for TON", "DNS resolver", "Web hosting", "Domain registrar"],
                correct: 0
            },
            {
                question: "What are TON NFTs?",
                options: ["Non-fungible tokens on TON", "Fungible tokens", "Stablecoins", "Privacy tokens"],
                correct: 0
            },
            {
                question: "What is TON Storage?",
                options: ["Decentralized storage", "Cloud storage", "Database", "File system"],
                correct: 0
            },
            {
                question: "What is TON Proxy?",
                options: ["Network proxy", "VPN service", "Load balancer", "CDN"],
                correct: 0
            },
            {
                question: "What programming language is used for TON smart contracts?",
                options: ["FunC", "Solidity", "Rust", "Python"],
                correct: 0
            },
            {
                question: "What is the TON virtual machine called?",
                options: ["TVM", "EVM", "WASM", "BVM"],
                correct: 0
            }
        ];

        let currentQuizIndex = 0;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadUserData();
            loadTasks();
            loadBlogPosts();
            loadLeaderboard();
            initializeTONConnect();
        });

        // Initialize Telegram Web App
        function initializeApp() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                currentUser = tg.initDataUnsafe.user;
                document.getElementById('userName').textContent = currentUser.first_name + ' ' + (currentUser.last_name || '');
                document.getElementById('userAvatar').src = currentUser.photo_url || `https://ui-avatars.com/api/?name=${currentUser.first_name}&background=FF6B6B&color=fff`;
                
                // Generate referral link
                const referralLink = `http://t.me/TrimintBot/open?startapp=${currentUser.id}`;
                document.getElementById('referralLink').textContent = referralLink;
            } else {
                // Fallback for testing
                document.getElementById('userName').textContent = 'Test User';
                document.getElementById('userAvatar').src = 'https://ui-avatars.com/api/?name=Test+User&background=FF6B6B&color=fff';
                const referralLink = 'http://t.me/TrimintBot/open?startapp=123456';
                document.getElementById('referralLink').textContent = referralLink;
            }
        }

        // Load user data from Firebase
        async function loadUserData() {
            if (!currentUser) return;

            try {
                const userDoc = await db.collection('users').doc(currentUser.id.toString()).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                } else {
                    // Create new user
                    await db.collection('users').doc(currentUser.id.toString()).set(userData);
                }

                updateUI();
                checkFarmingStatus();
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Error loading user data');
            }
        }

        // Save user data to Firebase
        async function saveUserData() {
            if (!currentUser) return;

            try {
                await db.collection('users').doc(currentUser.id.toString()).set(userData);
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        // Update UI with user data
        function updateUI() {
            document.getElementById('balance').textContent = userData.balance.toFixed(3) + ' TRM';
            document.getElementById('userLevel').textContent = 'Level ' + userData.level;
            document.getElementById('profileLevel').textContent = userData.level;
            document.getElementById('completedQuizzes').textContent = userData.completedQuizzes;
            document.getElementById('totalFriends').textContent = userData.referrals.length;
            document.getElementById('referralCount').textContent = userData.referrals.length;
            document.getElementById('totalReferrals').textContent = userData.referrals.length;
            document.getElementById('referralEarnings').textContent = (userData.referrals.length * 5000) + ' TRM';
            
            updateReferralsList();
        }

        // Farming functionality
        function toggleFarming() {
            if (userData.isFarming) {
                stopFarming();
            } else {
                startFarming();
            }
        }

        function startFarming() {
            userData.isFarming = true;
            userData.farmingStartTime = Date.now();
            userData.farmingEndTime = Date.now() + (12 * 60 * 60 * 1000); // 12 hours
            
            document.getElementById('farmButton').textContent = 'Stop Farming';
            document.getElementById('farmButton').disabled = true;
            document.getElementById('coin').classList.add('farming');
            
            saveUserData();
            updateFarmingTimer();
            
            // Start token generation
            farmingInterval = setInterval(generateToken, 1000);
        }

        function stopFarming() {
            userData.isFarming = false;
            userData.farmingStartTime = null;
            userData.farmingEndTime = null;
            
            document.getElementById('farmButton').textContent = 'Start Farming';
            document.getElementById('farmButton').disabled = false;
            document.getElementById('coin').classList.remove('farming');
            document.getElementById('farmingTimer').textContent = '';
            
            if (farmingInterval) {
                clearInterval(farmingInterval);
                farmingInterval = null;
            }
            
            saveUserData();
        }

        function generateToken() {
            userData.balance += 0.001;
            updateUI();
            showTokenAnimation();
            
            // Check if 12 hours completed
            if (Date.now() >= userData.farmingEndTime) {
                stopFarming();
                showToast('Farming completed! You earned 43.2 TRM');
            }
        }

        function showTokenAnimation() {
            const coinContainer = document.querySelector('.coin-container');
            const tokenAnim = document.createElement('div');
            tokenAnim.className = 'token-animation';
            tokenAnim.textContent = '+0.001 TRM';
            coinContainer.appendChild(tokenAnim);
            
            setTimeout(() => {
                tokenAnim.remove();
            }, 2000);
        }

        let farmingInterval;

        function updateFarmingTimer() {
            if (!userData.isFarming) return;

            const now = Date.now();
            const remaining = userData.farmingEndTime - now;
            
            if (remaining <= 0) {
                stopFarming();
                return;
            }

            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

            document.getElementById('farmingTimer').textContent = 
                `Time remaining: ${hours}h ${minutes}m ${seconds}s`;

            setTimeout(updateFarmingTimer, 1000);
        }

        async function checkFarmingStatus() {
            if (userData.isFarming && userData.farmingEndTime) {
                if (Date.now() >= userData.farmingEndTime) {
                    stopFarming();
                } else {
                    document.getElementById('farmButton').textContent = 'Stop Farming';
                    document.getElementById('farmButton').disabled = true;
                    document.getElementById('coin').classList.add('farming');
                    updateFarmingTimer();
                    farmingInterval = setInterval(generateToken, 1000);
                }
            }
        }

        // Quiz functionality
        function loadQuiz() {
            const question = quizQuestions[currentQuizIndex];
            document.getElementById('quizQuestion').textContent = question.question;
            
            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'quiz-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(optionDiv);
            });
        }

        function selectAnswer(selectedIndex) {
            const question = quizQuestions[currentQuizIndex];
            const options = document.querySelectorAll('.quiz-option');
            
            options.forEach(option => option.onclick = null);
            
            if (selectedIndex === question.correct) {
                options[selectedIndex].classList.add('correct');
                userData.balance += 1500;
                userData.completedQuizzes++;
                updateLevel();
                showToast('Correct! +1500 TRM');
            } else {
                options[selectedIndex].classList.add('incorrect');
                options[question.correct].classList.add('correct');
                showToast('Incorrect. Try the next quiz!');
            }
            
            saveUserData();
            updateUI();
            
            setTimeout(() => {
                currentQuizIndex = (currentQuizIndex + 1) % quizQuestions.length;
                loadQuiz();
            }, 3000);
        }

        function updateLevel() {
            const newLevel = Math.floor(userData.completedQuizzes / 5) + 1;
            if (newLevel > userData.level) {
                userData.level = newLevel;
                showToast(`Congratulations! You reached Level ${userData.level}!`);
            }
        }

        // Blog functionality
        async function loadBlogPosts() {
            try {
                const blogSnapshot = await db.collection('blogPosts').orderBy('createdAt', 'desc').get();
                const blogContainer = document.getElementById('blogContainer');
                blogContainer.innerHTML = '';
                
                blogSnapshot.forEach(doc => {
                    const post = doc.data();
                    createBlogPostElement(post, doc.id);
                });
            } catch (error) {
                console.error('Error loading blog posts:', error);
            }
        }

        function createBlogPostElement(post, docId) {
            const blogContainer = document.getElementById('blogContainer');
            const postDiv = document.createElement('div');
            postDiv.className = 'blog-post';
            postDiv.innerHTML = `
                <div class="blog-header">
                    <span class="blog-author">${post.authorName}</span>
                    <span>${new Date(post.createdAt.toDate()).toLocaleDateString()}</span>
                </div>
                <div class="blog-content">${post.content}</div>
                <div class="blog-actions">
                    <div class="blog-action ${post.likedBy?.includes(currentUser?.id) ? 'liked' : ''}" onclick="likePost('${docId}')">
                        <i class="fas fa-heart"></i>
                        <span>${post.likes || 0}</span>
                    </div>
                    <div class="blog-action" onclick="commentOnPost('${docId}')">
                        <i class="fas fa-comment"></i>
                        <span>${post.comments || 0}</span>
                    </div>
                    ${post.authorId === currentUser?.id ? `
                        <div class="blog-action" onclick="deletePost('${docId}')">
                            <i class="fas fa-trash"></i>
                        </div>
                    ` : ''}
                </div>
            `;
            blogContainer.appendChild(postDiv);
        }

        function showCreateBlogModal() {
            document.getElementById('createBlogModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function createBlogPost() {
            const content = document.getElementById('blogContent').value.trim();
            if (!content) {
                showToast('Please write something before posting!');
                return;
            }

            try {
                await db.collection('blogPosts').add({
                    authorId: currentUser.id,
                    authorName: currentUser.first_name + ' ' + (currentUser.last_name || ''),
                    content: content,
                    likes: 0,
                    likedBy: [],
                    comments: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('blogContent').value = '';
                closeModal('createBlogModal');
                loadBlogPosts();
                showToast('Blog post published successfully!');
            } catch (error) {
                console.error('Error creating blog post:', error);
                showToast('Error publishing blog post');
            }
        }

        async function likePost(postId) {
            try {
                const postRef = db.collection('blogPosts').doc(postId);
                const post = await postRef.get();
                
                if (post.exists) {
                    const postData = post.data();
                    let likedBy = postData.likedBy || [];
                    
                    if (likedBy.includes(currentUser.id)) {
                        // Unlike
                        likedBy = likedBy.filter(id => id !== currentUser.id);
                        await postRef.update({
                            likes: (postData.likes || 0) - 1,
                            likedBy: likedBy
                        });
                    } else {
                        // Like
                        likedBy.push(currentUser.id);
                        await postRef.update({
                            likes: (postData.likes || 0) + 1,
                            likedBy: likedBy
                        });
                    }
                    
                    loadBlogPosts();
                }
            } catch (error) {
                console.error('Error liking post:', error);
            }
        }

        function commentOnPost(postId) {
            showToast('Comment feature coming soon!');
        }

        async function deletePost(postId) {
            if (confirm('Are you sure you want to delete this post?')) {
                try {
                    await db.collection('blogPosts').doc(postId).delete();
                    loadBlogPosts();
                    showToast('Post deleted successfully!');
                } catch (error) {
                    console.error('Error deleting post:', error);
                    showToast('Error deleting post');
                }
            }
        }

        // Tasks functionality
        async function loadTasks() {
            try {
                const tasksSnapshot = await db.collection('tasks').orderBy('order').get();
                const tasksContainer = document.getElementById('tasksContainer');
                
                // Keep watch ads task
                const watchAdsTask = tasksContainer.querySelector('.task-item');
                tasksContainer.innerHTML = '';
                if (watchAdsTask) {
                    tasksContainer.appendChild(watchAdsTask);
                }
                
                tasksSnapshot.forEach(doc => {
                    const task = doc.data();
                    createTaskElement(task, doc.id);
                });
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        function createTaskElement(task, docId) {
            const tasksContainer = document.getElementById('tasksContainer');
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-item';
            
            const isCompleted = userData.completedTasks?.includes(docId);
            const buttonStatus = isCompleted ? 'Completed' : 'OPEN';
            const isProcessing = userData.processingTasks?.includes(docId);
            
            taskDiv.innerHTML = `
                <div class="task-icon">
                    <i class="fas fa-${task.icon || 'tasks'}"></i>
                </div>
                <div class="task-details">
                    <div class="task-name">${task.name}</div>
                    <div class="task-reward">+${task.reward} TRM</div>
                </div>
                <button class="task-button" id="task-${docId}" onclick="handleTask('${docId}', '${task.link}', ${task.reward})" ${isCompleted ? 'disabled' : ''}>
                    ${isProcessing ? 'Processing...' : buttonStatus}
                </button>
            `;
            
            tasksContainer.appendChild(taskDiv);
        }

        function handleTask(taskId, link, reward) {
            if (userData.completedTasks?.includes(taskId)) {
                window.open(link, '_blank');
                return;
            }

            // Mark as processing
            if (!userData.processingTasks) userData.processingTasks = [];
            userData.processingTasks.push(taskId);
            
            const button = document.getElementById(`task-${taskId}`);
            button.textContent = 'Processing...';
            button.disabled = true;

            // Open the task link
            window.open(link, '_blank');

            // After 10 seconds, complete the task
            setTimeout(async () => {
                if (!userData.completedTasks) userData.completedTasks = [];
                userData.completedTasks.push(taskId);
                
                userData.processingTasks = userData.processingTasks.filter(id => id !== taskId);
                userData.balance += reward;
                
                await saveUserData();
                updateUI();
                
                button.textContent = 'Completed';
                button.disabled = true;
                
                showToast(`Task completed! +${reward} TRM`);
            }, 10000);
        }

        function watchAds() {
            // Show ad reward
            userData.balance += 1;
            updateUI();
            saveUserData();
            showToast('+1 TRM for watching ads!');
            
            // Trigger ad display (Monetag)
            if (window.show_10290264) {
                window.show_10290264();
            }
        }

        // Friends functionality
        function copyReferralLink() {
            const referralLink = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(referralLink).then(() => {
                showToast('Referral link copied to clipboard!');
            });
        }

        function updateReferralsList() {
            const referralsList = document.getElementById('referralsList');
            referralsList.innerHTML = '';
            
            if (userData.referrals.length === 0) {
                referralsList.innerHTML = '<p style="text-align: center; opacity: 0.7;">No referrals yet</p>';
                return;
            }

            userData.referrals.forEach(referral => {
                const referralDiv = document.createElement('div');
                referralDiv.className = 'leaderboard-item';
                referralDiv.innerHTML = `
                    <img src="${referral.photo_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(referral.name) + '&background=FF6B6B&color=fff'}" alt="${referral.name}" class="leaderboard-avatar">
                    <span class="leaderboard-name">${referral.name}</span>
                    <span class="leaderboard-score">+5000 TRM</span>
                `;
                referralsList.appendChild(referralDiv);
            });
        }

        // Leaderboard functionality
        async function loadLeaderboard() {
            try {
                const usersSnapshot = await db.collection('users').orderBy('balance', 'desc').limit(25).get();
                const leaderboardContainer = document.getElementById('leaderboardContainer');
                leaderboardContainer.innerHTML = '';
                
                let userRank = 0;
                
                usersSnapshot.forEach((doc, index) => {
                    const user = doc.data();
                    const rank = index + 1;
                    
                    // Check if this is current user
                    const isCurrentUser = doc.id === currentUser?.id.toString();
                    if (isCurrentUser) {
                        userRank = rank;
                        document.getElementById('userRank').textContent = rank;
                        document.getElementById('profileRank').textContent = rank;
                    }
                    
                    createLeaderboardItem(user, doc.id, rank, isCurrentUser);
                });
                
                // If user not in top 25, show their rank
                if (userRank === 0 && currentUser) {
                    const userDoc = await db.collection('users').doc(currentUser.id.toString()).get();
                    if (userDoc.exists) {
                        const allUsers = await db.collection('users').orderBy('balance', 'desc').get();
                        let rank = 0;
                        allUsers.forEach((doc, index) => {
                            if (doc.id === currentUser.id.toString()) {
                                rank = index + 1;
                            }
                        });
                        
                        if (rank > 0) {
                            document.getElementById('userRank').textContent = rank;
                            document.getElementById('profileRank').textContent = rank;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        function createLeaderboardItem(user, userId, rank, isCurrentUser) {
            const leaderboardContainer = document.getElementById('leaderboardContainer');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'leaderboard-item' + (isCurrentUser ? ' current-user' : '');
            
            const rankClass = rank <= 3 ? 'top-3' : '';
            
            itemDiv.innerHTML = `
                <div class="rank-number ${rankClass}">${rank}</div>
                <img src="${user.photo_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.name || 'User') + '&background=FF6B6B&color=fff'}" alt="${user.name || 'User'}" class="leaderboard-avatar">
                <span class="leaderboard-name">${user.name || 'User'}</span>
                <span class="leaderboard-score">${user.balance.toFixed(3)} TRM</span>
            `;
            
            leaderboardContainer.appendChild(itemDiv);
        }

        // TON Wallet functionality
        function initializeTONConnect() {
            tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                manifestUrl: 'https://trimint.vercel.app/tonconnect-manifest.json',
                buttonRootId: null
            });

            tonConnectUI.onStatusChange(wallet => {
                if (wallet) {
                    tonWalletConnected = true;
                    userData.tonWallet = wallet.account.address;
                    document.getElementById('walletButton').innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        Wallet Connected
                    `;
                    document.getElementById('walletButton').classList.add('wallet-connected');
                    saveUserData();
                    showToast('TON Wallet connected successfully!');
                } else {
                    tonWalletConnected = false;
                    userData.tonWallet = null;
                    document.getElementById('walletButton').innerHTML = `
                        <i class="fas fa-wallet"></i>
                        Connect TON Wallet
                    `;
                    document.getElementById('walletButton').classList.remove('wallet-connected');
                }
            });
        }

        async function connectTONWallet() {
            try {
                if (tonWalletConnected) {
                    await tonConnectUI.disconnect();
                } else {
                    await tonConnectUI.connectWallet();
                }
            } catch (error) {
                console.error('Error connecting TON wallet:', error);
                showToast('Error connecting wallet. Please try again.');
            }
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            // Load section-specific data
            if (sectionName === 'quiz') {
                loadQuiz();
            } else if (sectionName === 'leaderboard') {
                loadLeaderboard();
            }
        }

        function showProfile() {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show profile section
            document.getElementById('profileSection').classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Handle referral when user starts app
        async function handleReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const referrerId = urlParams.get('startapp');
            
            if (referrerId && currentUser && referrerId !== currentUser.id.toString()) {
                try {
                    // Check if user is already referred
                    const referrerDoc = await db.collection('users').doc(referrerId).get();
                    
                    if (referrerDoc.exists) {
                        const referrerData = referrerDoc.data();
                        
                        // Check if current user is already in referrer's list
                        const alreadyReferred = referrerData.referrals?.some(r => r.id === currentUser.id);
                        
                        if (!alreadyReferred) {
                            // Add referral to referrer's data
                            if (!referrerData.referrals) referrerData.referrals = [];
                            referrerData.referrals.push({
                                id: currentUser.id,
                                name: currentUser.first_name + ' ' + (currentUser.last_name || ''),
                                photo_url: currentUser.photo_url
                            });
                            
                            // Add reward to referrer
                            referrerData.balance += 5000;
                            
                            await db.collection('users').doc(referrerId).update(referrerData);
                            showToast(`Welcome! You were referred by ${referrerData.name || 'a friend'}`);
                        }
                    }
                } catch (error) {
                    console.error('Error handling referral:', error);
                }
            }
        }

        // Initialize referral handling
        setTimeout(handleReferral, 2000);
    </script>
</body>
</html>
