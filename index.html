<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trimint - TRM Mining</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-bg: #0f172a;
            --dark-surface: #1e293b;
            --dark-text: #f1f5f9;
            --light-bg: #f8fafc;
            --light-surface: #ffffff;
            --light-text: #1e293b;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #13B497 0%, #59D4A4 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--dark-bg);
            color: var(--dark-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        body.light-mode {
            background: var(--light-bg);
            color: var(--light-text);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-coin {
            width: 120px;
            height: 120px;
            animation: bounce 1.5s infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .referred-by {
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            text-align: center;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        /* Header */
        .header {
            background: var(--dark-surface);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        body.light-mode .header {
            background: var(--light-surface);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .balance-section {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--gradient-primary);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .coin-icon {
            width: 24px;
            height: 24px;
        }

        .balance-amount {
            font-weight: bold;
            font-size: 16px;
            color: white;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--dark-text);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        body.light-mode .theme-toggle:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 20px;
            padding-bottom: 100px;
            overflow-y: auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Section */
        .home-container {
            text-align: center;
            padding: 20px 0;
        }

        .main-coin {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            cursor: pointer;
            transition: transform 0.3s ease;
            animation: float 3s ease-in-out infinite;
        }

        .main-coin:hover {
            transform: scale(1.05);
        }

        .main-coin.farming {
            animation: rotate 2s linear infinite, glow 1s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5)); }
            50% { filter: drop-shadow(0 0 30px rgba(99, 102, 241, 0.8)); }
        }

        .farm-button {
            background: var(--gradient-success);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .farm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .farm-button:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
        }

        .timer-display {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 15px 0;
        }

        .farming-info {
            background: var(--dark-surface);
            padding: 15px;
            border-radius: 15px;
            margin: 20px 0;
        }

        body.light-mode .farming-info {
            background: var(--light-surface);
        }

        /* Profile Section */
        .profile-card {
            background: var(--dark-surface);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        body.light-mode .profile-card {
            background: var(--light-surface);
        }

        .profile-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: var(--gradient-primary);
            z-index: 0;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            margin: 0 auto 15px;
            position: relative;
            z-index: 1;
        }

        .profile-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }

        .profile-level {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .level-bronze {
            background: linear-gradient(135deg, #cd7f32, #b87333);
            color: white;
        }

        .level-gold {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
        }

        .level-diamond {
            background: linear-gradient(135deg, #b9f2ff, #00d4ff);
            color: white;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Wallet Section */
        .wallet-card {
            background: var(--dark-surface);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        body.light-mode .wallet-card {
            background: var(--light-surface);
        }

        .wallet-address {
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            background: rgba(0, 0, 0, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .wallet-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .wallet-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-wallet {
            background: var(--gradient-primary);
            color: white;
        }

        .copy-address {
            background: var(--success-color);
            color: white;
        }

        .disconnect-wallet {
            background: var(--danger-color);
            color: white;
        }

        /* Tasks Section */
        .tasks-container {
            margin-top: 20px;
        }

        .task-card {
            background: var(--dark-surface);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        body.light-mode .task-card {
            background: var(--light-surface);
        }

        .task-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .task-reward {
            color: var(--success-color);
            font-size: 14px;
            font-weight: bold;
        }

        .task-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .task-button:hover {
            background: var(--secondary-color);
            transform: scale(1.05);
        }

        .task-button.processing {
            background: var(--warning-color);
            animation: pulse 1s infinite;
        }

        .task-button.completed {
            background: var(--success-color);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Leaderboard */
        .leaderboard-list {
            margin-top: 20px;
        }

        .leaderboard-item {
            background: var(--dark-surface);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        body.light-mode .leaderboard-item {
            background: var(--light-surface);
        }

        .leaderboard-rank {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            min-width: 30px;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .leaderboard-balance {
            color: var(--success-color);
            font-size: 14px;
        }

        /* Friends Section */
        .referral-card {
            background: var(--gradient-primary);
            border-radius: 20px;
            padding: 20px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .referral-link {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            word-break: break-all;
        }

        .copy-referral {
            background: white;
            color: var(--primary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-referral:hover {
            transform: scale(1.05);
        }

        .friends-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .friend-item {
            background: var(--dark-surface);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        body.light-mode .friend-item {
            background: var(--light-surface);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--dark-surface);
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        body.light-mode .bottom-nav {
            background: var(--light-surface);
        }

        .nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .nav-button {
            background: none;
            border: none;
            color: var(--dark-text);
            font-size: 12px;
            cursor: pointer;
            padding: 8px;
            border-radius: 15px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        body.light-mode .nav-button {
            color: var(--light-text);
        }

        .nav-button:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .nav-button.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-button.home {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 50%;
            transform: translateY(-10px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .nav-icon {
            font-size: 20px;
        }

        .nav-button.home .nav-icon {
            font-size: 25px;
        }

        /* Settings */
        .settings-section {
            background: var(--dark-surface);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        body.light-mode .settings-section {
            background: var(--light-surface);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.light-mode .setting-item {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: bold;
        }

        .setting-toggle {
            position: relative;
            width: 50px;
            height: 25px;
            background: #6b7280;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .setting-toggle.active {
            background: var(--success-color);
        }

        .setting-toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2.5px;
            left: 2.5px;
            transition: transform 0.3s ease;
        }

        .setting-toggle.active::after {
            transform: translateX(25px);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .content {
                padding: 15px;
            }

            .main-coin {
                width: 150px;
                height: 150px;
            }

            .profile-stats {
                grid-template-columns: 1fr;
            }

            .friends-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="Loading" class="loading-coin">
        <div class="loading-text">Trimint</div>
        <div class="referred-by" id="referredBy" style="display: none;"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="balance-section">
            <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="coin-icon">
            <span class="balance-amount" id="balanceAmount">0</span>
        </div>
        <button class="theme-toggle" id="themeToggle">üåô</button>
    </header>

    <!-- Content -->
    <main class="content">
        <!-- Home Section -->
        <section class="section active" id="homeSection">
            <div class="home-container">
                <h2 style="margin-bottom: 20px;">TRM Mining</h2>
                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM Coin" class="main-coin" id="mainCoin">
                <button class="farm-button" id="farmButton">Start Farming</button>
                <div class="timer-display" id="timerDisplay" style="display: none;">12:00:00</div>
                <div class="farming-info">
                    <h3>Farming Details</h3>
                    <p>Rate: 0.001 TRM per second</p>
                    <p>Duration: 12 hours</p>
                    <p>Total per session: 43.2 TRM</p>
                </div>
            </div>
        </section>

        <!-- Profile Section -->
        <section class="section" id="profileSection">
            <div class="profile-card">
                <img src="https://via.placeholder.com/80" alt="Avatar" class="profile-avatar" id="profileAvatar">
                <div class="profile-name" id="profileName">Loading...</div>
                <div class="profile-level level-bronze" id="profileLevel">Bronze</div>
                
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalBalance">0</div>
                        <div class="stat-label">Total Balance</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalFriends">0</div>
                        <div class="stat-label">Total Friends</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalEarned">0</div>
                        <div class="stat-label">Total Earned</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="farmSessions">0</div>
                        <div class="stat-label">Farm Sessions</div>
                    </div>
                </div>
            </div>

            <!-- Wallet Card -->
            <div class="wallet-card">
                <h3>TON Wallet</h3>
                <button class="wallet-button connect-wallet" id="connectWallet">Connect TON Wallet</button>
                <div id="walletInfo" style="display: none; margin-top: 15px;">
                    <div class="wallet-address" id="walletAddress"></div>
                    <div class="wallet-buttons">
                        <button class="wallet-button copy-address" id="copyAddress">Copy</button>
                        <button class="wallet-button disconnect-wallet" id="disconnectWallet">Disconnect</button>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="settings-section">
                <h3>Settings</h3>
                <div class="setting-item">
                    <div class="setting-label">Notifications</div>
                    <div class="setting-toggle active" id="notificationToggle"></div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">Sound Effects</div>
                    <div class="setting-toggle active" id="soundToggle"></div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">Auto Farming</div>
                    <div class="setting-toggle" id="autoFarmToggle"></div>
                </div>
            </div>
        </section>

        <!-- Tasks Section -->
        <section class="section" id="tasksSection">
            <h2 style="margin-bottom: 20px;">Tasks</h2>
            
            <!-- Watch Ads Task -->
            <div class="task-card">
                <img src="https://via.placeholder.com/50" alt="Watch Ads" class="task-icon">
                <div class="task-info">
                    <div class="task-name">Watch Ads</div>
                    <div class="task-reward">Reward: 1 TRM</div>
                </div>
                <button class="task-button" id="watchAdsButton">OPEN</button>
            </div>

            <div class="tasks-container" id="tasksContainer">
                <!-- Tasks will be loaded here from Firebase -->
            </div>
        </section>

        <!-- Leaderboard Section -->
        <section class="section" id="leaderboardSection">
            <h2 style="margin-bottom: 20px;">Leaderboard</h2>
            <div class="leaderboard-list" id="leaderboardList">
                <!-- Leaderboard will be loaded here -->
            </div>
        </section>

        <!-- Friends Section -->
        <section class="section" id="friendsSection">
            <h2 style="margin-bottom: 20px;">Friends</h2>
            
            <div class="referral-card">
                <h3>Invite Friends</h3>
                <p style="margin: 10px 0;">Earn 5000 TRM for each friend!</p>
                <div class="referral-link" id="referralLink"></div>
                <button class="copy-referral" id="copyReferral">Copy Link</button>
            </div>

            <div class="friends-stats">
                <div class="stat-item">
                    <div class="stat-value" id="referralCount">0</div>
                    <div class="stat-label">Total Referrals</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="referralEarned">0</div>
                    <div class="stat-label">Referral Earnings</div>
                </div>
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">Your Friends</h3>
            <div id="friendsList">
                <!-- Friends list will be loaded here -->
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-container">
            <button class="nav-button" data-section="tasks">
                <span class="nav-icon">üìã</span>
                <span>Tasks</span>
            </button>
            <button class="nav-button" data-section="leaderboard">
                <span class="nav-icon">üèÜ</span>
                <span>Leaderboard</span>
            </button>
            <button class="nav-button home active" data-section="home">
                <span class="nav-icon">üè†</span>
                <span>Home</span>
            </button>
            <button class="nav-button" data-section="friends">
                <span class="nav-icon">üë•</span>
                <span>Friends</span>
            </button>
            <button class="nav-button" data-section="profile">
                <span class="nav-icon">üë§</span>
                <span>Profile</span>
            </button>
        </div>
    </nav>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Telegram Web App
        const telegram = window.Telegram.WebApp;
        telegram.ready();
        telegram.expand();

        // Global Variables
        let currentUser = null;
        let userData = null;
        let farmingInterval = null;
        let farmingEndTime = null;
        let connectedWallet = null;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeUser();
            setupEventListeners();
            loadTasks();
            loadLeaderboard();
            loadUserData();
        });

        // Initialize User
        function initializeUser() {
            if (telegram.initDataUnsafe.user) {
                currentUser = telegram.initDataUnsafe.user;
                
                // Check for referral
                const urlParams = new URLSearchParams(window.location.search);
                const referrerId = urlParams.get('startapp');
                
                if (referrerId && referrerId !== currentUser.id.toString()) {
                    showReferredBy(referrerId);
                    processReferral(referrerId);
                }

                // Show loading screen briefly then main app
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    saveUserToDatabase();
                }, 2000);
            }
        }

        // Show referred by info
        function showReferredBy(referrerId) {
            const referralElement = document.getElementById('referredBy');
            referralElement.textContent = `Referred by user ${referrerId}`;
            referralElement.style.display = 'block';
        }

        // Process Referral
        async function processReferral(referrerId) {
            try {
                // Add referral bonus to referrer
                const referrerRef = database.ref(`users/${referrerId}`);
                const referrerSnapshot = await referrerRef.once('value');
                const referrerData = referrerSnapshot.val() || {};
                
                const newReferrerBalance = (referrerData.balance || 0) + 5000;
                const newReferralEarnings = (referrerData.referralEarnings || 0) + 5000;
                const referrals = referrerData.referrals || [];
                
                if (!referrals.includes(currentUser.id.toString())) {
                    referrals.push(currentUser.id.toString());
                }

                await referrerRef.update({
                    balance: newReferrerBalance,
                    referralEarnings: newReferralEarnings,
                    referrals: referrals
                });

                showToast('Referral processed successfully!');
            } catch (error) {
                console.error('Error processing referral:', error);
            }
        }

        // Save User to Database
        async function saveUserToDatabase() {
            if (!currentUser) return;

            try {
                const userRef = database.ref(`users/${currentUser.id}`);
                const snapshot = await userRef.once('value');
                const existingData = snapshot.val() || {};

                const userData = {
                    id: currentUser.id,
                    firstName: currentUser.first_name,
                    lastName: currentUser.last_name || '',
                    username: currentUser.username || '',
                    photoUrl: currentUser.photo_url || '',
                    balance: existingData.balance || 0,
                    totalEarned: existingData.totalEarned || 0,
                    referrals: existingData.referrals || [],
                    referralEarnings: existingData.referralEarnings || 0,
                    farmSessions: existingData.farmSessions || 0,
                    tasks: existingData.tasks || {},
                    walletAddress: existingData.walletAddress || '',
                    lastFarmingEnd: existingData.lastFarmingEnd || null,
                    joinDate: existingData.joinDate || new Date().toISOString(),
                    lastActive: new Date().toISOString()
                };

                await userRef.set(userData);
                loadUserData();
            } catch (error) {
                console.error('Error saving user:', error);
            }
        }

        // Load User Data
        async function loadUserData() {
            if (!currentUser) return;

            try {
                const userRef = database.ref(`users/${currentUser.id}`);
                const snapshot = await userRef.once('value');
                userData = snapshot.val();

                if (userData) {
                    // Update UI with user data
                    updateProfileUI();
                    updateBalance();
                    updateFarmingStatus();
                    loadReferrals();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Update Profile UI
        function updateProfileUI() {
            if (!userData) return;

            document.getElementById('profileName').textContent = 
                `${userData.firstName} ${userData.lastName}`.trim() || userData.username;
            
            if (userData.photoUrl) {
                document.getElementById('profileAvatar').src = userData.photoUrl;
            }

            document.getElementById('totalBalance').textContent = userData.balance || 0;
            document.getElementById('totalFriends').textContent = (userData.referrals || []).length;
            document.getElementById('totalEarned').textContent = userData.totalEarned || 0;
            document.getElementById('farmSessions').textContent = userData.farmSessions || 0;

            // Update level
            updateLevel(userData.balance || 0);

            // Update wallet info
            if (userData.walletAddress) {
                document.getElementById('walletAddress').textContent = userData.walletAddress;
                document.getElementById('connectWallet').textContent = 'Connected';
                document.getElementById('connectWallet').style.background = 'var(--success-color)';
                document.getElementById('walletInfo').style.display = 'block';
            }
        }

        // Update Level
        function updateLevel(balance) {
            const levelElement = document.getElementById('profileLevel');
            
            if (balance < 10000) {
                levelElement.textContent = 'Bronze';
                levelElement.className = 'profile-level level-bronze';
            } else if (balance < 50000) {
                levelElement.textContent = 'Gold';
                levelElement.className = 'profile-level level-gold';
            } else {
                levelElement.textContent = 'Diamond';
                levelElement.className = 'profile-level level-diamond';
            }
        }

        // Update Balance
        function updateBalance() {
            if (!userData) return;
            document.getElementById('balanceAmount').textContent = userData.balance || 0;
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', function() {
                    const section = this.dataset.section;
                    switchSection(section);
                });
            });

            // Theme Toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Farm Button
            document.getElementById('farmButton').addEventListener('click', toggleFarming);

            // Main Coin Click
            document.getElementById('mainCoin').addEventListener('click', function() {
                if (!farmingInterval) {
                    this.style.animation = 'none';
                    setTimeout(() => {
                        this.style.animation = '';
                    }, 10);
                }
            });

            // Wallet Connect
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('copyAddress').addEventListener('click', copyWalletAddress);
            document.getElementById('disconnectWallet').addEventListener('click', disconnectWallet);

            // Referral Copy
            document.getElementById('copyReferral').addEventListener('click', copyReferralLink);

            // Watch Ads
            document.getElementById('watchAdsButton').addEventListener('click', watchAds);

            // Settings Toggles
            document.querySelectorAll('.setting-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    saveSettings();
                });
            });
        }

        // Switch Section
        function switchSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            document.getElementById(`${sectionName}Section`).classList.add('active');

            // Update nav buttons
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
                if (button.dataset.section === sectionName) {
                    button.classList.add('active');
                }
            });
        }

        // Toggle Theme
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            body.classList.toggle('light-mode');
            
            if (body.classList.contains('light-mode')) {
                themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                themeToggle.textContent = 'üåô';
            }

            // Save theme preference
            if (currentUser) {
                database.ref(`users/${currentUser.id}/theme`).set(
                    body.classList.contains('light-mode') ? 'light' : 'dark'
                );
            }
        }

        // Toggle Farming
        async function toggleFarming() {
            if (farmingInterval) {
                stopFarming();
            } else {
                await startFarming();
            }
        }

        // Start Farming
        async function startFarming() {
            if (!currentUser || !userData) return;

            // Check if previous farming session ended
            if (userData.lastFarmingEnd) {
                const endTime = new Date(userData.lastFarmingEnd);
                const now = new Date();
                if (now < endTime) {
                    showToast('Previous farming session still active!');
                    updateFarmingStatus();
                    return;
                }
            }

            farmingEndTime = new Date(Date.now() + 12 * 60 * 60 * 1000); // 12 hours
            userData.lastFarmingEnd = farmingEndTime.toISOString();
            
            // Update database
            await database.ref(`users/${currentUser.id}`).update({
                lastFarmingEnd: userData.lastFarmingEnd
            });

            // Update UI
            document.getElementById('farmButton').textContent = 'Stop Farming';
            document.getElementById('farmButton').style.background = 'var(--danger-color)';
            document.getElementById('timerDisplay').style.display = 'block';
            document.getElementById('mainCoin').classList.add('farming');

            // Start farming interval
            farmingInterval = setInterval(() => {
                updateFarming();
            }, 1000);

            showToast('Farming started!');
        }

        // Update Farming
        async function updateFarming() {
            if (!farmingEndTime || !currentUser) return;

            const now = new Date();
            const remaining = farmingEndTime - now;

            if (remaining <= 0) {
                stopFarming();
                return;
            }

            // Update timer
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            document.getElementById('timerDisplay').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // Add 0.001 TRM per second
            const currentBalance = userData.balance || 0;
            const newBalance = currentBalance + 0.001;
            userData.balance = newBalance;
            userData.totalEarned = (userData.totalEarned || 0) + 0.001;

            // Update database every 10 seconds
            if (seconds % 10 === 0) {
                await database.ref(`users/${currentUser.id}`).update({
                    balance: newBalance,
                    totalEarned: userData.totalEarned
                });
                updateBalance();
                updateLevel(newBalance);
            }
        }

        // Stop Farming
        async function stopFarming() {
            if (farmingInterval) {
                clearInterval(farmingInterval);
                farmingInterval = null;
            }

            farmingEndTime = null;
            
            // Update UI
            document.getElementById('farmButton').textContent = 'Start Farming';
            document.getElementById('farmButton').style.background = '';
            document.getElementById('timerDisplay').style.display = 'none';
            document.getElementById('mainCoin').classList.remove('farming');

            // Update database
            if (currentUser) {
                userData.farmSessions = (userData.farmSessions || 0) + 1;
                await database.ref(`users/${currentUser.id}`).update({
                    lastFarmingEnd: null,
                    balance: userData.balance,
                    totalEarned: userData.totalEarned,
                    farmSessions: userData.farmSessions
                });
                updateProfileUI();
            }

            showToast('Farming completed!');
        }

        // Update Farming Status
        async function updateFarmingStatus() {
            if (!userData || !userData.lastFarmingEnd) return;

            const endTime = new Date(userData.lastFarmingEnd);
            const now = new Date();

            if (now < endTime) {
                farmingEndTime = endTime;
                document.getElementById('farmButton').textContent = 'Stop Farming';
                document.getElementById('farmButton').style.background = 'var(--danger-color)';
                document.getElementById('timerDisplay').style.display = 'block';
                document.getElementById('mainCoin').classList.add('farming');

                farmingInterval = setInterval(() => {
                    updateFarming();
                }, 1000);
            }
        }

        // Connect Wallet
        async function connectWallet() {
            // Open TON wallet connection
            const walletUrl = 'https://trimint.vercel.app/';
            window.open(walletUrl, '_blank');
            
            // Simulate wallet connection (in real app, this would connect to actual wallet)
            setTimeout(() => {
                const mockAddress = 'EQD' + Math.random().toString(36).substr(2, 34).toUpperCase();
                connectedWallet = mockAddress;
                
                userData.walletAddress = mockAddress;
                document.getElementById('walletAddress').textContent = mockAddress;
                document.getElementById('connectWallet').textContent = 'Connected';
                document.getElementById('connectWallet').style.background = 'var(--success-color)';
                document.getElementById('walletInfo').style.display = 'block';

                // Save to database
                if (currentUser) {
                    database.ref(`users/${currentUser.id}`).update({
                        walletAddress: mockAddress
                    });
                }

                showToast('Wallet connected successfully!');
            }, 2000);
        }

        // Copy Wallet Address
        function copyWalletAddress() {
            const address = document.getElementById('walletAddress').textContent;
            navigator.clipboard.writeText(address).then(() => {
                showToast('Wallet address copied!');
            });
        }

        // Disconnect Wallet
        async function disconnectWallet() {
            connectedWallet = null;
            userData.walletAddress = '';
            
            document.getElementById('connectWallet').textContent = 'Connect TON Wallet';
            document.getElementById('connectWallet').style.background = '';
            document.getElementById('walletInfo').style.display = 'none';

            // Update database
            if (currentUser) {
                database.ref(`users/${currentUser.id}`).update({
                    walletAddress: ''
                });
            }

            showToast('Wallet disconnected!');
        }

        // Copy Referral Link
        function copyReferralLink() {
            if (!currentUser) return;
            
            const referralLink = `https://t.me/TrimintBot/open?startapp=${currentUser.id}`;
            document.getElementById('referralLink').textContent = referralLink;
            
            navigator.clipboard.writeText(referralLink).then(() => {
                showToast('Referral link copied!');
            });
        }

        // Watch Ads
        async function watchAds() {
            const button = document.getElementById('watchAdsButton');
            
            if (button.textContent === 'OPEN') {
                button.textContent = 'PROCESSING';
                button.classList.add('processing');
                
                // Show Monetag ads
                if (window.libtl) {
                    window.libtl.show();
                }
                
                // Simulate ad processing
                setTimeout(async () => {
                    userData.balance = (userData.balance || 0) + 1;
                    userData.totalEarned = (userData.totalEarned || 0) + 1;
                    
                    button.textContent = 'COMPLETED';
                    button.classList.remove('processing');
                    button.classList.add('completed');
                    
                    // Update database
                    if (currentUser) {
                        await database.ref(`users/${currentUser.id}`).update({
                            balance: userData.balance,
                            totalEarned: userData.totalEarned
                        });
                        updateBalance();
                        updateLevel(userData.balance);
                    }
                    
                    showToast('Earned 1 TRM!');
                }, 10000);
            } else {
                // Redirect to link even if completed
                window.open('https://trimint.vercel.app/', '_blank');
            }
        }

        // Load Tasks
        async function loadTasks() {
            try {
                const tasksRef = database.ref('tasks');
                const snapshot = await tasksRef.once('value');
                const tasks = snapshot.val() || {};
                
                const container = document.getElementById('tasksContainer');
                container.innerHTML = '';
                
                Object.entries(tasks).forEach(([taskId, task]) => {
                    const taskCard = createTaskCard(taskId, task);
                    container.appendChild(taskCard);
                });
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        // Create Task Card
        function createTaskCard(taskId, task) {
            const div = document.createElement('div');
            div.className = 'task-card';
            
            const isCompleted = userData?.tasks?.[taskId];
            const buttonText = isCompleted ? 'COMPLETED' : 'OPEN';
            const buttonClass = isCompleted ? 'completed' : '';
            
            div.innerHTML = `
                <img src="${task.photoUrl || 'https://via.placeholder.com/50'}" alt="${task.name}" class="task-icon">
                <div class="task-info">
                    <div class="task-name">${task.name}</div>
                    <div class="task-reward">Reward: ${task.reward} TRM</div>
                </div>
                <button class="task-button ${buttonClass}" data-task-id="${taskId}">${buttonText}</button>
            `;
            
            // Add click handler
            div.querySelector('.task-button').addEventListener('click', function() {
                handleTaskClick(taskId, task, this);
            });
            
            return div;
        }

        // Handle Task Click
        async function handleTaskClick(taskId, task, button) {
            if (button.textContent === 'OPEN') {
                button.textContent = 'PROCESSING';
                button.classList.add('processing');
                
                // Open task link
                window.open(task.link, '_blank');
                
                // Simulate task completion
                setTimeout(async () => {
                    if (!userData.tasks) userData.tasks = {};
                    userData.tasks[taskId] = true;
                    userData.balance = (userData.balance || 0) + task.reward;
                    userData.totalEarned = (userData.totalEarned || 0) + task.reward;
                    
                    button.textContent = 'COMPLETED';
                    button.classList.remove('processing');
                    button.classList.add('completed');
                    
                    // Update database
                    if (currentUser) {
                        await database.ref(`users/${currentUser.id}`).update({
                            balance: userData.balance,
                            totalEarned: userData.totalEarned,
                            tasks: userData.tasks
                        });
                        updateBalance();
                        updateLevel(userData.balance);
                    }
                    
                    showToast(`Earned ${task.reward} TRM!`);
                }, 10000);
            } else {
                // Redirect to link even if completed
                window.open(task.link, '_blank');
            }
        }

        // Load Leaderboard
        async function loadLeaderboard() {
            try {
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                const users = snapshot.val() || {};
                
                // Sort users by balance
                const sortedUsers = Object.entries(users)
                    .map(([id, user]) => ({ id, ...user }))
                    .sort((a, b) => (b.balance || 0) - (a.balance || 0))
                    .slice(0, 25);
                
                const container = document.getElementById('leaderboardList');
                container.innerHTML = '';
                
                sortedUsers.forEach((user, index) => {
                    const item = createLeaderboardItem(index + 1, user);
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Create Leaderboard Item
        function createLeaderboardItem(rank, user) {
            const div = document.createElement('div');
            div.className = 'leaderboard-item';
            
            div.innerHTML = `
                <div class="leaderboard-rank">#${rank}</div>
                <img src="${user.photoUrl || 'https://via.placeholder.com/40'}" alt="${user.firstName}" class="leaderboard-avatar">
                <div class="leaderboard-info">
                    <div class="leaderboard-name">${user.firstName} ${user.lastName}`.trim() || user.username}</div>
                    <div class="leaderboard-balance">${user.balance || 0} TRM</div>
                </div>
            `;
            
            return div;
        }

        // Load Referrals
        async function loadReferrals() {
            if (!userData || !userData.referrals) return;
            
            try {
                const referralPromises = userData.referrals.map(referralId => 
                    database.ref(`users/${referralId}`).once('value')
                );
                
                const snapshots = await Promise.all(referralPromises);
                const referrals = snapshots.map(snapshot => snapshot.val()).filter(Boolean);
                
                // Update referral stats
                document.getElementById('referralCount').textContent = referrals.length;
                document.getElementById('referralEarned').textContent = userData.referralEarnings || 0;
                
                // Show friends list
                const container = document.getElementById('friendsList');
                container.innerHTML = '';
                
                referrals.forEach(referral => {
                    const item = createFriendItem(referral);
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading referrals:', error);
            }
        }

        // Create Friend Item
        function createFriendItem(user) {
            const div = document.createElement('div');
            div.className = 'friend-item';
            
            div.innerHTML = `
                <img src="${user.photoUrl || 'https://via.placeholder.com/40'}" alt="${user.firstName}" class="leaderboard-avatar">
                <div class="leaderboard-info">
                    <div class="leaderboard-name">${user.firstName} ${user.lastName}`.trim() || user.username}</div>
                    <div class="leaderboard-balance">Balance: ${user.balance || 0} TRM | Earned: ${user.totalEarned || 0} TRM</div>
                </div>
            `;
            
            return div;
        }

        // Save Settings
        function saveSettings() {
            if (!currentUser) return;
            
            const settings = {
                notifications: document.getElementById('notificationToggle').classList.contains('active'),
                sound: document.getElementById('soundToggle').classList.contains('active'),
                autoFarm: document.getElementById('autoFarmToggle').classList.contains('active')
            };
            
            database.ref(`users/${currentUser.id}/settings`).set(settings);
        }

        // Show Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Real-time updates
        database.ref('users').on('value', () => {
            if (document.getElementById('leaderboardSection').classList.contains('active')) {
                loadLeaderboard();
            }
        });

        database.ref('tasks').on('value', () => {
            if (document.getElementById('tasksSection').classList.contains('active')) {
                loadTasks();
            }
        });
    </script>
</body>
</html>
