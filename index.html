<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trimint - TRM Mining Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tonconnect-ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .dark-mode {
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: #ffffff;
        }
        
        .light-mode {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: #0f172a;
        }
        
        .bottom-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .dark-mode .bottom-nav {
            background: rgba(15, 15, 15, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .nav-button:hover {
            transform: translateY(-2px);
        }
        
        .nav-button.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .coin-animation {
            animation: coinFloat 3s ease-in-out infinite;
        }
        
        @keyframes coinFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(180deg); }
        }
        
        .farming-active {
            animation: pulse 1s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        .sparkle {
            animation: sparkle 2s linear infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .gradient-border {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8, #8b5cf6);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .task-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .task-card:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .level-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
        
        .level-badge.gold {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
        }
        
        .level-badge.diamond {
            background: linear-gradient(135deg, #c0caf5 0%, #9333ea 100%);
        }
        
        .wallet-connected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .floating-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #3b82f6;
            border-radius: 50%;
            animation: float 4s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body class="light-mode min-h-screen flex flex-col">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="text-center">
            <div class="coin-animation mb-6">
                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="w-24 h-24 mx-auto">
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Trimint</h2>
            <p class="text-gray-300 mb-4">Initializing your mining experience...</p>
            <div id="referralInfo" class="text-green-400 hidden">
                <p class="text-sm">Referred by: <span id="referralName"></span></p>
                <p class="text-xs mt-2">You received 5000 TRM welcome bonus!</p>
            </div>
            <div class="flex justify-center space-x-2">
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <div class="sticky top-0 z-40 p-4">
        <div class="max-w-md mx-auto">
            <div class="rounded-2xl p-4 shadow-lg" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <img id="userPhoto" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff" alt="User" class="w-10 h-10 rounded-full">
                        <div>
                            <h2 id="userName" class="font-semibold text-sm">Loading...</h2>
                            <div id="userLevel" class="level-badge text-xs px-2 py-1 rounded-full text-white inline-block mt-1">Bronze</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="flex items-center justify-end space-x-1">
                            <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="w-5 h-5">
                            <span id="userBalance" class="font-bold text-lg">0</span>
                        </div>
                        <p class="text-xs opacity-75">TRM Balance</p>
                    </div>
                </div>
                
                <!-- TON Wallet Connection -->
                <div id="walletSection" class="mt-3 pt-3 border-t border-gray-200">
                    <button id="connectWalletBtn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-2 px-4 rounded-lg font-semibold text-sm hover:opacity-90 transition-opacity">
                        <i class="fas fa-wallet mr-2"></i>Connect TON Wallet
                    </button>
                    <div id="walletInfo" class="hidden mt-2">
                        <div class="bg-green-100 dark:bg-green-900 p-2 rounded-lg">
                            <p class="text-xs font-semibold text-green-800 dark:text-green-200">
                                <i class="fas fa-check-circle mr-1"></i>Connected
                            </p>
                            <p id="walletAddress" class="text-xs text-green-700 dark:text-green-300 mt-1"></p>
                            <div class="flex space-x-2 mt-2">
                                <button id="copyWalletBtn" class="flex-1 bg-green-500 text-white py-1 px-2 rounded text-xs hover:bg-green-600">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button id="disconnectWalletBtn" class="flex-1 bg-red-500 text-white py-1 px-2 rounded text-xs hover:bg-red-600">
                                    <i class="fas fa-unlink"></i> Disconnect
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto pb-20">
        <div class="max-w-md mx-auto p-4">
            <!-- Home Section -->
            <div id="homeSection" class="section">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold mb-2">TRM Farming</h3>
                    <p class="opacity-75">Start mining TRM tokens every second</p>
                </div>
                
                <div class="relative">
                    <div class="floating-particle" style="top: 10%; left: 10%;"></div>
                    <div class="floating-particle" style="top: 20%; right: 15%; animation-delay: 1s;"></div>
                    <div class="floating-particle" style="bottom: 20%; left: 20%; animation-delay: 2s;"></div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-xl">
                        <div class="text-center mb-6">
                            <div id="mainCoin" class="coin-animation inline-block mb-4">
                                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="w-32 h-32 mx-auto">
                            </div>
                            
                            <div id="farmingStatus" class="mb-4">
                                <p class="text-sm opacity-75">Status: <span id="statusText" class="font-semibold">Not Farming</span></p>
                            </div>
                            
                            <div id="farmingTimer" class="hidden mb-4">
                                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
                                    <p class="text-sm mb-1">Time Remaining:</p>
                                    <p id="countdown" class="text-2xl font-bold">12:00:00</p>
                                </div>
                                
                                <div class="mt-3 bg-blue-50 dark:bg-blue-900 rounded-lg p-2">
                                    <p class="text-xs text-blue-700 dark:text-blue-300">
                                        <i class="fas fa-coins mr-1"></i>
                                        Earning: <span id="earningRate">0.001</span> TRM/sec
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <button id="startFarmingBtn" class="w-full gradient-border text-white py-4 px-6 rounded-xl font-bold text-lg hover:opacity-90 transition-opacity">
                            <i class="fas fa-play mr-2"></i>Start Farming
                        </button>
                    </div>
                </div>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-clock text-blue-500"></i>
                            <span class="text-xs opacity-75">Total Time</span>
                        </div>
                        <p id="totalFarmTime" class="text-xl font-bold">0h 0m</p>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-coins text-green-500"></i>
                            <span class="text-xs opacity-75">Total Earned</span>
                        </div>
                        <p id="totalEarned" class="text-xl font-bold">0 TRM</p>
                    </div>
                </div>
            </div>

            <!-- Tasks Section -->
            <div id="tasksSection" class="section hidden">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold mb-2">Tasks & Rewards</h3>
                    <p class="opacity-75">Complete tasks to earn more TRM</p>
                </div>
                
                <!-- Watch Ads Task -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 mb-4 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-ad text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold">Watch Ads</h4>
                                <p class="text-sm opacity-75">Earn 1 TRM per ad</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-green-500">+1 TRM</p>
                            <button id="watchAdBtn" class="mt-1 bg-blue-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-blue-600">
                                Watch
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Dynamic Tasks -->
                <div id="tasksList">
                    <!-- Tasks will be loaded here from Firebase -->
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div id="leaderboardSection" class="section hidden">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold mb-2">Top Miners</h3>
                    <p class="opacity-75">Best TRM miners worldwide</p>
                </div>
                
                <div id="leaderboardList">
                    <!-- Leaderboard will be loaded here from Firebase -->
                </div>
            </div>

            <!-- Friends Section -->
            <div id="friendsSection" class="section hidden">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold mb-2">Invite Friends</h3>
                    <p class="opacity-75">Earn 5000 TRM for each referral</p>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg mb-4">
                    <div class="text-center mb-4">
                        <p class="text-sm opacity-75 mb-2">Your Referral Link:</p>
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 flex items-center justify-between">
                            <span id="referralLink" class="text-sm font-mono truncate flex-1"></span>
                            <button id="copyReferralBtn" class="ml-2 bg-blue-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-blue-600">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 dark:bg-blue-900 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-blue-600 dark:text-blue-300" id="totalReferrals">0</p>
                            <p class="text-xs opacity-75">Total Referrals</p>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-green-600 dark:text-green-300" id="referralEarnings">0</p>
                            <p class="text-xs opacity-75">Referral Earnings</p>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold mb-3">Your Referrals</h4>
                    <div id="referralsList">
                        <!-- Referrals will be loaded here from Firebase -->
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profileSection" class="section hidden">
                <div class="mb-6">
                    <h3 class="text-2xl font-bold mb-2">Profile Settings</h3>
                    <p class="opacity-75">Manage your account</p>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg mb-4">
                    <div class="text-center mb-4">
                        <img id="profilePhoto" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff" alt="Profile" class="w-20 h-20 rounded-full mx-auto mb-3">
                        <h4 id="profileName" class="font-bold text-lg">Loading...</h4>
                        <p id="profileId" class="text-sm opacity-75">ID: Loading...</p>
                        <div id="profileLevel" class="level-badge text-sm px-3 py-1 rounded-full text-white inline-block mt-2">Bronze</div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm opacity-75">Total Balance:</span>
                            <span class="font-semibold flex items-center">
                                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="w-4 h-4 mr-1">
                                <span id="profileBalance">0</span>
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm opacity-75">Total Friends:</span>
                            <span id="profileFriends" class="font-semibold">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm opacity-75">Joined Date:</span>
                            <span id="joinedDate" class="font-semibold">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg mb-4">
                    <h4 class="font-semibold mb-3">Settings</h4>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Dark Mode</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Notifications</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="notificationToggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <button id="logoutBtn" class="w-full bg-red-500 text-white py-3 px-6 rounded-xl font-semibold hover:bg-red-600 transition-opacity">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav fixed bottom-0 left-0 right-0 p-4">
        <div class="max-w-md mx-auto">
            <div class="flex justify-around items-center">
                <button data-section="home" class="nav-button active p-3 rounded-xl">
                    <i class="fas fa-home text-xl"></i>
                    <p class="text-xs mt-1">Home</p>
                </button>
                <button data-section="tasks" class="nav-button p-3 rounded-xl">
                    <i class="fas fa-tasks text-xl"></i>
                    <p class="text-xs mt-1">Tasks</p>
                </button>
                <button data-section="leaderboard" class="nav-button p-3 rounded-xl">
                    <i class="fas fa-trophy text-xl"></i>
                    <p class="text-xs mt-1">Leaderboard</p>
                </button>
                <button data-section="friends" class="nav-button p-3 rounded-xl">
                    <i class="fas fa-user-friends text-xl"></i>
                    <p class="text-xs mt-1">Friends</p>
                </button>
                <button data-section="profile" class="nav-button p-3 rounded-xl">
                    <i class="fas fa-user text-xl"></i>
                    <p class="text-xs mt-1">Profile</p>
                </button>
            </div>
        </div>
    </div>

    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // Global Variables
        let telegramUser = null;
        let userData = null;
        let farmingActive = false;
        let farmingEndTime = null;
        let farmingInterval = null;
        let tonConnectUI = null;

        // Initialize App
        window.addEventListener('load', () => {
            initializeTelegram();
            initializeTonConnect();
            setupEventListeners();
        });

        // Initialize Telegram Web App
        function initializeTelegram() {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                
                telegramUser = window.Telegram.WebApp.initDataUnsafe?.user;
                
                if (telegramUser) {
                    loadUserData();
                } else {
                    // For testing without Telegram
                    telegramUser = {
                        id: 123456,
                        first_name: "Test User",
                        last_name: "",
                        photo_url: "",
                        username: "testuser"
                    };
                    loadUserData();
                }
            } else {
                setTimeout(initializeTelegram, 100);
            }
        }

        // Initialize TON Connect
        function initializeTonConnect() {
            if (typeof TonConnectUI !== 'undefined') {
                tonConnectUI = new TonConnectUI({
                    manifestUrl: 'https://trimint.vercel.app/tonconnect-manifest.json',
                    buttonRootId: null
                });
                
                tonConnectUI.onStatusChange(wallet => {
                    handleWalletChange(wallet);
                });
            }
        }

        // Load User Data
        async function loadUserData() {
            try {
                const userRef = db.collection('users').doc(telegramUser.id.toString());
                const userDoc = await userRef.get();
                
                if (!userDoc.exists) {
                    // New user
                    userData = {
                        telegramId: telegramUser.id,
                        firstName: telegramUser.first_name,
                        lastName: telegramUser.last_name || '',
                        username: telegramUser.username || '',
                        photoUrl: telegramUser.photo_url || '',
                        balance: 0,
                        level: 'Bronze',
                        totalFarmTime: 0,
                        totalEarned: 0,
                        referrals: [],
                        referralEarnings: 0,
                        joinedDate: new Date().toISOString(),
                        walletAddress: null,
                        tasksCompleted: [],
                        farmingStartTime: null,
                        farmingEndTime: null
                    };
                    
                    // Check for referral
                    const urlParams = new URLSearchParams(window.location.search);
                    const referrerId = urlParams.get('startapp');
                    
                    if (referrerId && referrerId !== telegramUser.id.toString()) {
                        userData.referredBy = referrerId;
                        await processReferral(referrerId);
                    }
                    
                    await userRef.set(userData);
                    showLoadingScreen(false);
                } else {
                    userData = userDoc.data();
                    
                    // Check if user was referred
                    if (!userData.referralProcessed && userData.referredBy) {
                        await processReferral(userData.referredBy);
                        userData.referralProcessed = true;
                        await userRef.update({ referralProcessed: true });
                    }
                    
                    showLoadingScreen(false);
                }
                
                updateUI();
                checkFarmingStatus();
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showLoadingScreen(false);
            }
        }

        // Process Referral
        async function processReferral(referrerId) {
            try {
                // Add 5000 TRM to new user
                userData.balance += 5000;
                userData.referralEarnings += 5000;
                
                // Update referrer
                const referrerRef = db.collection('users').doc(referrerId);
                const referrerDoc = await referrerRef.get();
                
                if (referrerDoc.exists) {
                    await referrerRef.update({
                        referrals: firebase.firestore.FieldValue.arrayUnion({
                            telegramId: telegramUser.id,
                            firstName: telegramUser.first_name,
                            lastName: telegramUser.last_name || '',
                            username: telegramUser.username || '',
                            photoUrl: telegramUser.photo_url || '',
                            joinedDate: new Date().toISOString(),
                            earnings: 5000
                        }),
                        balance: firebase.firestore.FieldValue.increment(5000),
                        referralEarnings: firebase.firestore.FieldValue.increment(5000)
                    });
                    
                    // Show referral info
                    const referrerData = referrerDoc.data();
                    document.getElementById('referralName').textContent = 
                        `${referrerData.firstName} ${referrerData.lastName}`.trim();
                    document.getElementById('referralInfo').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error processing referral:', error);
            }
        }

        // Show/Hide Loading Screen
        function showLoadingScreen(show) {
            const loadingScreen = document.getElementById('loadingScreen');
            if (show) {
                loadingScreen.style.opacity = '1';
                loadingScreen.style.pointerEvents = 'auto';
            } else {
                setTimeout(() => {
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.pointerEvents = 'none';
                }, 1000);
            }
        }

        // Update UI
        function updateUI() {
            if (!userData) return;
            
            // Update user info
            const userName = `${userData.firstName} ${userData.lastName}`.trim();
            document.getElementById('userName').textContent = userName;
            document.getElementById('profileName').textContent = userName;
            document.getElementById('profileId').textContent = `ID: ${userData.telegramId}`;
            
            // Update photos
            const photoUrl = userData.photoUrl || `https://ui-avatars.com/api/?name=${userName}&background=3b82f6&color=fff`;
            document.getElementById('userPhoto').src = photoUrl;
            document.getElementById('profilePhoto').src = photoUrl;
            
            // Update balance
            document.getElementById('userBalance').textContent = userData.balance.toLocaleString();
            document.getElementById('profileBalance').textContent = userData.balance.toLocaleString();
            
            // Update level
            updateLevel(userData.balance);
            
            // Update referrals
            document.getElementById('totalReferrals').textContent = userData.referrals?.length || 0;
            document.getElementById('referralEarnings').textContent = userData.referralEarnings.toLocaleString();
            document.getElementById('profileFriends').textContent = userData.referrals?.length || 0;
            
            // Update referral link
            document.getElementById('referralLink').textContent = 
                `https://t.me/TrimintBot/mine?startapp=${userData.telegramId}`;
            
            // Update stats
            const hours = Math.floor(userData.totalFarmTime / 3600);
            const minutes = Math.floor((userData.totalFarmTime % 3600) / 60);
            document.getElementById('totalFarmTime').textContent = `${hours}h ${minutes}m`;
            document.getElementById('totalEarned').textContent = `${userData.totalEarned} TRM`;
            
            // Update joined date
            if (userData.joinedDate) {
                const joinedDate = new Date(userData.joinedDate).toLocaleDateString();
                document.getElementById('joinedDate').textContent = joinedDate;
            }
            
            // Load sections data
            loadTasks();
            loadLeaderboard();
            loadReferrals();
        }

        // Update Level
        function updateLevel(balance) {
            let level = 'Bronze';
            let levelClass = '';
            
            if (balance >= 50000) {
                level = 'Diamond';
                levelClass = 'diamond';
            } else if (balance >= 10000) {
                level = 'Gold';
                levelClass = 'gold';
            }
            
            userData.level = level;
            
            // Update all level badges
            document.querySelectorAll('.level-badge').forEach(badge => {
                badge.textContent = level;
                badge.className = `level-badge text-sm px-2 py-1 rounded-full text-white inline-block mt-1 ${levelClass}`;
            });
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const section = e.currentTarget.dataset.section;
                    switchSection(section);
                });
            });
            
            // Farming
            document.getElementById('startFarmingBtn').addEventListener('click', toggleFarming);
            
            // Wallet
            document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
            document.getElementById('disconnectWalletBtn').addEventListener('click', disconnectWallet);
            document.getElementById('copyWalletBtn').addEventListener('click', copyWalletAddress);
            
            // Referral
            document.getElementById('copyReferralBtn').addEventListener('click', copyReferralLink);
            
            // Watch Ad
            document.getElementById('watchAdBtn').addEventListener('click', watchAd);
            
            // Dark Mode
            document.getElementById('darkModeToggle').addEventListener('change', (e) => {
                document.body.className = e.target.checked ? 'dark-mode min-h-screen flex flex-col' : 'light-mode min-h-screen flex flex-col';
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to logout?')) {
                    window.Telegram.WebApp.close();
                }
            });
        }

        // Switch Section
        function switchSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(`${section}Section`).classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
        }

        // Toggle Farming
        async function toggleFarming() {
            if (farmingActive) {
                stopFarming();
            } else {
                startFarming();
            }
        }

        // Start Farming
        async function startFarming() {
            farmingActive = true;
            farmingEndTime = Date.now() + (12 * 60 * 60 * 1000); // 12 hours
            
            userData.farmingStartTime = Date.now();
            userData.farmingEndTime = farmingEndTime;
            
            await db.collection('users').doc(telegramUser.id.toString()).update({
                farmingStartTime: userData.farmingStartTime,
                farmingEndTime: userData.farmingEndTime
            });
            
            // Update UI
            document.getElementById('startFarmingBtn').innerHTML = 
                '<i class="fas fa-stop mr-2"></i>Stop Farming';
            document.getElementById('startFarmingBtn').classList.add('bg-red-500');
            document.getElementById('statusText').textContent = 'Farming Active';
            document.getElementById('farmingStatus').classList.add('hidden');
            document.getElementById('farmingTimer').classList.remove('hidden');
            document.getElementById('mainCoin').classList.add('farming-active');
            
            // Start farming loop
            farmingInterval = setInterval(() => {
                const now = Date.now();
                
                if (now >= farmingEndTime) {
                    stopFarming();
                    return;
                }
                
                // Add 0.001 TRM per second
                userData.balance += 0.001;
                userData.totalEarned += 0.001;
                userData.totalFarmTime += 1;
                
                updateBalance();
                updateCountdown();
                
            }, 1000);
        }

        // Stop Farming
        async function stopFarming() {
            farmingActive = false;
            
            if (farmingInterval) {
                clearInterval(farmingInterval);
                farmingInterval = null;
            }
            
            userData.farmingStartTime = null;
            userData.farmingEndTime = null;
            
            await db.collection('users').doc(telegramUser.id.toString()).update({
                balance: userData.balance,
                totalEarned: userData.totalEarned,
                totalFarmTime: userData.totalFarmTime,
                farmingStartTime: null,
                farmingEndTime: null
            });
            
            // Update UI
            document.getElementById('startFarmingBtn').innerHTML = 
                '<i class="fas fa-play mr-2"></i>Start Farming';
            document.getElementById('startFarmingBtn').classList.remove('bg-red-500');
            document.getElementById('statusText').textContent = 'Not Farming';
            document.getElementById('farmingStatus').classList.remove('hidden');
            document.getElementById('farmingTimer').classList.add('hidden');
            document.getElementById('mainCoin').classList.remove('farming-active');
        }

        // Update Balance
        function updateBalance() {
            document.getElementById('userBalance').textContent = userData.balance.toLocaleString(undefined, {
                minimumFractionDigits: 3,
                maximumFractionDigits: 3
            });
            document.getElementById('profileBalance').textContent = userData.balance.toLocaleString(undefined, {
                minimumFractionDigits: 3,
                maximumFractionDigits: 3
            });
            
            const hours = Math.floor(userData.totalFarmTime / 3600);
            const minutes = Math.floor((userData.totalFarmTime % 3600) / 60);
            document.getElementById('totalFarmTime').textContent = `${hours}h ${minutes}m`;
            document.getElementById('totalEarned').textContent = `${userData.totalEarned.toFixed(3)} TRM`;
            
            updateLevel(userData.balance);
        }

        // Update Countdown
        function updateCountdown() {
            const remaining = Math.max(0, farmingEndTime - Date.now());
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            document.getElementById('countdown').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Check Farming Status
        async function checkFarmingStatus() {
            if (userData.farmingEndTime && userData.farmingEndTime > Date.now()) {
                farmingActive = true;
                farmingEndTime = userData.farmingEndTime;
                
                document.getElementById('startFarmingBtn').innerHTML = 
                    '<i class="fas fa-stop mr-2"></i>Stop Farming';
                document.getElementById('startFarmingBtn').classList.add('bg-red-500');
                document.getElementById('statusText').textContent = 'Farming Active';
                document.getElementById('farmingStatus').classList.add('hidden');
                document.getElementById('farmingTimer').classList.remove('hidden');
                document.getElementById('mainCoin').classList.add('farming-active');
                
                // Resume farming loop
                farmingInterval = setInterval(() => {
                    const now = Date.now();
                    
                    if (now >= farmingEndTime) {
                        stopFarming();
                        return;
                    }
                    
                    userData.balance += 0.001;
                    userData.totalEarned += 0.001;
                    userData.totalFarmTime += 1;
                    
                    updateBalance();
                    updateCountdown();
                    
                }, 1000);
            }
        }

        // Wallet Functions
        async function connectWallet() {
            if (tonConnectUI) {
                try {
                    await tonConnectUI.connectWallet();
                } catch (error) {
                    console.error('Error connecting wallet:', error);
                }
            }
        }

        async function disconnectWallet() {
            if (tonConnectUI) {
                try {
                    await tonConnectUI.disconnect();
                } catch (error) {
                    console.error('Error disconnecting wallet:', error);
                }
            }
        }

        function handleWalletChange(wallet) {
            if (wallet) {
                const address = wallet.account.address;
                const formattedAddress = `${address.slice(0, 4)}...${address.slice(-4)}`;
                
                document.getElementById('walletSection').querySelector('.hidden').classList.remove('hidden');
                document.getElementById('connectWalletBtn').classList.add('hidden');
                document.getElementById('walletAddress').textContent = formattedAddress;
                
                userData.walletAddress = address;
                db.collection('users').doc(telegramUser.id.toString()).update({
                    walletAddress: address
                });
            } else {
                document.getElementById('walletSection').querySelector('div.hidden').classList.add('hidden');
                document.getElementById('connectWalletBtn').classList.remove('hidden');
                userData.walletAddress = null;
            }
        }

        function copyWalletAddress() {
            const address = userData.walletAddress;
            navigator.clipboard.writeText(address);
            
            const btn = document.getElementById('copyWalletBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        function copyReferralLink() {
            const link = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(link);
            
            const btn = document.getElementById('copyReferralBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        // Watch Ad
        async function watchAd() {
            const btn = document.getElementById('watchAdBtn');
            btn.disabled = true;
            btn.textContent = 'Loading...';
            
            try {
                // Show Monetag ad
                if (window.show_10290264) {
                    window.show_10290264();
                }
                
                // Add reward after ad
                setTimeout(() => {
                    userData.balance += 1;
                    userData.totalEarned += 1;
                    
                    updateBalance();
                    
                    db.collection('users').doc(telegramUser.id.toString()).update({
                        balance: userData.balance,
                        totalEarned: userData.totalEarned
                    });
                    
                    btn.disabled = false;
                    btn.textContent = 'Watch';
                    
                    // Show success message
                    showNotification('You earned 1 TRM!');
                }, 3000);
                
            } catch (error) {
                console.error('Error showing ad:', error);
                btn.disabled = false;
                btn.textContent = 'Watch';
            }
        }

        // Load Tasks
        async function loadTasks() {
            try {
                const tasksSnapshot = await db.collection('tasks').orderBy('order').get();
                const tasksList = document.getElementById('tasksList');
                tasksList.innerHTML = '';
                
                tasksSnapshot.forEach(doc => {
                    const task = doc.data();
                    const taskId = doc.id;
                    const isCompleted = userData.tasksCompleted?.includes(taskId);
                    
                    const taskCard = document.createElement('div');
                    taskCard.className = 'task-card bg-white dark:bg-gray-800 rounded-xl p-4 mb-3 shadow-lg';
                    taskCard.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <img src="${task.photo || 'https://ui-avatars.com/api/?name=Task&background=3b82f6&color=fff'}" 
                                     alt="${task.name}" class="w-12 h-12 rounded-lg">
                                <div class="flex-1">
                                    <h4 class="font-semibold">${task.name}</h4>
                                    <p class="text-sm opacity-75">${task.description}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold text-green-500">+${task.reward} TRM</p>
                                <button onclick="handleTask('${taskId}', '${task.link}', ${task.reward})" 
                                        class="task-btn mt-1 ${isCompleted ? 'bg-gray-400' : 'bg-blue-500'} 
                                               text-white px-3 py-1 rounded-lg text-xs hover:opacity-90">
                                    ${isCompleted ? 'Completed' : 'Open'}
                                </button>
                            </div>
                        </div>
                    `;
                    tasksList.appendChild(taskCard);
                });
                
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        // Handle Task
        async function handleTask(taskId, link, reward) {
            const isCompleted = userData.tasksCompleted?.includes(taskId);
            
            if (isCompleted) {
                window.open(link, '_blank');
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Processing...';
            button.disabled = true;
            
            window.open(link, '_blank');
            
            setTimeout(async () => {
                userData.balance += reward;
                userData.totalEarned += reward;
                
                if (!userData.tasksCompleted) {
                    userData.tasksCompleted = [];
                }
                userData.tasksCompleted.push(taskId);
                
                await db.collection('users').doc(telegramUser.id.toString()).update({
                    balance: userData.balance,
                    totalEarned: userData.totalEarned,
                    tasksCompleted: userData.tasksCompleted
                });
                
                updateBalance();
                button.textContent = 'Completed';
                button.classList.remove('bg-blue-500');
                button.classList.add('bg-gray-400');
                
                showNotification(`You earned ${reward} TRM!`);
            }, 10000);
        }

        // Load Leaderboard
        async function loadLeaderboard() {
            try {
                const usersSnapshot = await db.collection('users')
                    .orderBy('balance', 'desc')
                    .limit(25)
                    .get();
                
                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = '';
                
                usersSnapshot.forEach((doc, index) => {
                    const user = doc.data();
                    
                    const userCard = document.createElement('div');
                    userCard.className = 'bg-white dark:bg-gray-800 rounded-xl p-4 mb-3 shadow-lg';
                    userCard.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm
                                            ${index === 0 ? 'bg-yellow-500 text-white' : 
                                              index === 1 ? 'bg-gray-400 text-white' : 
                                              index === 2 ? 'bg-orange-600 text-white' : 
                                              'bg-gray-200 text-gray-700'}">
                                    ${index + 1}
                                </div>
                                <img src="${user.photoUrl || `https://ui-avatars.com/api/?name=${user.firstName}&background=3b82f6&color=fff`}" 
                                     alt="${user.firstName}" class="w-10 h-10 rounded-full">
                                <div>
                                    <h4 class="font-semibold">${user.firstName} ${user.lastName}</h4>
                                    <p class="text-xs opacity-75">${user.level}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold flex items-center">
                                    <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="w-4 h-4 mr-1">
                                    ${user.balance.toLocaleString()}
                                </p>
                                <p class="text-xs opacity-75">${user.referrals?.length || 0} friends</p>
                            </div>
                        </div>
                    `;
                    leaderboardList.appendChild(userCard);
                });
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Load Referrals
        async function loadReferrals() {
            try {
                const referralsList = document.getElementById('referralsList');
                referralsList.innerHTML = '';
                
                if (!userData.referrals || userData.referrals.length === 0) {
                    referralsList.innerHTML = '<p class="text-center opacity-75 py-4">No referrals yet</p>';
                    return;
                }
                
                userData.referrals.forEach(referral => {
                    const referralCard = document.createElement('div');
                    referralCard.className = 'bg-white dark:bg-gray-800 rounded-xl p-4 mb-3 shadow-lg';
                    referralCard.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <img src="${referral.photoUrl || `https://ui-avatars.com/api/?name=${referral.firstName}&background=3b82f6&color=fff`}" 
                                     alt="${referral.firstName}" class="w-10 h-10 rounded-full">
                                <div>
                                    <h4 class="font-semibold">${referral.firstName} ${referral.lastName}</h4>
                                    <p class="text-xs opacity-75">ID: ${referral.telegramId}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold text-green-500">+${referral.earnings} TRM</p>
                                <p class="text-xs opacity-75">${new Date(referral.joinedDate).toLocaleDateString()}</p>
                            </div>
                        </div>
                    `;
                    referralsList.appendChild(referralCard);
                });
                
            } catch (error) {
                console.error('Error loading referrals:', error);
            }
        }

        // Show Notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
