<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trimint - Telegram Mining Bot</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #ec4899;
            --background-light: #f8fafc;
            --background-dark: #1e1b4b;
            --card-light: #ffffff;
            --card-dark: #312e81;
            --text-light: #1e293b;
            --text-dark: #f1f5f9;
            --bronze: #cd7f32;
            --gold: #ffd700;
            --diamond: #b9f2ff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }
        
        body.dark-mode {
            --background-light: #1e1b4b;
            --card-light: #312e81;
            --text-light: #f1f5f9;
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            font-weight: 600;
            color: white;
        }
        
        .referral-info {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-weight: 500;
            text-align: center;
            max-width: 80%;
        }
        
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-bottom: 80px;
        }
        
        header {
            background: var(--card-light);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 20px 20px;
            margin-bottom: 20px;
        }
        
        .balance-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .coin-icon {
            width: 30px;
            height: 30px;
        }
        
        .balance {
            font-size: 18px;
            font-weight: 600;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-light);
            transition: transform 0.3s ease;
        }
        
        .theme-toggle:hover {
            transform: scale(1.2);
        }
        
        main {
            flex: 1;
            padding: 0 20px;
            overflow-y: auto;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .home-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .coin-container {
            position: relative;
            margin: 30px 0;
        }
        
        .main-coin {
            width: 200px;
            height: 200px;
            animation: float 3s ease-in-out infinite;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .main-coin:hover {
            transform: scale(1.05);
        }
        
        .main-coin.farming {
            animation: pulse 1s infinite, float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(236, 72, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }
        }
        
        .token-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 18px;
            color: var(--accent-color);
            pointer-events: none;
            opacity: 0;
        }
        
        .token-animation.show {
            animation: tokenFloat 1s ease forwards;
        }
        
        @keyframes tokenFloat {
            0% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -150%); }
        }
        
        .farming-button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        
        .farming-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }
        
        .farming-button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .farming-timer {
            margin-top: 20px;
            font-size: 16px;
            font-weight: 500;
        }
        
        .profile-content {
            background: var(--card-light);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .profile-info h2 {
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .level-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .level-bronze {
            background: var(--bronze);
            color: white;
        }
        
        .level-gold {
            background: var(--gold);
            color: #333;
        }
        
        .level-diamond {
            background: var(--diamond);
            color: #333;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(99, 102, 241, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 14px;
            color: #64748b;
            margin-top: 5px;
        }
        
        .wallet-section {
            margin-top: 20px;
        }
        
        .wallet-button {
            width: 100%;
            background: linear-gradient(135deg, #0088cc, #005580);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .wallet-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 136, 204, 0.4);
        }
        
        .wallet-info {
            background: rgba(0, 136, 204, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .wallet-address {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .address-text {
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            flex: 1;
        }
        
        .wallet-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .wallet-action-btn {
            flex: 1;
            background: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 8px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .wallet-action-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .settings-section {
            margin-top: 20px;
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .setting-label {
            font-size: 16px;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #ccc;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: var(--primary-color);
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }
        
        .tasks-content {
            background: var(--card-light);
            border-radius: 15px;
            padding: 20px;
        }
        
        .task-item {
            background: rgba(99, 102, 241, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
        }
        
        .task-info {
            flex: 1;
        }
        
        .task-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .task-reward {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: var(--primary-color);
        }
        
        .task-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .task-button:hover {
            background: var(--secondary-color);
        }
        
        .task-button.processing {
            background: #f59e0b;
        }
        
        .task-button.completed {
            background: #10b981;
        }
        
        .leaderboard-content {
            background: var(--card-light);
            border-radius: 15px;
            padding: 20px;
        }
        
        .leaderboard-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(99, 102, 241, 0.05);
        }
        
        .leaderboard-rank {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border-radius: 50%;
        }
        
        .rank-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
        }
        
        .rank-2 {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #333;
        }
        
        .rank-3 {
            background: linear-gradient(135deg, #cd7f32, #e4a853);
            color: white;
        }
        
        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .leaderboard-info {
            flex: 1;
        }
        
        .leaderboard-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .leaderboard-balance {
            font-size: 14px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .friends-content {
            background: var(--card-light);
            border-radius: 15px;
            padding: 20px;
        }
        
        .referral-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }
        
        .referral-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .referral-link {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            word-break: break-all;
        }
        
        .copy-button {
            background: white;
            color: var(--primary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .copy-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .referral-stat {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .referral-stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .referral-stat-label {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .referrals-list {
            margin-top: 20px;
        }
        
        .referrals-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .referral-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(99, 102, 241, 0.05);
            margin-bottom: 10px;
        }
        
        .referral-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .referral-info {
            flex: 1;
        }
        
        .referral-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .referral-earned {
            font-size: 14px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card-light);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 20px 20px 0 0;
        }
        
        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px;
            position: relative;
        }
        
        .nav-button.active {
            color: var(--primary-color);
        }
        
        .nav-button.home-button {
            transform: scale(1.2);
        }
        
        .nav-button.home-button.active {
            color: var(--accent-color);
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            color: var(--text-light);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .notification-message {
            font-size: 14px;
        }
        
        .ad-container {
            margin: 20px 0;
            text-align: center;
        }
        
        .ad-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .ad-button {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0 auto;
        }
        
        .ad-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        @media (max-width: 480px) {
            .main-coin {
                width: 150px;
                height: 150px;
            }
            
            .profile-stats {
                grid-template-columns: 1fr;
            }
            
            .referral-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">Loading Trimint...</div>
        <div class="referral-info" id="referralInfo" style="display: none;">
            You were invited by <span id="referralName"></span>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-title" id="notificationTitle">Notification</div>
        <div class="notification-message" id="notificationMessage">Message</div>
    </div>
    
    <!-- App Container -->
    <div class="app-container">
        <!-- Header -->
        <header>
            <div class="balance-container">
                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="coin-icon">
                <div class="balance" id="userBalance">0 TRM</div>
            </div>
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
        </header>
        
        <!-- Main Content -->
        <main>
            <!-- Home Page -->
            <div class="page active" id="homePage">
                <div class="home-content">
                    <div class="coin-container">
                        <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM Coin" class="main-coin" id="mainCoin">
                        <div class="token-animation" id="tokenAnimation">+0.001 TRM</div>
                    </div>
                    <button class="farming-button" id="farmingButton">Start Farming</button>
                    <div class="farming-timer" id="farmingTimer" style="display: none;">
                        Time remaining: <span id="timerDisplay">12:00:00</span>
                    </div>
                </div>
            </div>
            
            <!-- Profile Page -->
            <div class="page" id="profilePage">
                <div class="profile-content">
                    <div class="profile-header">
                        <img src="https://picsum.photos/seed/trimint/80/80.jpg" alt="Profile" class="profile-avatar" id="profileAvatar">
                        <div class="profile-info">
                            <h2 id="profileName">User</h2>
                            <div class="level-badge level-bronze" id="levelBadge">Bronze</div>
                        </div>
                    </div>
                    
                    <div class="profile-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalBalance">0</div>
                            <div class="stat-label">Total Balance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalFriends">0</div>
                            <div class="stat-label">Total Friends</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalTasks">0</div>
                            <div class="stat-label">Tasks Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalFarming">0</div>
                            <div class="stat-label">Farming Hours</div>
                        </div>
                    </div>
                    
                    <div class="wallet-section">
                        <button class="wallet-button" id="walletButton">
                            <i class="fas fa-wallet"></i>
                            Connect TON Wallet
                        </button>
                        <div class="wallet-info" id="walletInfo" style="display: none;">
                            <div class="wallet-address">
                                <div class="address-text" id="walletAddress">Address</div>
                            </div>
                            <div class="wallet-actions">
                                <button class="wallet-action-btn" id="copyAddress">Copy</button>
                                <button class="wallet-action-btn" id="disconnectWallet">Disconnect</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-title">Settings</div>
                        <div class="setting-item">
                            <div class="setting-label">Notifications</div>
                            <div class="toggle-switch active" id="notificationToggle">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Sound Effects</div>
                            <div class="toggle-switch active" id="soundToggle">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Auto-start Farming</div>
                            <div class="toggle-switch" id="autoFarmingToggle">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tasks Page -->
            <div class="page" id="tasksPage">
                <div class="tasks-content">
                    <div class="ad-container">
                        <div class="ad-title">Watch Ads & Earn</div>
                        <button class="ad-button" id="watchAdsButton">
                            <i class="fas fa-play-circle"></i>
                            Watch Ads (+1 TRM)
                        </button>
                    </div>
                    
                    <div class="tasks-list" id="tasksList">
                        <!-- Tasks will be loaded here from Firebase -->
                    </div>
                </div>
            </div>
            
            <!-- Leaderboard Page -->
            <div class="page" id="leaderboardPage">
                <div class="leaderboard-content">
                    <div class="leaderboard-title">Top Miners</div>
                    <div class="leaderboard-list" id="leaderboardList">
                        <!-- Leaderboard items will be loaded here from Firebase -->
                    </div>
                </div>
            </div>
            
            <!-- Friends Page -->
            <div class="page" id="friendsPage">
                <div class="friends-content">
                    <div class="referral-section">
                        <div class="referral-title">Invite Friends & Earn 5000 TRM</div>
                        <div class="referral-link" id="referralLink">https://t.me/TrimintBot/mine?startapp=</div>
                        <button class="copy-button" id="copyReferralLink">Copy Link</button>
                    </div>
                    
                    <div class="referral-stats">
                        <div class="referral-stat">
                            <div class="referral-stat-value" id="totalReferrals">0</div>
                            <div class="referral-stat-label">Total Referrals</div>
                        </div>
                        <div class="referral-stat">
                            <div class="referral-stat-value" id="referralEarnings">0 TRM</div>
                            <div class="referral-stat-label">Referral Earnings</div>
                        </div>
                    </div>
                    
                    <div class="referrals-list">
                        <div class="referrals-title">Your Referrals</div>
                        <div id="referralsList">
                            <!-- Referrals will be loaded here from Firebase -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-button home-button active" id="homeNav">
                <i class="fas fa-home nav-icon"></i>
                <span class="nav-label">Home</span>
            </button>
            <button class="nav-button" id="profileNav">
                <i class="fas fa-user nav-icon"></i>
                <span class="nav-label">Profile</span>
            </button>
            <button class="nav-button" id="tasksNav">
                <i class="fas fa-tasks nav-icon"></i>
                <span class="nav-label">Tasks</span>
            </button>
            <button class="nav-button" id="leaderboardNav">
                <i class="fas fa-trophy nav-icon"></i>
                <span class="nav-label">Leaderboard</span>
            </button>
            <button class="nav-button" id="friendsNav">
                <i class="fas fa-user-friends nav-icon"></i>
                <span class="nav-label">Friends</span>
            </button>
        </nav>
    </div>
    
    <!-- Monetag Ads Script -->
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Telegram Bot API
        const telegramBotToken = "8099896534:AAFmOTkOjLC8RSSJy-dXtjPQotF3hJlyXTQ";
        
        // TON Connect
        let tonConnectUI;
        
        // App State
        let currentUser = null;
        let isFarming = false;
        let farmingEndTime = null;
        let farmingInterval = null;
        let balance = 0;
        let tasks = [];
        let leaderboard = [];
        let referrals = [];
        let settings = {
            notifications: true,
            soundEffects: true,
            autoFarming: false
        };
        let lastSavedBalance = 0;
        let balanceSaveInterval = null;
        
        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const notification = document.getElementById('notification');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        const themeToggle = document.getElementById('themeToggle');
        const userBalance = document.getElementById('userBalance');
        const mainCoin = document.getElementById('mainCoin');
        const tokenAnimation = document.getElementById('tokenAnimation');
        const farmingButton = document.getElementById('farmingButton');
        const farmingTimer = document.getElementById('farmingTimer');
        const timerDisplay = document.getElementById('timerDisplay');
        
        // Navigation Elements
        const homeNav = document.getElementById('homeNav');
        const profileNav = document.getElementById('profileNav');
        const tasksNav = document.getElementById('tasksNav');
        const leaderboardNav = document.getElementById('leaderboardNav');
        const friendsNav = document.getElementById('friendsNav');
        
        // Page Elements
        const homePage = document.getElementById('homePage');
        const profilePage = document.getElementById('profilePage');
        const tasksPage = document.getElementById('tasksPage');
        const leaderboardPage = document.getElementById('leaderboardPage');
        const friendsPage = document.getElementById('friendsPage');
        
        // Profile Elements
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const levelBadge = document.getElementById('levelBadge');
        const totalBalance = document.getElementById('totalBalance');
        const totalFriends = document.getElementById('totalFriends');
        const totalTasks = document.getElementById('totalTasks');
        const totalFarming = document.getElementById('totalFarming');
        const walletButton = document.getElementById('walletButton');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddress = document.getElementById('walletAddress');
        const copyAddress = document.getElementById('copyAddress');
        const disconnectWallet = document.getElementById('disconnectWallet');
        
        // Settings Elements
        const notificationToggle = document.getElementById('notificationToggle');
        const soundToggle = document.getElementById('soundToggle');
        const autoFarmingToggle = document.getElementById('autoFarmingToggle');
        
        // Tasks Elements
        const tasksList = document.getElementById('tasksList');
        const watchAdsButton = document.getElementById('watchAdsButton');
        
        // Leaderboard Elements
        const leaderboardList = document.getElementById('leaderboardList');
        
        // Friends Elements
        const referralLink = document.getElementById('referralLink');
        const copyReferralLink = document.getElementById('copyReferralLink');
        const totalReferrals = document.getElementById('totalReferrals');
        const referralEarnings = document.getElementById('referralEarnings');
        const referralsList = document.getElementById('referralsList');
        
        // Initialize Telegram Web App
        function initTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                
                // Get user data from Telegram
                currentUser = tg.initDataUnsafe?.user;
                
                if (currentUser) {
                    // Update profile with Telegram data
                    profileName.textContent = `${currentUser.first_name} ${currentUser.last_name || ''}`;
                    profileAvatar.src = currentUser.photo_url || `https://picsum.photos/seed/${currentUser.id}/80/80.jpg`;
                    
                    // Generate referral link
                    referralLink.textContent = `https://t.me/TrimintBot/mine?startapp=${currentUser.id}`;
                    
                    // Check if user came from a referral
                    const urlParams = new URLSearchParams(window.location.search);
                    const referrerId = urlParams.get('startapp');
                    
                    if (referrerId && referrerId !== currentUser.id.toString()) {
                        // Process referral
                        processReferral(referrerId, currentUser);
                    }
                    
                    // Load user data from Firebase
                    loadUserData();
                } else {
                    // For testing without Telegram
                    currentUser = {
                        id: 123456789,
                        first_name: "Test",
                        last_name: "User",
                        username: "testuser",
                        photo_url: "https://picsum.photos/seed/testuser/80/80.jpg"
                    };
                    
                    profileName.textContent = `${currentUser.first_name} ${currentUser.last_name || ''}`;
                    profileAvatar.src = currentUser.photo_url;
                    referralLink.textContent = `https://t.me/TrimintBot/mine?startapp=${currentUser.id}`;
                    
                    // Check for test referral
                    const urlParams = new URLSearchParams(window.location.search);
                    const referrerId = urlParams.get('startapp');
                    
                    if (referrerId && referrerId !== currentUser.id.toString()) {
                        processReferral(referrerId, currentUser);
                    }
                    
                    loadUserData();
                }
            } else {
                // For testing outside Telegram
                currentUser = {
                    id: 123456789,
                    first_name: "Test",
                    last_name: "User",
                    username: "testuser",
                    photo_url: "https://picsum.photos/seed/testuser/80/80.jpg"
                };
                
                profileName.textContent = `${currentUser.first_name} ${currentUser.last_name || ''}`;
                profileAvatar.src = currentUser.photo_url;
                referralLink.textContent = `https://t.me/TrimintBot/mine?startapp=${currentUser.id}`;
                
                // Check for test referral
                const urlParams = new URLSearchParams(window.location.search);
                const referrerId = urlParams.get('startapp');
                
                if (referrerId && referrerId !== currentUser.id.toString()) {
                    processReferral(referrerId, currentUser);
                }
                
                loadUserData();
            }
            
            // Hide loading screen after initialization
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, 2000);
        }
        
        // Load user data from Firebase
        function loadUserData() {
            if (!currentUser) return;
            
            const userRef = db.collection('users').doc(currentUser.id.toString());
            
            userRef.get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    balance = userData.balance || 0;
                    lastSavedBalance = balance;
                    isFarming = userData.isFarming || false;
                    farmingEndTime = userData.farmingEndTime || null;
                    settings = userData.settings || settings;
                    
                    // Update UI with user data
                    updateBalance();
                    updateLevel();
                    updateSettings();
                    
                    // Start periodic balance save
                    startBalanceSaveInterval();
                    
                    // Check if farming was in progress
                    if (isFarming && farmingEndTime) {
                        const now = new Date().getTime();
                        const endTime = new Date(farmingEndTime).getTime();
                        
                        if (now < endTime) {
                            // Continue farming
                            startFarming(true);
                        } else {
                            // Farming ended, update state
                            isFarming = false;
                            farmingEndTime = null;
                            userRef.update({
                                isFarming: false,
                                farmingEndTime: null
                            });
                        }
                    }
                } else {
                    // Create new user document
                    userRef.set({
                        id: currentUser.id,
                        name: `${currentUser.first_name} ${currentUser.last_name || ''}`,
                        username: currentUser.username || '',
                        photoUrl: currentUser.photo_url || '',
                        balance: 0,
                        isFarming: false,
                        farmingEndTime: null,
                        level: 'Bronze',
                        totalFriends: 0,
                        totalTasks: 0,
                        totalFarming: 0,
                        referralEarnings: 0,
                        referrals: [],
                        walletAddress: null,
                        settings: settings,
                        createdAt: new Date()
                    });
                    
                    // Start periodic balance save
                    startBalanceSaveInterval();
                }
                
                // Load tasks
                loadTasks();
                
                // Load leaderboard
                loadLeaderboard();
                
                // Load referrals
                loadReferrals();
            });
        }
        
        // Start periodic balance save
        function startBalanceSaveInterval() {
            // Clear any existing interval
            if (balanceSaveInterval) {
                clearInterval(balanceSaveInterval);
            }
            
            // Save balance every 30 seconds
            balanceSaveInterval = setInterval(() => {
                if (currentUser && Math.abs(balance - lastSavedBalance) > 0.001) {
                    saveBalance();
                }
            }, 30000);
        }
        
        // Save balance to Firebase
        function saveBalance() {
            if (!currentUser) return;
            
            const userRef = db.collection('users').doc(currentUser.id.toString());
            userRef.update({
                balance: balance
            }).then(() => {
                lastSavedBalance = balance;
            }).catch(error => {
                console.error('Error saving balance:', error);
            });
        }
        
        // Update balance display
        function updateBalance() {
            userBalance.textContent = `${balance.toFixed(3)} TRM`;
            totalBalance.textContent = balance.toFixed(3);
        }
        
        // Update user level based on balance
        function updateLevel() {
            let level = 'Bronze';
            let levelClass = 'level-bronze';
            
            if (balance >= 50000) {
                level = 'Diamond';
                levelClass = 'level-diamond';
            } else if (balance >= 10000) {
                level = 'Gold';
                levelClass = 'level-gold';
            }
            
            levelBadge.textContent = level;
            levelBadge.className = `level-badge ${levelClass}`;
            
            // Update in Firebase
            if (currentUser) {
                db.collection('users').doc(currentUser.id.toString()).update({
                    level: level
                });
            }
        }
        
        // Update settings UI
        function updateSettings() {
            notificationToggle.classList.toggle('active', settings.notifications);
            soundToggle.classList.toggle('active', settings.soundEffects);
            autoFarmingToggle.classList.toggle('active', settings.autoFarming);
        }
        
        // Start farming
        function startFarming(resume = false) {
            if (!currentUser) return;
            
            isFarming = true;
            mainCoin.classList.add('farming');
            farmingButton.textContent = 'Farming...';
            farmingButton.disabled = true;
            farmingTimer.style.display = 'block';
            
            // Set end time if not resuming
            if (!resume) {
                const now = new Date();
                farmingEndTime = new Date(now.getTime() + 12 * 60 * 60 * 1000); // 12 hours from now
                
                // Update in Firebase
                db.collection('users').doc(currentUser.id.toString()).update({
                    isFarming: true,
                    farmingEndTime: farmingEndTime
                });
                
                // Update total farming count
                db.collection('users').doc(currentUser.id.toString()).update({
                    totalFarming: firebase.firestore.FieldValue.increment(1)
                });
            }
            
            // Update timer
            updateFarmingTimer();
            
            // Start farming interval
            farmingInterval = setInterval(() => {
                if (isFarming) {
                    // Add 0.001 TRM every second
                    balance += 0.001;
                    updateBalance();
                    updateLevel();
                    
                    // Show token animation
                    showTokenAnimation();
                    
                    // Update in Firebase every 10 seconds
                    if (Math.floor(balance * 1000) % 10 === 0) {
                        saveBalance();
                    }
                    
                    // Check if farming is complete
                    const now = new Date().getTime();
                    const endTime = new Date(farmingEndTime).getTime();
                    
                    if (now >= endTime) {
                        stopFarming();
                        showNotification('Farming Complete', 'You have successfully farmed for 12 hours!');
                    }
                }
            }, 1000);
        }
        
        // Stop farming
        function stopFarming() {
            isFarming = false;
            mainCoin.classList.remove('farming');
            farmingButton.textContent = 'Start Farming';
            farmingButton.disabled = false;
            farmingTimer.style.display = 'none';
            
            // Clear interval
            if (farmingInterval) {
                clearInterval(farmingInterval);
                farmingInterval = null;
            }
            
            // Save balance before stopping
            saveBalance();
            
            // Update in Firebase
            if (currentUser) {
                db.collection('users').doc(currentUser.id.toString()).update({
                    isFarming: false,
                    farmingEndTime: null
                });
            }
        }
        
        // Update farming timer display
        function updateFarmingTimer() {
            if (!isFarming || !farmingEndTime) return;
            
            const now = new Date().getTime();
            const endTime = new Date(farmingEndTime).getTime();
            const distance = endTime - now;
            
            if (distance > 0) {
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                timerDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Update timer every second
                setTimeout(updateFarmingTimer, 1000);
            }
        }
        
        // Show token animation
        function showTokenAnimation() {
            tokenAnimation.classList.add('show');
            setTimeout(() => {
                tokenAnimation.classList.remove('show');
            }, 1000);
        }
        
        // Process referral
        function processReferral(referrerId, newUser) {
            // Get referrer data
            db.collection('users').doc(referrerId).get().then((referrerDoc) => {
                if (referrerDoc.exists) {
                    // Add 5000 TRM to referrer
                    const referrerData = referrerDoc.data();
                    const newBalance = (referrerData.balance || 0) + 5000;
                    const referralEarnings = (referrerData.referralEarnings || 0) + 5000;
                    const referrals = referrerData.referrals || [];
                    
                    // Add new user to referrals list
                    referrals.push({
                        id: newUser.id,
                        name: `${newUser.first_name} ${newUser.last_name || ''}`,
                        username: newUser.username || '',
                        photoUrl: newUser.photo_url || '',
                        joinedAt: new Date()
                    });
                    
                    // Update referrer data
                    db.collection('users').doc(referrerId).update({
                        balance: newBalance,
                        referralEarnings: referralEarnings,
                        referrals: referrals,
                        totalFriends: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    // Show referral info on loading screen
                    document.getElementById('referralName').textContent = referrerData.name;
                    document.getElementById('referralInfo').style.display = 'block';
                }
            });
        }
        
        // Load tasks from Firebase
        function loadTasks() {
            db.collection('tasks').orderBy('order').get().then((querySnapshot) => {
                tasks = [];
                tasksList.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const task = doc.data();
                    task.id = doc.id;
                    tasks.push(task);
                    
                    // Create task element
                    const taskElement = document.createElement('div');
                    taskElement.className = 'task-item';
                    
                    // Check if user has completed this task
                    if (currentUser) {
                        db.collection('users').doc(currentUser.id.toString()).collection('completedTasks').doc(task.id).get().then((taskDoc) => {
                            const isCompleted = taskDoc.exists;
                            
                            taskElement.innerHTML = `
                                <img src="${task.icon || 'https://picsum.photos/seed/task/50/50.jpg'}" alt="${task.name}" class="task-icon">
                                <div class="task-info">
                                    <div class="task-name">${task.name}</div>
                                    <div class="task-reward">
                                        <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" style="width: 16px; height: 16px;">
                                        ${task.reward} TRM
                                    </div>
                                </div>
                                <button class="task-button ${isCompleted ? 'completed' : ''}" data-task-id="${task.id}" data-task-link="${task.link}" data-task-reward="${task.reward}">${isCompleted ? 'COMPLETED' : 'OPEN'}</button>
                            `;
                            
                            tasksList.appendChild(taskElement);
                            
                            // Add event listener to task button
                            const button = taskElement.querySelector('.task-button');
                            button.addEventListener('click', handleTaskClick);
                        });
                    } else {
                        taskElement.innerHTML = `
                            <img src="${task.icon || 'https://picsum.photos/seed/task/50/50.jpg'}" alt="${task.name}" class="task-icon">
                            <div class="task-info">
                                <div class="task-name">${task.name}</div>
                                <div class="task-reward">
                                    <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" style="width: 16px; height: 16px;">
                                    ${task.reward} TRM
                                </div>
                            </div>
                            <button class="task-button" data-task-id="${task.id}" data-task-link="${task.link}" data-task-reward="${task.reward}">OPEN</button>
                        `;
                        
                        tasksList.appendChild(taskElement);
                        
                        // Add event listener to task button
                        const button = taskElement.querySelector('.task-button');
                        button.addEventListener('click', handleTaskClick);
                    }
                });
            });
        }
        
        // Handle task button click
        function handleTaskClick(event) {
            const button = event.target;
            const taskId = button.getAttribute('data-task-id');
            const taskLink = button.getAttribute('data-task-link');
            const taskReward = parseFloat(button.getAttribute('data-task-reward'));
            
            if (button.classList.contains('completed')) {
                // Already completed, just open the link
                window.open(taskLink, '_blank');
                return;
            }
            
            if (button.classList.contains('processing')) {
                // Already processing, do nothing
                return;
            }
            
            // Start processing
            button.classList.add('processing');
            button.textContent = 'PROCESSING';
            
            // Open the task link
            window.open(taskLink, '_blank');
            
            // After 10 seconds, mark as completed and add reward
            setTimeout(() => {
                button.classList.remove('processing');
                button.classList.add('completed');
                button.textContent = 'COMPLETED';
                
                // Add reward to balance
                balance += taskReward;
                updateBalance();
                updateLevel();
                
                // Save balance
                saveBalance();
                
                // Update in Firebase
                if (currentUser) {
                    db.collection('users').doc(currentUser.id.toString()).update({
                        totalTasks: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    // Mark task as completed
                    db.collection('users').doc(currentUser.id.toString()).collection('completedTasks').doc(taskId).set({
                        completedAt: new Date()
                    });
                    
                    // Show notification
                    showNotification('Task Completed', `You earned ${taskReward} TRM!`);
                }
            }, 10000);
        }
        
        // Load leaderboard from Firebase
        function loadLeaderboard() {
            db.collection('users').orderBy('balance', 'desc').limit(25).get().then((querySnapshot) => {
                leaderboard = [];
                leaderboardList.innerHTML = '';
                
                querySnapshot.forEach((doc, index) => {
                    const user = doc.data();
                    user.id = doc.id;
                    user.rank = index + 1;
                    leaderboard.push(user);
                    
                    // Create leaderboard item
                    const leaderboardItem = document.createElement('div');
                    leaderboardItem.className = 'leaderboard-item';
                    
                    let rankClass = '';
                    if (index === 0) rankClass = 'rank-1';
                    else if (index === 1) rankClass = 'rank-2';
                    else if (index === 2) rankClass = 'rank-3';
                    
                    leaderboardItem.innerHTML = `
                        <div class="leaderboard-rank ${rankClass}">${user.rank}</div>
                        <img src="${user.photoUrl || `https://picsum.photos/seed/${user.id}/40/40.jpg`}" alt="${user.name}" class="leaderboard-avatar">
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${user.name}</div>
                            <div class="leaderboard-balance">
                                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" style="width: 16px; height: 16px;">
                                ${user.balance ? user.balance.toFixed(3) : '0'} TRM
                            </div>
                        </div>
                    `;
                    
                    leaderboardList.appendChild(leaderboardItem);
                });
            });
        }
        
        // Load referrals from Firebase
        function loadReferrals() {
            if (!currentUser) return;
            
            const userRef = db.collection('users').doc(currentUser.id.toString());
            
            userRef.get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    const referrals = userData.referrals || [];
                    const referralEarnings = userData.referralEarnings || 0;
                    
                    // Update referral stats
                    totalReferrals.textContent = referrals.length;
                    referralEarnings.textContent = `${referralEarnings} TRM`;
                    
                    // Update referrals list
                    referralsList.innerHTML = '';
                    
                    referrals.forEach((referral) => {
                        const referralItem = document.createElement('div');
                        referralItem.className = 'referral-item';
                        
                        referralItem.innerHTML = `
                            <img src="${referral.photoUrl || `https://picsum.photos/seed/${referral.id}/40/40.jpg`}" alt="${referral.name}" class="referral-avatar">
                            <div class="referral-info">
                                <div class="referral-name">${referral.name}</div>
                                <div class="referral-earned">
                                    <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" style="width: 16px; height: 16px;">
                                    5000 TRM
                                </div>
                            </div>
                        `;
                        
                        referralsList.appendChild(referralItem);
                    });
                }
            });
        }
        
        // Initialize TON Connect
        function initTonConnect() {
            tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                manifestUrl: 'https://trimint.vercel.app/tonconnect-manifest.json',
                buttonRootId: null
            });
            
            // Check if wallet is already connected
            tonConnectUI.onStatusChange(wallet => {
                if (wallet) {
                    // Wallet connected
                    const address = wallet.account.address;
                    walletAddress.textContent = address;
                    walletInfo.style.display = 'block';
                    walletButton.textContent = 'Connected';
                    walletButton.disabled = true;
                    
                    // Update in Firebase
                    if (currentUser) {
                        db.collection('users').doc(currentUser.id.toString()).update({
                            walletAddress: address
                        });
                    }
                } else {
                    // Wallet disconnected
                    walletInfo.style.display = 'none';
                    walletButton.textContent = 'Connect TON Wallet';
                    walletButton.disabled = false;
                    
                    // Update in Firebase
                    if (currentUser) {
                        db.collection('users').doc(currentUser.id.toString()).update({
                            walletAddress: null
                        });
                    }
                }
            });
        }
        
        // Show notification
        function showNotification(title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Event Listeners
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const icon = themeToggle.querySelector('i');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        });
        
        farmingButton.addEventListener('click', () => {
            if (!isFarming) {
                startFarming();
            }
        });
        
        // Navigation
        homeNav.addEventListener('click', () => {
            showPage('home');
        });
        
        profileNav.addEventListener('click', () => {
            showPage('profile');
        });
        
        tasksNav.addEventListener('click', () => {
            showPage('tasks');
        });
        
        leaderboardNav.addEventListener('click', () => {
            showPage('leaderboard');
        });
        
        friendsNav.addEventListener('click', () => {
            showPage('friends');
        });
        
        // Show page function
        function showPage(pageName) {
            // Hide all pages
            homePage.classList.remove('active');
            profilePage.classList.remove('active');
            tasksPage.classList.remove('active');
            leaderboardPage.classList.remove('active');
            friendsPage.classList.remove('active');
            
            // Remove active class from all nav buttons
            homeNav.classList.remove('active');
            profileNav.classList.remove('active');
            tasksNav.classList.remove('active');
            leaderboardNav.classList.remove('active');
            friendsNav.classList.remove('active');
            
            // Show selected page
            switch (pageName) {
                case 'home':
                    homePage.classList.add('active');
                    homeNav.classList.add('active');
                    break;
                case 'profile':
                    profilePage.classList.add('active');
                    profileNav.classList.add('active');
                    break;
                case 'tasks':
                    tasksPage.classList.add('active');
                    tasksNav.classList.add('active');
                    break;
                case 'leaderboard':
                    leaderboardPage.classList.add('active');
                    leaderboardNav.classList.add('active');
                    loadLeaderboard(); // Refresh leaderboard when page is shown
                    break;
                case 'friends':
                    friendsPage.classList.add('active');
                    friendsNav.classList.add('active');
                    break;
            }
        }
        
        // Wallet button
        walletButton.addEventListener('click', () => {
            if (tonConnectUI) {
                tonConnectUI.connectWallet();
            }
        });
        
        // Copy address button
        copyAddress.addEventListener('click', () => {
            const address = walletAddress.textContent;
            navigator.clipboard.writeText(address).then(() => {
                showNotification('Copied', 'Wallet address copied to clipboard');
            });
        });
        
        // Disconnect wallet button
        disconnectWallet.addEventListener('click', () => {
            if (tonConnectUI) {
                tonConnectUI.disconnect();
            }
        });
        
        // Copy referral link
        copyReferralLink.addEventListener('click', () => {
            const link = referralLink.textContent;
            navigator.clipboard.writeText(link).then(() => {
                showNotification('Copied', 'Referral link copied to clipboard');
            });
        });
        
        // Settings toggles
        notificationToggle.addEventListener('click', () => {
            notificationToggle.classList.toggle('active');
            settings.notifications = notificationToggle.classList.contains('active');
            
            // Update in Firebase
            if (currentUser) {
                db.collection('users').doc(currentUser.id.toString()).update({
                    settings: settings
                });
            }
        });
        
        soundToggle.addEventListener('click', () => {
            soundToggle.classList.toggle('active');
            settings.soundEffects = soundToggle.classList.contains('active');
            
            // Update in Firebase
            if (currentUser) {
                db.collection('users').doc(currentUser.id.toString()).update({
                    settings: settings
                });
            }
        });
        
        autoFarmingToggle.addEventListener('click', () => {
            autoFarmingToggle.classList.toggle('active');
            settings.autoFarming = autoFarmingToggle.classList.contains('active');
            
            // Update in Firebase
            if (currentUser) {
                db.collection('users').doc(currentUser.id.toString()).update({
                    settings: settings
                });
            }
        });
        
        // Watch ads button
        watchAdsButton.addEventListener('click', () => {
            // Show ad using Monetag
            if (window.libtl) {
                window.libtl.showAd(() => {
                    // Ad completed, add 1 TRM to balance
                    balance += 1;
                    updateBalance();
                    updateLevel();
                    
                    // Save balance
                    saveBalance();
                    
                    // Show notification
                    showNotification('Ad Watched', 'You earned 1 TRM!');
                });
            } else {
                // Fallback if ad library is not loaded
                balance += 1;
                updateBalance();
                updateLevel();
                
                // Save balance
                saveBalance();
                
                // Show notification
                showNotification('Ad Watched', 'You earned 1 TRM!');
            }
        });
        
        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page is hidden, save current state
                if (currentUser) {
                    saveBalance();
                    
                    if (isFarming) {
                        db.collection('users').doc(currentUser.id.toString()).update({
                            isFarming: isFarming,
                            farmingEndTime: farmingEndTime
                        });
                    }
                }
            } else {
                // Page is visible again, check if farming should continue
                if (currentUser && isFarming && farmingEndTime) {
                    const now = new Date().getTime();
                    const endTime = new Date(farmingEndTime).getTime();
                    
                    if (now < endTime) {
                        // Continue farming
                        startFarming(true);
                    } else {
                        // Farming ended while page was hidden
                        stopFarming();
                        showNotification('Farming Complete', 'You have successfully farmed for 12 hours!');
                    }
                }
            }
        });
        
        // Handle beforeunload event
        window.addEventListener('beforeunload', () => {
            // Save data before leaving
            if (currentUser) {
                saveBalance();
                
                if (isFarming) {
                    db.collection('users').doc(currentUser.id.toString()).update({
                        isFarming: isFarming,
                        farmingEndTime: farmingEndTime
                    });
                }
            }
        });
        
        // Initialize app
        window.addEventListener('DOMContentLoaded', () => {
            initTelegramWebApp();
            initTonConnect();
        });
    </script>
</body>
</html>
