<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trimint - TRM Mining</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #6c63ff;
            --accent-color: #ff6584;
            --background-color: #f5f7ff;
            --card-color: #ffffff;
            --text-color: #333333;
            --text-secondary: #666666;
            --border-color: #e0e6ed;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --dark-bg: #1a1a2e;
            --dark-card: #16213e;
            --dark-text: #eee;
            --dark-secondary: #a8a8a8;
            --dark-border: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        body.dark-mode {
            --background-color: var(--dark-bg);
            --card-color: var(--dark-card);
            --text-color: var(--dark-text);
            --text-secondary: var(--dark-secondary);
            --border-color: var(--dark-border);
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }

        header {
            background-color: var(--card-color);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .balance-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coin-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }

        .balance-amount {
            font-size: 20px;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            font-weight: 600;
        }

        .level-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .bronze {
            background-color: #cd7f32;
        }

        .silver {
            background-color: #c0c0c0;
        }

        .gold {
            background-color: #ffd700;
        }

        .diamond {
            background-color: #b9f2ff;
            color: #333;
        }

        main {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        .content-section {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .home-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .coin-container {
            position: relative;
            margin-bottom: 30px;
        }

        .main-coin {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            animation: pulse 2s infinite;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .main-coin:hover {
            transform: scale(1.05);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        .farming-status {
            text-align: center;
            margin-bottom: 20px;
        }

        .farming-timer {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .farming-rate {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .farming-button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(74, 108, 247, 0.4);
        }

        .farming-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 108, 247, 0.6);
        }

        .farming-button:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            box-shadow: none;
        }

        .task-card {
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s;
        }

        .task-card:hover {
            transform: translateY(-2px);
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
        }

        .task-details {
            flex: 1;
        }

        .task-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .task-reward {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--success-color);
            font-weight: 500;
        }

        .task-button {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .task-open {
            background-color: var(--primary-color);
            color: white;
        }

        .task-processing {
            background-color: var(--warning-color);
            color: white;
        }

        .task-completed {
            background-color: var(--success-color);
            color: white;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .leaderboard-table th {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .leaderboard-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .referral-link-container {
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .referral-link {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .referral-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .copy-button {
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .copy-button:hover {
            background-color: var(--secondary-color);
        }

        .referral-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

        .stat-card {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .referral-list {
            margin-top: 20px;
        }

        .referral-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background-color: var(--card-color);
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .referral-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .referral-details {
            flex: 1;
        }

        .referral-name {
            font-weight: 600;
        }

        .referral-earned {
            color: var(--success-color);
            font-size: 14px;
        }

        .profile-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .profile-card {
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-info h2 {
            margin-bottom: 5px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .profile-stat {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .profile-stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .profile-stat-value {
            font-size: 18px;
            font-weight: 600;
        }

        .wallet-section {
            margin-top: 20px;
        }

        .wallet-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #0088cc, #005580);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .wallet-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.4);
        }

        .wallet-connected {
            background: linear-gradient(135deg, var(--success-color), #388e3c);
        }

        .wallet-info {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--background-color);
            border-radius: 12px;
            display: none;
        }

        .wallet-address {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .wallet-actions {
            display: flex;
            gap: 10px;
        }

        .wallet-action-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-wallet {
            background-color: var(--primary-color);
            color: white;
        }

        .disconnect-wallet {
            background-color: var(--danger-color);
            color: white;
        }

        .settings-section {
            margin-top: 20px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-label {
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 10;
        }

        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 5px 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 12px;
        }

        .nav-button.active {
            color: var(--primary-color);
        }

        .nav-button i {
            font-size: 20px;
        }

        .nav-button.home-button {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 50%;
            margin-top: -20px;
            box-shadow: 0 4px 15px rgba(74, 108, 247, 0.4);
        }

        .nav-button.home-button i {
            font-size: 24px;
        }

        .nav-button span {
            font-size: 12px;
            font-weight: 600;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-referral {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-top: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--card-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
            z-index: 100;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--danger-color);
        }

        .notification.info {
            border-left: 4px solid var(--primary-color);
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification.success .notification-icon {
            color: var(--success-color);
        }

        .notification.error .notification-icon {
            color: var(--danger-color);
        }

        .notification.info .notification-icon {
            color: var(--primary-color);
        }

        .notification-message {
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
        }

        .ads-container {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--card-color);
            border-radius: 12px;
            text-align: center;
        }

        .ads-title {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .ads-button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ads-button:hover {
            background-color: var(--secondary-color);
        }

        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }
            
            .main-coin {
                width: 150px;
                height: 150px;
            }
            
            .profile-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="Trimint" class="loading-logo">
        <div class="loading-text">Loading Trimint...</div>
        <div class="loading-referral" id="loadingReferral"></div>
        <div class="loading-spinner"></div>
    </div>

    <div class="app-container">
        <header>
            <div class="balance-container">
                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="coin-icon">
                <div class="balance-amount" id="balanceAmount">0 TRM</div>
            </div>
            <div class="user-info">
                <div class="level-badge bronze" id="userLevel">Bronze</div>
                <img src="https://picsum.photos/seed/user123/40/40.jpg" alt="User" class="user-avatar" id="userAvatar">
                <div class="user-name" id="userName">User</div>
            </div>
        </header>

        <main>
            <section class="content-section active home-section" id="homeSection">
                <div class="coin-container">
                    <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="main-coin" id="mainCoin">
                </div>
                <div class="farming-status">
                    <div class="farming-timer" id="farmingTimer">Start farming to earn TRM</div>
                    <div class="farming-rate" id="farmingRate">0.001 TRM per second</div>
                </div>
                <button class="farming-button" id="farmingButton">Start Farming</button>
            </section>

            <section class="content-section" id="tasksSection">
                <div class="ads-container">
                    <div class="ads-title">Watch Ads</div>
                    <p>Watch ads to earn 1 TRM token</p>
                    <button class="ads-button" id="watchAdsButton">Watch Ads</button>
                </div>
                <div id="tasksList"></div>
            </section>

            <section class="content-section" id="leaderboardSection">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Balance</th>
                            <th>Level</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <!-- Leaderboard data will be populated here -->
                    </tbody>
                </table>
            </section>

            <section class="content-section" id="friendsSection">
                <div class="referral-link-container">
                    <h3>Invite Friends</h3>
                    <p>Invite friends and earn 5000 TRM for each referral</p>
                    <div class="referral-link">
                        <input type="text" class="referral-input" id="referralLink" readonly>
                        <button class="copy-button" id="copyReferralButton">Copy</button>
                    </div>
                </div>
                <div class="referral-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="referralEarnings">0 TRM</div>
                        <div class="stat-label">Referral Earnings</div>
                    </div>
                </div>
                <div class="referral-list">
                    <h3>Your Referrals</h3>
                    <div id="referralsList">
                        <!-- Referrals will be populated here -->
                    </div>
                </div>
            </section>

            <section class="content-section" id="profileSection">
                <div class="profile-card">
                    <div class="profile-header">
                        <img src="https://picsum.photos/seed/user123/80/80.jpg" alt="Profile" class="profile-avatar" id="profileAvatar">
                        <div class="profile-info">
                            <h2 id="profileName">User Name</h2>
                            <div class="level-badge bronze" id="profileLevel">Bronze</div>
                        </div>
                    </div>
                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="profile-stat-label">Balance</div>
                            <div class="profile-stat-value" id="profileBalance">0 TRM</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-label">Total Friends</div>
                            <div class="profile-stat-value" id="totalFriends">0</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-label">Total Earned</div>
                            <div class="profile-stat-value" id="totalEarned">0 TRM</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-label">Farm Time</div>
                            <div class="profile-stat-value" id="farmTime">0h</div>
                        </div>
                    </div>
                </div>
                <div class="profile-card wallet-section">
                    <h3>TON Wallet</h3>
                    <button class="wallet-button" id="walletButton">
                        <i class="fas fa-wallet"></i>
                        <span id="walletButtonText">Connect TON Wallet</span>
                    </button>
                    <div class="wallet-info" id="walletInfo">
                        <div class="wallet-address">
                            <span id="walletAddress"></span>
                        </div>
                        <div class="wallet-actions">
                            <button class="wallet-action-button copy-wallet" id="copyWalletButton">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="wallet-action-button disconnect-wallet" id="disconnectWalletButton">
                                <i class="fas fa-unlink"></i> Disconnect
                            </button>
                        </div>
                    </div>
                </div>
                <div class="profile-card settings-section">
                    <h3>Settings</h3>
                    <div class="setting-item">
                        <div class="setting-label">Dark Mode</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">Notifications</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notificationsToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">Sound Effects</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundEffectsToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <button class="nav-button home-button active" data-section="homeSection">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-button" data-section="tasksSection">
                <i class="fas fa-tasks"></i>
                <span>Tasks</span>
            </button>
            <button class="nav-button" data-section="leaderboardSection">
                <i class="fas fa-trophy"></i>
                <span>Leaderboard</span>
            </button>
            <button class="nav-button" data-section="friendsSection">
                <i class="fas fa-user-friends"></i>
                <span>Friends</span>
            </button>
            <button class="nav-button" data-section="profileSection">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </button>
        </nav>
    </div>

    <div class="notification" id="notification">
        <i class="notification-icon"></i>
        <div class="notification-message"></div>
        <button class="notification-close" id="notificationClose">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Monetag Ads Script -->
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Telegram WebApp API
        let tg;
        let user;
        let userId;

        // App state
        let balance = 0;
        let farmingActive = false;
        let farmingEndTime = null;
        let farmingInterval = null;
        let walletConnected = false;
        let walletAddress = null;
        let tasks = [];
        let referrals = [];
        let leaderboard = [];
        let darkMode = false;

        // DOM elements
        const balanceAmount = document.getElementById('balanceAmount');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const userLevel = document.getElementById('userLevel');
        const farmingButton = document.getElementById('farmingButton');
        const farmingTimer = document.getElementById('farmingTimer');
        const mainCoin = document.getElementById('mainCoin');
        const walletButton = document.getElementById('walletButton');
        const walletButtonText = document.getElementById('walletButtonText');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddressElement = document.getElementById('walletAddress');
        const referralLink = document.getElementById('referralLink');
        const totalReferrals = document.getElementById('totalReferrals');
        const referralEarnings = document.getElementById('referralEarnings');
        const notificationsToggle = document.getElementById('notificationsToggle');
        const soundEffectsToggle = document.getElementById('soundEffectsToggle');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const watchAdsButton = document.getElementById('watchAdsButton');

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Telegram WebApp
            if (window.Telegram) {
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                
                user = tg.initDataUnsafe.user;
                userId = user.id;
                
                // Update user info
                userName.textContent = user.first_name;
                userAvatar.src = user.photo_url || `https://picsum.photos/seed/user${userId}/40/40.jpg`;
                
                // Check for referral
                const urlParams = new URLSearchParams(window.location.search);
                const referrerId = urlParams.get('startapp');
                
                if (referrerId && referrerId !== userId.toString()) {
                    // Process referral
                    processReferral(referrerId);
                }
                
                // Generate referral link
                referralLink.value = `https://t.me/TrimintBot/mine?startapp=${userId}`;
            } else {
                // Fallback for testing outside Telegram
                userId = 123456;
                userName.textContent = 'Test User';
                userAvatar.src = `https://picsum.photos/seed/user${userId}/40/40.jpg`;
                referralLink.value = `https://t.me/TrimintBot/mine?startapp=${userId}`;
            }
            
            // Load user data from Firebase
            loadUserData();
            
            // Load tasks from Firebase
            loadTasks();
            
            // Load leaderboard from Firebase
            loadLeaderboard();
            
            // Setup event listeners
            setupEventListeners();
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
            }, 2000);
        });

        // Load user data from Firebase
        function loadUserData() {
            db.collection('users').doc(userId.toString()).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        balance = userData.balance || 0;
                        farmingActive = userData.farmingActive || false;
                        farmingEndTime = userData.farmingEndTime || null;
                        walletConnected = userData.walletConnected || false;
                        walletAddress = userData.walletAddress || null;
                        referrals = userData.referrals || [];
                        
                        updateUI();
                        
                        if (farmingActive && farmingEndTime) {
                            startFarming(false);
                        }
                    } else {
                        // Create new user document
                        db.collection('users').doc(userId.toString()).set({
                            telegramId: userId,
                            name: userName.textContent,
                            avatar: userAvatar.src,
                            balance: 0,
                            farmingActive: false,
                            farmingEndTime: null,
                            walletConnected: false,
                            walletAddress: null,
                            referrals: [],
                            totalEarned: 0,
                            farmTime: 0,
                            tasksCompleted: []
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                    showNotification('Failed to load user data', 'error');
                });
        }

        // Save user data to Firebase
        function saveUserData() {
            db.collection('users').doc(userId.toString()).set({
                telegramId: userId,
                name: userName.textContent,
                avatar: userAvatar.src,
                balance: balance,
                farmingActive: farmingActive,
                farmingEndTime: farmingEndTime,
                walletConnected: walletConnected,
                walletAddress: walletAddress,
                referrals: referrals,
                totalEarned: parseInt(document.getElementById('totalEarned').textContent) || 0,
                farmTime: parseInt(document.getElementById('farmTime').textContent) || 0,
                tasksCompleted: tasks.filter(task => task.completed).map(task => task.id)
            }, { merge: true })
                .catch(error => {
                    console.error('Error saving user data:', error);
                    showNotification('Failed to save data', 'error');
                });
        }

        // Load tasks from Firebase
        function loadTasks() {
            db.collection('tasks').get()
                .then(querySnapshot => {
                    tasks = [];
                    querySnapshot.forEach(doc => {
                        const taskData = doc.data();
                        tasks.push({
                            id: doc.id,
                            name: taskData.name,
                            description: taskData.description,
                            icon: taskData.icon,
                            reward: taskData.reward,
                            link: taskData.link,
                            completed: false
                        });
                    });
                    
                    // Check which tasks are completed by the user
                    db.collection('users').doc(userId.toString()).get()
                        .then(userDoc => {
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                const completedTasks = userData.tasksCompleted || [];
                                
                                tasks.forEach(task => {
                                    if (completedTasks.includes(task.id)) {
                                        task.completed = true;
                                    }
                                });
                            }
                            
                            renderTasks();
                        });
                })
                .catch(error => {
                    console.error('Error loading tasks:', error);
                    showNotification('Failed to load tasks', 'error');
                });
        }

        // Render tasks
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = '';
            
            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card';
                
                let buttonClass = 'task-open';
                let buttonText = 'OPEN';
                
                if (task.completed) {
                    buttonClass = 'task-completed';
                    buttonText = 'COMPLETED';
                }
                
                taskCard.innerHTML = `
                    <img src="${task.icon}" alt="${task.name}" class="task-icon">
                    <div class="task-details">
                        <div class="task-name">${task.name}</div>
                        <div class="task-description">${task.description}</div>
                        <div class="task-reward">
                            <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" style="width: 16px; height: 16px;">
                            <span>${task.reward} TRM</span>
                        </div>
                    </div>
                    <button class="task-button ${buttonClass}" data-task-id="${task.id}" data-task-link="${task.link}" data-task-reward="${task.reward}">${buttonText}</button>
                `;
                
                tasksList.appendChild(taskCard);
            });
            
            // Add event listeners to task buttons
            document.querySelectorAll('.task-button').forEach(button => {
                button.addEventListener('click', handleTaskClick);
            });
        }

        // Handle task button click
        function handleTaskClick(event) {
            const button = event.target;
            const taskId = button.getAttribute('data-task-id');
            const taskLink = button.getAttribute('data-task-link');
            const taskReward = parseInt(button.getAttribute('data-task-reward'));
            
            if (button.classList.contains('task-completed')) {
                // Open link even if completed
                window.open(taskLink, '_blank');
                return;
            }
            
            if (button.classList.contains('task-processing')) {
                return; // Already processing
            }
            
            // Change button to processing
            button.classList.remove('task-open');
            button.classList.add('task-processing');
            button.textContent = 'PROCESSING';
            
            // Open task link
            window.open(taskLink, '_blank');
            
            // After 10 seconds, mark as completed and add reward
            setTimeout(() => {
                button.classList.remove('task-processing');
                button.classList.add('task-completed');
                button.textContent = 'COMPLETED';
                
                // Add reward to balance
                balance += taskReward;
                updateUI();
                saveUserData();
                
                // Mark task as completed in user data
                db.collection('users').doc(userId.toString()).update({
                    tasksCompleted: firebase.firestore.FieldValue.arrayUnion(taskId)
                });
                
                showNotification(`You earned ${taskReward} TRM!`, 'success');
            }, 10000);
        }

        // Load leaderboard from Firebase
        function loadLeaderboard() {
            db.collection('users').orderBy('balance', 'desc').limit(25).get()
                .then(querySnapshot => {
                    leaderboard = [];
                    querySnapshot.forEach(doc => {
                        const userData = doc.data();
                        leaderboard.push({
                            id: doc.id,
                            name: userData.name,
                            avatar: userData.avatar,
                            balance: userData.balance,
                            level: getLevel(userData.balance)
                        });
                    });
                    
                    renderLeaderboard();
                })
                .catch(error => {
                    console.error('Error loading leaderboard:', error);
                    showNotification('Failed to load leaderboard', 'error');
                });
        }

        // Render leaderboard
        function renderLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboardBody');
            leaderboardBody.innerHTML = '';
            
            leaderboard.forEach((user, index) => {
                const row = document.createElement('tr');
                
                let levelClass = '';
                if (user.level === 'Bronze') levelClass = 'bronze';
                else if (user.level === 'Gold') levelClass = 'gold';
                else if (user.level === 'Diamond') levelClass = 'diamond';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <div class="leaderboard-user">
                            <img src="${user.avatar}" alt="${user.name}" class="leaderboard-avatar">
                            <span>${user.name}</span>
                        </div>
                    </td>
                    <td>${user.balance} TRM</td>
                    <td><span class="level-badge ${levelClass}">${user.level}</span></td>
                `;
                
                leaderboardBody.appendChild(row);
            });
        }

        // Process referral
        function processReferral(referrerId) {
            // Add referral to referrer's data
            db.collection('users').doc(referrerId).get()
                .then(doc => {
                    if (doc.exists) {
                        const referrerData = doc.data();
                        const referrals = referrerData.referrals || [];
                        
                        // Check if user is already referred
                        if (!referrals.includes(userId.toString())) {
                            // Add referral
                            db.collection('users').doc(referrerId).update({
                                referrals: firebase.firestore.FieldValue.arrayUnion(userId.toString()),
                                balance: firebase.firestore.FieldValue.increment(5000)
                            });
                            
                            // Show referral info on loading screen
                            document.getElementById('loadingReferral').textContent = `Referred by ${referrerData.name}`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error processing referral:', error);
                });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation buttons
            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', () => {
                    const sectionId = button.getAttribute('data-section');
                    
                    // Update active button
                    document.querySelectorAll('.nav-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                    
                    // Show corresponding section
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(sectionId).classList.add('active');
                });
            });
            
            // Farming button
            farmingButton.addEventListener('click', () => {
                if (farmingActive) {
                    stopFarming();
                } else {
                    startFarming(true);
                }
            });
            
            // Main coin click animation
            mainCoin.addEventListener('click', () => {
                mainCoin.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    mainCoin.style.transform = 'scale(1)';
                }, 200);
            });
            
            // Wallet button
            walletButton.addEventListener('click', () => {
                if (walletConnected) {
                    // Wallet already connected, show wallet info
                    walletInfo.style.display = walletInfo.style.display === 'block' ? 'none' : 'block';
                } else {
                    // Connect wallet
                    connectWallet();
                }
            });
            
            // Copy wallet button
            document.getElementById('copyWalletButton').addEventListener('click', () => {
                navigator.clipboard.writeText(walletAddress);
                showNotification('Wallet address copied!', 'success');
            });
            
            // Disconnect wallet button
            document.getElementById('disconnectWalletButton').addEventListener('click', () => {
                disconnectWallet();
            });
            
            // Copy referral button
            document.getElementById('copyReferralButton').addEventListener('click', () => {
                navigator.clipboard.writeText(referralLink.value);
                showNotification('Referral link copied!', 'success');
            });
            
            // Dark mode toggle
            darkModeToggle.addEventListener('change', () => {
                darkMode = darkModeToggle.checked;
                document.body.classList.toggle('dark-mode', darkMode);
                localStorage.setItem('darkMode', darkMode);
            });
            
            // Load dark mode preference
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            darkMode = savedDarkMode;
            darkModeToggle.checked = darkMode;
            document.body.classList.toggle('dark-mode', darkMode);
            
            // Watch ads button
            watchAdsButton.addEventListener('click', () => {
                // Show ads using Monetag
                if (window.show_10290264) {
                    window.show_10290264();
                    
                    // Add 1 TRM after watching ads
                    setTimeout(() => {
                        balance += 1;
                        updateUI();
                        saveUserData();
                        showNotification('You earned 1 TRM from watching ads!', 'success');
                    }, 5000); // Assuming 5 seconds for ads
                } else {
                    showNotification('Ads not available', 'error');
                }
            });
            
            // Notification close button
            document.getElementById('notificationClose').addEventListener('click', () => {
                hideNotification();
            });
        }

        // Start farming
        function startFarming(setEndTime) {
            farmingActive = true;
            
            if (setEndTime) {
                // Set end time to 12 hours from now
                farmingEndTime = Date.now() + 12 * 60 * 60 * 1000;
            }
            
            farmingButton.textContent = 'Stop Farming';
            farmingButton.style.backgroundColor = 'var(--danger-color)';
            
            // Update farming timer
            updateFarmingTimer();
            
            // Start farming interval
            farmingInterval = setInterval(() => {
                // Add 0.001 TRM per second
                balance += 0.001;
                updateUI();
                
                // Update farming timer
                updateFarmingTimer();
                
                // Check if farming time is up
                if (Date.now() >= farmingEndTime) {
                    stopFarming();
                    showNotification('Farming completed! Start again to earn more TRM.', 'info');
                }
            }, 1000);
            
            // Add animation to coin
            mainCoin.style.animation = 'pulse 1s infinite';
            
            saveUserData();
        }

        // Stop farming
        function stopFarming() {
            farmingActive = false;
            farmingEndTime = null;
            
            farmingButton.textContent = 'Start Farming';
            farmingButton.style.backgroundColor = '';
            
            // Clear farming interval
            if (farmingInterval) {
                clearInterval(farmingInterval);
                farmingInterval = null;
            }
            
            // Update farming timer
            farmingTimer.textContent = 'Start farming to earn TRM';
            
            // Remove animation from coin
            mainCoin.style.animation = 'pulse 2s infinite';
            
            saveUserData();
        }

        // Update farming timer
        function updateFarmingTimer() {
            if (!farmingActive || !farmingEndTime) return;
            
            const remainingTime = farmingEndTime - Date.now();
            
            if (remainingTime <= 0) {
                stopFarming();
                return;
            }
            
            const hours = Math.floor(remainingTime / (1000 * 60 * 60));
            const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
            
            farmingTimer.textContent = `Farming: ${hours}h ${minutes}m ${seconds}s remaining`;
        }

        // Connect wallet
        function connectWallet() {
            // In a real implementation, this would use the TON Connect SDK
            // For now, we'll simulate the connection
            showNotification('Connecting to TON wallet...', 'info');
            
            setTimeout(() => {
                // Simulate successful connection
                walletConnected = true;
                walletAddress = 'EQD' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                
                walletButtonText.textContent = 'Connected';
                walletButton.classList.add('wallet-connected');
                walletAddressElement.textContent = walletAddress;
                walletInfo.style.display = 'block';
                
                saveUserData();
                showNotification('Wallet connected successfully!', 'success');
            }, 2000);
        }

        // Disconnect wallet
        function disconnectWallet() {
            walletConnected = false;
            walletAddress = null;
            
            walletButtonText.textContent = 'Connect TON Wallet';
            walletButton.classList.remove('wallet-connected');
            walletInfo.style.display = 'none';
            
            saveUserData();
            showNotification('Wallet disconnected', 'info');
        }

        // Update UI
        function updateUI() {
            // Update balance
            balanceAmount.textContent = `${balance.toFixed(3)} TRM`;
            document.getElementById('profileBalance').textContent = `${balance.toFixed(3)} TRM`;
            
            // Update level
            const level = getLevel(balance);
            userLevel.textContent = level;
            userLevel.className = `level-badge ${level.toLowerCase()}`;
            document.getElementById('profileLevel').textContent = level;
            document.getElementById('profileLevel').className = `level-badge ${level.toLowerCase()}`;
            
            // Update profile info
            document.getElementById('profileName').textContent = userName.textContent;
            document.getElementById('profileAvatar').src = userAvatar.src;
            
            // Update referral stats
            document.getElementById('totalReferrals').textContent = referrals.length;
            document.getElementById('referralEarnings').textContent = `${referrals.length * 5000} TRM`;
            
            // Render referrals
            renderReferrals();
            
            // Update total friends
            document.getElementById('totalFriends').textContent = referrals.length;
        }

        // Get level based on balance
        function getLevel(balance) {
            if (balance < 10000) return 'Bronze';
            if (balance < 50000) return 'Gold';
            return 'Diamond';
        }

        // Render referrals
        function renderReferrals() {
            const referralsList = document.getElementById('referralsList');
            referralsList.innerHTML = '';
            
            if (referrals.length === 0) {
                referralsList.innerHTML = '<p>No referrals yet</p>';
                return;
            }
            
            referrals.forEach(referralId => {
                db.collection('users').doc(referralId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const referralData = doc.data();
                            const referralItem = document.createElement('div');
                            referralItem.className = 'referral-item';
                            
                            referralItem.innerHTML = `
                                <img src="${referralData.avatar}" alt="${referralData.name}" class="referral-avatar">
                                <div class="referral-details">
                                    <div class="referral-name">${referralData.name}</div>
                                    <div class="referral-earned">Balance: ${referralData.balance.toFixed(3)} TRM</div>
                                </div>
                                <div class="referral-reward">+5000 TRM</div>
                            `;
                            
                            referralsList.appendChild(referralItem);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading referral:', error);
                    });
            });
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationMessage = notification.querySelector('.notification-message');
            const notificationIcon = notification.querySelector('.notification-icon');
            
            // Set message
            notificationMessage.textContent = message;
            
            // Set type
            notification.className = `notification ${type}`;
            
            // Set icon
            if (type === 'success') {
                notificationIcon.className = 'notification-icon fas fa-check-circle';
            } else if (type === 'error') {
                notificationIcon.className = 'notification-icon fas fa-exclamation-circle';
            } else {
                notificationIcon.className = 'notification-icon fas fa-info-circle';
            }
            
            // Show notification
            notification.classList.add('show');
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                hideNotification();
            }, 3000);
        }

        // Hide notification
        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }
    </script>
</body>
</html>
