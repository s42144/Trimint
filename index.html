<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>TRIMint - Mining App</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #7C3AED;
            --secondary: #EC4899;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --dark: #1F2937;
            --light: #F9FAFB;
            --gray: #6B7280;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gradient);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
            transition: all 0.3s ease;
        }

        body.dark-mode {
            --light: #1F2937;
            --dark: #F9FAFB;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .coin-loader {
            width: 120px;
            height: 120px;
            background: url('https://i.postimg.cc/fTQktNmX/maincoin.png') no-repeat center;
            background-size: contain;
            animation: rotate 2s linear infinite;
            margin-bottom: 30px;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .referral-info {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 15px;
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 80px;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .balance-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: 600;
        }

        .balance-display img {
            width: 24px;
            height: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .coin-container {
            text-align: center;
            margin: 30px 0;
        }

        .main-coin {
            width: 200px;
            height: 200px;
            background: url('https://i.postimg.cc/fTQktNmX/maincoin.png') no-repeat center;
            background-size: contain;
            margin: 0 auto 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .main-coin:hover {
            transform: scale(1.05);
        }

        .main-coin.farming {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .farming-btn {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .farming-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .farming-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        .countdown {
            margin: 20px 0;
            font-size: 16px;
            color: white;
            font-weight: 500;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }

        body.dark-mode .bottom-nav {
            background: rgba(31, 41, 55, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 5px;
            position: relative;
        }

        .nav-btn.active {
            color: var(--primary);
        }

        .nav-btn:hover {
            color: var(--primary);
        }

        .nav-btn i {
            font-size: 20px;
        }

        .nav-btn.home-btn {
            background: var(--primary);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-top: -20px;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }

        .nav-btn.home-btn i {
            font-size: 24px;
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        body.dark-mode .card {
            background: rgba(31, 41, 55, 0.9);
            color: var(--light);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 600;
        }

        .profile-details h2 {
            margin-bottom: 5px;
            color: var(--dark);
        }

        body.dark-mode .profile-details h2 {
            color: var(--light);
        }

        .level-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .level-bronze {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: white;
        }

        .level-gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
        }

        .level-diamond {
            background: linear-gradient(135deg, #B9F2FF, #00CED1);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 10px;
        }

        body.dark-mode .stat-item {
            background: rgba(124, 58, 237, 0.2);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray);
        }

        .wallet-section {
            margin: 20px 0;
        }

        .wallet-btn {
            background: linear-gradient(135deg, #0088CC, #005A8B);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .wallet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
        }

        .wallet-connected {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .wallet-address {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .copy-btn, .disconnect-btn {
            background: var(--gray);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover, .disconnect-btn:hover {
            background: var(--dark);
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        body.dark-mode .task-item {
            background: rgba(31, 41, 55, 0.9);
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .task-details {
            flex: 1;
        }

        .task-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .task-reward {
            color: var(--success);
            font-size: 14px;
        }

        .task-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .task-btn:hover {
            background: #6D28D9;
        }

        .task-btn.processing {
            background: var(--warning);
        }

        .task-btn.completed {
            background: var(--success);
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        body.dark-mode .leaderboard-item {
            background: rgba(31, 41, 55, 0.9);
        }

        .rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .leaderboard-details {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .leaderboard-balance {
            color: var(--success);
            font-size: 14px;
        }

        .referral-link-container {
            background: rgba(124, 58, 237, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        body.dark-mode .referral-link-container {
            background: rgba(124, 58, 237, 0.2);
        }

        .referral-link {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .referral-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            background: white;
            font-size: 14px;
        }

        body.dark-mode .referral-input {
            background: var(--dark);
            color: var(--light);
            border-color: var(--gray);
        }

        .copy-referral-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-referral-btn:hover {
            background: #6D28D9;
        }

        .referral-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .referral-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        body.dark-mode .referral-item {
            background: rgba(31, 41, 55, 0.5);
        }

        .settings-section {
            margin: 20px 0;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .setting-item {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--gray);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: all 0.3s ease;
            z-index: 10000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .ads-container {
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .main-coin {
                width: 150px;
                height: 150px;
            }
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="coin-loader"></div>
        <div class="referral-info" id="referralInfo" style="display: none;">
            <h3>Welcome!</h3>
            <p>You were invited by: <strong id="referralName"></strong></p>
        </div>
    </div>

    <div class="app-container">
        <div class="header">
            <div class="balance-display">
                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM">
                <span id="userBalance">0 TRM</span>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <span id="userName">Loading...</span>
            </div>
        </div>

        <div class="content">
            <!-- Home Section -->
            <div class="section active" id="homeSection">
                <div class="card">
                    <div class="coin-container">
                        <div class="main-coin" id="mainCoin"></div>
                        <button class="farming-btn" id="farmingBtn">Start Farming</button>
                        <div class="countdown" id="countdown" style="display: none;">
                            <div>Time remaining: <span id="timeRemaining">12:00:00</span></div>
                            <div>Earning: 0.001 TRM/s</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Quick Stats</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="todayEarning">0</div>
                            <div class="stat-label">Today's Earning</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalEarned">0</div>
                            <div class="stat-label">Total Earned</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Section -->
            <div class="section" id="tasksSection">
                <div class="card">
                    <h3>Daily Tasks</h3>
                    <div class="ads-container">
                        <div id="monetagAd"></div>
                    </div>
                    <div id="tasksList">
                        <div class="task-item">
                            <div class="task-icon">
                                <i class="fas fa-ad"></i>
                            </div>
                            <div class="task-details">
                                <div class="task-name">Watch Ads</div>
                                <div class="task-reward">+1 TRM</div>
                            </div>
                            <button class="task-btn" onclick="watchAds()">OPEN</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div class="section" id="leaderboardSection">
                <div class="card">
                    <h3>üèÜ Top Users</h3>
                    <div id="leaderboardList">
                        <!-- Leaderboard items will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div class="section" id="profileSection">
                <div class="card">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="profile-details">
                            <h2 id="profileName">Loading...</h2>
                            <div class="level-badge level-bronze" id="levelBadge">Bronze</div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="profileLevel">1</div>
                            <div class="stat-label">Level</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalFriends">0</div>
                            <div class="stat-label">Total Friends</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="referralEarnings">0</div>
                            <div class="stat-label">Referral Earnings</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="joinDate">-</div>
                            <div class="stat-label">Join Date</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="wallet-section">
                        <h3>TON Wallet</h3>
                        <button class="wallet-btn" id="walletBtn" onclick="connectWallet()">
                            Connect TON Wallet
                        </button>
                        <div class="wallet-address" id="walletAddress" style="display: none;">
                            <span id="addressText"></span>
                            <button class="copy-btn" onclick="copyAddress()">Copy</button>
                            <button class="disconnect-btn" onclick="disconnectWallet()">Disconnect</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="settings-section">
                        <h3>Settings</h3>
                        <div class="setting-item">
                            <span>Dark Mode</span>
                            <div class="toggle-switch" id="darkModeToggle" onclick="toggleDarkMode()">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span>Notifications</span>
                            <div class="toggle-switch active" onclick="toggleNotifications()">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span>Sound Effects</span>
                            <div class="toggle-switch active" onclick="toggleSound()">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Friends Section -->
            <div class="section" id="friendsSection">
                <div class="card">
                    <h3>Invite Friends</h3>
                    <div class="referral-link-container">
                        <p>Share your referral link and earn 5000 TRM for each friend!</p>
                        <div class="referral-link">
                            <input type="text" class="referral-input" id="referralInput" readonly>
                            <button class="copy-referral-btn" onclick="copyReferralLink()">Copy</button>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalReferrals">0</div>
                            <div class="stat-label">Total Referrals</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="referralBonus">0</div>
                            <div class="stat-label">Referral Bonus</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Your Referrals</h3>
                    <div class="referral-list" id="referralList">
                        <!-- Referral items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-btn" onclick="switchSection('tasks')">
                <i class="fas fa-tasks"></i>
                <span>Tasks</span>
            </button>
            <button class="nav-btn" onclick="switchSection('leaderboard')">
                <i class="fas fa-trophy"></i>
                <span>Leaderboard</span>
            </button>
            <button class="nav-btn home-btn" onclick="switchSection('home')">
                <i class="fas fa-home"></i>
            </button>
            <button class="nav-btn" onclick="switchSection('friends')">
                <i class="fas fa-users"></i>
                <span>Friends</span>
            </button>
            <button class="nav-btn" onclick="switchSection('profile')">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </button>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Global variables
        let currentUser = null;
        let farmingInterval = null;
        let farmingEndTime = null;
        let isConnectedWallet = false;
        let walletAddress = '';

        // Initialize Telegram Web App
        const telegram = window.Telegram.WebApp;
        telegram.ready();
        telegram.expand();

        // Check for referral
        function checkReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const referralId = urlParams.get('startapp');
            
            if (referralId) {
                // Store referral and process
                localStorage.setItem('referralId', referralId);
                
                // Get referrer data and show on loading screen
                database.ref('users/' + referralId).once('value').then((snapshot) => {
                    const referrerData = snapshot.val();
                    if (referrerData) {
                        document.getElementById('referralName').textContent = referrerData.name || 'Someone';
                        document.getElementById('referralInfo').style.display = 'block';
                    }
                });
            }
        }

        // Initialize user
        function initializeUser() {
            const telegramUser = telegram.initDataUnsafe?.user;
            
            if (telegramUser) {
                currentUser = {
                    id: telegramUser.id,
                    name: telegramUser.first_name + ' ' + (telegramUser.last_name || ''),
                    username: telegramUser.username || '',
                    photoUrl: telegramUser.photo_url || ''
                };
                
                // Save user to Firebase
                saveUserToFirebase();
                loadUserData();
                
                // Update UI
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('profileName').textContent = currentUser.name;
                
                if (currentUser.photoUrl) {
                    document.getElementById('userAvatar').innerHTML = `<img src="${currentUser.photoUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                    document.getElementById('profileAvatar').innerHTML = `<img src="${currentUser.photoUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                }
                
                // Generate referral link
                const referralLink = `https://t.me/TrimintBot/mine?startapp=${currentUser.id}`;
                document.getElementById('referralInput').value = referralLink;
                
                // Process referral if exists
                processReferral();
            } else {
                // Demo user for testing
                currentUser = {
                    id: 'demo_' + Date.now(),
                    name: 'Demo User',
                    username: 'demo',
                    photoUrl: ''
                };
                
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('profileName').textContent = currentUser.name;
                loadUserData();
                
                const referralLink = `https://t.me/TrimintBot/mine?startapp=${currentUser.id}`;
                document.getElementById('referralInput').value = referralLink;
            }
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 2000);
        }

        // Save user to Firebase
        function saveUserToFirebase() {
            const userRef = database.ref('users/' + currentUser.id);
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val() || {};
                
                const updatedData = {
                    ...userData,
                    id: currentUser.id,
                    name: currentUser.name,
                    username: currentUser.username,
                    photoUrl: currentUser.photoUrl,
                    lastActive: new Date().toISOString(),
                    joinDate: userData.joinDate || new Date().toISOString()
                };
                
                userRef.set(updatedData);
            });
        }

        // Load user data
        function loadUserData() {
            const userRef = database.ref('users/' + currentUser.id);
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val() || {};
                
                // Update balance
                const balance = userData.balance || 0;
                document.getElementById('userBalance').textContent = balance.toFixed(3) + ' TRM';
                
                // Update level
                updateLevel(balance);
                
                // Update profile stats
                document.getElementById('totalFriends').textContent = Object.keys(userData.referralstekila || {}).length;
                document.getElementById('referralEarnings').textContent = (userData.referralEarnings || 0).toFixed(0);
                
                // Update friends section
                document.getElementById('totalReferrals').textContent = Object.keys(userData.referrals || {}).length;
                document.getElementById('referralBonus').textContent = (userData.referralEarnings || 0).toFixed(0);
                
                // Load farming state
                if (userData.farmingEndTime) {
                    const endTime = new Date(userData.farmingEndTime);
                    if (endTime > new Date()) {
                        startFarming(endTime);
                    }
                }
                
                // Load referrals
                loadReferrals();
                
                // Update leaderboard
                loadLeaderboard();
            });
            
            // Load tasks
            loadTasks();
        }

        // Update user level
        function updateLevel(balance) {
            let level, levelClass;
            
            if (balance < 10000) {
                level = 'Bronze';
                levelClass = 'level-bronze';
            } else if (balance < 50000) {
                level = 'Gold';
                levelClass = 'level-gold';
            } else {
                level = 'Diamond';
                levelClass = 'level-diamond';
            }
            
            const badge = document.getElementById('levelBadge');
            badge.textContent = level;
            badge.className = 'level-badge ' + levelClass;
            
            document.getElementById('profileLevel').textContent = level;
        }

        // Process referral
        function processReferral() {
            const referralId = localStorage.getItem('referralId');
            
            if (referralId && referralId !== currentUser.id) {
                // Check if already processed
                const userRef = database.ref('users/' + currentUser.id);
                userRef.once('value').then((snapshot) => {
                    const userData = snapshot.val() || {};
                    
                    if (!userData.referralProcessed) {
                        // Add referral to referrer
                        database.ref('users/' + referralId + '/referrals/' + currentUser.id).set({
                            name: currentUser.name,
                            joinDate: new Date().toISOString(),
                            bonus: 5000
                        });
                        
                        // Add balance to referrer
                        database.ref('users/' + referralId).once('value').then((referrerSnapshot) => {
                            const referrerData = referrerSnapshot.val() || {};
                            const newBalance = (referrerData.balance || 0) + 5000;
                            const newReferralEarnings = (referrerData.referralEarnings || 0) + 5000;
                            
                            database.ref('users/' + referralId).update({
                                balance: newBalance,
                                referralEarnings: newReferralEarnings
                            });
                        });
                        
                        // Mark referral as processed
                        userRef.update({
                            referralProcessed: true,
                            referredBy: referralId
                        });
                        
                        showNotification('Welcome! You were successfully referred!');
                        
                        // Clear referral from storage
                        localStorage.removeItem('referralId');
                    }
                });
            }
        }

        // Switch section
        function switchSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            // Show selected section
            document.getElementById(section + 'Section').classList.add('active');
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.nav-btn').classList.add('active');
            
            // Load section-specific data
            if (section === 'leaderboard') {
                loadLeaderboard();
            } else if (section === 'tasks') {
                loadTasks();
            }
        }

        // Farming functions
        document.getElementById('farmingBtn').addEventListener('click', function() {
            if (!farmingInterval) {
                startFarming();
            }
        });

        function startFarming(endTime = null) {
            const btn = document.getElementById('farmingBtn');
            const coin = document.getElementById('mainCoin');
            const countdown = document.getElementById('countdown');
            
            if (!endTime) {
                endTime = new Date();
                endTime.setHours(endTime.getHours() + 12);
                
                // Save to Firebase
                database.ref('users/' + currentUser.id).update({
                    farmingEndTime: endTime.toISOString()
                });
            }
            
            farmingEndTime = endTime;
            btn.disabled = true;
            btn.textContent = 'Farming...';
            coin.classList.add('farming');
            countdown.style.display = 'block';
            
            farmingInterval = setInterval(() => {
                const now = new Date();
                const remaining = farmingEndTime - now;
                
                if (remaining <= 0) {
                    stopFarming();
                } else {
                    // Update countdown
                    const hours = Math.floor(remaining / 3600000);
                    const minutes = Math.floor((remaining % 3600000) / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    
                    document.getElementById('timeRemaining').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Add balance
                    database.ref('users/' + currentUser.id).once('value').then((snapshot) => {
                        const userData = snapshot.val() || {};
                        const newBalance = (userData.balance || 0) + 0.001;
                        database.ref('users/' + currentUser.id).update({
                            balance: newBalance
                        });
                    });
                }
            }, 1000);
        }

        function stopFarming() {
            clearInterval(farmingInterval);
            farmingInterval = null;
            farmingEndTime = null;
            
            const btn = document.getElementById('farmingBtn');
            const coin = document.getElementById('mainCoin');
            const countdown = document.getElementById('countdown');
            
            btn.disabled = false;
            btn.textContent = 'Start Farming';
            coin.classList.remove('farming');
            countdown.style.display = 'none';
            
            // Clear from Firebase
            database.ref('users/' + currentUser.id).update({
                farmingEndTime: null
            });
            
            showNotification('Farming completed! Start again to earn more.');
        }

        // Load tasks
        function loadTasks() {
            const tasksRef = database.ref('tasks');
            tasksRef.on('value', (snapshot) => {
                const tasks = snapshot.val() || {};
                const tasksList = document.getElementById('tasksList');
                
                let html = `
                    <div class="task-item">
                        <div class="task-icon">
                            <i class="fas fa-ad"></i>
                        </div>
                        <div class="task-details">
                            <div class="task-name">Watch Ads</div>
                            <div class="task-reward">+1 TRM</div>
                        </div>
                        <button class="task-btn" onclick="watchAds()">OPEN</button>
                    </div>
                `;
                
                Object.keys(tasks).forEach(taskId => {
                    const task = tasks[taskId];
                    html += `
                        <div class="task-item">
                            <div class="task-icon">
                                <i class="fas fa-${task.icon || 'star'}"></i>
                            </div>
                            <div class="task-details">
                                <div class="task-name">${task.name}</div>
                                <div class="task-reward">+${task.reward} TRM</div>
                            </div>
                            <button class="task-btn" id="task_${taskId}" onclick="completeTask('${taskId}', '${task.link}', ${task.reward})">OPEN</button>
                        </div>
                    `;
                });
                
                tasksList.innerHTML = html;
            });
        }

        // Complete task
        function completeTask(taskId, link, reward) {
            const btn = document.getElementById('task_' + taskId);
            
            if (btn.classList.contains('completed')) {
                // Still redirect to link even if completed
                window.open(link, '_blank');
                return;
            }
            
            if (btn.classList.contains('processing')) {
                return;
            }
            
            btn.classList.add('processing');
            btn.textContent = 'PROCESSING';
            
            window.open(link, '_blank');
            
            setTimeout(() => {
                // Add reward to balance
                database.ref('users/' + currentUser.id).once('value').then((snapshot) => {
                    const userData = snapshot.val() || {};
                    const completedTasks = userData.completedTasks || {};
                    
                    if (!completedTasks[taskId]) {
                        const newBalance = (userData.balance || 0) + reward;
                        
                        database.ref('users/' + currentUser.id).update({
                            balance: newBalance,
                            ['completedTasks/' + taskId]: true
                        });
                        
                        showNotification(`Task completed! +${reward} TRM earned!`);
                    }
                });
                
                btn.classList.remove('processing');
                btn.classList.add('completed');
                btn.textContent = 'COMPLETED';
            }, 10000);
        }

        // Watch ads function
        function watchAds() {
            // Trigger Monetag ad
            if (window.libtl) {
                window.libtl.showAd();
            }
            
            // Add reward after ad watch
            setTimeout(() => {
                database.ref('users/' + currentUser.id).once('value').then((snapshot) => {
                    const userData = snapshot.val() || {};
                    const newBalance = (userData.balance || 0) + 1;
                    
                    database.ref('users/' + currentUser.id).update({
                        balance: newBalance
                    });
                    
                    showNotification('Ad watched! +1 TRM earned!');
                });
            }, 3000);
        }

        // Load leaderboard
        function loadLeaderboard() {
            const usersRef = database.ref('users');
            usersRef.orderByChild('balance').limitToLast(25).on('value', (snapshot) => {
                const users = snapshot.val() || {};
                const leaderboardList = document.getElementById('leaderboardList');
                
                // Convert to array and sort by balance
                const userArray = Object.entries(users).map(([id, user]) => ({
                    id,
                    ...user
                })).sort((a, b) => (b.balance || 0) - (a.balance || 0));
                
                let html = '';
                userArray.slice(0, 25).forEach((user, index) => {
                    const level = getLevelByBalance(user.balance || 0);
                    html += `
                        <div class="leaderboard-item">
                            <div class="rank">${index + 1}</div>
                            <div class="leaderboard-avatar">
                                ${user.photoUrl ? `<img src="${user.photoUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : '<i class="fas fa-user"></i>'}
                            </div>
                            <div class="leaderboard-details">
                                <div class="leaderboard-name">${user.name}</div>
                                <div class="leaderboard-balance">${(user.balance || 0).toFixed(3)} TRM ‚Ä¢ ${level}</div>
                            </div>
                        </div>
                    `;
                });
                
                leaderboardList.innerHTML = html;
            });
        }

        // Get level by balance
        function getLevelByBalance(balance) {
            if (balance < 10000) return 'Bronze';
            if (balance < 50000) return 'Gold';
            return 'Diamond';
        }

        // Load referrals
        function loadReferrals() {
            const userRef = database.ref('users/' + currentUser.id + '/referrals');
            userRef.on('value', (snapshot) => {
                const referrals = snapshot.val() || {};
                const referralList = document.getElementById('referralList');
                
                let html = '';
                Object.entries(referrals).forEach(([id, referral]) => {
                    html += `
                        <div class="referral-item">
                            <div class="leaderboard-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="leaderboard-details">
                                <div class="leaderboard-name">${referral.name}</div>
                                <div class="leaderboard-balance">+5000 TRM earned</div>
                            </div>
                        </div>
                    `;
                });
                
                if (html === '') {
                    html = '<p style="text-align:center;color:#666;">No referrals yet</p>';
                }
                
                referralList.innerHTML = html;
            });
        }

        // Copy referral link
        function copyReferralLink() {
            const input = document.getElementById('referralInput');
            input.select();
            document.execCommand('copy');
            showNotification('Referral link copied!');
        }

        // Wallet functions
        function connectWallet() {
            // Redirect to TON wallet connection
            window.open('https://trimint.vercel.app/', '_blank');
            
            // Simulate wallet connection (in real app, this would handle the callback)
            setTimeout(() => {
                isConnectedWallet = true;
                walletAddress = '0x' + Math.random().toString(36).substring(2, 15);
                
                document.getElementById('walletBtn').textContent = 'Connected';
                document.getElementById('walletBtn').classList.add('wallet-connected');
                document.getElementById('walletAddress').style.display = 'flex';
                document.getElementById('addressText').textContent = walletAddress.substring(0, 6) + '...' + walletAddress.substring(walletAddress.length - 4);
                
                // Save to Firebase
                database.ref('users/' + currentUser.id).update({
                    walletAddress: walletAddress
                });
                
                showNotification('Wallet connected successfully!');
            }, 2000);
        }

        function copyAddress() {
            const tempInput = document.createElement('input');
            tempInput.value = walletAddress;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showNotification('Wallet address copied!');
        }

        function disconnectWallet() {
            isConnectedWallet = false;
            walletAddress = '';
            
            document.getElementById('walletBtn').textContent = 'Connect TON Wallet';
            document.getElementById('walletBtn').classList.remove('wallet-connected');
            document.getElementById('walletAddress').style.display = 'none';
            
            // Remove from Firebase
            database.ref('users/' + currentUser.id).update({
                walletAddress: null
            });
            
            showNotification('Wallet disconnected!');
        }

        // Settings functions
        function toggleDarkMode() {
            const toggle = document.getElementById('darkModeToggle');
            toggle.classList.toggle('active');
            document.body.classList.toggle('dark-mode');
            
            // Save preference
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
        }

        function toggleNotifications() {
            const toggle = event.target.closest('.toggle-switch');
            toggle.classList.toggle('active');
            
            if (toggle.classList.contains('active')) {
                showNotification('Notifications enabled');
            }
        }

        function toggleSound() {
            const toggle = event.target.closest('.toggle-switch');
            toggle.classList.toggle('active');
        }

        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Load preferences
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').classList.add('active');
            }
            
            // Check for referral
            checkReferral();
            
            // Initialize user
            initializeUser();
            
            // Initialize Monetag ads
            if (window.libtl) {
                console.log('Monetag SDK loaded');
            }
        });

        // Handle TON wallet callback (in real implementation)
        window.addEventListener('message', function(event) {
            if (event.data.type === 'TON_WALLET_CONNECTED') {
                isConnectedWallet = true;
                walletAddress = event.data.address;
                
                document.getElementById('walletBtn').textContent = 'Connected';
                document.getElementById('walletBtn').classList.add('wallet-connected');
                document.getElementById('walletAddress').style.display = 'flex';
                document.getElementById('addressText').textContent = walletAddress.substring(0, 6) + '...' + walletAddress.substring(walletAddress.length - 4);
                
                database.ref('users/' + currentUser.id).update({
                    walletAddress: walletAddress
                });
                
                showNotification('Wallet connected successfully!');
            }
        });
    </script>
</body>
</html>
