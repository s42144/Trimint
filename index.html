<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trimint - Telegram Mini App</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <!-- Telegram WebApp API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- TON Connect -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <!-- Monetag Ads -->
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
    
    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #6b7aff;
            --accent-color: #ff6b6b;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --background-color: #f5f7ff;
            --card-background: #ffffff;
            --text-color: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --primary-color: #5a7cff;
            --secondary-color: #7b8aff;
            --accent-color: #ff7b7b;
            --background-color: #1a1a2e;
            --card-background: #16213e;
            --text-color: #f5f5f5;
            --text-secondary: #b0b0b0;
            --border-color: #3a3a5c;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
            padding-bottom: 80px;
            min-height: 100vh;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .referral-message {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--card-background);
            border-radius: 10px;
            box-shadow: var(--shadow);
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--card-background);
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
        }

        .balance-container {
            display: flex;
            align-items: center;
            background-color: var(--primary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .coin-icon {
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }

        /* Theme Toggle */
        .theme-toggle {
            background-color: var(--card-background);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Section */
        .home-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 0;
        }

        .coin-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin-bottom: 30px;
        }

        .main-coin {
            width: 100%;
            height: 100%;
            object-fit: contain;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .farming-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: white;
            font-size: 18px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .farm-button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(74, 108, 247, 0.4);
            transition: var(--transition);
            margin-bottom: 20px;
        }

        .farm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 108, 247, 0.5);
        }

        .farm-button:disabled {
            background: linear-gradient(135deg, #8b9dc3, #a0aec0);
            cursor: not-allowed;
            transform: none;
        }

        .farming-timer {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .token-animation {
            position: absolute;
            color: var(--success-color);
            font-weight: bold;
            font-size: 14px;
            pointer-events: none;
            animation: riseUp 2s ease-out forwards;
        }

        @keyframes riseUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        /* Tasks Section */
        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .tasks-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .watch-ads-button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .watch-ads-button:hover {
            transform: scale(1.05);
        }

        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .task-card {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 15px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            margin-right: 15px;
            object-fit: cover;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .task-reward {
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-weight: 600;
        }

        .task-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .task-button:hover {
            background-color: var(--secondary-color);
        }

        .task-button.processing {
            background-color: var(--warning-color);
        }

        .task-button.completed {
            background-color: var(--success-color);
        }

        /* Leaderboard Section */
        .leaderboard-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .leaderboard-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .leaderboard-item {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 15px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
        }

        .leaderboard-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .leaderboard-level {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .leaderboard-balance {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Friends Section */
        .friends-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .friends-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .referral-card {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .referral-link-container {
            display: flex;
            margin-bottom: 15px;
        }

        .referral-link {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 10px 0 0 10px;
            background-color: var(--background-color);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .copy-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 0 10px 10px 0;
            cursor: pointer;
            transition: var(--transition);
        }

        .copy-button:hover {
            background-color: var(--secondary-color);
        }

        .referral-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .referrals-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .referral-item {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 15px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
        }

        .referral-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .referral-info {
            flex: 1;
        }

        .referral-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .referral-id {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .referral-reward {
            font-weight: 600;
            color: var(--success-color);
        }

        /* Profile Section */
        .profile-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 15px;
            object-fit: cover;
            border: 4px solid var(--primary-color);
        }

        .profile-name {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .profile-level {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .level-bronze {
            background-color: #cd7f32;
            color: white;
        }

        .level-gold {
            background-color: #ffd700;
            color: #333;
        }

        .level-diamond {
            background-color: #b9f2ff;
            color: #333;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .profile-stat-card {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 15px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .profile-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .profile-stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .wallet-section {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .wallet-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .wallet-address {
            display: flex;
            margin-bottom: 15px;
        }

        .wallet-address-text {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--background-color);
            font-size: 14px;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .wallet-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-right: 10px;
        }

        .wallet-button:hover {
            background-color: var(--secondary-color);
        }

        .wallet-button.disconnect {
            background-color: var(--accent-color);
        }

        .settings-section {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-label {
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background-color: var(--border-color);
            border-radius: 13px;
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-switch.active {
            background-color: var(--primary-color);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--card-background);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }

        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            padding: 5px;
            position: relative;
        }

        .nav-button.active {
            color: var(--primary-color);
        }

        .nav-button.home {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            margin-top: -20px;
            box-shadow: 0 4px 10px rgba(74, 108, 247, 0.4);
        }

        .nav-button.home.active {
            color: white;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 12px;
            font-weight: 600;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-background);
            color: var(--text-color);
            padding: 15px 25px;
            border-radius: 30px;
            box-shadow: var(--shadow);
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .profile-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="referral-message" id="referralMessage" style="display: none;"></div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="user-info">
                <img class="user-avatar" id="userAvatar" src="https://picsum.photos/seed/user123/40/40.jpg" alt="User Avatar">
                <div class="user-name" id="userName">Loading...</div>
            </div>
            <div class="balance-container">
                <img class="coin-icon" src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM">
                <span id="userBalance">0</span>
            </div>
            <button class="theme-toggle" id="themeToggle">
                <span id="themeIcon">üåô</span>
            </button>
        </header>

        <!-- Home Section -->
        <section class="section active" id="homeSection">
            <div class="home-content">
                <div class="coin-container">
                    <img class="main-coin" src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM Coin">
                    <div class="farming-status" id="farmingStatus"></div>
                </div>
                <button class="farm-button" id="farmButton">Start Farming</button>
                <div class="farming-timer" id="farmingTimer"></div>
            </div>
        </section>

        <!-- Tasks Section -->
        <section class="section" id="tasksSection">
            <div class="tasks-header">
                <h2 class="tasks-title">Tasks</h2>
                <button class="watch-ads-button" id="watchAdsButton">
                    <span>Watch Ads (+1 TRM)</span>
                </button>
            </div>
            <div class="tasks-list" id="tasksList">
                <!-- Tasks will be loaded here from Firebase -->
            </div>
        </section>

        <!-- Leaderboard Section -->
        <section class="section" id="leaderboardSection">
            <div class="leaderboard-header">
                <h2 class="leaderboard-title">Leaderboard</h2>
            </div>
            <div class="leaderboard-list" id="leaderboardList">
                <!-- Leaderboard items will be loaded here from Firebase -->
            </div>
        </section>

        <!-- Friends Section -->
        <section class="section" id="friendsSection">
            <div class="friends-header">
                <h2 class="friends-title">Friends</h2>
            </div>
            <div class="referral-card">
                <div class="referral-link-container">
                    <input class="referral-link" id="referralLink" readonly>
                    <button class="copy-button" id="copyReferralButton">Copy</button>
                </div>
                <div class="referral-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="referralEarnings">0</div>
                        <div class="stat-label">Referral Earnings</div>
                    </div>
                </div>
            </div>
            <div class="referrals-list" id="referralsList">
                <!-- Referrals will be loaded here from Firebase -->
            </div>
        </section>

        <!-- Profile Section -->
        <section class="section" id="profileSection">
            <div class="profile-header">
                <img class="profile-avatar" id="profileAvatar" src="https://picsum.photos/seed/user123/100/100.jpg" alt="Profile Avatar">
                <h2 class="profile-name" id="profileName">Loading...</h2>
                <div class="profile-level" id="profileLevel">Bronze</div>
            </div>
            <div class="profile-stats">
                <div class="profile-stat-card">
                    <div class="profile-stat-value" id="profileBalance">0</div>
                    <div class="profile-stat-label">Balance</div>
                </div>
                <div class="profile-stat-card">
                    <div class="profile-stat-value" id="profileFriends">0</div>
                    <div class="profile-stat-label">Friends</div>
                </div>
                <div class="profile-stat-card">
                    <div class="profile-stat-value" id="profileTasks">0</div>
                    <div class="profile-stat-label">Tasks Completed</div>
                </div>
                <div class="profile-stat-card">
                    <div class="profile-stat-value" id="profileFarming">0</div>
                    <div class="profile-stat-label">Farming Sessions</div>
                </div>
            </div>
            <div class="wallet-section">
                <h3 class="wallet-title">TON Wallet</h3>
                <div class="wallet-address" id="walletAddressContainer" style="display: none;">
                    <div class="wallet-address-text" id="walletAddressText"></div>
                </div>
                <div class="wallet-buttons">
                    <button class="wallet-button" id="connectWalletButton">Connect TON Wallet</button>
                    <button class="wallet-button disconnect" id="disconnectWalletButton" style="display: none;">Disconnect</button>
                    <button class="wallet-button" id="copyWalletButton" style="display: none;">Copy Address</button>
                </div>
            </div>
            <div class="settings-section">
                <h3 class="settings-title">Settings</h3>
                <div class="setting-item">
                    <span class="setting-label">Notifications</span>
                    <div class="toggle-switch active" id="notificationToggle"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Sound Effects</span>
                    <div class="toggle-switch active" id="soundToggle"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Auto-Farming</span>
                    <div class="toggle-switch" id="autoFarmingToggle"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-button home active" id="homeNavButton">
            <span class="nav-icon">üè†</span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-button" id="tasksNavButton">
            <span class="nav-icon">üìã</span>
            <span class="nav-label">Tasks</span>
        </button>
        <button class="nav-button" id="leaderboardNavButton">
            <span class="nav-icon">üèÜ</span>
            <span class="nav-label">Leaderboard</span>
        </button>
        <button class="nav-button" id="friendsNavButton">
            <span class="nav-icon">üë•</span>
            <span class="nav-label">Friends</span>
        </button>
        <button class="nav-button" id="profileNavButton">
            <span class="nav-icon">üë§</span>
            <span class="nav-label">Profile</span>
        </button>
    </nav>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Telegram WebApp API
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // TON Connect
        let tonConnectUI;
        let walletConnected = false;
        let walletAddress = '';

        // User Data
        let userData = {
            id: 0,
            firstName: '',
            lastName: '',
            username: '',
            photoUrl: '',
            balance: 0,
            level: 'Bronze',
            referrals: [],
            tasksCompleted: [],
            farmingSessions: 0,
            farmingEndTime: 0,
            isFarming: false,
            referralCode: '',
            referredBy: ''
        };

        // App State
        let currentSection = 'home';
        let farmingInterval;
        let farmingStartTime;
        let tasks = [];

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupEventListeners();
            initializeTonConnect();
            loadTasks();
            loadLeaderboard();
        });

        // Initialize App
        function initializeApp() {
            // Get user data from Telegram
            if (tg.initDataUnsafe.user) {
                userData.id = tg.initDataUnsafe.user.id;
                userData.firstName = tg.initDataUnsafe.user.first_name || '';
                userData.lastName = tg.initDataUnsafe.user.last_name || '';
                userData.username = tg.initDataUnsafe.user.username || '';
                userData.photoUrl = tg.initDataUnsafe.user.photo_url || 'https://picsum.photos/seed/user' + userData.id + '/100/100.jpg';
                
                // Generate referral code
                userData.referralCode = 'TRM' + userData.id;
                
                // Check for referral
                const urlParams = new URLSearchParams(window.location.search);
                const startParam = urlParams.get('startapp');
                if (startParam) {
                    const referrerId = startParam.split('_')[1] || startParam;
                    if (referrerId && referrerId !== userData.id.toString()) {
                        userData.referredBy = referrerId;
                        processReferral(referrerId);
                    }
                }
                
                // Load user data from Firebase
                loadUserData();
                
                // Update UI
                updateUserUI();
            }
            
            // Check theme preference
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // Hide loading screen after a short delay
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 1500);
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Navigation buttons
            document.getElementById('homeNavButton').addEventListener('click', () => switchSection('home'));
            document.getElementById('tasksNavButton').addEventListener('click', () => switchSection('tasks'));
            document.getElementById('leaderboardNavButton').addEventListener('click', () => switchSection('leaderboard'));
            document.getElementById('friendsNavButton').addEventListener('click', () => switchSection('friends'));
            document.getElementById('profileNavButton').addEventListener('click', () => switchSection('profile'));
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Farm button
            document.getElementById('farmButton').addEventListener('click', toggleFarming);
            
            // Watch ads button
            document.getElementById('watchAdsButton').addEventListener('click', watchAd);
            
            // Copy referral link
            document.getElementById('copyReferralButton').addEventListener('click', copyReferralLink);
            
            // Wallet buttons
            document.getElementById('connectWalletButton').addEventListener('click', connectWallet);
            document.getElementById('disconnectWalletButton').addEventListener('click', disconnectWallet);
            document.getElementById('copyWalletButton').addEventListener('click', copyWalletAddress);
            
            // Settings toggles
            document.getElementById('notificationToggle').addEventListener('click', function() {
                this.classList.toggle('active');
                const isActive = this.classList.contains('active');
                localStorage.setItem('notifications', isActive);
                showToast(isActive ? 'Notifications enabled' : 'Notifications disabled');
            });
            
            document.getElementById('soundToggle').addEventListener('click', function() {
                this.classList.toggle('active');
                const isActive = this.classList.contains('active');
                localStorage.setItem('soundEffects', isActive);
                showToast(isActive ? 'Sound effects enabled' : 'Sound effects disabled');
            });
            
            document.getElementById('autoFarmingToggle').addEventListener('click', function() {
                this.classList.toggle('active');
                const isActive = this.classList.contains('active');
                localStorage.setItem('autoFarming', isActive);
                showToast(isActive ? 'Auto-farming enabled' : 'Auto-farming disabled');
            });
        }

        // Initialize TON Connect
        function initializeTonConnect() {
            tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                manifestUrl: 'https://trimint.vercel.app/tonconnect-manifest.json',
                buttonRootId: null
            });
            
            tonConnectUI.onStatusChange(wallet => {
                if (wallet) {
                    walletConnected = true;
                    walletAddress = wallet.account.address;
                    updateWalletUI(true);
                    saveWalletAddress(walletAddress);
                } else {
                    walletConnected = false;
                    walletAddress = '';
                    updateWalletUI(false);
                }
            });
        }

        // Switch Section
        function switchSection(section) {
            // Update navigation buttons
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(section + 'NavButton').classList.add('active');
            
            // Update sections
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(section + 'Section').classList.add('active');
            
            currentSection = section;
            
            // Load section-specific data
            if (section === 'leaderboard') {
                loadLeaderboard();
            } else if (section === 'friends') {
                loadReferrals();
            } else if (section === 'profile') {
                updateProfileUI();
            }
        }

        // Toggle Theme
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        // Update Theme Icon
        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Load User Data
        function loadUserData() {
            database.ref('users/' + userData.id).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    userData.balance = data.balance || 0;
                    userData.level = data.level || 'Bronze';
                    userData.referrals = data.referrals || [];
                    userData.tasksCompleted = data.tasksCompleted || [];
                    userData.farmingSessions = data.farmingSessions || 0;
                    userData.farmingEndTime = data.farmingEndTime || 0;
                    userData.isFarming = data.isFarming || false;
                    userData.walletAddress = data.walletAddress || '';
                    
                    // Update UI
                    updateUserUI();
                    updateProfileUI();
                    
                    // Check if farming is in progress
                    if (userData.isFarming && userData.farmingEndTime > Date.now()) {
                        startFarmingUI();
                    }
                } else {
                    // New user, save initial data
                    saveUserData();
                }
            });
        }

        // Save User Data
        function saveUserData() {
            database.ref('users/' + userData.id).set({
                id: userData.id,
                firstName: userData.firstName,
                lastName: userData.lastName,
                username: userData.username,
                photoUrl: userData.photoUrl,
                balance: userData.balance,
                level: userData.level,
                referrals: userData.referrals,
                tasksCompleted: userData.tasksCompleted,
                farmingSessions: userData.farmingSessions,
                farmingEndTime: userData.farmingEndTime,
                isFarming: userData.isFarming,
                referralCode: userData.referralCode,
                walletAddress: userData.walletAddress
            });
        }

        // Update User UI
        function updateUserUI() {
            document.getElementById('userAvatar').src = userData.photoUrl;
            document.getElementById('userName').textContent = userData.firstName + ' ' + userData.lastName;
            document.getElementById('userBalance').textContent = userData.balance.toFixed(2);
            
            // Update referral link
            document.getElementById('referralLink').value = `https://t.me/TrimintBot/open?startapp=${userData.id}`;
            
            // Update level based on balance
            updateLevel();
        }

        // Update Level
        function updateLevel() {
            if (userData.balance < 10000) {
                userData.level = 'Bronze';
            } else if (userData.balance < 50000) {
                userData.level = 'Gold';
            } else {
                userData.level = 'Diamond';
            }
            
            const levelElement = document.getElementById('profileLevel');
            levelElement.textContent = userData.level;
            levelElement.className = 'profile-level level-' + userData.level.toLowerCase();
        }

        // Toggle Farming
        function toggleFarming() {
            if (userData.isFarming) {
                // Stop farming
                stopFarming();
            } else {
                // Start farming
                startFarming();
            }
        }

        // Start Farming
        function startFarming() {
            userData.isFarming = true;
            userData.farmingEndTime = Date.now() + 12 * 60 * 60 * 1000; // 12 hours from now
            userData.farmingSessions++;
            
            saveUserData();
            startFarmingUI();
            
            showToast('Farming started! You will earn 0.001 TRM per second for 12 hours.');
        }

        // Start Farming UI
        function startFarmingUI() {
            const farmButton = document.getElementById('farmButton');
            const farmingStatus = document.getElementById('farmingStatus');
            const farmingTimer = document.getElementById('farmingTimer');
            
            farmButton.textContent = 'Stop Farming';
            farmButton.disabled = false;
            
            // Clear any existing interval
            if (farmingInterval) {
                clearInterval(farmingInterval);
            }
            
            // Update farming timer and balance
            farmingInterval = setInterval(() => {
                const now = Date.now();
                const remainingTime = userData.farmingEndTime - now;
                
                if (remainingTime <= 0) {
                    // Farming completed
                    stopFarming();
                    showToast('Farming completed! You earned 43.2 TRM.');
                    return;
                }
                
                // Update timer display
                const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                
                farmingTimer.textContent = `Time remaining: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Update balance
                userData.balance += 0.001;
                updateUserUI();
                
                // Show token animation
                showTokenAnimation();
                
                // Save data periodically
                if (now % 5000 < 1000) { // Every 5 seconds
                    saveUserData();
                }
            }, 1000);
            
            // Show farming status
            farmingStatus.textContent = 'Farming';
        }

        // Stop Farming
        function stopFarming() {
            userData.isFarming = false;
            userData.farmingEndTime = 0;
            
            saveUserData();
            
            // Clear interval
            if (farmingInterval) {
                clearInterval(farmingInterval);
                farmingInterval = null;
            }
            
            // Update UI
            const farmButton = document.getElementById('farmButton');
            const farmingStatus = document.getElementById('farmingStatus');
            const farmingTimer = document.getElementById('farmingTimer');
            
            farmButton.textContent = 'Start Farming';
            farmingStatus.textContent = '';
            farmingTimer.textContent = '';
        }

        // Show Token Animation
        function showTokenAnimation() {
            const coinContainer = document.querySelector('.coin-container');
            const tokenAnimation = document.createElement('div');
            tokenAnimation.className = 'token-animation';
            tokenAnimation.textContent = '+0.001 TRM';
            
            // Random position around the coin
            const randomX = Math.random() * 100 - 50;
            const randomY = Math.random() * 100 - 50;
            
            tokenAnimation.style.left = `calc(50% + ${randomX}px)`;
            tokenAnimation.style.top = `calc(50% + ${randomY}px)`;
            
            coinContainer.appendChild(tokenAnimation);
            
            // Remove after animation completes
            setTimeout(() => {
                tokenAnimation.remove();
            }, 2000);
        }

        // Load Tasks
        function loadTasks() {
            database.ref('tasks').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    tasks = [];
                    snapshot.forEach(childSnapshot => {
                        tasks.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // Sort tasks by order
                    tasks.sort((a, b) => a.order - b.order);
                    
                    // Render tasks
                    renderTasks();
                }
            });
        }

        // Render Tasks
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = '';
            
            tasks.forEach(task => {
                const isCompleted = userData.tasksCompleted.includes(task.id);
                const isProcessing = false; // This would be tracked in a real implementation
                
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card';
                
                taskCard.innerHTML = `
                    <img class="task-icon" src="${task.photoUrl || 'https://picsum.photos/seed/task' + task.id + '/50/50.jpg'}" alt="${task.name}">
                    <div class="task-info">
                        <div class="task-name">${task.name}</div>
                        <div class="task-reward">
                            <img class="coin-icon" src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM">
                            <span>${task.reward}</span>
                        </div>
                    </div>
                    <button class="task-button ${isCompleted ? 'completed' : isProcessing ? 'processing' : ''}" 
                            data-task-id="${task.id}" 
                            data-task-link="${task.link}" 
                            data-task-reward="${task.reward}">
                        ${isCompleted ? 'Completed' : isProcessing ? 'Processing' : 'Open'}
                    </button>
                `;
                
                tasksList.appendChild(taskCard);
            });
            
            // Add event listeners to task buttons
            document.querySelectorAll('.task-button').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    const taskLink = this.getAttribute('data-task-link');
                    const taskReward = parseFloat(this.getAttribute('data-task-reward'));
                    
                    if (!userData.tasksCompleted.includes(taskId)) {
                        // Open task link
                        window.open(taskLink, '_blank');
                        
                        // Change button to processing
                        this.classList.add('processing');
                        this.textContent = 'Processing';
                        
                        // Simulate task completion after 10 seconds
                        setTimeout(() => {
                            // Mark task as completed
                            userData.tasksCompleted.push(taskId);
                            userData.balance += taskReward;
                            
                            // Update UI
                            this.classList.remove('processing');
                            this.classList.add('completed');
                            this.textContent = 'Completed';
                            updateUserUI();
                            saveUserData();
                            
                            showToast(`Task completed! You earned ${taskReward} TRM.`);
                        }, 10000);
                    } else {
                        // Task already completed, just open link
                        window.open(taskLink, '_blank');
                    }
                });
            });
        }

        // Watch Ad
        function watchAd() {
            // Show Monetag ad
            if (window.libtl && window.libtl.showAd) {
                window.libtl.showAd(() => {
                    // Ad completed, add reward
                    userData.balance += 1;
                    updateUserUI();
                    saveUserData();
                    showToast('Ad watched! You earned 1 TRM.');
                });
            } else {
                // Fallback if ad SDK not loaded
                showToast('Ad loading... Please try again later.');
                
                // Simulate ad completion after 5 seconds
                setTimeout(() => {
                    userData.balance += 1;
                    updateUserUI();
                    saveUserData();
                    showToast('Ad watched! You earned 1 TRM.');
                }, 5000);
            }
        }

        // Load Leaderboard
        function loadLeaderboard() {
            database.ref('users').orderByChild('balance').limitToLast(25).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const leaderboardData = [];
                    snapshot.forEach(childSnapshot => {
                        leaderboardData.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // Sort by balance (descending)
                    leaderboardData.sort((a, b) => b.balance - a.balance);
                    
                    // Render leaderboard
                    renderLeaderboard(leaderboardData);
                }
            });
        }

        // Render Leaderboard
        function renderLeaderboard(leaderboardData) {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';
            
            leaderboardData.forEach((user, index) => {
                const leaderboardItem = document.createElement('div');
                leaderboardItem.className = 'leaderboard-item';
                
                // Determine level based on balance
                let level = 'Bronze';
                if (user.balance >= 50000) {
                    level = 'Diamond';
                } else if (user.balance >= 10000) {
                    level = 'Gold';
                }
                
                leaderboardItem.innerHTML = `
                    <div class="leaderboard-rank">${index + 1}</div>
                    <img class="leaderboard-avatar" src="${user.photoUrl || 'https://picsum.photos/seed/user' + user.id + '/40/40.jpg'}" alt="${user.firstName}">
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${user.firstName} ${user.lastName}</div>
                        <div class="leaderboard-level">${level}</div>
                    </div>
                    <div class="leaderboard-balance">
                        <img class="coin-icon" src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM">
                        <span>${user.balance.toFixed(2)}</span>
                    </div>
                `;
                
                leaderboardList.appendChild(leaderboardItem);
            });
        }

        // Load Referrals
        function loadReferrals() {
            // Update referral stats
            document.getElementById('totalReferrals').textContent = userData.referrals.length;
            document.getElementById('referralEarnings').textContent = (userData.referrals.length * 5000).toFixed(2);
            
            // Load referral details
            const referralsList = document.getElementById('referralsList');
            referralsList.innerHTML = '';
            
            if (userData.referrals.length === 0) {
                referralsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No referrals yet. Invite your friends to earn TRM!</p>';
                return;
            }
            
            userData.referrals.forEach(referralId => {
                database.ref('users/' + referralId).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        const referralData = snapshot.val();
                        
                        const referralItem = document.createElement('div');
                        referralItem.className = 'referral-item';
                        
                        referralItem.innerHTML = `
                            <img class="referral-avatar" src="${referralData.photoUrl || 'https://picsum.photos/seed/user' + referralData.id + '/40/40.jpg'}" alt="${referralData.firstName}">
                            <div class="referral-info">
                                <div class="referral-name">${referralData.firstName} ${referralData.lastName}</div>
                                <div class="referral-id">ID: ${referralData.id}</div>
                            </div>
                            <div class="referral-reward">+5000 TRM</div>
                        `;
                        
                        referralsList.appendChild(referralItem);
                    }
                });
            });
        }

        // Copy Referral Link
        function copyReferralLink() {
            const referralLink = document.getElementById('referralLink');
            referralLink.select();
            document.execCommand('copy');
            showToast('Referral link copied!');
        }

        // Process Referral
        function processReferral(referrerId) {
            // Check if this user was already referred
            if (userData.referredBy) {
                return;
            }
            
            // Show referral message on loading screen
            const referralMessage = document.getElementById('referralMessage');
            database.ref('users/' + referrerId).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const referrerData = snapshot.val();
                    referralMessage.textContent = `You were invited by ${referrerData.firstName} ${referrerData.lastName}`;
                    referralMessage.style.display = 'block';
                    
                    // Add referral to referrer's list
                    database.ref('users/' + referrerId + '/referrals').once('value').then(refSnapshot => {
                        const referrals = refSnapshot.val() || [];
                        if (!referrals.includes(userData.id.toString())) {
                            referrals.push(userData.id.toString());
                            
                            // Update referrer's data
                            database.ref('users/' + referrerId).update({
                                referrals: referrals,
                                balance: firebase.database.ServerValue.increment(5000)
                            });
                        }
                    });
                    
                    // Hide message after 5 seconds
                    setTimeout(() => {
                        referralMessage.style.display = 'none';
                    }, 5000);
                }
            });
        }

        // Connect Wallet
        async function connectWallet() {
            try {
                await tonConnectUI.connectWallet();
            } catch (error) {
                console.error('Failed to connect wallet:', error);
                showToast('Failed to connect wallet. Please try again.');
            }
        }

        // Disconnect Wallet
        async function disconnectWallet() {
            try {
                await tonConnectUI.disconnect();
            } catch (error) {
                console.error('Failed to disconnect wallet:', error);
                showToast('Failed to disconnect wallet. Please try again.');
            }
        }

        // Copy Wallet Address
        function copyWalletAddress() {
            if (walletAddress) {
                navigator.clipboard.writeText(walletAddress)
                    .then(() => showToast('Wallet address copied!'))
                    .catch(() => showToast('Failed to copy wallet address'));
            }
        }

        // Save Wallet Address
        function saveWalletAddress(address) {
            userData.walletAddress = address;
            saveUserData();
        }

        // Update Wallet UI
        function updateWalletUI(connected) {
            const connectButton = document.getElementById('connectWalletButton');
            const disconnectButton = document.getElementById('disconnectWalletButton');
            const copyButton = document.getElementById('copyWalletButton');
            const walletAddressContainer = document.getElementById('walletAddressContainer');
            const walletAddressText = document.getElementById('walletAddressText');
            
            if (connected) {
                connectButton.style.display = 'none';
                disconnectButton.style.display = 'inline-block';
                copyButton.style.display = 'inline-block';
                walletAddressContainer.style.display = 'flex';
                walletAddressText.textContent = walletAddress;
            } else {
                connectButton.style.display = 'inline-block';
                connectButton.textContent = 'Connect TON Wallet';
                disconnectButton.style.display = 'none';
                copyButton.style.display = 'none';
                walletAddressContainer.style.display = 'none';
            }
        }

        // Update Profile UI
        function updateProfileUI() {
            document.getElementById('profileAvatar').src = userData.photoUrl;
            document.getElementById('profileName').textContent = userData.firstName + ' ' + userData.lastName;
            document.getElementById('profileBalance').textContent = userData.balance.toFixed(2);
            document.getElementById('profileFriends').textContent = userData.referrals.length;
            document.getElementById('profileTasks').textContent = userData.tasksCompleted.length;
            document.getElementById('profileFarming').textContent = userData.farmingSessions;
            
            // Update level
            updateLevel();
            
            // Update wallet UI if connected
            if (userData.walletAddress) {
                walletAddress = userData.walletAddress;
                updateWalletUI(true);
            }
            
            // Update settings toggles
            const notifications = localStorage.getItem('notifications') !== 'false';
            const soundEffects = localStorage.getItem('soundEffects') !== 'false';
            const autoFarming = localStorage.getItem('autoFarming') === 'true';
            
            if (notifications) {
                document.getElementById('notificationToggle').classList.add('active');
            } else {
                document.getElementById('notificationToggle').classList.remove('active');
            }
            
            if (soundEffects) {
                document.getElementById('soundToggle').classList.add('active');
            } else {
                document.getElementById('soundToggle').classList.remove('active');
            }
            
            if (autoFarming) {
                document.getElementById('autoFarmingToggle').classList.add('active');
            } else {
                document.getElementById('autoFarmingToggle').classList.remove('active');
            }
        }

        // Show Toast Notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
