<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trimint - TRM Mining</title>
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #475569;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        body.light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #cbd5e1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .coin-loader {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 18px;
            margin-bottom: 10px;
        }

        .referral-info {
            color: var(--primary-color);
            font-size: 14px;
            text-align: center;
        }

        .header {
            background: var(--bg-secondary);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .balance-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .coin-icon {
            width: 30px;
            height: 30px;
        }

        .balance-amount {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            padding-bottom: 100px;
            overflow-y: auto;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .home-page {
            text-align: center;
        }

        .coin-container {
            margin: 30px 0;
            position: relative;
        }

        .main-coin {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .main-coin:hover {
            transform: scale(1.05);
        }

        .main-coin.farming {
            animation: rotate 2s linear infinite;
            box-shadow: 0 0 50px rgba(99, 102, 241, 0.6);
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .token-animation {
            position: absolute;
            font-size: 14px;
            font-weight: bold;
            color: var(--success-color);
            pointer-events: none;
            animation: floatUp 2s ease-out;
        }

        @keyframes floatUp {
            0% { 
                opacity: 1; 
                transform: translateY(0);
            }
            100% { 
                opacity: 0; 
                transform: translateY(-50px);
            }
        }

        .farm-button {
            background: var(--gradient-1);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .farm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .farm-button:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            transform: none;
        }

        .farm-timer {
            font-size: 16px;
            color: var(--text-secondary);
            margin: 10px 0;
        }

        .task-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .task-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .task-reward {
            color: var(--success-color);
            font-size: 14px;
        }

        .task-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .task-button:hover {
            transform: scale(1.05);
        }

        .task-button.completed {
            background: var(--success-color);
        }

        .task-button.processing {
            background: var(--warning-color);
        }

        .leaderboard-table {
            background: var(--bg-secondary);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
        }

        .leaderboard-header {
            background: var(--gradient-2);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            background: var(--bg-tertiary);
        }

        .rank-number {
            width: 30px;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .rank-number.top-3 {
            color: var(--warning-color);
            font-size: 18px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 15px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .user-level {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .user-balance {
            font-weight: bold;
            color: var(--success-color);
        }

        .referral-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .referral-link {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .referral-link-text {
            font-size: 12px;
            color: var(--text-secondary);
            flex: 1;
            margin-right: 10px;
            word-break: break-all;
        }

        .copy-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-button:hover {
            transform: scale(1.05);
        }

        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .referral-list {
            margin-top: 20px;
        }

        .referral-item {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .profile-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
        }

        .profile-info h2 {
            margin-bottom: 5px;
        }

        .profile-level {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .wallet-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .wallet-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .wallet-address {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }

        .wallet-buttons {
            display: flex;
            gap: 10px;
        }

        .wallet-button {
            flex: 1;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wallet-button:hover {
            transform: scale(1.05);
        }

        .wallet-button.disconnect {
            background: var(--danger-color);
        }

        .settings-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-toggle {
            background: var(--bg-tertiary);
            border-radius: 20px;
            padding: 5px;
            width: 50px;
            height: 26px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .setting-toggle.active {
            background: var(--primary-color);
        }

        .setting-toggle-slider {
            background: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: all 0.3s ease;
        }

        .setting-toggle.active .setting-toggle-slider {
            left: 27px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px 15px;
            border-radius: 10px;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item.home {
            transform: scale(1.1);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
        }

        .nav-icon.home {
            width: 30px;
            height: 30px;
        }

        .nav-label {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .nav-item.active .nav-label {
            color: var(--primary-color);
        }

        .level-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .level-bronze {
            background: linear-gradient(135deg, #8B4513, #A0522D);
            color: white;
        }

        .level-gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
        }

        .level-diamond {
            background: linear-gradient(135deg, #B9F2FF, #00BFFF);
            color: #333;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        @media (max-width: 380px) {
            .main-content {
                padding: 15px;
            }
            
            .main-coin {
                width: 150px;
                height: 150px;
            }
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="Loading" class="coin-loader">
        <div class="loading-text">Loading Trimint...</div>
        <div class="referral-info" id="referralInfo"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="balance-section">
            <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="coin-icon">
            <span class="balance-amount" id="balance">0 TRM</span>
        </div>
        <button class="theme-toggle" id="themeToggle">ðŸŒ™</button>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Home Page -->
        <div class="page home-page active" id="homePage">
            <div class="coin-container">
                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM Coin" class="main-coin" id="mainCoin">
            </div>
            <button class="farm-button" id="farmButton">Start Farming</button>
            <div class="farm-timer" id="farmTimer"></div>
        </div>

        <!-- Tasks Page -->
        <div class="page" id="tasksPage">
            <h2>Tasks</h2>
            <div id="tasksList">
                <div class="task-card">
                    <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="Watch Ads" class="task-icon">
                    <div class="task-info">
                        <div class="task-name">Watch Ads</div>
                        <div class="task-reward">+1 TRM</div>
                    </div>
                    <button class="task-button" id="watchAdsButton">OPEN</button>
                </div>
            </div>
        </div>

        <!-- Leaderboard Page -->
        <div class="page" id="leaderboardPage">
            <h2>Leaderboard</h2>
            <div class="leaderboard-table">
                <div class="leaderboard-header">Top Miners</div>
                <div id="leaderboardList"></div>
            </div>
        </div>

        <!-- Friends Page -->
        <div class="page" id="friendsPage">
            <h2>Friends</h2>
            <div class="referral-section">
                <h3>Invite Friends</h3>
                <div class="referral-link">
                    <span class="referral-link-text" id="referralLink"></span>
                    <button class="copy-button" id="copyReferralButton">Copy</button>
                </div>
                <div class="referral-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="referralEarnings">0 TRM</div>
                        <div class="stat-label">Referral Earnings</div>
                    </div>
                </div>
            </div>
            <div class="referral-list">
                <h3>Your Referrals</h3>
                <div id="referralsList"></div>
            </div>
        </div>

        <!-- Profile Page -->
        <div class="page" id="profilePage">
            <div class="profile-section">
                <div class="profile-header">
                    <img src="" alt="Profile" class="profile-avatar" id="profileAvatar">
                    <div class="profile-info">
                        <h2 id="profileName">Loading...</h2>
                        <div class="profile-level">
                            Level: <span class="level-badge" id="userLevel">Bronze</span>
                        </div>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="profileBalance">0</div>
                        <div class="stat-label">TRM Balance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalFriends">0</div>
                        <div class="stat-label">Total Friends</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="farmTime">0h</div>
                        <div class="stat-label">Farm Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completedTasks">0</div>
                        <div class="stat-label">Completed Tasks</div>
                    </div>
                </div>
            </div>

            <div class="wallet-section">
                <h3>TON Wallet</h3>
                <div class="wallet-status">
                    <span id="walletStatus">Not Connected</span>
                    <button class="wallet-button" id="connectWalletButton">Connect TON Wallet</button>
                </div>
                <div class="wallet-address" id="walletAddress" style="display: none;"></div>
                <div class="wallet-buttons" id="walletButtons" style="display: none;">
                    <button class="wallet-button" id="copyAddressButton">Copy Address</button>
                    <button class="wallet-button disconnect" id="disconnectWalletButton">Disconnect</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Settings</h3>
                <div class="setting-item">
                    <span>Notifications</span>
                    <div class="setting-toggle active" id="notificationsToggle">
                        <div class="setting-toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span>Sound Effects</span>
                    <div class="setting-toggle active" id="soundToggle">
                        <div class="setting-toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span>Vibration</span>
                    <div class="setting-toggle active" id="vibrationToggle">
                        <div class="setting-toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span>Auto Farming</span>
                    <div class="setting-toggle" id="autoFarmToggle">
                        <div class="setting-toggle-slider"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item home active" data-page="home">
            <svg class="nav-icon home" fill="currentColor" viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
            <span class="nav-label">Home</span>
        </div>
        <div class="nav-item" data-page="tasks">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
            </svg>
            <span class="nav-label">Tasks</span>
        </div>
        <div class="nav-item" data-page="leaderboard">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                <path d="M7.5 21L9 18l3-2 3 2 1.5 3h-9zm7.5-4.5L13 14l2-3-2-3 2-3.5L18 11v5.5zm-6 0L6 16.5V11l2.5-6.5L11 8l-2 3 2 3-2 2.5z"/>
            </svg>
            <span class="nav-label">Leaderboard</span>
        </div>
        <div class="nav-item" data-page="friends">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
            <span class="nav-label">Friends</span>
        </div>
        <div class="nav-item" data-page="profile">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <span class="nav-label">Profile</span>
        </div>
    </nav>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // Global Variables
        let currentUser = null;
        let userBalance = 0;
        let isFarming = false;
        let farmStartTime = null;
        let farmTimer = null;
        let walletAddress = null;
        let completedTasks = new Set();
        let referrals = [];
        let settings = {
            notifications: true,
            sound: true,
            vibration: true,
            autoFarm: false
        };

        // Telegram WebApp Integration
        const tg = window.Telegram.WebApp;

        // Initialize App
        async function initApp() {
            try {
                // Expand WebApp
                tg.expand();
                
                // Get user data from Telegram
                if (tg.initDataUnsafe.user) {
                    currentUser = tg.initDataUnsafe.user;
                    await loadUserData();
                    await checkReferral();
                    updateUI();
                    setupEventListeners();
                    loadTasks();
                    loadLeaderboard();
                }
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                }, 2000);
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showToast('Error initializing app');
            }
        }

        // Load User Data from Firebase
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.id.toString()).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userBalance = userData.balance || 0;
                    isFarming = userData.isFarming || false;
                    farmStartTime = userData.farmStartTime || null;
                    walletAddress = userData.walletAddress || null;
                    completedTasks = new Set(userData.completedTasks || []);
                    referrals = userData.referrals || [];
                    settings = { ...settings, ...userData.settings };
                } else {
                    // Create new user
                    await createNewUser();
                }
                
                // Resume farming if needed
                if (isFarming && farmStartTime) {
                    resumeFarming();
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Create New User
        async function createNewUser() {
            try {
                await db.collection('users').doc(currentUser.id.toString()).set({
                    telegramId: currentUser.id,
                    username: currentUser.username || 'Unknown',
                    firstName: currentUser.first_name,
                    lastName: currentUser.last_name || '',
                    photoUrl: currentUser.photo_url || '',
                    balance: 0,
                    isFarming: false,
                    farmStartTime: null,
                    walletAddress: null,
                    completedTasks: [],
                    referrals: [],
                    settings: settings,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    totalFarmTime: 0,
                    tasksCompleted: 0
                });
            } catch (error) {
                console.error('Error creating user:', error);
            }
        }

        // Check Referral
        async function checkReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const referrerId = urlParams.get('startapp');
            
            if (referrerId && referrerId !== currentUser.id.toString()) {
                try {
                    // Check if this user was already referred
                    const referrerDoc = await db.collection('users').doc(referrerId).get();
                    
                    if (referrerDoc.exists) {
                        // Add referral to referrer
                        await db.collection('users').doc(referrerId).update({
                            referrals: firebase.firestore.FieldValue.arrayUnion({
                                telegramId: currentUser.id,
                                username: currentUser.username || 'Unknown',
                                firstName: currentUser.first_name,
                                photoUrl: currentUser.photo_url || '',
                                referredAt: firebase.firestore.FieldValue.serverTimestamp(),
                                earned: 5000
                            }),
                            balance: firebase.firestore.FieldValue.increment(5000)
                        });
                        
                        // Show referrer name on loading screen
                        const referrerData = referrerDoc.data();
                        document.getElementById('referralInfo').textContent = 
                            `Referred by ${referrerData.firstName}`;
                        
                        showToast('Welcome! You were referred by ' + referrerData.firstName);
                    }
                } catch (error) {
                    console.error('Error processing referral:', error);
                }
            }
        }

        // Update UI
        function updateUI() {
            // Update balance
            document.getElementById('balance').textContent = `${userBalance.toFixed(3)} TRM`;
            document.getElementById('profileBalance').textContent = userBalance.toFixed(3);
            
            // Update profile info
            if (currentUser) {
                document.getElementById('profileName').textContent = 
                    `${currentUser.first_name} ${currentUser.last_name || ''}`.trim();
                
                if (currentUser.photo_url) {
                    document.getElementById('profileAvatar').src = currentUser.photo_url;
                }
                
                // Update referral link
                const referralLink = `https://t.me/TrimintBot/open?startapp=${currentUser.id}`;
                document.getElementById('referralLink').textContent = referralLink;
            }
            
            // Update user level
            updateUserLevel();
            
            // Update stats
            updateStats();
            
            // Update wallet status
            updateWalletStatus();
            
            // Update farming button
            updateFarmButton();
        }

        // Update User Level
        function updateUserLevel() {
            const levelElement = document.getElementById('userLevel');
            let level = 'Bronze';
            let levelClass = 'level-bronze';
            
            if (userBalance >= 50000) {
                level = 'Diamond';
                levelClass = 'level-diamond';
            } else if (userBalance >= 10000) {
                level = 'Gold';
                levelClass = 'level-gold';
            }
            
            levelElement.textContent = level;
            levelElement.className = `level-badge ${levelClass}`;
        }

        // Update Stats
        function updateStats() {
            document.getElementById('totalReferrals').textContent = referrals.length;
            document.getElementById('referralEarnings').textContent = `${(referrals.length * 5000).toLocaleString()} TRM`;
            document.getElementById('totalFriends').textContent = referrals.length;
            document.getElementById('completedTasks').textContent = completedTasks.size;
            
            // Calculate farm time
            const farmTimeHours = Math.floor((userBalance / 0.001) / 3600);
            document.getElementById('farmTime').textContent = `${farmTimeHours}h`;
            
            // Update referrals list
            updateReferralsList();
        }

        // Update Referrals List
        function updateReferralsList() {
            const referralsList = document.getElementById('referralsList');
            referralsList.innerHTML = '';
            
            referrals.forEach(referral => {
                const referralItem = document.createElement('div');
                referralItem.className = 'referral-item';
                referralItem.innerHTML = `
                    <img src="${referral.photoUrl || 'https://via.placeholder.com/40'}" alt="${referral.firstName}" class="user-avatar">
                    <div class="user-info">
                        <div class="user-name">${referral.firstName}</div>
                        <div class="user-level">ID: ${referral.telegramId}</div>
                    </div>
                    <div class="user-balance">+${referral.earned} TRM</div>
                `;
                referralsList.appendChild(referralItem);
            });
        }

        // Update Wallet Status
        function updateWalletStatus() {
            const walletStatus = document.getElementById('walletStatus');
            const walletAddressElement = document.getElementById('walletAddress');
            const walletButtons = document.getElementById('walletButtons');
            const connectButton = document.getElementById('connectWalletButton');
            
            if (walletAddress) {
                walletStatus.textContent = 'Connected';
                walletAddressElement.textContent = walletAddress;
                walletAddressElement.style.display = 'block';
                walletButtons.style.display = 'flex';
                connectButton.textContent = 'Connected';
                connectButton.style.background = 'var(--success-color)';
            } else {
                walletStatus.textContent = 'Not Connected';
                walletAddressElement.style.display = 'none';
                walletButtons.style.display = 'none';
                connectButton.textContent = 'Connect TON Wallet';
                connectButton.style.background = 'var(--primary-color)';
            }
        }

        // Update Farm Button
        function updateFarmButton() {
            const farmButton = document.getElementById('farmButton');
            const farmTimer = document.getElementById('farmTimer');
            
            if (isFarming) {
                farmButton.textContent = 'Farming...';
                farmButton.disabled = true;
                document.getElementById('mainCoin').classList.add('farming');
            } else {
                farmButton.textContent = 'Start Farming';
                farmButton.disabled = false;
                document.getElementById('mainCoin').classList.remove('farming');
                farmTimer.textContent = '';
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.dataset.page;
                    switchPage(page);
                });
            });
            
            // Farm Button
            document.getElementById('farmButton').addEventListener('click', startFarming);
            
            // Main Coin Click
            document.getElementById('mainCoin').addEventListener('click', function() {
                if (!isFarming) {
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 100);
                }
            });
            
            // Theme Toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Copy Referral Link
            document.getElementById('copyReferralButton').addEventListener('click', copyReferralLink);
            
            // Watch Ads Button
            document.getElementById('watchAdsButton').addEventListener('click', watchAds);
            
            // Wallet Buttons
            document.getElementById('connectWalletButton').addEventListener('click', connectWallet);
            document.getElementById('copyAddressButton').addEventListener('click', copyWalletAddress);
            document.getElementById('disconnectWalletButton').addEventListener('click', disconnectWallet);
            
            // Settings Toggles
            document.getElementById('notificationsToggle').addEventListener('click', function() {
                toggleSetting('notifications', this);
            });
            
            document.getElementById('soundToggle').addEventListener('click', function() {
                toggleSetting('sound', this);
            });
            
            document.getElementById('vibrationToggle').addEventListener('click', function() {
                toggleSetting('vibration', this);
            });
            
            document.getElementById('autoFarmToggle').addEventListener('click', function() {
                toggleSetting('autoFarm', this);
            });
        }

        // Switch Page
        function switchPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(`${pageName}Page`).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[data-page="${pageName}"]`).classList.add('active');
            
            // Load page-specific data
            if (pageName === 'leaderboard') {
                loadLeaderboard();
            } else if (pageName === 'tasks') {
                loadTasks();
            }
        }

        // Start Farming
        async function startFarming() {
            if (isFarming) return;
            
            try {
                isFarming = true;
                farmStartTime = Date.now();
                
                await db.collection('users').doc(currentUser.id.toString()).update({
                    isFarming: true,
                    farmStartTime: farmStartTime
                });
                
                updateFarmButton();
                startFarmTimer();
                showToast('Farming started! Earn 0.001 TRM per second');
                
            } catch (error) {
                console.error('Error starting farming:', error);
                isFarming = false;
                updateFarmButton();
                showToast('Error starting farming');
            }
        }

        // Resume Farming
        function resumeFarming() {
            const elapsed = Date.now() - farmStartTime;
            const remainingTime = 12 * 60 * 60 * 1000 - elapsed;
            
            if (remainingTime > 0) {
                startFarmTimer();
            } else {
                isFarming = false;
                farmStartTime = null;
                updateFarmButton();
            }
        }

        // Start Farm Timer
        function startFarmTimer() {
            const farmDuration = 12 * 60 * 60 * 1000; // 12 hours
            
            farmTimer = setInterval(async () => {
                const elapsed = Date.now() - farmStartTime;
                const remainingTime = farmDuration - elapsed;
                
                if (remainingTime <= 0) {
                    // Farming completed
                    clearInterval(farmTimer);
                    isFarming = false;
                    farmStartTime = null;
                    
                    await db.collection('users').doc(currentUser.id.toString()).update({
                        isFarming: false,
                        farmStartTime: null
                    });
                    
                    updateFarmButton();
                    showToast('Farming completed! Start again to continue earning');
                    return;
                }
                
                // Add tokens
                userBalance += 0.001;
                
                // Show animation
                showTokenAnimation();
                
                // Update balance
                document.getElementById('balance').textContent = `${userBalance.toFixed(3)} TRM`;
                document.getElementById('profileBalance').textContent = userBalance.toFixed(3);
                
                // Update timer display
                const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                
                document.getElementById('farmTimer').textContent = 
                    `Time remaining: ${hours}h ${minutes}m ${seconds}s`;
                
                // Save balance periodically (every 10 seconds)
                if (elapsed % 10000 < 1000) {
                    await db.collection('users').doc(currentUser.id.toString()).update({
                        balance: userBalance
                    });
                }
                
            }, 1000);
        }

        // Show Token Animation
        function showTokenAnimation() {
            const coin = document.getElementById('mainCoin');
            const animation = document.createElement('div');
            animation.className = 'token-animation';
            animation.textContent = '+0.001';
            animation.style.left = '50%';
            animation.style.top = '50%';
            
            coin.parentElement.appendChild(animation);
            
            setTimeout(() => {
                animation.remove();
            }, 2000);
        }

        // Toggle Theme
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.textContent = document.body.classList.contains('light-mode') ? 'â˜€ï¸' : 'ðŸŒ™';
        }

        // Copy Referral Link
        function copyReferralLink() {
            const referralLink = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(referralLink).then(() => {
                showToast('Referral link copied!');
            });
        }

        // Watch Ads
        async function watchAds() {
            const button = document.getElementById('watchAdsButton');
            
            if (button.textContent === 'COMPLETED') {
                // Still redirect to ads
                window.open('https://your-ads-link.com', '_blank');
                return;
            }
            
            if (button.textContent === 'PROCESSING') {
                return;
            }
            
            button.textContent = 'PROCESSING';
            button.classList.add('processing');
            
            try {
                // Show ads (integrate with your ad provider)
                if (window.showAd) {
                    await window.showAd();
                }
                
                // Wait 10 seconds
                await new Promise(resolve => setTimeout(resolve, 10000));
                
                // Add reward
                userBalance += 1;
                await db.collection('users').doc(currentUser.id.toString()).update({
                    balance: userBalance,
                    tasksCompleted: firebase.firestore.FieldValue.increment(1)
                });
                
                // Update UI
                document.getElementById('balance').textContent = `${userBalance.toFixed(3)} TRM`;
                document.getElementById('profileBalance').textContent = userBalance.toFixed(3);
                updateStats();
                
                button.textContent = 'COMPLETED';
                button.classList.remove('processing');
                button.classList.add('completed');
                
                showToast('Earned 1 TRM!');
                
            } catch (error) {
                console.error('Error watching ads:', error);
                button.textContent = 'OPEN';
                button.classList.remove('processing');
                showToast('Error watching ads');
            }
        }

        // Connect Wallet
        function connectWallet() {
            // Open wallet connection URL
            window.open('https://trimint.vercel.app/', '_blank');
            
            // In a real implementation, you would handle the callback from wallet connection
            // For now, we'll simulate wallet connection
            setTimeout(() => {
                walletAddress = 'EQD_sample_wallet_address_123456789';
                saveWalletAddress();
                updateWalletStatus();
                showToast('Wallet connected successfully!');
            }, 2000);
        }

        // Save Wallet Address
        async function saveWalletAddress() {
            try {
                await db.collection('users').doc(currentUser.id.toString()).update({
                    walletAddress: walletAddress
                });
            } catch (error) {
                console.error('Error saving wallet address:', error);
            }
        }

        // Copy Wallet Address
        function copyWalletAddress() {
            if (walletAddress) {
                navigator.clipboard.writeText(walletAddress).then(() => {
                    showToast('Wallet address copied!');
                });
            }
        }

        // Disconnect Wallet
        async function disconnectWallet() {
            try {
                walletAddress = null;
                await db.collection('users').doc(currentUser.id.toString()).update({
                    walletAddress: null
                });
                updateWalletStatus();
                showToast('Wallet disconnected');
            } catch (error) {
                console.error('Error disconnecting wallet:', error);
            }
        }

        // Toggle Setting
        async function toggleSetting(setting, element) {
            element.classList.toggle('active');
            settings[setting] = element.classList.contains('active');
            
            try {
                await db.collection('users').doc(currentUser.id.toString()).update({
                    [`settings.${setting}`]: settings[setting]
                });
            } catch (error) {
                console.error('Error updating setting:', error);
            }
        }

        // Load Tasks
        async function loadTasks() {
            try {
                const tasksSnapshot = await db.collection('tasks').orderBy('order').get();
                const tasksList = document.getElementById('tasksList');
                
                // Keep the watch ads task
                tasksList.innerHTML = `
                    <div class="task-card">
                        <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="Watch Ads" class="task-icon">
                        <div class="task-info">
                            <div class="task-name">Watch Ads</div>
                            <div class="task-reward">+1 TRM</div>
                        </div>
                        <button class="task-button" id="watchAdsButton">OPEN</button>
                    </div>
                `;
                
                tasksSnapshot.forEach(doc => {
                    const task = doc.data();
                    const taskCard = createTaskCard(task, doc.id);
                    tasksList.appendChild(taskCard);
                });
                
                // Re-attach watch ads button listener
                document.getElementById('watchAdsButton').addEventListener('click', watchAds);
                
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        // Create Task Card
        function createTaskCard(task, taskId) {
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card';
            
            const isCompleted = completedTasks.has(taskId);
            let buttonClass = 'task-button';
            let buttonText = 'OPEN';
            
            if (isCompleted) {
                buttonClass += ' completed';
                buttonText = 'COMPLETED';
            }
            
            taskCard.innerHTML = `
                <img src="${task.icon || 'https://i.postimg.cc/fTQktNmX/maincoin.png'}" alt="${task.name}" class="task-icon">
                <div class="task-info">
                    <div class="task-name">${task.name}</div>
                    <div class="task-reward">+${task.reward} TRM</div>
                </div>
                <button class="${buttonClass}" data-task-id="${taskId}" data-task-link="${task.link}" data-task-reward="${task.reward}">${buttonText}</button>
            `;
            
            // Add click listener to task button
            const taskButton = taskCard.querySelector('button');
            taskButton.addEventListener('click', () => completeTask(taskId, task.link, task.reward, taskButton));
            
            return taskCard;
        }

        // Complete Task
        async function completeTask(taskId, taskLink, taskReward, button) {
            if (button.textContent === 'COMPLETED') {
                window.open(taskLink, '_blank');
                return;
            }
            
            if (button.textContent === 'PROCESSING') {
                return;
            }
            
            button.textContent = 'PROCESSING';
            button.classList.add('processing');
            
            try {
                // Open task link
                window.open(taskLink, '_blank');
                
                // Wait 10 seconds
                await new Promise(resolve => setTimeout(resolve, 10000));
                
                // Add reward
                userBalance += taskReward;
                completedTasks.add(taskId);
                
                await db.collection('users').doc(currentUser.id.toString()).update({
                    balance: userBalance,
                    completedTasks: Array.from(completedTasks),
                    tasksCompleted: firebase.firestore.FieldValue.increment(1)
                });
                
                // Update UI
                document.getElementById('balance').textContent = `${userBalance.toFixed(3)} TRM`;
                document.getElementById('profileBalance').textContent = userBalance.toFixed(3);
                updateStats();
                
                button.textContent = 'COMPLETED';
                button.classList.remove('processing');
                button.classList.add('completed');
                
                showToast(`Earned ${taskReward} TRM!`);
                
            } catch (error) {
                console.error('Error completing task:', error);
                button.textContent = 'OPEN';
                button.classList.remove('processing');
                showToast('Error completing task');
            }
        }

        // Load Leaderboard
        async function loadLeaderboard() {
            try {
                const usersSnapshot = await db.collection('users')
                    .orderBy('balance', 'desc')
                    .limit(25)
                    .get();
                
                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = '';
                
                usersSnapshot.forEach((doc, index) => {
                    const user = doc.data();
                    const leaderboardItem = createLeaderboardItem(user, index + 1);
                    leaderboardList.appendChild(leaderboardItem);
                });
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Create Leaderboard Item
        function createLeaderboardItem(user, rank) {
            const item = document.createElement('div');
            item.className = 'leaderboard-item';
            
            let levelClass = 'level-bronze';
            let level = 'Bronze';
            
            if (user.balance >= 50000) {
                level = 'Diamond';
                levelClass = 'level-diamond';
            } else if (user.balance >= 10000) {
                level = 'Gold';
                levelClass = 'level-gold';
            }
            
            const rankClass = rank <= 3 ? 'top-3' : '';
            
            item.innerHTML = `
                <span class="rank-number ${rankClass}">#${rank}</span>
                <img src="${user.photoUrl || 'https://via.placeholder.com/40'}" alt="${user.firstName}" class="user-avatar">
                <div class="user-info">
                    <div class="user-name">${user.firstName}</div>
                    <span class="level-badge ${levelClass}">${level}</span>
                </div>
                <div class="user-balance">${user.balance.toFixed(3)} TRM</div>
            `;
            
            return item;
        }

        // Show Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && isFarming) {
                // Resume farming if needed
                resumeFarming();
            }
        });
        
        // Save data before unload
        window.addEventListener('beforeunload', async () => {
            if (currentUser && userBalance) {
                try {
                    await db.collection('users').doc(currentUser.id.toString()).update({
                        balance: userBalance
                    });
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            }
        });
    </script>
</body>
</html>
