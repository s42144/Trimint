<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trimint - Telegram Mining App</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <!-- TON Connect -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <!-- Monetag Ads -->
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #4A6FFF;
            --secondary-color: #6C63FF;
            --accent-color: #FFD700;
            --background-color: #F8F9FA;
            --card-background: #FFFFFF;
            --text-primary: #212529;
            --text-secondary: #6C757D;
            --border-color: #E9ECEF;
            --success-color: #28A745;
            --danger-color: #DC3545;
            --warning-color: #FFC107;
            --info-color: #17A2B8;
            --dark-mode-bg: #1A1A2E;
            --dark-mode-card: #16213E;
            --dark-mode-text: #EAEAEA;
            --dark-mode-border: #2A2A4E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
            padding-bottom: 70px;
            position: relative;
            min-height: 100vh;
        }

        body.dark-mode {
            background-color: var(--dark-mode-bg);
            color: var(--dark-mode-text);
        }

        body.dark-mode .card {
            background-color: var(--dark-mode-card);
            border-color: var(--dark-mode-border);
        }

        body.dark-mode .bottom-nav {
            background-color: var(--dark-mode-card);
            border-top-color: var(--dark-mode-border);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primary-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }

        .loading-text {
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .referral-info {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            text-align: center;
            color: white;
            max-width: 80%;
        }

        /* Header */
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .theme-toggle:hover {
            transform: scale(1.2);
        }

        /* Balance Display */
        .balance-container {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .balance-info {
            flex: 1;
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
        }

        .coin-icon {
            width: 30px;
            height: 30px;
            margin-right: 8px;
        }

        .level-badge {
            background-color: var(--accent-color);
            color: #333;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        /* Card Component */
        .card {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 20px;
            margin: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        /* Home Section */
        .coin-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
        }

        .main-coin {
            width: 150px;
            height: 150px;
            margin-bottom: 20px;
            transition: transform 0.5s;
            cursor: pointer;
        }

        .main-coin:hover {
            transform: scale(1.05);
        }

        .main-coin.farming {
            animation: pulse 1s infinite;
        }

        .farming-button {
            background: linear-gradient(135deg, var(--success-color), #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .farming-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .farming-button:disabled {
            background: linear-gradient(135deg, var(--text-secondary), #adb5bd);
            cursor: not-allowed;
            box-shadow: none;
        }

        .farming-status {
            margin-top: 15px;
            text-align: center;
        }

        .countdown {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 5px;
        }

        .earning-animation {
            position: absolute;
            font-weight: bold;
            color: var(--success-color);
            pointer-events: none;
            animation: float-up 2s ease-out forwards;
            z-index: 10;
        }

        /* Tasks Section */
        .task-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            margin-right: 15px;
            object-fit: cover;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .task-reward {
            color: var(--success-color);
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .task-button {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-button.open {
            background-color: var(--primary-color);
            color: white;
        }

        .task-button.processing {
            background-color: var(--warning-color);
            color: white;
        }

        .task-button.completed {
            background-color: var(--success-color);
            color: white;
        }

        /* Leaderboard Section */
        .leaderboard-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .leaderboard-rank {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 600;
            margin-right: 15px;
        }

        .leaderboard-rank.top1 {
            background-color: var(--warning-color);
            color: white;
        }

        .leaderboard-rank.top2 {
            background-color: #C0C0C0;
            color: white;
        }

        .leaderboard-rank.top3 {
            background-color: #CD7F32;
            color: white;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .leaderboard-balance {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }

        /* Friends Section */
        .referral-link-container {
            background-color: var(--card-background);
            border-radius: 15px;
            padding: 20px;
            margin: 15px;
            border: 1px solid var(--border-color);
        }

        .referral-link {
            display: flex;
            align-items: center;
            background-color: var(--background-color);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
        }

        .referral-link-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .copy-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .copy-button:hover {
            background-color: var(--secondary-color);
        }

        .referral-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .referrals-list {
            margin-top: 20px;
        }

        .referral-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            background-color: var(--background-color);
        }

        .referral-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .referral-info {
            flex: 1;
        }

        .referral-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .referral-earnings {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Profile Section */
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-right: 20px;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .profile-id {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .profile-stat {
            background-color: var(--background-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .profile-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .profile-stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .wallet-section {
            margin-top: 20px;
        }

        .wallet-button {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wallet-button.connect {
            background-color: var(--primary-color);
            color: white;
        }

        .wallet-button.connected {
            background-color: var(--success-color);
            color: white;
        }

        .wallet-address {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--background-color);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .wallet-actions {
            display: flex;
            margin-top: 10px;
        }

        .wallet-action-button {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .copy-wallet-button {
            background-color: var(--info-color);
            color: white;
        }

        .disconnect-wallet-button {
            background-color: var(--danger-color);
            color: white;
        }

        .settings-section {
            margin-top: 20px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            background-color: var(--background-color);
        }

        .setting-label {
            font-weight: 600;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background-color: var(--text-secondary);
            border-radius: 13px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-switch.active {
            background-color: var(--primary-color);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--card-background);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item.home {
            transform: scale(1.2);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 12px;
        }

        /* Section Container */
        .section {
            display: none;
            padding-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        /* Animations */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes float-up {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .header-title {
                font-size: 18px;
            }

            .balance-amount {
                font-size: 20px;
            }

            .main-coin {
                width: 120px;
                height: 120px;
            }

            .farming-button {
                padding: 12px 25px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="Trimint" class="loading-logo">
        <div class="loading-text">Loading Trimint...</div>
        <div class="referral-info" id="referralInfo" style="display: none;">
            <div>You were referred by <span id="referralName"></span></div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-title">Trimint</div>
        <button class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <!-- Balance Display -->
    <div class="balance-container">
        <div class="balance-info">
            <div class="balance-label">Your Balance</div>
            <div class="balance-amount">
                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="coin-icon">
                <span id="userBalance">0</span> TRM
            </div>
        </div>
        <div class="level-badge" id="userLevel">Bronze</div>
    </div>

    <!-- Home Section -->
    <div class="section active" id="homeSection">
        <div class="card">
            <div class="coin-container">
                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM Coin" class="main-coin" id="mainCoin">
                <button class="farming-button" id="farmingButton">Start Farming</button>
                <div class="farming-status" id="farmingStatus" style="display: none;">
                    <div>Farming in progress...</div>
                    <div class="countdown" id="countdown">12:00:00</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks Section -->
    <div class="section" id="tasksSection">
        <div class="card">
            <h2 style="margin-bottom: 15px;">Tasks</h2>
            <div class="task-item">
                <img src="https://i.postimg.cc/3JzC6z1B/ads.png" alt="Watch Ads" class="task-icon">
                <div class="task-info">
                    <div class="task-name">Watch Ads</div>
                    <div class="task-reward">
                        <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" style="width: 16px; height: 16px; margin-right: 5px;">
                        +1 TRM
                    </div>
                </div>
                <button class="task-button open" id="watchAdsButton">OPEN</button>
            </div>
            <div id="tasksList"></div>
        </div>
    </div>

    <!-- Leaderboard Section -->
    <div class="section" id="leaderboardSection">
        <div class="card">
            <h2 style="margin-bottom: 15px;">Leaderboard</h2>
            <div class="leaderboard-list" id="leaderboardList">
                <!-- Leaderboard items will be populated here -->
            </div>
        </div>
    </div>

    <!-- Friends Section -->
    <div class="section" id="friendsSection">
        <div class="referral-link-container">
            <h2>Invite Friends</h2>
            <p style="margin: 10px 0; color: var(--text-secondary);">Invite friends and earn 5000 TRM for each referral!</p>
            <div class="referral-link">
                <div class="referral-link-text" id="referralLink">https://t.me/TrimintBot/mine?startapp=</div>
                <button class="copy-button" id="copyReferralButton">COPY</button>
            </div>
            <div class="referral-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalReferrals">0</div>
                    <div class="stat-label">Total Referrals</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="referralEarnings">0</div>
                    <div class="stat-label">Referral Earnings</div>
                </div>
            </div>
            <div class="referrals-list" id="referralsList">
                <!-- Referrals will be populated here -->
            </div>
        </div>
    </div>

    <!-- Profile Section -->
    <div class="section" id="profileSection">
        <div class="card">
            <div class="profile-header">
                <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="Profile" class="profile-avatar" id="profileAvatar">
                <div class="profile-info">
                    <div class="profile-name" id="profileName">Loading...</div>
                    <div class="profile-id" id="profileId">ID: Loading...</div>
                </div>
            </div>
            <div class="profile-stats">
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileLevel">Bronze</div>
                    <div class="profile-stat-label">Level</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileBalance">0</div>
                    <div class="profile-stat-label">Balance</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileFriends">0</div>
                    <div class="profile-stat-label">Friends</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="profileFarmingTime">0h</div>
                    <div class="profile-stat-label">Farming Time</div>
                </div>
            </div>
            <div class="wallet-section">
                <h3 style="margin-bottom: 10px;">TON Wallet</h3>
                <button class="wallet-button connect" id="walletButton">Connect TON Wallet</button>
                <div class="wallet-address" id="walletAddress" style="display: none;">
                    <span id="walletAddressText">Not connected</span>
                </div>
                <div class="wallet-actions" id="walletActions" style="display: none;">
                    <button class="wallet-action-button copy-wallet-button" id="copyWalletButton">Copy Address</button>
                    <button class="wallet-action-button disconnect-wallet-button" id="disconnectWalletButton">Disconnect</button>
                </div>
            </div>
            <div class="settings-section">
                <h3 style="margin-bottom: 10px;">Settings</h3>
                <div class="setting-item">
                    <div class="setting-label">Notifications</div>
                    <div class="toggle-switch active" id="notificationToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">Sound Effects</div>
                    <div class="toggle-switch active" id="soundToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">Auto-Farming</div>
                    <div class="toggle-switch" id="autoFarmingToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item home active" data-section="homeSection">
            <i class="fas fa-home nav-icon"></i>
            <div class="nav-label">Home</div>
        </div>
        <div class="nav-item" data-section="tasksSection">
            <i class="fas fa-tasks nav-icon"></i>
            <div class="nav-label">Tasks</div>
        </div>
        <div class="nav-item" data-section="leaderboardSection">
            <i class="fas fa-trophy nav-icon"></i>
            <div class="nav-label">Leaderboard</div>
        </div>
        <div class="nav-item" data-section="friendsSection">
            <i class="fas fa-user-friends nav-icon"></i>
            <div class="nav-label">Friends</div>
        </div>
        <div class="nav-item" data-section="profileSection">
            <i class="fas fa-user nav-icon"></i>
            <div class="nav-label">Profile</div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Initialize TON Connect
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://trimint.vercel.app/tonconnect-manifest.json',
            buttonRootId: null
        });

        // Global Variables
        let user = null;
        let userData = null;
        let farmingInterval = null;
        let farmingEndTime = null;
        let isFarming = false;
        let tasks = [];
        let leaderboard = [];
        let referrals = [];

        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const referralInfo = document.getElementById('referralInfo');
        const referralName = document.getElementById('referralName');
        const themeToggle = document.getElementById('themeToggle');
        const userBalance = document.getElementById('userBalance');
        const userLevel = document.getElementById('userLevel');
        const mainCoin = document.getElementById('mainCoin');
        const farmingButton = document.getElementById('farmingButton');
        const farmingStatus = document.getElementById('farmingStatus');
        const countdown = document.getElementById('countdown');
        const watchAdsButton = document.getElementById('watchAdsButton');
        const tasksList = document.getElementById('tasksList');
        const leaderboardList = document.getElementById('leaderboardList');
        const referralLink = document.getElementById('referralLink');
        const copyReferralButton = document.getElementById('copyReferralButton');
        const totalReferrals = document.getElementById('totalReferrals');
        const referralEarnings = document.getElementById('referralEarnings');
        const referralsList = document.getElementById('referralsList');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileId = document.getElementById('profileId');
        const profileLevel = document.getElementById('profileLevel');
        const profileBalance = document.getElementById('profileBalance');
        const profileFriends = document.getElementById('profileFriends');
        const profileFarmingTime = document.getElementById('profileFarmingTime');
        const walletButton = document.getElementById('walletButton');
        const walletAddress = document.getElementById('walletAddress');
        const walletAddressText = document.getElementById('walletAddressText');
        const walletActions = document.getElementById('walletActions');
        const copyWalletButton = document.getElementById('copyWalletButton');
        const disconnectWalletButton = document.getElementById('disconnectWalletButton');
        const notificationToggle = document.getElementById('notificationToggle');
        const soundToggle = document.getElementById('soundToggle');
        const autoFarmingToggle = document.getElementById('autoFarmingToggle');
        const toast = document.getElementById('toast');

        // Initialize App
        async function initApp() {
            // Get user data from Telegram
            user = tg.initDataUnsafe.user;
            
            if (!user) {
                // For testing outside Telegram
                user = {
                    id: 123456789,
                    first_name: "Test",
                    last_name: "User",
                    username: "testuser",
                    photo_url: "https://i.postimg.cc/fTQktNmX/maincoin.png"
                };
            }

            // Check for referral
            const urlParams = new URLSearchParams(window.location.search);
            const referrerId = urlParams.get('startapp');
            
            if (referrerId && referrerId !== user.id.toString()) {
                // Process referral
                await processReferral(referrerId);
                
                // Show referral info on loading screen
                const referrerDoc = await db.collection('users').doc(referrerId).get();
                if (referrerDoc.exists) {
                    const referrerData = referrerDoc.data();
                    referralName.textContent = referrerData.firstName || referrerData.username || "Someone";
                    referralInfo.style.display = "block";
                }
            }

            // Get or create user document
            const userDoc = await db.collection('users').doc(user.id.toString()).get();
            
            if (userDoc.exists) {
                userData = userDoc.data();
                
                // Check if farming was in progress
                if (userData.farmingEndTime && userData.farmingEndTime > Date.now()) {
                    startFarming(true, userData.farmingEndTime);
                }
            } else {
                // Create new user document
                userData = {
                    id: user.id,
                    firstName: user.first_name,
                    lastName: user.last_name || "",
                    username: user.username || "",
                    photoUrl: user.photo_url || "https://i.postimg.cc/fTQktNmX/maincoin.png",
                    balance: 0,
                    level: "Bronze",
                    totalFriends: 0,
                    totalFarmingTime: 0,
                    farmingEndTime: null,
                    walletAddress: null,
                    referrals: [],
                    completedTasks: [],
                    notifications: true,
                    soundEffects: true,
                    autoFarming: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(user.id.toString()).set(userData);
            }

            // Update UI with user data
            updateUI();
            
            // Load tasks
            await loadTasks();
            
            // Load leaderboard
            await loadLeaderboard();
            
            // Load referrals
            await loadReferrals();
            
            // Hide loading screen
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, 2000);
        }

        // Process Referral
        async function processReferral(referrerId) {
            const referrerDoc = await db.collection('users').doc(referrerId).get();
            
            if (referrerDoc.exists) {
                const referrerData = referrerDoc.data();
                
                // Check if user is already in referrer's list
                if (!referrerData.referrals.includes(user.id.toString())) {
                    // Update referrer
                    await db.collection('users').doc(referrerId).update({
                        referrals: firebase.firestore.FieldValue.arrayUnion(user.id.toString()),
                        balance: firebase.firestore.FieldValue.increment(5000),
                        totalFriends: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    // Give referral bonus to new user
                    await db.collection('users').doc(user.id.toString()).update({
                        balance: firebase.firestore.FieldValue.increment(5000)
                    });
                    
                    showToast("Referral bonus: 5000 TRM!");
                }
            }
        }

        // Update UI
        function updateUI() {
            // Update balance and level
            userBalance.textContent = userData.balance.toFixed(2);
            userLevel.textContent = userData.level;
            
            // Update profile
            profileAvatar.src = userData.photoUrl;
            profileName.textContent = `${userData.firstName} ${userData.lastName}`.trim();
            profileId.textContent = `ID: ${userData.id}`;
            profileLevel.textContent = userData.level;
            profileBalance.textContent = userData.balance.toFixed(2);
            profileFriends.textContent = userData.totalFriends;
            profileFarmingTime.textContent = formatTime(userData.totalFarmingTime);
            
            // Update referral link
            referralLink.textContent = `https://t.me/TrimintBot/mine?startapp=${userData.id}`;
            
            // Update settings
            notificationToggle.classList.toggle('active', userData.notifications);
            soundToggle.classList.toggle('active', userData.soundEffects);
            autoFarmingToggle.classList.toggle('active', userData.autoFarming);
            
            // Update wallet button
            if (userData.walletAddress) {
                walletButton.textContent = "Connected";
                walletButton.classList.remove('connect');
                walletButton.classList.add('connected');
                walletAddress.style.display = "flex";
                walletAddressText.textContent = formatAddress(userData.walletAddress);
                walletActions.style.display = "flex";
            }
        }

        // Load Tasks
        async function loadTasks() {
            tasksList.innerHTML = '';
            
            const tasksSnapshot = await db.collection('tasks').orderBy('order').get();
            tasks = [];
            
            tasksSnapshot.forEach(doc => {
                const task = doc.data();
                task.id = doc.id;
                tasks.push(task);
                
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                
                let buttonClass = 'open';
                let buttonText = 'OPEN';
                
                if (userData.completedTasks && userData.completedTasks.includes(task.id)) {
                    buttonClass = 'completed';
                    buttonText = 'COMPLETED';
                }
                
                taskItem.innerHTML = `
                    <img src="${task.icon}" alt="${task.name}" class="task-icon">
                    <div class="task-info">
                        <div class="task-name">${task.name}</div>
                        <div class="task-reward">
                            <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" style="width: 16px; height: 16px; margin-right: 5px;">
                            +${task.reward} TRM
                        </div>
                    </div>
                    <button class="task-button ${buttonClass}" data-task-id="${task.id}" data-task-link="${task.link}" data-task-reward="${task.reward}">${buttonText}</button>
                `;
                
                tasksList.appendChild(taskItem);
            });
            
            // Add event listeners to task buttons
            document.querySelectorAll('.task-button').forEach(button => {
                button.addEventListener('click', handleTaskClick);
            });
        }

        // Handle Task Click
        async function handleTaskClick(e) {
            const button = e.target;
            const taskId = button.getAttribute('data-task-id');
            const taskLink = button.getAttribute('data-task-link');
            const taskReward = parseFloat(button.getAttribute('data-task-reward'));
            
            if (button.classList.contains('completed')) {
                // Open link even if completed
                window.open(taskLink, '_blank');
                return;
            }
            
            if (button.classList.contains('processing')) {
                showToast("Task is being processed...");
                return;
            }
            
            // Change button to processing
            button.classList.remove('open');
            button.classList.add('processing');
            button.textContent = 'PROCESSING';
            
            // Open task link
            window.open(taskLink, '_blank');
            
            // Simulate task completion after 10 seconds
            setTimeout(async () => {
                // Update button to completed
                button.classList.remove('processing');
                button.classList.add('completed');
                button.textContent = 'COMPLETED';
                
                // Add reward to user balance
                await db.collection('users').doc(user.id.toString()).update({
                    balance: firebase.firestore.FieldValue.increment(taskReward),
                    completedTasks: firebase.firestore.FieldValue.arrayUnion(taskId)
                });
                
                // Update local data
                userData.balance += taskReward;
                if (!userData.completedTasks) userData.completedTasks = [];
                userData.completedTasks.push(taskId);
                
                // Update UI
                updateUI();
                
                // Show reward animation
                showRewardAnimation(taskReward);
                
                showToast(`Task completed! +${taskReward} TRM`);
            }, 10000);
        }

        // Load Leaderboard
        async function loadLeaderboard() {
            leaderboardList.innerHTML = '';
            
            const usersSnapshot = await db.collection('users')
                .orderBy('balance', 'desc')
                .limit(25)
                .get();
            
            leaderboard = [];
            let rank = 1;
            
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                user.id = doc.id;
                user.rank = rank++;
                leaderboard.push(user);
                
                const leaderboardItem = document.createElement('div');
                leaderboardItem.className = 'leaderboard-item';
                
                let rankClass = '';
                if (user.rank === 1) rankClass = 'top1';
                else if (user.rank === 2) rankClass = 'top2';
                else if (user.rank === 3) rankClass = 'top3';
                
                leaderboardItem.innerHTML = `
                    <div class="leaderboard-rank ${rankClass}">${user.rank}</div>
                    <img src="${user.photoUrl}" alt="${user.firstName}" class="leaderboard-avatar">
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${user.firstName} ${user.lastName}`.trim()}</div>
                        <div class="leaderboard-balance">
                            <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" style="width: 16px; height: 16px; margin-right: 5px;">
                            ${user.balance.toFixed(2)} TRM
                        </div>
                    </div>
                `;
                
                leaderboardList.appendChild(leaderboardItem);
            });
        }

        // Load Referrals
        async function loadReferrals() {
            referralsList.innerHTML = '';
            
            if (!userData.referrals || userData.referrals.length === 0) {
                referralsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No referrals yet</p>';
                totalReferrals.textContent = '0';
                referralEarnings.textContent = '0';
                return;
            }
            
            let referralEarningsAmount = 0;
            
            for (const referralId of userData.referrals) {
                const referralDoc = await db.collection('users').doc(referralId).get();
                
                if (referralDoc.exists) {
                    const referral = referralDoc.data();
                    referral.id = referralId;
                    
                    referralEarningsAmount += 5000;
                    
                    const referralItem = document.createElement('div');
                    referralItem.className = 'referral-item';
                    
                    referralItem.innerHTML = `
                        <img src="${referral.photoUrl}" alt="${referral.firstName}" class="referral-avatar">
                        <div class="referral-info">
                            <div class="referral-name">${referral.firstName} ${referral.lastName}`.trim()}</div>
                            <div class="referral-earnings">Balance: ${referral.balance.toFixed(2)} TRM</div>
                        </div>
                    `;
                    
                    referralsList.appendChild(referralItem);
                }
            }
            
            totalReferrals.textContent = userData.referrals.length;
            referralEarnings.textContent = referralEarningsAmount.toFixed(0);
        }

        // Start Farming
        function startFarming(resume = false, endTime = null) {
            if (isFarming && !resume) return;
            
            isFarming = true;
            
            if (!resume) {
                farmingEndTime = Date.now() + (12 * 60 * 60 * 1000); // 12 hours from now
            } else {
                farmingEndTime = endTime;
            }
            
            // Update UI
            farmingButton.textContent = "Farming...";
            farmingButton.disabled = true;
            farmingStatus.style.display = "block";
            mainCoin.classList.add('farming');
            
            // Save farming end time to database
            db.collection('users').doc(user.id.toString()).update({
                farmingEndTime: farmingEndTime
            });
            
            // Start farming interval
            farmingInterval = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, farmingEndTime - now);
                
                if (remaining > 0) {
                    // Add 0.001 TRM every second
                    db.collection('users').doc(user.id.toString()).update({
                        balance: firebase.firestore.FieldValue.increment(0.001),
                        totalFarmingTime: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    // Update local data
                    userData.balance += 0.001;
                    userData.totalFarmingTime += 1;
                    
                    // Update UI
                    updateUI();
                    updateCountdown(remaining);
                    
                    // Show earning animation
                    showEarningAnimation(0.001);
                } else {
                    // Farming completed
                    stopFarming();
                    
                    // Check for auto-farming
                    if (userData.autoFarming) {
                        setTimeout(() => {
                            startFarming();
                        }, 1000);
                    }
                }
            }, 1000);
        }

        // Stop Farming
        function stopFarming() {
            if (!isFarming) return;
            
            isFarming = false;
            
            // Clear interval
            if (farmingInterval) {
                clearInterval(farmingInterval);
                farmingInterval = null;
            }
            
            // Update UI
            farmingButton.textContent = "Start Farming";
            farmingButton.disabled = false;
            farmingStatus.style.display = "none";
            mainCoin.classList.remove('farming');
            
            // Clear farming end time from database
            db.collection('users').doc(user.id.toString()).update({
                farmingEndTime: null
            });
            
            showToast("Farming completed! You can start again.");
        }

        // Update Countdown
        function updateCountdown(remaining) {
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            countdown.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Show Earning Animation
        function showEarningAnimation(amount) {
            const animation = document.createElement('div');
            animation.className = 'earning-animation';
            animation.textContent = `+${amount.toFixed(3)} TRM`;
            
            // Position the animation near the coin
            const coinRect = mainCoin.getBoundingClientRect();
            animation.style.left = `${coinRect.left + coinRect.width / 2}px`;
            animation.style.top = `${coinRect.top}px`;
            
            document.body.appendChild(animation);
            
            // Remove animation after it completes
            setTimeout(() => {
                document.body.removeChild(animation);
            }, 2000);
        }

        // Show Reward Animation
        function showRewardAnimation(amount) {
            const animation = document.createElement('div');
            animation.className = 'earning-animation';
            animation.textContent = `+${amount} TRM`;
            animation.style.fontSize = '20px';
            animation.style.color = 'var(--success-color)';
            
            // Position the animation in the center of the screen
            animation.style.left = '50%';
            animation.style.top = '50%';
            animation.style.transform = 'translate(-50%, -50%)';
            
            document.body.appendChild(animation);
            
            // Remove animation after it completes
            setTimeout(() => {
                document.body.removeChild(animation);
            }, 2000);
        }

        // Format Address
        function formatAddress(address) {
            if (!address) return '';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        // Format Time
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }

        // Show Toast
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Update User Level
        function updateUserLevel() {
            let newLevel = 'Bronze';
            
            if (userData.balance >= 50000) {
                newLevel = 'Diamond';
            } else if (userData.balance >= 10000) {
                newLevel = 'Gold';
            }
            
            if (newLevel !== userData.level) {
                userData.level = newLevel;
                
                db.collection('users').doc(user.id.toString()).update({
                    level: newLevel
                });
                
                showToast(`Congratulations! You've reached ${newLevel} level!`);
            }
        }

        // Event Listeners
        farmingButton.addEventListener('click', () => {
            if (!isFarming) {
                startFarming();
            }
        });

        watchAdsButton.addEventListener('click', () => {
            // Show Monetag Ad
            if (window.show_10290264) {
                window.show_10290264();
                
                // Add reward after ad is watched
                setTimeout(() => {
                    db.collection('users').doc(user.id.toString()).update({
                        balance: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    userData.balance += 1;
                    updateUI();
                    showRewardAnimation(1);
                    showToast("Ad watched! +1 TRM");
                }, 5000);
            } else {
                showToast("Ad loading failed. Please try again.");
            }
        });

        copyReferralButton.addEventListener('click', () => {
            navigator.clipboard.writeText(referralLink.textContent);
            showToast("Referral link copied!");
        });

        walletButton.addEventListener('click', async () => {
            if (!userData.walletAddress) {
                try {
                    const wallet = await tonConnectUI.connectWallet();
                    const address = wallet.account.address;
                    
                    // Save wallet address
                    await db.collection('users').doc(user.id.toString()).update({
                        walletAddress: address
                    });
                    
                    userData.walletAddress = address;
                    updateUI();
                    
                    showToast("Wallet connected successfully!");
                } catch (error) {
                    console.error("Wallet connection error:", error);
                    showToast("Failed to connect wallet. Please try again.");
                }
            }
        });

        copyWalletButton.addEventListener('click', () => {
            navigator.clipboard.writeText(userData.walletAddress);
            showToast("Wallet address copied!");
        });

        disconnectWalletButton.addEventListener('click', async () => {
            try {
                await tonConnectUI.disconnect();
                
                // Remove wallet address
                await db.collection('users').doc(user.id.toString()).update({
                    walletAddress: null
                });
                
                userData.walletAddress = null;
                updateUI();
                
                showToast("Wallet disconnected!");
            } catch (error) {
                console.error("Wallet disconnection error:", error);
                showToast("Failed to disconnect wallet. Please try again.");
            }
        });

        notificationToggle.addEventListener('click', () => {
            userData.notifications = !userData.notifications;
            notificationToggle.classList.toggle('active', userData.notifications);
            
            db.collection('users').doc(user.id.toString()).update({
                notifications: userData.notifications
            });
            
            showToast(`Notifications ${userData.notifications ? 'enabled' : 'disabled'}`);
        });

        soundToggle.addEventListener('click', () => {
            userData.soundEffects = !userData.soundEffects;
            soundToggle.classList.toggle('active', userData.soundEffects);
            
            db.collection('users').doc(user.id.toString()).update({
                soundEffects: userData.soundEffects
            });
            
            showToast(`Sound effects ${userData.soundEffects ? 'enabled' : 'disabled'}`);
        });

        autoFarmingToggle.addEventListener('click', () => {
            userData.autoFarming = !userData.autoFarming;
            autoFarmingToggle.classList.toggle('active', userData.autoFarming);
            
            db.collection('users').doc(user.id.toString()).update({
                autoFarming: userData.autoFarming
            });
            
            showToast(`Auto-farming ${userData.autoFarming ? 'enabled' : 'disabled'}`);
        });

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            themeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            
            localStorage.setItem('darkMode', isDarkMode);
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                // Remove active class from all items and sections
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Add active class to clicked item and corresponding section
                item.classList.add('active');
                const sectionId = item.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');
                
                // Refresh data when switching to certain sections
                if (sectionId === 'leaderboardSection') {
                    loadLeaderboard();
                } else if (sectionId === 'friendsSection') {
                    loadReferrals();
                } else if (sectionId === 'tasksSection') {
                    loadTasks();
                }
            });
        });

        // Check for saved theme preference
        const savedDarkMode = localStorage.getItem('darkMode') === 'true';
        if (savedDarkMode) {
            document.body.classList.add('dark-mode');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }

        // Update user level periodically
        setInterval(() => {
            updateUserLevel();
        }, 5000);

        // Initialize the app
        initApp();
    </script>
</body>
</html>
