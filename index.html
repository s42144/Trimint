<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trimint - Telegram Mini App</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Monetag Ads -->
    <script src='//libtl.com/sdk.js' data-zone='10290264' data-sdk='show_10290264'></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #b4b4b4;
            --accent: #667eea;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.light-mode {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #666666;
            --accent: #667eea;
            --border: rgba(0, 0, 0, 0.1);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            overflow-x: hidden;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .referral-welcome {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 15px;
            text-align: center;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .balance-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: var(--bg-card);
            border-radius: 25px;
            box-shadow: var(--shadow);
        }

        .coin-icon {
            width: 24px;
            height: 24px;
        }

        .balance-amount {
            font-size: 18px;
            font-weight: bold;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent);
        }

        .level-badge {
            padding: 5px 15px;
            background: var(--primary-gradient);
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 80px;
            background: var(--bg-primary);
        }

        .section {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Section */
        .home-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }

        .coin-container {
            position: relative;
            margin: 30px 0;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .main-coin {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            transition: var(--transition);
        }

        .main-coin:hover {
            transform: scale(1.05);
            box-shadow: 0 25px 70px rgba(102, 126, 234, 0.6);
        }

        .main-coin.farming {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .main-coin img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
        }

        .farming-info {
            text-align: center;
            margin-top: 20px;
        }

        .farming-timer {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent);
            margin: 10px 0;
        }

        .farming-rate {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .farming-button {
            padding: 15px 40px;
            background: var(--success-gradient);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.3);
        }

        .farming-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(79, 172, 254, 0.4);
        }

        .farming-button:disabled {
            background: var(--warning-gradient);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Tasks Section */
        .tasks-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .watch-ads-container {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .watch-ads-button {
            width: 100%;
            padding: 15px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .watch-ads-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .task-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .task-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .task-reward {
            color: var(--accent);
            font-size: 14px;
        }

        .task-description {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .task-button {
            padding: 10px 20px;
            background: var(--success-gradient);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .task-button:hover {
            transform: translateY(-2px);
        }

        .task-button.processing {
            background: var(--warning-gradient);
            cursor: wait;
        }

        .task-button.completed {
            background: var(--secondary-gradient);
        }

        /* Profile Section */
        .profile-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 15px;
            border: 3px solid var(--accent);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .profile-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-id {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 5px;
        }

        .wallet-section {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .wallet-title {
            font-weight: bold;
            font-size: 18px;
        }

        .wallet-address {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin-bottom: 10px;
            display: none;
        }

        .wallet-address.connected {
            display: block;
        }

        .wallet-buttons {
            display: flex;
            gap: 10px;
        }

        .wallet-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .connect-button {
            background: var(--primary-gradient);
            color: white;
        }

        .disconnect-button {
            background: var(--secondary-gradient);
            color: white;
        }

        .copy-button {
            background: var(--success-gradient);
            color: white;
        }

        .settings-section {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .settings-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-label {
            color: var(--text-secondary);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: var(--bg-secondary);
            border-radius: 25px;
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-switch.active {
            background: var(--accent);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2.5px;
            left: 2.5px;
            transition: var(--transition);
        }

        .toggle-switch.active::after {
            left: 27.5px;
        }

        /* Leaderboard Section */
        .leaderboard-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .leaderboard-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .leaderboard-item {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
        }

        .rank-badge {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .rank-badge.gold {
            background: var(--warning-gradient);
        }

        .rank-badge.silver {
            background: linear-gradient(135deg, #c0c0c0 0%, #808080 100%);
        }

        .rank-badge.bronze {
            background: linear-gradient(135deg, #cd7f32 0%, #8b4513 100%);
        }

        .leaderboard-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .leaderboard-level {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .leaderboard-balance {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            color: var(--accent);
        }

        /* Friends Section */
        .friends-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .friends-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .referral-section {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .referral-link {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
        }

        .copy-referral-button {
            width: 100%;
            padding: 15px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .copy-referral-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .referral-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent);
        }

        .stat-text {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .referrals-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .referral-item {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
        }

        .referral-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .referral-info {
            flex: 1;
        }

        .referral-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .referral-details {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .referral-earned {
            color: var(--accent);
            font-weight: bold;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 10px 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .nav-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 5px;
        }

        .nav-button.active {
            color: var(--accent);
        }

        .nav-button:hover {
            transform: translateY(-2px);
        }

        .nav-button.home {
            width: 60px;
            height: 60px;
            background: var(--primary-gradient);
            border-radius: 50%;
            color: white;
            font-size: 14px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid #4facfe;
        }

        .toast.error {
            border-left: 4px solid #f5576c;
        }

        .toast.info {
            border-left: 4px solid #667eea;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .header {
                padding: 10px 15px;
            }

            .balance-amount {
                font-size: 16px;
            }

            .main-coin {
                width: 150px;
                height: 150px;
            }

            .main-coin img {
                width: 120px;
                height: 120px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-button {
                font-size: 10px;
            }

            .nav-icon {
                width: 20px;
                height: 20px;
            }
        }

        /* Animations */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .coin-animation {
            position: absolute;
            color: var(--accent);
            font-weight: bold;
            font-size: 18px;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.5);
                opacity: 0;
            }
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <div class="referral-welcome" id="referralWelcome" style="display: none;">
            <h3>Welcome! You were invited by</h3>
            <p id="referrerName" style="font-size: 20px; font-weight: bold; margin-top: 10px;"></p>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="balance-container">
            <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" class="coin-icon">
            <span class="balance-amount" id="balance">0 TRM</span>
        </div>
        <div class="user-info">
            <img src="https://via.placeholder.com/40" alt="User" class="user-avatar" id="userAvatar">
            <span class="level-badge" id="userLevel">Bronze</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Home Section -->
        <section class="section active" id="homeSection">
            <div class="home-container">
                <div class="coin-container">
                    <div class="main-coin" id="mainCoin">
                        <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM Coin">
                    </div>
                </div>
                <div class="farming-info">
                    <div class="farming-timer" id="farmingTimer">12:00:00</div>
                    <div class="farming-rate">0.001 TRM per second</div>
                    <button class="farming-button" id="farmingButton">Start Farming</button>
                </div>
            </div>
        </section>

        <!-- Tasks Section -->
        <section class="section" id="tasksSection">
            <div class="tasks-header">
                <h2>Tasks</h2>
            </div>
            <div class="watch-ads-container">
                <h3>Watch Ads</h3>
                <p>Earn 1 TRM token for each ad watched</p>
                <button class="watch-ads-button" id="watchAdsButton">Watch Ad</button>
            </div>
            <div class="task-list" id="taskList">
                <!-- Tasks will be loaded from Firebase -->
            </div>
        </section>

        <!-- Profile Section -->
        <section class="section" id="profileSection">
            <div class="profile-container">
                <div class="profile-header">
                    <img src="https://via.placeholder.com/100" alt="Profile" class="profile-avatar" id="profileAvatar">
                    <h2 class="profile-name" id="profileName">User</h2>
                    <p class="profile-id" id="profileId">ID: 123456789</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalFriends">0</div>
                        <div class="stat-label">Total Friends</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalEarned">0</div>
                        <div class="stat-label">Total Earned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="farmingTime">0h</div>
                        <div class="stat-label">Farming Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="tasksCompleted">0</div>
                        <div class="stat-label">Tasks Done</div>
                    </div>
                </div>

                <div class="wallet-section">
                    <div class="wallet-header">
                        <h3 class="wallet-title">TON Wallet</h3>
                    </div>
                    <button class="wallet-button connect-button" id="connectWalletButton">Connect TON Wallet</button>
                    <div class="wallet-address" id="walletAddress"></div>
                    <div class="wallet-buttons" id="walletButtons" style="display: none;">
                        <button class="wallet-button copy-button" id="copyAddressButton">Copy</button>
                        <button class="wallet-button disconnect-button" id="disconnectButton">Disconnect</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">Settings</h3>
                    <div class="setting-item">
                        <span class="setting-label">Dark Mode</span>
                        <div class="toggle-switch active" id="darkModeToggle"></div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Notifications</span>
                        <div class="toggle-switch active" id="notificationsToggle"></div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Sound Effects</span>
                        <div class="toggle-switch" id="soundToggle"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Leaderboard Section -->
        <section class="section" id="leaderboardSection">
            <div class="leaderboard-container">
                <div class="leaderboard-header">
                    <h2>Leaderboard</h2>
                    <p>Top 25 Players</p>
                </div>
                <div class="leaderboard-list" id="leaderboardList">
                    <!-- Leaderboard will be loaded from Firebase -->
                </div>
            </div>
        </section>

        <!-- Friends Section -->
        <section class="section" id="friendsSection">
            <div class="friends-container">
                <div class="friends-header">
                    <h2>Friends</h2>
                    <p>Invite friends and earn rewards</p>
                </div>
                
                <div class="referral-section">
                    <h3>Your Referral Link</h3>
                    <div class="referral-link" id="referralLink">https://t.me/TrimintBot/open?startapp=123456789</div>
                    <button class="copy-referral-button" id="copyReferralButton">Copy Referral Link</button>
                    
                    <div class="referral-stats">
                        <div class="stat-box">
                            <div class="stat-number" id="referralCount">0</div>
                            <div class="stat-text">Total Referrals</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="referralEarned">0</div>
                            <div class="stat-text">TRM Earned</div>
                        </div>
                    </div>
                </div>

                <div class="referrals-list" id="referralsList">
                    <!-- Referrals will be loaded from Firebase -->
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-button" data-section="tasksSection">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 100 4h2a2 2 0 100 4h2a1 1 0 100 2 2 2 0 01-2 2H4a2 2 0 01-2-2V7a2 2 0 012-2z" clip-rule="evenodd"></path>
            </svg>
            <span>Tasks</span>
        </button>
        
        <button class="nav-button home active" data-section="homeSection">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
            </svg>
            <span>Home</span>
        </button>
        
        <button class="nav-button" data-section="profileSection">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
            </svg>
            <span>Profile</span>
        </button>
        
        <button class="nav-button" data-section="leaderboardSection">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 100 4h2a2 2 0 100 4h2a1 1 0 100 2 2 2 0 01-2 2H4a2 2 0 01-2-2V7a2 2 0 012-2z" clip-rule="evenodd"></path>
            </svg>
            <span>Leaderboard</span>
        </button>
        
        <button class="nav-button" data-section="friendsSection">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
            </svg>
            <span>Friends</span>
        </button>
    </nav>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAt9PRbvok0g5XL4187btrPvGx6VjfurJU",
            authDomain: "msc-by-shawon.firebaseapp.com",
            projectId: "msc-by-shawon",
            storageBucket: "msc-by-shawon.firebasestorage.app",
            messagingSenderId: "432753389120",
            appId: "1:432753389120:web:dcbb46ca39408a405579a5",
            measurementId: "G-8LHGLJSSEE"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // Initialize Telegram Web App
        let tg = null;
        let user = null;
        let userData = null;

        // App State
        let appState = {
            balance: 0,
            level: 'Bronze',
            isFarming: false,
            farmingEndTime: null,
            farmingStartTime: null,
            walletConnected: false,
            walletAddress: null,
            referrals: [],
            tasksCompleted: [],
            soundEnabled: false,
            notificationsEnabled: true
        };

        // Initialize App
        async function initApp() {
            try {
                // Initialize Telegram Web App
                if (window.Telegram) {
                    tg = window.Telegram.WebApp;
                    tg.ready();
                    tg.expand();
                    
                    user = tg.initDataUnsafe?.user;
                    if (user) {
                        await loadUserData();
                        setupUserProfile();
                        checkReferral();
                    }
                } else {
                    // Fallback for testing
                    user = {
                        id: 123456789,
                        first_name: 'Test User',
                        last_name: '',
                        username: 'testuser',
                        photo_url: 'https://via.placeholder.com/100'
                    };
                    await loadUserData();
                    setupUserProfile();
                }

                // Setup event listeners
                setupEventListeners();
                
                // Load initial data
                await loadTasks();
                await loadLeaderboard();
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                }, 1000);

            } catch (error) {
                console.error('App initialization error:', error);
                showToast('Error initializing app', 'error');
            }
        }

        // Load user data from Firebase
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(user.id.toString()).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    appState = { ...appState, ...userData };
                } else {
                    // Create new user
                    userData = {
                        telegramId: user.id,
                        firstName: user.first_name,
                        lastName: user.last_name || '',
                        username: user.username || '',
                        photoUrl: user.photo_url || '',
                        balance: 0,
                        level: 'Bronze',
                        isFarming: false,
                        farmingEndTime: null,
                        farmingStartTime: null,
                        walletConnected: false,
                        walletAddress: null,
                        referrals: [],
                        tasksCompleted: [],
                        totalFriendsInvited: 0,
                        totalEarned: 0,
                        farmingTime: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('users').doc(user.id.toString()).set(userData);
                    appState = { ...appState, ...userData };
                }
                
                updateUI();
                checkFarmingStatus();
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Update UI with current state
        function updateUI() {
            // Update balance
            document.getElementById('balance').textContent = `${appState.balance.toLocaleString()} TRM`;
            
            // Update level
            updateLevel();
            document.getElementById('userLevel').textContent = appState.level;
            
            // Update farming button
            updateFarmingButton();
            
            // Update profile stats
            document.getElementById('totalFriends').textContent = appState.totalFriendsInvited || 0;
            document.getElementById('totalEarned').textContent = (appState.totalEarned || 0).toLocaleString();
            document.getElementById('farmingTime').textContent = `${Math.floor((appState.farmingTime || 0) / 3600)}h`;
            document.getElementById('tasksCompleted').textContent = (appState.tasksCompleted || []).length;
            
            // Update wallet section
            updateWalletSection();
            
            // Update referral section
            updateReferralSection();
        }

        // Update user level based on balance
        function updateLevel() {
            if (appState.balance < 10000) {
                appState.level = 'Bronze';
            } else if (appState.balance < 50000) {
                appState.level = 'Gold';
            } else {
                appState.level = 'Diamond';
            }
        }

        // Setup user profile
        function setupUserProfile() {
            const avatar = user.photo_url || 'https://via.placeholder.com/100';
            const name = `${user.first_name} ${user.last_name || ''}`.trim() || user.username || 'User';
            
            document.getElementById('userAvatar').src = avatar;
            document.getElementById('profileAvatar').src = avatar;
            document.getElementById('profileName').textContent = name;
            document.getElementById('profileId').textContent = `ID: ${user.id}`;
        }

        // Check for referral
        function checkReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const referrerId = urlParams.get('startapp');
            
            if (referrerId && referrerId !== user.id.toString()) {
                processReferral(referrerId);
            }
        }

        // Process referral
        async function processReferral(referrerId) {
            try {
                const referrerDoc = await db.collection('users').doc(referrerId).get();
                
                if (referrerDoc.exists) {
                    const referrerData = referrerDoc.data();
                    
                    // Show referrer name
                    document.getElementById('referrerName').textContent = 
                        `${referrerData.firstName} ${referrerData.lastName || ''}`.trim() || referrerData.username || 'Unknown';
                    document.getElementById('referralWelcome').style.display = 'block';
                    
                    // Add referral to current user
                    appState.referrerId = referrerId;
                    
                    // Add 5000 TRM to referrer
                    await db.collection('users').doc(referrerId).update({
                        balance: firebase.firestore.FieldValue.increment(5000),
                        totalEarned: firebase.firestore.FieldValue.increment(5000),
                        totalFriendsInvited: firebase.firestore.FieldValue.increment(1),
                        referrals: firebase.firestore.FieldValue.arrayUnion({
                            telegramId: user.id,
                            firstName: user.first_name,
                            lastName: user.last_name || '',
                            username: user.username || '',
                            photoUrl: user.photo_url || '',
                            joinedAt: new Date().toISOString(),
                            earned: 5000
                        })
                    });
                    
                    // Save current user data
                    await saveUserData();
                    
                    // Load referrals for current user
                    loadReferrals();
                    
                    showToast('Welcome! You were successfully referred.', 'success');
                }
            } catch (error) {
                console.error('Error processing referral:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', function() {
                    const sectionId = this.dataset.section;
                    switchSection(sectionId);
                });
            });

            // Farming
            document.getElementById('mainCoin').addEventListener('click', startFarming);
            document.getElementById('farmingButton').addEventListener('click', startFarming);

            // Wallet
            document.getElementById('connectWalletButton').addEventListener('click', connectWallet);
            document.getElementById('disconnectButton').addEventListener('click', disconnectWallet);
            document.getElementById('copyAddressButton').addEventListener('click', copyWalletAddress);

            // Settings
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            document.getElementById('notificationsToggle').addEventListener('click', toggleNotifications);
            document.getElementById('soundToggle').addEventListener('click', toggleSound);

            // Referral
            document.getElementById('copyReferralButton').addEventListener('click', copyReferralLink);

            // Tasks
            document.getElementById('watchAdsButton').addEventListener('click', watchAd);
        }

        // Switch section
        function switchSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Update navigation
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');

            // Load section-specific data
            if (sectionId === 'leaderboardSection') {
                loadLeaderboard();
            } else if (sectionId === 'friendsSection') {
                loadReferrals();
            } else if (sectionId === 'tasksSection') {
                loadTasks();
            }
        }

        // Farming functions
        async function startFarming() {
            if (appState.isFarming) {
                showToast('Farming is already in progress!', 'info');
                return;
            }

            try {
                const startTime = Date.now();
                const endTime = startTime + (12 * 60 * 60 * 1000); // 12 hours

                appState.isFarming = true;
                appState.farmingStartTime = startTime;
                appState.farmingEndTime = endTime;

                await saveUserData();
                updateFarmingButton();
                startFarmingAnimation();

                showToast('Farming started! Earn 0.001 TRM per second for 12 hours.', 'success');

            } catch (error) {
                console.error('Error starting farming:', error);
                showToast('Error starting farming', 'error');
            }
        }

        function checkFarmingStatus() {
            if (appState.isFarming && appState.farmingEndTime) {
                const now = Date.now();
                if (now >= appState.farmingEndTime) {
                    // Farming completed
                    completeFarming();
                } else {
                    // Continue farming
                    startFarmingAnimation();
                }
            }
        }

        function startFarmingAnimation() {
            if (!appState.isFarming) return;

            const coin = document.getElementById('mainCoin');
            coin.classList.add('farming');

            const farmingInterval = setInterval(async () => {
                const now = Date.now();
                
                if (now >= appState.farmingEndTime) {
                    clearInterval(farmingInterval);
                    completeFarming();
                    return;
                }

                // Add 0.001 TRM every second
                appState.balance += 0.001;
                
                // Show animation
                showCoinAnimation(coin);
                
                // Update UI
                updateUI();
                
                // Update timer
                const remaining = Math.max(0, appState.farmingEndTime - now);
                updateFarmingTimer(remaining);
                
                // Save progress every 10 seconds
                if (now % 10000 < 1000) {
                    await saveUserData();
                }
                
            }, 1000);
        }

        function updateFarmingTimer(remainingMs) {
            const hours = Math.floor(remainingMs / (1000 * 60 * 60));
            const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);
            
            const timer = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('farmingTimer').textContent = timer;
        }

        async function completeFarming() {
            appState.isFarming = false;
            appState.farmingEndTime = null;
            appState.farmingStartTime = null;
            
            const coin = document.getElementById('mainCoin');
            coin.classList.remove('farming');
            
            await saveUserData();
            updateFarmingButton();
            
            showToast('Farming completed! Start farming again to earn more TRM.', 'success');
        }

        function updateFarmingButton() {
            const button = document.getElementById('farmingButton');
            
            if (appState.isFarming) {
                button.textContent = 'Farming...';
                button.disabled = true;
            } else {
                button.textContent = 'Start Farming';
                button.disabled = false;
            }
        }

        function showCoinAnimation(element) {
            const animation = document.createElement('div');
            animation.className = 'coin-animation';
            animation.textContent = '+0.001 TRM';
            
            const rect = element.getBoundingClientRect();
            animation.style.left = `${rect.left + rect.width / 2}px`;
            animation.style.top = `${rect.top}px`;
            
            document.body.appendChild(animation);
            
            setTimeout(() => {
                animation.remove();
            }, 2000);
        }

        // Wallet functions
        async function connectWallet() {
            try {
                // Open TON wallet connection
                const walletUrl = 'https://trimint.vercel.app/';
                window.open(walletUrl, '_blank');
                
                // In a real implementation, you would handle the wallet connection callback
                // For now, we'll simulate a successful connection
                setTimeout(() => {
                    appState.walletConnected = true;
                    appState.walletAddress = 'EQD' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                    updateWalletSection();
                    saveUserData();
                    showToast('TON wallet connected successfully!', 'success');
                }, 3000);
                
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showToast('Error connecting wallet', 'error');
            }
        }

        async function disconnectWallet() {
            try {
                appState.walletConnected = false;
                appState.walletAddress = null;
                updateWalletSection();
                await saveUserData();
                showToast('Wallet disconnected', 'info');
            } catch (error) {
                console.error('Error disconnecting wallet:', error);
            }
        }

        function copyWalletAddress() {
            if (appState.walletAddress) {
                navigator.clipboard.writeText(appState.walletAddress);
                showToast('Wallet address copied!', 'success');
            }
        }

        function updateWalletSection() {
            const connectButton = document.getElementById('connectWalletButton');
            const walletAddress = document.getElementById('walletAddress');
            const walletButtons = document.getElementById('walletButtons');
            
            if (appState.walletConnected && appState.walletAddress) {
                connectButton.textContent = 'Connected';
                connectButton.style.background = 'var(--success-gradient)';
                walletAddress.textContent = appState.walletAddress;
                walletAddress.classList.add('connected');
                walletButtons.style.display = 'flex';
            } else {
                connectButton.textContent = 'Connect TON Wallet';
                connectButton.style.background = 'var(--primary-gradient)';
                walletAddress.classList.remove('connected');
                walletButtons.style.display = 'none';
            }
        }

        // Settings functions
        function toggleDarkMode() {
            const toggle = document.getElementById('darkModeToggle');
            toggle.classList.toggle('active');
            document.body.classList.toggle('light-mode');
            
            const isDarkMode = !document.body.classList.contains('light-mode');
            localStorage.setItem('darkMode', isDarkMode);
        }

        function toggleNotifications() {
            const toggle = document.getElementById('notificationsToggle');
            toggle.classList.toggle('active');
            appState.notificationsEnabled = toggle.classList.contains('active');
            localStorage.setItem('notifications', appState.notificationsEnabled);
        }

        function toggleSound() {
            const toggle = document.getElementById('soundToggle');
            toggle.classList.toggle('active');
            appState.soundEnabled = toggle.classList.contains('active');
            localStorage.setItem('sound', appState.soundEnabled);
        }

        // Tasks functions
        async function loadTasks() {
            try {
                const tasksSnapshot = await db.collection('tasks').orderBy('order', 'asc').get();
                const taskList = document.getElementById('taskList');
                taskList.innerHTML = '';
                
                tasksSnapshot.forEach(doc => {
                    const task = doc.data();
                    const taskElement = createTaskElement(task, doc.id);
                    taskList.appendChild(taskElement);
                });
                
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        function createTaskElement(task, taskId) {
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card';
            
            const isCompleted = appState.tasksCompleted && appState.tasksCompleted.includes(taskId);
            const buttonText = isCompleted ? 'Completed' : 'OPEN';
            const buttonClass = isCompleted ? 'task-button completed' : 'task-button';
            
            taskCard.innerHTML = `
                <div class="task-header">
                    <img src="${task.photo || 'https://via.placeholder.com/50'}" alt="${task.name}" class="task-icon">
                    <div class="task-info">
                        <div class="task-name">${task.name}</div>
                        <div class="task-reward">Reward: ${task.reward} TRM</div>
                    </div>
                </div>
                <div class="task-description">${task.description}</div>
                <button class="${buttonClass}" data-task-id="${taskId}" data-link="${task.link || '#'}" data-reward="${task.reward}">${buttonText}</button>
            `;
            
            const button = taskCard.querySelector('button');
            button.addEventListener('click', () => handleTaskClick(taskId, task.link, task.reward));
            
            return taskCard;
        }

        async function handleTaskClick(taskId, link, reward) {
            const button = document.querySelector(`[data-task-id="${taskId}"]`);
            
            if (button.textContent === 'Completed') {
                // Still redirect to link if completed
                if (link && link !== '#') {
                    window.open(link, '_blank');
                }
                return;
            }
            
            if (button.textContent === 'processing') {
                showToast('Task is being processed...', 'info');
                return;
            }
            
            try {
                // Change button state to processing
                button.textContent = 'processing';
                button.classList.add('processing');
                
                // Open task link
                if (link && link !== '#') {
                    window.open(link, '_blank');
                }
                
                // Wait 10 seconds
                setTimeout(async () => {
                    // Add reward to balance
                    appState.balance += reward;
                    
                    // Mark task as completed
                    if (!appState.tasksCompleted) {
                        appState.tasksCompleted = [];
                    }
                    appState.tasksCompleted.push(taskId);
                    
                    // Update UI and save
                    updateUI();
                    await saveUserData();
                    
                    // Update button
                    button.textContent = 'Completed';
                    button.classList.remove('processing');
                    button.classList.add('completed');
                    
                    showToast(`Task completed! You earned ${reward} TRM`, 'success');
                    
                    // Play sound if enabled
                    if (appState.soundEnabled) {
                        playTaskCompleteSound();
                    }
                    
                }, 10000);
                
            } catch (error) {
                console.error('Error handling task:', error);
                button.textContent = 'OPEN';
                button.classList.remove('processing');
                showToast('Error completing task', 'error');
            }
        }

        // Watch ads function
        async function watchAd() {
            try {
                const button = document.getElementById('watchAdsButton');
                button.textContent = 'Loading ad...';
                button.disabled = true;
                
                // Show Monetag ad
                if (typeof show_10290264 !== 'undefined') {
                    show_10290264();
                }
                
                // Wait for ad to complete (simulate)
                setTimeout(async () => {
                    // Add 1 TRM reward
                    appState.balance += 1;
                    updateUI();
                    await saveUserData();
                    
                    button.textContent = 'Watch Ad';
                    button.disabled = false;
                    
                    showToast('Ad watched! You earned 1 TRM', 'success');
                    
                }, 3000);
                
            } catch (error) {
                console.error('Error watching ad:', error);
                const button = document.getElementById('watchAdsButton');
                button.textContent = 'Watch Ad';
                button.disabled = false;
                showToast('Error loading ad', 'error');
            }
        }

        // Leaderboard functions
        async function loadLeaderboard() {
            try {
                const usersSnapshot = await db.collection('users')
                    .orderBy('balance', 'desc')
                    .limit(25)
                    .get();
                
                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = '';
                
                let rank = 1;
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const leaderboardItem = createLeaderboardItem(user, rank);
                    leaderboardList.appendChild(leaderboardItem);
                    rank++;
                });
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        function createLeaderboardItem(user, rank) {
            const item = document.createElement('div');
            item.className = 'leaderboard-item';
            
            let rankClass = '';
            if (rank === 1) rankClass = 'gold';
            else if (rank === 2) rankClass = 'silver';
            else if (rank === 3) rankClass = 'bronze';
            
            const level = user.balance < 10000 ? 'Bronze' : 
                         user.balance < 50000 ? 'Gold' : 'Diamond';
            
            item.innerHTML = `
                <div class="rank-badge ${rankClass}">${rank}</div>
                <img src="${user.photoUrl || 'https://via.placeholder.com/50'}" alt="${user.firstName}" class="leaderboard-avatar">
                <div class="leaderboard-info">
                    <div class="leaderboard-name">${user.firstName} ${user.lastName || ''}`.trim() || user.username || 'Unknown'</div>
                    <div class="leaderboard-level">${level} Level</div>
                </div>
                <div class="leaderboard-balance">
                    <img src="https://i.postimg.cc/fTQktNmX/maincoin.png" alt="TRM" style="width: 16px; height: 16px;">
                    ${user.balance.toLocaleString()}
                </div>
            `;
            
            return item;
        }

        // Referral functions
        function updateReferralSection() {
            const referralLink = `https://t.me/TrimintBot/open?startapp=${user.id}`;
            document.getElementById('referralLink').textContent = referralLink;
            
            const referralCount = appState.referrals ? appState.referrals.length : 0;
            const referralEarned = referralCount * 5000;
            
            document.getElementById('referralCount').textContent = referralCount;
            document.getElementById('referralEarned').textContent = referralEarned.toLocaleString();
        }

        async function loadReferrals() {
            try {
                if (!appState.referrals) return;
                
                const referralsList = document.getElementById('referralsList');
                referralsList.innerHTML = '';
                
                appState.referrals.forEach(referral => {
                    const referralItem = createReferralItem(referral);
                    referralsList.appendChild(referralItem);
                });
                
            } catch (error) {
                console.error('Error loading referrals:', error);
            }
        }

        function createReferralItem(referral) {
            const item = document.createElement('div');
            item.className = 'referral-item';
            
            item.innerHTML = `
                <img src="${referral.photoUrl || 'https://via.placeholder.com/40'}" alt="${referral.firstName}" class="referral-avatar">
                <div class="referral-info">
                    <div class="referral-name">${referral.firstName} ${referral.lastName || ''}`.trim() || referral.username || 'Unknown'</div>
                    <div class="referral-details">ID: ${referral.telegramId} | Balance: ${referral.balance || 0} TRM</div>
                </div>
                <div class="referral-earned">+${referral.earned || 5000} TRM</div>
            `;
            
            return item;
        }

        function copyReferralLink() {
            const referralLink = `https://t.me/TrimintBot/open?startapp=${user.id}`;
            navigator.clipboard.writeText(referralLink);
            showToast('Referral link copied!', 'success');
        }

        // Utility functions
        async function saveUserData() {
            try {
                appState.lastActive = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection('users').doc(user.id.toString()).update(appState);
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function playTaskCompleteSound() {
            // Simple sound effect using Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // Load settings from localStorage
        function loadSettings() {
            const darkMode = localStorage.getItem('darkMode') !== 'false';
            const notifications = localStorage.getItem('notifications') !== 'false';
            const sound = localStorage.getItem('sound') === 'true';
            
            if (!darkMode) {
                document.body.classList.add('light-mode');
                document.getElementById('darkModeToggle').classList.remove('active');
            }
            
            if (!notifications) {
                document.getElementById('notificationsToggle').classList.remove('active');
            }
            
            if (sound) {
                document.getElementById('soundToggle').classList.add('active');
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            initApp();
        });

        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                checkFarmingStatus();
            }
        });

        // Periodic save
        setInterval(async () => {
            if (appState.isFarming) {
                await saveUserData();
            }
        }, 30000); // Save every 30 seconds during farming
    </script>
</body>
</html>
